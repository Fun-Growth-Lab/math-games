<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Sugoroku - Collector Edition</title>
    
    <style>
        /* --- Âü∫Êú¨Ë®≠ÂÆö --- */
        body, html {
            margin: 0; padding: 0; height: 100%; overflow: hidden;
            font-family: 'M PLUS Rounded 1c', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            background-color: #2c3e50; color: #333;
            user-select: none; touch-action: none;
        }

        #main-wrapper { display: flex; width: 100vw; height: 100vh; }

        /* --- Â∑¶„Éë„Éç„É´Ôºö„ÅÇ„Åù„Å≥„Åã„Åü --- */
        #side-panel-left {
            width: 220px; background-color: #34495e; color: #ecf0f1;
            padding: 10px;
            box-sizing: border-box; display: flex; flex-direction: column;
            border-right: 1px solid #2c3e50; z-index: 10;
            font-size: 13px; overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0,0,0,0.2);
        }
        #side-panel-left h2 { margin-top: 0; font-size: 16px; border-bottom: 2px solid #3498db; padding-bottom: 2px; margin-bottom: 5px; color:#fff;}
        #side-panel-left ul { padding-left: 20px; line-height: 1.4; margin: 2px 0; }
        #side-panel-left li { margin-bottom: 2px; }
        .instruction-box { background: rgba(255,255,255,0.1); padding: 5px; border-radius: 8px; margin-bottom: 5px; text-align: center;}
        hr { border: 0; border-top: 1px solid #7f8c8d; width: 100%; margin: 5px 0; }
        #side-panel-left p { margin: 5px 0; font-weight: bold;}

        /* --- ‰∏≠Â§Æ„Éë„Éç„É´Ôºö„Ç≤„Éº„É†ÁîªÈù¢ --- */
        #game-container {
            flex-grow: 1; display: flex; flex-direction: column;
            background-color: #f0f4f8; position: relative;
        }

        /* „Ç≠„É£„É≥„Éê„Çπ */
        #game-canvas {
            background-color: #e6f7ff; width: 100%; flex-grow: 1;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.05);
        }

        /* ÊÆã„ÇäÊôÇÈñìË°®Á§∫ */
        #top-timer-container {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: #fff; padding: 5px 40px;
            border-radius: 50px; box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            text-align: center; z-index: 50; border: 4px solid #e74c3c; min-width: 120px;
        }
        #top-timer-label { font-size: 12px; color: #7f8c8d; font-weight: bold; }
        #top-timer-value { font-size: 40px; font-weight: 900; color: #e74c3c; line-height: 1; font-family: sans-serif;}

        /* „É°„ÉÉ„Çª„Éº„Ç∏„Ç®„É™„Ç¢ */
        #central-message-area {
            position: absolute; 
            bottom: 240px; 
            top: auto;
            left: 50%; transform: translateX(-50%); width: 90%;
            pointer-events: none; text-align: center; z-index: 60;
            height: 60px; display: flex; justify-content: center; align-items: center;
        }
        #central-message-text {
            font-size: 28px; font-weight: bold; color: #fff;
            background: rgba(0, 0, 0, 0.85); padding: 15px 40px;
            border-radius: 50px; box-shadow: 0 5px 20px rgba(0,0,0,0.4);
            white-space: nowrap; opacity: 0; transition: opacity 0.2s;
            border: 2px solid #fff;
        }
        #central-message-text.visible { opacity: 1; }

        /* --- Âè≥„Éë„Éç„É´ÔºöÊÉÖÂ†±„Å®„Çπ„Ç≠„É´ --- */
        #side-panel-right {
            width: 260px; background-color: #fff; color: #333;
            padding: 10px;
            box-sizing: border-box; display: flex; flex-direction: column;
            border-left: 2px solid #bdc3c7; z-index: 20; overflow-y: auto;
        }

        .panel-section { margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .panel-title { font-size: 13px; font-weight: bold; color: #7f8c8d; margin-bottom: 5px; display: flex; align-items: center; gap: 5px;}
        
        .status-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 2px; }
        .status-val { font-size: 22px; font-weight: bold; color: #2c3e50; font-family: monospace; }
        #point-val { color: #f39c12; }
        #gem-val { color: #00bcd4; }

        .skill-btn {
            display: block; width: 100%; padding: 8px; margin-bottom: 5px;
            background: #fff; border: 2px solid #00bcd4; color: #008ba3;
            border-radius: 10px; font-size: 13px; font-weight: bold; cursor: pointer;
            text-align: left; box-shadow: 0 2px 0 #00bcd4; transition: all 0.1s;
            position: relative;
        }
        .skill-btn:active { transform: translateY(3px); box-shadow: none; }
        .skill-btn:disabled {
            background: #f9f9f9; border-color: #e0e0e0; color: #bdc3c7; box-shadow: none; cursor: not-allowed;
        }
        .skill-cost { float: right; font-size: 10px; background: #00bcd4; color: white; padding: 2px 5px; border-radius: 4px; }
        .skill-btn:disabled .skill-cost { background: #bdc3c7; }

        #collection-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px;
        }
        .collection-item {
            width: 100%; aspect-ratio: 1; background: #f0f3f4; border-radius: 8px;
            display: flex; justify-content: center; align-items: center; font-size: 20px;
            opacity: 0.3; filter: grayscale(100%); transition: all 0.3s;
        }
        .collection-item.collected {
            opacity: 1; filter: grayscale(0%); background: #fff3e0; 
            box-shadow: 0 0 8px rgba(255, 165, 0, 0.5); transform: scale(1.05);
            border: 1px solid #ffe0b2;
        }

        /* ÊâãÊú≠„Ç®„É™„Ç¢ */
        #hand-area {
            height: 230px;
            width: 100%; background-color: #fff;
            border-top: 4px solid #bdc3c7; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 20;
            position: relative; box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
        }

        #hand-message { 
            font-size: 42px;
            color: #2c3e50; margin-bottom: 15px; font-weight: 900; 
            background: #fff; padding: 10px 40px; border-radius: 50px;
            font-family: monospace; border: 2px solid #bdc3c7;
            min-width: 150px; text-align: center;
        }
        #hand-cards-container { display: flex; gap: 15px; padding: 5px; align-items: center; }

        .card {
            width: 70px; height: 90px; background-color: white; border: 3px solid #34495e;
            border-radius: 12px; display: flex; justify-content: center; align-items: center;
            font-size: 40px; font-weight: bold; color: #2c3e50; cursor: pointer;
            box-shadow: 0 6px 0px rgba(0,0,0,0.2); transition: transform 0.1s;
            user-select: none;
        }
        .card:active { transform: translateY(6px); box-shadow: none; }
        .card:hover { background-color: #f7f9f9; border-color: #3498db; color: #3498db; transform: translateY(-2px); }

        /* --- „Ç™„Éº„Éê„Éº„É¨„Ç§ÂÖ±ÈÄö --- */
        .overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(44, 62, 80, 0.95); display:flex; justify-content:center; align-items:center; z-index:100;}
        
        #result-screen .overlay-content {
            text-align: center; background:#fff; padding: 40px 50px; 
            border-radius: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
            max-width: 600px; width: 90%;
            border: 5px solid #f1c40f;
            max-height: 90vh; overflow-y: auto;
        }

        /* „É©„É≥„Ç≠„É≥„Ç∞ÁîªÈù¢Áî®„Çπ„Çø„Ç§„É´ */
        #ranking-screen {
            position: absolute; top:0; left:0; width:100%; height:100%; 
            background:rgba(30, 40, 50, 0.98); 
            display:flex; justify-content:center; align-items:center; z-index:110;
        }
        #ranking-content {
            width: 90%; max-width: 900px; height: 85%;
            display: flex; flex-direction: column;
            color: #fff;
        }
        .ranking-header { text-align: center; margin-bottom: 10px; font-size: 24px; color: #f1c40f; font-weight: bold; }
        
        /* „É©„É≥„Ç≠„É≥„Ç∞„Çø„Éñ */
        .ranking-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .rank-tab {
            padding: 8px 30px; border-radius: 20px; border: 2px solid #7f8c8d;
            background: transparent; color: #bdc3c7; cursor: pointer; font-weight: bold;
            transition: all 0.2s;
        }
        .rank-tab.active {
            background: #f1c40f; color: #2c3e50; border-color: #f1c40f;
            box-shadow: 0 0 10px rgba(241, 196, 15, 0.5);
        }

        .ranking-columns { display: flex; justify-content: space-between; gap: 10px; height: 100%; overflow: hidden; }
        
        .ranking-col {
            flex: 1; 
            background: #2c3e50;
            border: 2px solid #5d6d7e; 
            border-radius: 10px;
            display: flex; flex-direction: column;
            padding: 10px;
        }
        /* Á¥ö„Åî„Å®„ÅÆËâ≤ÂàÜ„Åë */
        #rank-col-easy { border-color: #2ecc71; box-shadow: 0 0 10px rgba(46, 204, 113, 0.2); }
        #rank-col-normal { border-color: #3498db; box-shadow: 0 0 10px rgba(52, 152, 219, 0.2); }
        #rank-col-hard { border-color: #e74c3c; box-shadow: 0 0 10px rgba(231, 76, 60, 0.2); }

        .rank-col-header {
            text-align: center; font-size: 18px; font-weight: bold; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 10px;
        }
        #rank-col-easy .rank-col-header { color: #2ecc71; }
        #rank-col-normal .rank-col-header { color: #3498db; }
        #rank-col-hard .rank-col-header { color: #e74c3c; }

        .rank-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        .rank-item {
            display: flex; justify-content: space-between; padding: 8px 5px;
            border-bottom: 1px dashed rgba(255,255,255,0.1); font-size: 14px;
        }
        .rank-item:last-child { border-bottom: none; }
        .rank-num { width: 25px; color: #bdc3c7; }
        .rank-score { font-weight: bold; color: #fff; text-align: right; flex-grow: 1; }
        .rank-name { font-size: 10px; color: #bdc3c7; width: 60px; text-align: right; margin-left: 5px; display: flex; align-items: center; justify-content: flex-end; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;}
        .rank-date { font-size: 10px; color: #7f8c8d; width: 60px; text-align: right; margin-left: 5px; display: flex; align-items: center; justify-content: flex-end;}

        #title-screen { background: #fff; }
        #title-screen .overlay-content {
            text-align: center; max-width: 800px; width: 100%; padding: 20px; box-shadow: none;
        }

        #char-screen .overlay-content {
            text-align: center; background:#fff; padding: 30px;
            border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            max-width: 500px; width: 90%;
        }

        .hidden { display: none !important; }
        
        .btn { padding: 12px 0; font-size: 16px; border: none; border-radius: 50px; cursor: pointer; color: white; margin: 5px; font-weight: bold; width: 100%; transition: opacity 0.2s; box-shadow: 0 4px 0 rgba(0,0,0,0.15);}
        .btn:active { transform: translateY(2px); box-shadow: none; }
        
        .btn-easy { background: #2ecc71; box-shadow: 0 4px 0 #27ae60; }
        .btn-normal { background: #3498db; box-shadow: 0 4px 0 #2980b9; }
        .btn-hard { background: #e74c3c; box-shadow: 0 4px 0 #c0392b; }
        .btn-gray { background: #95a5a6; color: white; box-shadow: 0 4px 0 #7f8c8d; }
        .btn-yellow { background-color: #f1c40f; color: #333; box-shadow: 0 4px 0 #d4ac0d; }
        .btn-google { background-color: #dd4b39; box-shadow: 0 4px 0 #c0392b; }

        .title-header { margin-bottom: 30px; }
        .title-main { 
            font-family: 'Impact', 'Arial Black', 'Hiragino Kaku Gothic Std', sans-serif; 
            font-size: 60px; color: #e74c3c; margin: 0; text-transform: uppercase; letter-spacing: 2px;
            -webkit-text-stroke: 3px #2c3e50; paint-order: stroke fill;
            text-shadow: 5px 5px 0px rgba(0,0,0,0.3);
        }
        .title-sub { font-size: 18px; color: #7f8c8d; margin-top: 10px; font-weight: bold;}
        
        .level-select-container { display: flex; justify-content: center; gap: 20px; margin: 30px 0; }
        .level-box { display: flex; flex-direction: column; align-items: center; width: 140px; }
        .clear-count-label { margin-top: 5px; font-size: 12px; color: #7f8c8d; font-weight: bold; }

        .bottom-actions { display: flex; flex-direction: column; align-items: center; gap: 10px; max-width: 300px; margin: 0 auto; }
        
        #login-status-text { font-size:12px; color:#aaa; margin-top:5px; }

        #char-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px auto; 
            max-width: 350px; justify-content: center;
        }
        .char-btn {
            width: 70px; height: 70px; font-size: 42px; padding: 0;
            border: 2px solid #ecf0f1; border-radius: 12px; background: #fff; cursor: pointer;
            transition: transform 0.1s, background 0.2s; box-shadow: 0 4px 0 #ecf0f1;
            display: flex; justify-content: center; align-items: center;
        }
        .char-btn:hover { background: #e8f6f3; border-color: #1abc9c; }
        .char-btn:active { transform: scale(0.95); box-shadow: none; translateY(4px); }

        .result-row { display: flex; justify-content: space-between; font-size: 18px; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 5px;}
        .result-label { color: #7f8c8d; }
        .result-val { font-weight: bold; color: #2c3e50; }
        .result-total { display: flex; justify-content: space-between; font-size: 32px; color: #e74c3c; margin-top: 20px; border-top: 3px solid #f1c40f; padding-top: 10px;}

    </style>
</head>
<body>

    <div id="main-wrapper">
        <div id="side-panel-left">
            <h2>„ÅÇ„Åù„Å≥„Åã„Åü</h2>
            <div class="instruction-box">
                <strong style="color:#e74c3c; font-size:16px;">100„Åæ„Åß„ÅÑ„Å£„Åü„Çâ„Ç¥„Éº„É´ÔºÅ</strong>
            </div>
            <ul>
                <li><strong>„Åò„Åã„Çì„Åé„Çå„Å´„Å™„Çã„Å®<br>„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº</strong></li>
            </ul>
            <p><strong>„ÅÑ„Çç„ÅÑ„Çç„Å™„Éû„Çπ„Åå„ÅÇ„Çã„Çà</strong></p>
            <ul>
                <li>‚è∞: „Åò„Åã„Çì„Åã„ÅÑ„Åµ„Åè</li>
                <li>üéÅ: „Éù„Ç§„É≥„Éà</li>
                <li>üëª: „Åä„Å∞„Åë(„Éû„Ç§„Éä„Çπ)</li>
                <li>üíé: „Åª„ÅÜ„Åõ„Åç</li>
            </ul>
            <hr>
            <p><strong>„Éú„Éº„Éä„ÇπÔºÅ</strong></p>
            <ul>
                <li>10,20‚Ä¶„Çí„Åì„Åà„Çã„Å®<br><strong style="color:#f39c12;">+100„Éù„Ç§„É≥„Éà</strong></li>
                <li>„Å¥„Å£„Åü„Çä„Å®„Åæ„Çã„Å®<br><strong style="color:#e74c3c;">+200„Éù„Ç§„É≥„Éà</strong></li>
                <li>„Ç¥„Éº„É´„Å¥„Å£„Åü„Çä„ÅØ<br><strong style="color:#e74c3c;">+1000„Éù„Ç§„É≥„Éà!</strong></li>
            </ul>
            <hr>
            <ul>
                <li><strong>16„Åó„ÇÖ„Çã„ÅÑ„ÅÆ„Ç¢„Ç§„ÉÜ„É†<br>„ÅÑ„Åè„Å§„Å≤„Çç„Åà„Çã„Åã„Å™Ôºü</strong></li>
                <li><strong>üíé„Åå„ÅÇ„Çå„Å∞<br>„Å®„Åè„Åó„ÇÖ„ÅÆ„ÅÜ„Çä„Çá„Åè„Åå<br>„Å§„Åã„Åà„Çã„ÅûÔºÅ</strong></li>
            </ul>
            <button class="btn btn-gray" onclick="location.reload()" style="margin-top:10px; width:90%;">„Çø„Ç§„Éà„É´„Å∏</button>
        </div>

        <div id="game-container">
            <div id="top-timer-container">
                <div id="top-timer-label">„ÅÆ„Åì„Çä„Åò„Åã„Çì</div>
                <div id="top-timer-value">10</div>
            </div>

            <canvas id="game-canvas"></canvas>
            
            <div id="central-message-area">
                <div id="central-message-text"></div>
            </div>

            <div id="hand-area">
                <div id="hand-message" style="font-size:24px; min-width:300px;">„Åì„Åì„Å´„Åë„ÅÑ„Åï„Çì„Åå„Å≤„Çá„ÅÜ„Åò„Åï„Çå„Çã„Çà</div>
                <div id="hand-cards-container"></div>
            </div>

            <div id="title-screen" class="overlay">
                <div class="overlay-content">
                    <div class="title-header">
                        <h1 class="title-main">Math Sugoroku</h1>
                        <div class="title-sub">„Åü„Åó„Åñ„Çì„Åó„Å™„Åå„ÇâÔºëÔºêÔºê„Çí„ÇÅ„Åñ„ÅõÔºÅ<br>„ÅÑ„Çç„Çì„Å™„Éû„Çπ„ÇÑ„Ç¢„Ç§„ÉÜ„É†„Åå„Åß„Å¶„Åè„Çã„ÇàÔºÅ</div>
                    </div>

                    <div class="level-select-container">
                        <div class="level-box">
                            <button class="btn btn-easy" onclick="selectLevel('easy')">„Åó„Çá„Åç„ÇÖ„ÅÜ</button>
                            <div class="clear-count-label"><span id="clear-easy">0</span>Âõû„ÇØ„É™„Ç¢</div>
                        </div>
                        <div class="level-box">
                            <button class="btn btn-normal" onclick="selectLevel('normal')">„Å°„ÇÖ„ÅÜ„Åç„ÇÖ„ÅÜ</button>
                            <div class="clear-count-label"><span id="clear-normal">0</span>Âõû„ÇØ„É™„Ç¢</div>
                        </div>
                        <div class="level-box">
                            <button class="btn btn-hard" onclick="selectLevel('hard')">„Åò„Çá„ÅÜ„Åç„ÇÖ„ÅÜ</button>
                            <div class="clear-count-label"><span id="clear-hard">0</span>Âõû„ÇØ„É™„Ç¢</div>
                        </div>
                    </div>

                    <div class="bottom-actions">
                        <button class="btn btn-yellow" onclick="showFullRanking()">„Çπ„Ç≥„Ç¢„Çí„Åø„Çã</button>
                        <div id="login-status-text">„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì</div>
                        <button id="btn-login-google" class="btn btn-google" onclick="handleGoogleLogin()">Google„Åß„É≠„Ç∞„Ç§„É≥</button>
                        <button class="btn btn-gray" onclick="window.location.href='index.html'">INDEX„Å∏</button>
                    </div>
                </div>
            </div>

            <div id="char-screen" class="overlay hidden">
                <div class="overlay-content">
                    <h2 style="color:#2c3e50; margin-top:0;">Â•Ω„Åç„Å™„Ç≠„É£„É©„ÇØ„Çø„Éº„Çí„Åà„Çâ„Çì„Åß„Å≠</h2>
                    <div id="char-grid"></div>
                    <div style="display:flex; flex-direction:column; align-items:center; gap:10px; margin-top:20px;">
                        <button class="btn btn-normal" onclick="pickRandomChar()" style="width:200px;">üé≤ „Åä„Åæ„Åã„Åõ</button>
                        <button class="btn btn-gray" onclick="backToTitle()" style="width:200px;">Êàª„Çã</button>
                    </div>
                </div>
            </div>

            <div id="result-screen" class="overlay hidden">
                <div class="overlay-content">
                    <h1 id="result-title" style="font-size:48px; margin:0 0 20px 0; color:#e74c3c;">„Ç≤„Éº„É†„Çª„ÉÉ„Éà</h1>
                    
                    <div style="text-align:left; width:100%; margin-bottom:20px;">
                        <div class="result-row">
                            <span class="result-label">„Åã„Åè„Å®„Åè„Éù„Ç§„É≥„Éà</span>
                            <span class="result-val" id="res-base">0</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">„Ç¢„Ç§„ÉÜ„É†„Éú„Éº„Éä„Çπ <span id="res-item-cnt" style="font-size:0.8em;">(0ÂÄã)</span></span>
                            <span class="result-val" style="color:#e67e22;" id="res-item">0</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">„Çø„Ç§„É†„Éú„Éº„Éä„Çπ <span id="res-time-cnt" style="font-size:0.8em;">(0s)</span></span>
                            <span class="result-val" style="color:#27ae60;" id="res-time">0</span>
                        </div>
                        <div class="result-row">
                            <span class="result-label">„Åª„ÅÜ„Åõ„Åç„Éú„Éº„Éä„Çπ <span id="res-gem-cnt" style="font-size:0.8em;">(0ÂÄã)</span></span>
                            <span class="result-val" style="color:#00bcd4;" id="res-gem">0</span>
                        </div>
                        
                        <div class="result-total">
                            <span>„Åî„ÅÜ„Åë„ÅÑ</span>
                            <span id="res-final" style="font-weight:900;">0</span>
                        </div>
                    </div>

                    <div style="margin-bottom:20px;">
                         <button class="btn btn-yellow" onclick="showFullRanking()">„É©„É≥„Ç≠„É≥„Ç∞„Çí„Åø„Çã</button>
                    </div>

                    <button class="btn btn-normal" onclick="location.reload()" style="width:250px; font-size:20px; padding:15px;">„Çø„Ç§„Éà„É´„Å∏„ÇÇ„Å©„Çã</button>
                </div>
            </div>

            <div id="ranking-screen" class="hidden">
                <div id="ranking-content">
                    <div class="ranking-header">„É©„É≥„Ç≠„É≥„Ç∞</div>
                    
                    <div class="ranking-tabs">
                        <button id="tab-local" class="rank-tab active" onclick="switchRankingMode('local')">„É≠„Éº„Ç´„É´</button>
                        <button id="tab-online" class="rank-tab" onclick="switchRankingMode('online')">„Ç™„É≥„É©„Ç§„É≥</button>
                    </div>

                    <div class="ranking-columns">
                        <div class="ranking-col" id="rank-col-easy">
                            <div class="rank-col-header">„Åó„Çá„Åç„ÇÖ„ÅÜ</div>
                            <ul class="rank-list" id="rank-list-easy"></ul>
                        </div>
                        <div class="ranking-col" id="rank-col-normal">
                            <div class="rank-col-header">„Å°„ÇÖ„ÅÜ„Åç„ÇÖ„ÅÜ</div>
                            <ul class="rank-list" id="rank-list-normal"></ul>
                        </div>
                        <div class="ranking-col" id="rank-col-hard">
                            <div class="rank-col-header">„Åò„Çá„ÅÜ„Åç„ÇÖ„ÅÜ</div>
                            <ul class="rank-list" id="rank-list-hard"></ul>
                        </div>
                    </div>
                    <div style="text-align:center; margin-top:20px;">
                        <button class="btn btn-normal" onclick="closeRanking()" style="width:200px;">„Å®„Åò„Çã</button>
                    </div>
                </div>
            </div>
        
        </div>

        <div id="side-panel-right">
            <div class="panel-section">
                <div class="panel-title">„Çπ„ÉÜ„Éº„Çø„Çπ</div>
                <div class="status-row">
                    <span>„É¨„Éô„É´</span> <span id="level-val" style="font-weight:bold;">-</span>
                </div>
                <div class="status-row">
                    <span>„Éù„Ç§„É≥„Éà</span> <span id="point-val">0</span>
                </div>
                <div class="status-row">
                    <span>üíé „Åª„ÅÜ„Åõ„Åç</span> <span id="gem-val">0</span>
                </div>
            </div>

            <div class="panel-section">
                <div class="panel-title">„Å®„Åè„Åó„ÇÖ„ÅÆ„ÅÜ„Çä„Çá„Åè (üíéÊ∂àË≤ª)</div>
                <button class="skill-btn" onclick="useAbility('change')" id="btn-change" disabled>
                    üÉè ÊâãÊú≠„ÉÅ„Çß„É≥„Ç∏ <span class="skill-cost">üíé1</span>
                </button>
                <button class="skill-btn" onclick="useAbility('move1')" id="btn-move1" disabled>
                    üü¢ 1„Éû„Çπ„Åô„Åô„ÇÄ <span class="skill-cost">üíé1</span>
                </button>
                <button class="skill-btn" onclick="useAbility('time5')" id="btn-time5" disabled>
                    ‚è∞ „Åò„Åã„Çì +5 <span class="skill-cost">üíé1</span>
                </button>
            </div>

            <div class="panel-section" style="border-bottom:none;">
                <div class="panel-title">„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ (<span id="collected-count">0</span>/16)</div>
                <div id="collection-grid"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- FirebaseË®≠ÂÆö ---
        const firebaseConfig = {
            apiKey: "AIzaSyBCg5dCEM89UmYYhfGqVeRf_VrUlg8_o-4",
            authDomain: "math-braves.firebaseapp.com",
            projectId: "math-braves",
            storageBucket: "math-braves.firebasestorage.app",
            messagingSenderId: "217117619290",
            appId: "1:217117619290:web:d227feb603970d3948d463"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        // --- FirebaseÈñ¢ÈÄ£Èñ¢Êï∞ ---
        function handleGoogleLogin() {
            if (currentUser) {
                // Êó¢„Å´„É≠„Ç∞„Ç§„É≥Ê∏à„Åø„Å™„Çâ„É≠„Ç∞„Ç¢„Ç¶„Éà
                signOut(auth).then(() => {
                    alert("„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü");
                }).catch((error) => {
                    console.error(error);
                });
            } else {
                // „É≠„Ç∞„Ç§„É≥Âá¶ÁêÜ
                const provider = new GoogleAuthProvider();
                signInWithPopup(auth, provider)
                    .then((result) => {
                        console.log("Logged in:", result.user);
                    }).catch((error) => {
                        console.error("Login failed:", error);
                        alert("„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + error.message);
                    });
            }
        }

        // Ë™çË®ºÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const statusText = document.getElementById("login-status-text");
            const loginBtn = document.getElementById("btn-login-google");

            if (user) {
                statusText.innerText = `„É≠„Ç∞„Ç§„É≥‰∏≠: ${user.displayName}`;
                statusText.style.color = "#27ae60";
                statusText.style.fontWeight = "bold";
                loginBtn.innerText = "„É≠„Ç∞„Ç¢„Ç¶„Éà";
                loginBtn.classList.remove("btn-google");
                loginBtn.classList.add("btn-gray");
            } else {
                statusText.innerText = "„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì";
                statusText.style.color = "#aaa";
                statusText.style.fontWeight = "normal";
                loginBtn.innerText = "Google„Åß„É≠„Ç∞„Ç§„É≥";
                loginBtn.classList.remove("btn-gray");
                loginBtn.classList.add("btn-google");
            }
        });

        // --- ÂÆöÊï∞„ÉªÂ§âÊï∞ ---
        const ITEMS = ["üõº","üèçÔ∏è","üö≤","üöÄ","üöÅ","üö©","üóº","üåà","ü§ñ","üëì","üíç","üß∏","üéª","üçú","üçπ","‚òÉÔ∏è"];
        const CHARACTERS = ["üê±","üòÑ","üòé","üê∂","üê∞","üêº","üêª‚Äç‚ùÑÔ∏è","üê£","ü¶Å","üêØ","üêÆ","üê∏","üî¥","üü¢","üîµ","üü†"];

        const GOAL_POS = 100;
        const TILES_PER_ROW = 10;
        const TILES_PER_PAGE = 20; 

        let gameState = "title"; 
        let currentPos = 0;
        let points = 0;
        let gems = 0;
        let timeLeft = 10;
        let difficulty = "normal";
        let hand = [];
        let mapData = []; 
        let cameraOffset = 0;
        let collectedItems = [];
        let playerChar = "üê±";
        let selectedLevel = "normal";

        let scrollAnim = { active: false, progress: 0, startOff: 0, targetOff: 0 };
        let messageQueue = [];
        let isDisplayingMessage = false;

        // „É©„É≥„Ç≠„É≥„Ç∞ÁÆ°ÁêÜÁî®
        let currentRankingMode = 'local'; // 'local' or 'online'

        const canvas = document.getElementById("game-canvas");
        const ctx = canvas.getContext("2d");
        const handContainer = document.getElementById("hand-cards-container");
        const msgText = document.getElementById("central-message-text");
        
        const ui = {
            time: document.getElementById("top-timer-value"),
            point: document.getElementById("point-val"),
            gem: document.getElementById("gem-val"),
            level: document.getElementById("level-val"),
            count: document.getElementById("collected-count"),
            grid: document.getElementById("collection-grid"),
            btns: {
                change: document.getElementById("btn-change"),
                move1: document.getElementById("btn-move1"),
                time5: document.getElementById("btn-time5")
            }
        };

        // --- ÂàùÊúüÂåñ ---
        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            if(gameState !== 'title' && gameState !== 'char_select' && gameState !== 'ranking') drawGame();
        }
        window.addEventListener("resize", resizeCanvas);
        window.onload = () => { 
            resizeCanvas(); 
            initCollectionGrid(); 
            initCharGrid(); 
            loadClearCounts(); 
        };

        function initCollectionGrid() {
            ui.grid.innerHTML = "";
            ITEMS.forEach((icon, idx) => {
                const div = document.createElement("div");
                div.className = "collection-item";
                div.id = `col-item-${idx}`;
                div.textContent = icon;
                ui.grid.appendChild(div);
            });
        }

        function initCharGrid() {
            const grid = document.getElementById("char-grid");
            CHARACTERS.forEach(char => {
                const btn = document.createElement("div");
                btn.className = "char-btn";
                btn.textContent = char;
                btn.onclick = () => startGameWithChar(char);
                grid.appendChild(btn);
            });
        }

        // --- „ÇØ„É™„Ç¢ÂõûÊï∞ ---
        function loadClearCounts() {
            const data = JSON.parse(localStorage.getItem('mathSugorokuClears')) || { easy: 0, normal: 0, hard: 0 };
            document.getElementById('clear-easy').innerText = data.easy;
            document.getElementById('clear-normal').innerText = data.normal;
            document.getElementById('clear-hard').innerText = data.hard;
        }

        function saveClearCount(level) {
            const data = JSON.parse(localStorage.getItem('mathSugorokuClears')) || { easy: 0, normal: 0, hard: 0 };
            if(data[level] !== undefined) {
                data[level]++;
                localStorage.setItem('mathSugorokuClears', JSON.stringify(data));
            }
        }

        // --- „Ç≤„Éº„É†„Éï„É≠„Éº ---
        function selectLevel(level) {
            selectedLevel = level;
            document.getElementById("title-screen").classList.add("hidden");
            document.getElementById("char-screen").classList.remove("hidden");
            gameState = "char_select";
        }

        function backToTitle() {
            document.getElementById("char-screen").classList.add("hidden");
            document.getElementById("title-screen").classList.remove("hidden");
            gameState = "title";
        }

        function pickRandomChar() {
            const r = Math.floor(Math.random() * CHARACTERS.length);
            startGameWithChar(CHARACTERS[r]);
        }

        function startGameWithChar(char) {
            playerChar = char;
            document.getElementById("char-screen").classList.add("hidden");
            startGame(selectedLevel);
        }

        function startGame(level) {
            difficulty = level;
            timeLeft = (level === 'easy' ? 20 : level === 'normal' ? 15 : 10);
            ui.level.innerText = (level === 'easy' ? "„Åó„Çá„Åç„ÇÖ„ÅÜ" : level === 'normal' ? "„Å°„ÇÖ„ÅÜ„Åç„ÇÖ„ÅÜ" : "„Åò„Çá„ÅÜ„Åç„ÇÖ„ÅÜ");

            currentPos = 0;
            points = 0;
            gems = 0;
            cameraOffset = 0;
            hand = [];
            collectedItems = [];
            messageQueue = [];
            isDisplayingMessage = false;
            scrollAnim.active = false;
            
            ITEMS.forEach((_, i) => document.getElementById(`col-item-${i}`).className = "collection-item");
            msgText.classList.remove("visible");

            generateMap();
            fillHandInitial();
            
            gameState = "playing";
            updateUI();
            drawGame();
        }

        // --- „Ç≤„Éº„É†„É≠„Ç∏„ÉÉ„ÇØ ---
        function generateMap() {
            mapData = new Array(GOAL_POS + 1).fill(0);
            let available = [];
            for(let i=11; i<GOAL_POS; i++) available.push(i);
            
            for (let i = available.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [available[i], available[j]] = [available[j], available[i]];
            }

            for(let k=0; k<16; k++) {
                if(k < available.length) mapData[available[k]] = 100 + k;
            }

            let probs = (difficulty === 'easy') ? [0.3, 0.55, 0.75, 0.85, 0.90, 1.0] 
                      : (difficulty === 'hard') ? [0.25, 0.35, 0.45, 0.60, 0.85, 1.0] 
                      : [0.30, 0.45, 0.60, 0.75, 0.85, 1.0];

            for(let i=1; i<GOAL_POS; i++) {
                if(mapData[i] >= 100) continue; 
                let r = Math.random();
                if(r < probs[0]) mapData[i] = 0; 
                else if(r < probs[1]) mapData[i] = 1; 
                else if(r < probs[2]) mapData[i] = 2; 
                else if(r < probs[3]) mapData[i] = 3; 
                else if(r < probs[4]) mapData[i] = 4; 
                else mapData[i] = 5; 
            }
        }

        function getRandomCard() { return Math.floor(Math.random() * 9) + 1; }

        function fillHandInitial() {
            hand = [];
            for(let i=0; i<5; i++) hand.push(getRandomCard());
            renderHand();
        }

        function updateUI() {
            ui.time.innerText = timeLeft;
            ui.point.innerText = points;
            ui.gem.innerText = gems;
            ui.count.innerText = collectedItems.length;

            const active = (gameState === "playing" && timeLeft > 0 && gems > 0 && !isDisplayingMessage && !scrollAnim.active);
            ui.btns.change.disabled = !active;
            ui.btns.move1.disabled = !active;
            ui.btns.time5.disabled = !active;
        }

        // --- ÊèèÁîª (Â§âÊõ¥„Å™„Åó) ---
        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            const marginX = 20;
            const tileW = (canvas.width - marginX * 2) / TILES_PER_ROW;
            const tileH = tileW * 1.3; 
            const marginY = 15; 
            const totalBoardH = tileH * 2 + marginY;
            let startY = (canvas.height - totalBoardH) / 2 + 20;
            const minStartY = tileH + marginY + 20;
            if(startY < minStartY) startY = minStartY;

            const zoneColors = ["#e3f2fd", "#e8f5e9", "#fff3e0", "#fce4ec", "#f3e5f5"];

            let yShift = 0;
            let drawOffset = cameraOffset;
            let drawCount = TILES_PER_PAGE;
            if (scrollAnim.active) {
                yShift = -scrollAnim.progress * (tileH + marginY);
                drawOffset = scrollAnim.startOff;
                drawCount = 30; 
            }
            ctx.translate(0, yShift);

            if (drawOffset === 0) {
                let zRow = -1; let zCol = 0;
                let zx = marginX + zCol * tileW;
                let zy = startY + zRow * (tileH + marginY);
                ctx.fillStyle = "#ffcc80"; 
                drawRoundedRect(ctx, zx + 5, zy + 5, tileW - 10, tileH - 10, 8);
                ctx.fill();
                ctx.strokeStyle = "#fff"; ctx.stroke();
                ctx.fillStyle = "#e65100";
                ctx.font = "bold 14px Arial"; ctx.textAlign = "center"; ctx.textBaseline="bottom";
                ctx.fillText("START", zx + tileW/2, zy + tileH - 8);
                if (currentPos === 0) drawPlayer(zx + tileW/2, zy + tileH/2, tileW);
            }

            for (let i = 0; i < drawCount; i++) {
                let tileNum = drawOffset + i + 1;
                if (tileNum > GOAL_POS + 1) continue;
                let row = Math.floor(i / 10);
                let col = i % 10;
                let x = marginX + col * tileW;
                let y = startY + row * (tileH + marginY);
                let type = mapData[tileNum];
                let zoneIndex = Math.floor((tileNum - 1) / 10) % zoneColors.length;
                ctx.fillStyle = (tileNum === GOAL_POS) ? "#fff9c4" : zoneColors[zoneIndex];
                drawRoundedRect(ctx, x + 2, y + 2, tileW - 4, tileH - 4, 8);
                ctx.fill();
                ctx.strokeStyle = "#95a5a6"; ctx.lineWidth = 1; ctx.stroke();
                let isPassed = (tileNum <= currentPos);
                if (isPassed && tileNum <= GOAL_POS) {
                    ctx.fillStyle = "rgba(100, 181, 246, 0.4)";
                    drawRoundedRect(ctx, x + 2, y + 2, tileW - 4, tileH - 4, 8);
                    ctx.fill();
                }
                if (!isPassed && tileNum <= GOAL_POS) {
                    if (type >= 100) {
                        const borderX = x + 6; const borderY = y + 6;
                        const borderW = tileW - 12; const borderH = tileH - 12;
                        ctx.fillStyle = "#fff8e1"; ctx.fillRect(borderX, borderY, borderW, borderH);
                        ctx.strokeStyle = "#e67e22"; ctx.lineWidth = 3; ctx.strokeRect(borderX, borderY, borderW, borderH);
                        ctx.lineWidth = 1;
                        let icon = ITEMS[type - 100];
                        ctx.fillStyle = "#333";
                        ctx.font = `${tileW * 0.5}px Arial`;
                        ctx.textAlign = "center"; ctx.textBaseline = "middle";
                        ctx.fillText(icon, x + tileW/2, y + tileH * 0.4);
                    } else {
                        let icon = "";
                        switch(type) {
                            case 1: icon = "‚è∞"; break;
                            case 2: icon = "üéÅ"; break;
                            case 3: icon = "‚ùì"; break;
                            case 4: icon = "üëª"; break;
                            case 5: icon = "üíé"; break;
                        }
                        if (icon) {
                            ctx.fillStyle = "#333";
                            ctx.font = `${tileW * 0.5}px Arial`;
                            ctx.textAlign = "center"; ctx.textBaseline = "middle";
                            ctx.fillText(icon, x + tileW/2, y + tileH * 0.35);
                        }
                    }
                }
                if (tileNum <= GOAL_POS) {
                    ctx.fillStyle = "#546e7a";
                    let isKiri = (tileNum % 10 === 0);
                    let fontSize = isKiri ? tileW * 0.55 : tileW * 0.5; 
                    let fontWeigth = isKiri ? "900" : "bold"; 
                    ctx.font = `${fontWeigth} ${fontSize}px Arial`;
                    ctx.textAlign = "center"; ctx.textBaseline = "middle";
                    ctx.fillText(tileNum, x + tileW/2, y + tileH * 0.75);
                }
                if (tileNum === currentPos) {
                    drawPlayer(x + tileW/2, y + tileH * 0.35, tileW);
                }
            }
            ctx.restore();
        }

        function drawPlayer(x, y, tileSize) {
            const offsetY = y - (tileSize * 0.15); 
            ctx.font = `${tileSize * 0.65}px Arial`;
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillStyle = "rgba(0,0,0,0.3)";
            ctx.fillText(playerChar, x + 2, offsetY + 2); 
            ctx.fillStyle = "#fff"; 
            ctx.fillText(playerChar, x, offsetY);
        }

        function drawRoundedRect(ctx, x, y, w, h, r) {
            ctx.beginPath();
            ctx.moveTo(x+r, y); ctx.lineTo(x+w-r, y);
            ctx.quadraticCurveTo(x+w, y, x+w, y+r); ctx.lineTo(x+w, y+h-r);
            ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h); ctx.lineTo(x+r, y+h);
            ctx.quadraticCurveTo(x, y+h, x, y+h-r); ctx.lineTo(x, y+r);
            ctx.quadraticCurveTo(x, y, x+r, y); ctx.closePath();
        }

        // --- „É°„ÉÉ„Çª„Éº„Ç∏„Ç∑„Çπ„ÉÜ„É† ---
        function enqueueMessage(text) {
            messageQueue.push(text);
            processMessageQueue();
        }

        function processMessageQueue() {
            if (isDisplayingMessage || messageQueue.length === 0) {
                if (messageQueue.length === 0 && !isDisplayingMessage && gameState !== "title" && gameState !== "char_select" && gameState !== "ranking" && !scrollAnim.active) {
                    onTurnMessagesFinished();
                }
                return;
            }
            isDisplayingMessage = true;
            updateUI(); 
            const text = messageQueue.shift();
            msgText.innerText = text;
            msgText.classList.add("visible");
            setTimeout(() => {
                if (gameState !== 'goal_waiting') {
                    msgText.classList.remove("visible");
                    setTimeout(() => {
                        isDisplayingMessage = false;
                        processMessageQueue();
                    }, 200); 
                }
            }, 1000); 
        }

        function onTurnMessagesFinished() {
            if(gameState === "playing") {
                checkSlide();
                if(!scrollAnim.active && timeLeft <= 0) gameOver();
                updateUI(); 
            }
        }

        // --- „Ç¢„ÇØ„Ç∑„Éß„É≥ ---
        function playCard(index) {
            if (gameState !== "playing" || timeLeft <= 0 || isDisplayingMessage || scrollAnim.active) return;
            let moveVal = hand[index];
            timeLeft--;
            const equation = `<span style="color:#7f8c8d">${currentPos}</span> + <span style="color:#e74c3c">${moveVal}</span> = ${(currentPos + moveVal)}`;
            const hm = document.getElementById('hand-message');
            hm.style.fontSize = "42px"; hm.style.minWidth = "150px"; hm.innerHTML = equation;
            hand[index] = getRandomCard();
            renderHand();
            if (timeLeft < 0) { timeLeft = 0; gameOver(); return; }
            animateMove(currentPos, currentPos + moveVal, moveVal);
        }

        function useAbility(type) {
            if (gameState !== "playing" || gems <= 0 || isDisplayingMessage || scrollAnim.active) return;
            if (type === 'change') {
                gems--; hand = []; for(let i=0; i<5; i++) hand.push(getRandomCard());
                renderHand(); enqueueMessage("üíé „Å¶„Åµ„Å†„ÉÅ„Çß„É≥„Ç∏ÔºÅ"); updateUI();
            } else if (type === 'time5') {
                gems--; timeLeft += 5; enqueueMessage("üíé „Åò„Åã„Çì Ôºã5ÔºÅ"); updateUI();
            } else if (type === 'move1') {
                gems--; updateUI(); animateMove(currentPos, currentPos + 1, 1);
            }
        }

        function animateMove(start, end, steps) {
            gameState = "animation";
            let current = start;
            let count = 0;
            const timer = setInterval(() => {
                current++; count++; currentPos = current;
                if (current % 10 === 0 && current < end && current <= 90) {
                    points += 100; enqueueMessage(`${current}ÈÄöÈÅé! +100pt`);
                }
                drawGame();
                if (current >= GOAL_POS) {
                    clearInterval(timer);
                    currentPos = GOAL_POS;
                    if (end > GOAL_POS) { points += 500; enqueueMessage("„Ç¥„Éº„É´ÈÄöÈÅé! +500pt"); } 
                    else { points += 1000; }
                    msgText.innerText = "„Ç¥„Éº„É´ÔºÅ";
                    msgText.classList.add("visible");
                    gameState = "goal_waiting";
                    const clickHandler = () => {
                        document.removeEventListener('click', clickHandler);
                        document.removeEventListener('touchstart', clickHandler);
                        finishGame(true, (end === GOAL_POS));
                    };
                    setTimeout(() => {
                        document.addEventListener('click', clickHandler);
                        document.addEventListener('touchstart', clickHandler);
                    }, 500);
                    return;
                }
                if (count >= steps) {
                    clearInterval(timer);
                    if (current % 10 === 0 && current <= 90) {
                        points += 200; enqueueMessage(`„Å¥„Å£„Åü„Çä! +200pt`);
                    }
                    gameState = "playing";
                    handleEvent(current);
                }
            }, 200);
        }

        function handleEvent(pos) {
            let type = mapData[pos];
            if (type >= 100) {
                let itemIdx = type - 100;
                if (!collectedItems.includes(itemIdx)) {
                    collectedItems.push(itemIdx);
                    document.getElementById(`col-item-${itemIdx}`).classList.add("collected");
                    enqueueMessage(`${ITEMS[itemIdx]} „Ç≤„ÉÉ„ÉàÔºÅ`);
                } else { enqueueMessage("„Åô„Åß„Å´„ÇÇ„Å£„Å¶„ÅÑ„ÇãÔºÅ"); }
            } else {
                switch(type) {
                    case 1: 
                        let t = Math.floor(Math.random()*2)+1; timeLeft += t; enqueueMessage(`„Åò„Åã„Çì Ôºã${t}`); break;
                    case 2:
                        let p = (Math.floor(Math.random()*3)+1)*50; points += p; enqueueMessage(`„Éù„Ç§„É≥„Éà Ôºã${p}`); break;
                    case 3: 
                        if(Math.random()<0.5) { points+=200; enqueueMessage("„É©„ÉÉ„Ç≠„Éº! +200pt"); } 
                        else { points = Math.max(0, points-100); enqueueMessage("„Ç¢„É≥„É©„ÉÉ„Ç≠„Éº... -100pt"); }
                        break;
                    case 4: 
                        if(Math.random()<0.5) { timeLeft=Math.max(0, timeLeft-2); enqueueMessage("üëª „Åò„Åã„Çì -2"); } 
                        else { points=Math.max(0, points-50); enqueueMessage("üëª „Éù„Ç§„É≥„Éà -50"); }
                        break;
                    case 5:
                        gems++; enqueueMessage("üíé „Åª„ÅÜ„Åõ„Åç„Ç≤„ÉÉ„ÉàÔºÅ"); break;
                    default:
                        processMessageQueue(); break;
                }
            }
        }

        function checkSlide() {
            if (currentPos > 0 && currentPos <= 90) {
                let row = Math.floor((currentPos - 1) / 10);
                let target = row * 10;
                if (target > cameraOffset) {
                    gameState = "sliding";
                    scrollAnim.active = true;
                    scrollAnim.startOff = cameraOffset;
                    scrollAnim.targetOff = target;
                    scrollAnim.progress = 0;
                    const slideTimer = setInterval(() => {
                        scrollAnim.progress += 0.05;
                        if (scrollAnim.progress >= 1.0) {
                            scrollAnim.progress = 0; scrollAnim.active = false;
                            cameraOffset = scrollAnim.targetOff;
                            clearInterval(slideTimer);
                            gameState = "playing";
                            if(timeLeft <= 0) gameOver();
                            updateUI(); 
                        }
                        drawGame();
                    }, 20);
                }
            }
        }

        function renderHand() {
            handContainer.innerHTML = "";
            hand.forEach((num, idx) => {
                let div = document.createElement("div");
                div.className = "card";
                div.innerText = num;
                div.onclick = () => playCard(idx);
                handContainer.appendChild(div);
            });
        }

        // --- „Çπ„Ç≥„Ç¢‰øùÂ≠ò„ÅÆÁµ±ÂêàÂá¶ÁêÜ ---
        function recordScore(score, level) {
            // 1. „É≠„Éº„Ç´„É´‰øùÂ≠ò (Â∏∏„Å´Ë°å„ÅÜ)
            saveLocalScore(score, level);

            // 2. „Ç™„É≥„É©„Ç§„É≥‰øùÂ≠ò („É≠„Ç∞„Ç§„É≥‰∏≠„ÅÆ„Åø)
            if (currentUser) {
                saveOnlineScore(score, level);
            }
        }

        function gameOver() {
            gameState = "result";
            document.getElementById("result-screen").classList.remove("hidden");
            document.getElementById("result-title").innerText = "„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº...";
            document.getElementById("result-title").style.color = "#7f8c8d";
            document.getElementById("res-base").innerText = points;
            document.getElementById("res-item").innerText = 0; document.getElementById("res-item-cnt").innerText = "";
            document.getElementById("res-time").innerText = 0; document.getElementById("res-time-cnt").innerText = "";
            document.getElementById("res-gem").innerText = 0; document.getElementById("res-gem-cnt").innerText = "";
            document.getElementById("res-final").innerText = points;
            
            recordScore(points, difficulty);
        }

        function finishGame(cleared, isPerfectGoal) {
            gameState = "result";
            msgText.classList.remove("visible"); 
            let count = collectedItems.length;
            let bonusItem = count * 300; 
            let bonusTime = timeLeft * 50;
            let bonusGem = gems * 300;
            let final = points + bonusItem + bonusTime + bonusGem;

            if (cleared) {
                saveClearCount(difficulty);
                recordScore(final, difficulty);
            }

            document.getElementById("result-screen").classList.remove("hidden");
            if (isPerfectGoal) {
                 document.getElementById("result-title").innerText = "„Å¥„Å£„Åü„Çä„Ç¥„Éº„É´ÔºÅ";
                 document.getElementById("result-title").style.color = "#e74c3c";
            } else {
                 document.getElementById("result-title").innerText = "„Ç¥„Éº„É´ÔºÅ";
                 document.getElementById("result-title").style.color = "#f39c12";
            }
            document.getElementById("res-base").innerText = points;
            document.getElementById("res-item").innerText = `+${bonusItem}`; document.getElementById("res-item-cnt").innerText = `(${count}ÂÄã)`;
            document.getElementById("res-time").innerText = `+${bonusTime}`; document.getElementById("res-time-cnt").innerText = `(${timeLeft}Áßí)`;
            document.getElementById("res-gem").innerText = `+${bonusGem}`; document.getElementById("res-gem-cnt").innerText = `(${gems}ÂÄã)`;
            document.getElementById("res-final").innerText = final;
        }

        // --- „É≠„Éº„Ç´„É´„É©„É≥„Ç≠„É≥„Ç∞ ---
        const LOCAL_RANKING_KEY = 'mathSugorokuRankingByLevel';

        function saveLocalScore(score, level) {
            let rankingData = JSON.parse(localStorage.getItem(LOCAL_RANKING_KEY)) || { easy: [], normal: [], hard: [] };
            if(Array.isArray(rankingData)) rankingData = { easy: [], normal: [], hard: [] }; 
            if (!rankingData[level]) rankingData[level] = [];

            // „É≠„Éº„Ç´„É´„ÅØÂêçÂâç„Çí„Äå„ÅÇ„Å™„Åü„ÄçÂõ∫ÂÆö
            rankingData[level].push({ score: score, name: "„ÅÇ„Å™„Åü", date: new Date().toLocaleDateString() });
            rankingData[level].sort((a, b) => b.score - a.score);
            rankingData[level] = rankingData[level].slice(0, 10); 
            
            localStorage.setItem(LOCAL_RANKING_KEY, JSON.stringify(rankingData));
        }

        function loadLocalRankingColumn(level, elementId) {
            const list = document.getElementById(elementId);
            list.innerHTML = "";
            let rankingData = JSON.parse(localStorage.getItem(LOCAL_RANKING_KEY)) || { easy: [], normal: [], hard: [] };
            if(Array.isArray(rankingData)) rankingData = { easy: [], normal: [], hard: [] };
            
            const data = rankingData[level] || [];
            renderRankingList(data, list);
        }

        // --- „Ç™„É≥„É©„Ç§„É≥„É©„É≥„Ç≠„É≥„Ç∞ (Firestore) ---
        async function saveOnlineScore(score, level) {
            try {
                await addDoc(collection(db, "scores"), {
                    uid: currentUser.uid,
                    name: currentUser.displayName || "Unknown",
                    score: score,
                    level: level,
                    date: new Date().toLocaleDateString(),
                    timestamp: new Date()
                });
                console.log("Score saved to Firestore");
            } catch (e) {
                console.error("Error adding score: ", e);
            }
        }

        async function loadOnlineRankingColumn(level, elementId) {
            const list = document.getElementById(elementId);
            list.innerHTML = "<li style='text-align:center; padding:10px;'>Ë™≠„ÅøËæº„Åø‰∏≠...</li>";
            
            try {
                const q = query(
                    collection(db, "scores"),
                    where("level", "==", level),
                    orderBy("score", "desc"),
                    limit(10)
                );
                const querySnapshot = await getDocs(q);
                const data = [];
                querySnapshot.forEach((doc) => {
                    data.push(doc.data());
                });
                renderRankingList(data, list);
            } catch (e) {
                console.error("Error fetching online scores: ", e);
                list.innerHTML = "<li style='text-align:center; color:#e74c3c; padding:10px;'>„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü<br><span style='font-size:10px'>Firestore„ÅÆË®≠ÂÆö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</span></li>";
            }
        }

        // --- „É©„É≥„Ç≠„É≥„Ç∞Ë°®Á§∫ÂÖ±ÈÄö ---
        function renderRankingList(data, listElement) {
            listElement.innerHTML = "";
            if (data.length === 0) {
                listElement.innerHTML = "<li style='text-align:center; color:#7f8c8d; margin-top:20px;'>Ë®òÈå≤„Å™„Åó</li>";
                return;
            }
            data.forEach((entry, idx) => {
                const li = document.createElement("li");
                li.className = "rank-item";
                
                let rankColor = "#fff";
                if(idx === 0) rankColor = "#f1c40f"; 
                else if(idx === 1) rankColor = "#bdc3c7";
                else if(idx === 2) rankColor = "#d35400";

                li.innerHTML = `
                    <span class="rank-num">${idx + 1}.</span>
                    <span class="rank-score" style="color:${rankColor}">${entry.score}</span>
                    <span class="rank-name">${entry.name}</span>
                    <span class="rank-date">${entry.date}</span>
                `;
                listElement.appendChild(li);
            });
        }
        
        // --- „É©„É≥„Ç≠„É≥„Ç∞Âàá„ÇäÊõø„Åà ---
        function switchRankingMode(mode) {
            currentRankingMode = mode;
            // „Çø„Éñ„ÅÆË¶ã„ÅüÁõÆÊõ¥Êñ∞
            document.getElementById("tab-local").classList.toggle("active", mode === 'local');
            document.getElementById("tab-online").classList.toggle("active", mode === 'online');

            // „Éá„Éº„ÇøË™≠„ÅøËæº„Åø
            if (mode === 'local') {
                loadLocalRankingColumn('easy', 'rank-list-easy');
                loadLocalRankingColumn('normal', 'rank-list-normal');
                loadLocalRankingColumn('hard', 'rank-list-hard');
            } else {
                loadOnlineRankingColumn('easy', 'rank-list-easy');
                loadOnlineRankingColumn('normal', 'rank-list-normal');
                loadOnlineRankingColumn('hard', 'rank-list-hard');
            }
        }

        function showFullRanking() {
            document.getElementById("title-screen").classList.add("hidden");
            document.getElementById("result-screen").classList.add("hidden");
            document.getElementById("ranking-screen").classList.remove("hidden");
            gameState = "ranking";
            
            // ÂàùÊúüË°®Á§∫„ÅØ„É≠„Éº„Ç´„É´
            switchRankingMode('local');
        }

        function closeRanking() {
            document.getElementById("ranking-screen").classList.add("hidden");
            if (timeLeft <= 0 || currentPos >= GOAL_POS) {
                document.getElementById("result-screen").classList.remove("hidden");
                gameState = "result";
            } else {
                document.getElementById("title-screen").classList.remove("hidden");
                gameState = "title";
            }
        }

        // --- Window„Å∏„ÅÆÂÖ¨Èñã (Module„Çπ„Ç≥„Éº„ÉóÂØæÂøú) ---
        window.selectLevel = selectLevel;
        window.backToTitle = backToTitle;
        window.pickRandomChar = pickRandomChar;
        window.startGameWithChar = startGameWithChar;
        window.startGame = startGame;
        window.playCard = playCard;
        window.useAbility = useAbility;
        window.showFullRanking = showFullRanking;
        window.closeRanking = closeRanking;
        window.handleGoogleLogin = handleGoogleLogin;
        window.switchRankingMode = switchRankingMode;

    </script>
</body>
</html>
