<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Braves - ã‹ã‘ã–ã‚“ï¼’</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --main-bg: #2c3e50;
            --panel-bg: #34495e;
            --text-color: #ecf0f1;
            --accent-color: #f1c40f;
            --danger-color: #e74c3c;
        }

        body {
            margin: 0; padding: 0; overflow: hidden;
            background-color: #1a1a1a; color: var(--text-color);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            touch-action: none; user-select: none;
            width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center;
        }

        /* --- ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ç”¨ã‚³ãƒ³ãƒ†ãƒŠ (16:9æ¯”ç‡ 1280x720 å›ºå®š) --- */
        #game-scaler {
            width: 1280px; height: 720px;
            position: relative;
            transform-origin: center center;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            background-color: var(--main-bg);
            display: flex;
            overflow: hidden;
            flex-shrink: 0; /* ã‚³ãƒ³ãƒ†ãƒŠè‡ªä½“ã®ç¸®å°ç¦æ­¢ */
        }

        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼ˆã‚µã‚¤ã‚ºå›ºå®šãƒ»ä¼¸ç¸®ç¦æ­¢ï¼‰ */
        .side-panel {
            width: 290px; 
            height: 720px;
            background-color: var(--panel-bg);
            padding: 20px; 
            display: flex; flex-direction: column;
            box-sizing: border-box; 
            z-index: 10;
            border-right: 1px solid #2c3e50; border-left: 1px solid #2c3e50;
            flex: 0 0 290px; /* ä¼¸é•·ãƒ»ç¸®å°ç¦æ­¢ã€ãƒ™ãƒ¼ã‚¹å¹…å›ºå®š */
        }
        
        #game-wrapper {
            width: 700px;
            height: 720px;
            position: relative;
            display: flex; justify-content: center; align-items: center;
            background: #f0f4f8; overflow: hidden;
            flex: 0 0 700px; /* ä¼¸é•·ãƒ»ç¸®å°ç¦æ­¢ã€ãƒ™ãƒ¼ã‚¹å¹…å›ºå®š */
        }

        canvas {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            background-color: #ffffff; border-radius: 8px;
            /* ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã¯JSã§åˆ¶å¾¡ */
        }

        /* å·¦ãƒ‘ãƒãƒ« */
        #left-panel h2 { margin-top: 0; border-bottom: 2px solid var(--accent-color); padding-bottom: 10px; font-size: 24px; }
        #left-panel ol { padding-left: 20px; line-height: 1.6; font-size: 15px; }
        #left-panel li { margin-bottom: 10px; }
        
        .btn-back {
            margin-top: auto; background-color: var(--danger-color); color: white;
            border: none; padding: 15px; border-radius: 8px; font-size: 18px; font-weight: bold;
            cursor: pointer; box-shadow: 0 4px 0 #c0392b; transition: transform 0.1s;
        }
        .btn-back:active { transform: translateY(4px); box-shadow: none; }

        /* å³ãƒ‘ãƒãƒ« */
        /* åˆæœŸçŠ¶æ…‹ã¯éè¡¨ç¤º(none)ã«ã—ã€ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚ã«JSã§flexã«å¤‰æ›´ã™ã‚‹ */
        #right-panel-content { display: none; flex-direction: column; height: 100%; width: 100%; }
        
        .info-block { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #7f8c8d; }
        .info-label { font-size: 14px; color: #bdc3c7; margin-bottom: 5px; }
        .info-value { font-size: 26px; font-weight: bold; color: var(--accent-color); }
        #item-list { flex: 1; overflow-y: auto; padding-right: 5px; }
        #item-list::-webkit-scrollbar { width: 6px; }
        #item-list::-webkit-scrollbar-thumb { background: #7f8c8d; border-radius: 3px; }

        .item-btn {
            display: block; width: 100%; padding: 10px; margin-bottom: 8px;
            border: none; border-radius: 8px; color: white; font-weight: bold; font-size: 14px;
            cursor: pointer; text-align: left; position: relative;
            box-shadow: 0 3px 0 rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        .item-btn:active { transform: translateY(3px); box-shadow: none; }
        .item-count {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 10px; font-size: 12px;
        }

        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤å…±é€š */
        .overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(240, 244, 248, 0.98); z-index: 20; color: #2c3e50;
            transition: opacity 0.3s;
        }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }
        
        /* ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ */
        .title-main { font-size: 54px; margin-bottom: 0px; margin-top: 0; color: #c0392b; text-shadow: 2px 2px 0px #bdc3c7; font-weight: 900; }
        .title-sub { font-size: 24px; color: #34495e; margin-bottom: 15px; margin-top: 5px; font-weight: bold; }
        .title-flavor { font-size: 16px; color: #555; margin-bottom: 20px; text-align: center; line-height: 1.4; }

        .btn {
            padding: 10px 20px; font-size: 18px; border: none; border-radius: 8px;
            cursor: pointer; margin: 5px; font-weight: bold; color: white; min-width: 180px;
            font-family: 'M PLUS Rounded 1c', sans-serif; transition: transform 0.1s;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-easy { background-color: #2ecc71; min-width: 130px; }
        .btn-normal { background-color: #3498db; min-width: 130px; } 
        .btn-hard { background-color: #e74c3c; min-width: 130px; }
        
        .btn-score { background-color: #f1c40f; color: #2c3e50; }
        .btn-red { background-color: #e74c3c; width: 220px; }
        .btn-gray { background-color: #7f8c8d; }
        .btn-blue { background-color: #3498db; }

        .difficulty-container { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center; }
        .difficulty-item { text-align: center; display: flex; flex-direction: column; align-items: center; }
        .crown { font-size: 28px; margin-bottom: -5px; height: 35px; }
        .clear-count { font-weight: bold; font-size: 13px; margin-top: 4px; color: #555; }

        .bottom-btns {
            display: flex; gap: 10px; margin-top: 10px;
        }

        /* -----------------------------------------------
           ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼åå¤‰æ›´æ©Ÿèƒ½
           ----------------------------------------------- */
        .player-select-btn {
            background-color: #8e44ad; color: white;
            padding: 8px 25px; border-radius: 40px;
            font-size: 20px; font-weight: bold;
            display: flex; align-items: center; gap: 10px;
            cursor: pointer; box-shadow: 0 5px 0 #6c3483;
            transition: transform 0.1s; margin-bottom: 20px;
            width: auto; min-width: 280px; justify-content: space-between;
        }
        .player-select-btn:active { transform: translateY(5px); box-shadow: none; }
        .player-icon { font-size: 24px; background: rgba(0,0,0,0.2); border-radius: 50%; width: 34px; height: 34px; display: flex; justify-content: center; align-items: center; }
        .change-label { font-size: 14px; opacity: 0.8; font-weight: normal; }

        /* ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */
        #player-modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }
        .player-modal {
            background: #34495e; padding: 30px; border-radius: 12px;
            width: 480px; text-align: center; color: white;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .player-modal h2 { margin-top: 0; color: #f1c40f; font-size: 28px; margin-bottom: 5px; }
        .player-modal-sub { font-size: 14px; color: #bdc3c7; margin-bottom: 25px; line-height: 1.4; }
        
        .player-input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .player-input {
            flex: 1; padding: 12px; border-radius: 6px; border: none; font-size: 18px;
            font-family: inherit; text-align: center;
        }
        .btn-add {
            background-color: #2ecc71; color: white; border: none; padding: 0 25px;
            border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 16px;
            box-shadow: 0 3px 0 #27ae60;
        }
        .btn-add:active { transform: translateY(3px); box-shadow: none; }
        
        .validation-msg {
            color: #e74c3c; font-size: 14px; height: 20px; margin-bottom: 15px; font-weight: bold;
        }

        .player-list { list-style: none; padding: 0; margin: 0 0 25px 0; max-height: 250px; overflow-y: auto; }
        .player-item {
            background: #2c3e50; padding: 10px 15px; margin-bottom: 8px;
            border-radius: 8px; display: flex; justify-content: space-between; align-items: center;
            border: 2px solid transparent; cursor: pointer; transition: 0.2s;
        }
        .player-item.selected { border: 2px solid #f1c40f; background: #3e5871; }
        .player-item-name { font-size: 20px; font-weight: bold; }
        .btn-delete-name {
            background: #e74c3c; color: white; border: none; border-radius: 50%;
            width: 30px; height: 30px; font-weight: bold; cursor: pointer; line-height: 1;
        }
        
        .btn-close-modal {
            background-color: #3498db; width: 140px; margin: 0 auto; display: block;
        }

        /* ãƒ­ã‚°ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        #login-area { margin-bottom: 5px; text-align: center; }
        #login-status-text { margin-bottom: 5px; font-size: 13px; color: #7f8c8d; }

        /* ãƒªã‚¶ãƒ«ãƒˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        #result-screen {
            background: rgba(0, 0, 0, 0.7); 
        }
        #result-popup {
            background: #34495e; padding: 30px; border-radius: 15px;
            width: 420px; border: 4px solid #7f8c8d;
            display: flex; flex-direction: column; gap: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        #result-popup-title {
            text-align: center; margin: 0 0 10px 0; font-size: 36px; font-weight: 900;
        }
        .result-row {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 18px; color: #ecf0f1;
        }
        .result-row span:last-child {
            font-weight: bold; font-size: 24px; color: #f1c40f;
        }
        .result-divider {
            border: 0; border-top: 2px solid #95a5a6; margin: 10px 0; width: 100%;
        }
        .total-row {
            font-size: 24px; font-weight: bold;
        }
        .total-row span:last-child {
            font-size: 36px; color: #f1c40f;
        }
        .btn-ok {
            background-color: #f1c40f; color: #2c3e50; font-size: 24px;
            padding: 12px; margin-top: 15px; width: 100%; border: none;
            border-radius: 8px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 0 #d35400; font-family: 'M PLUS Rounded 1c', sans-serif;
        }
        .btn-ok:active { transform: translateY(4px); box-shadow: none; }

        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ (å…¨ç”»é¢åŒ–) */
        #ranking-popup {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #34495e; color: #ecf0f1;
            padding: 40px; box-sizing: border-box;
            z-index: 100; display: flex; flex-direction: column;
            align-items: center;
        }
        .ranking-header { font-size: 36px; margin-bottom: 20px; color: var(--accent-color); font-weight: bold; }
        .ranking-tabs { display: flex; justify-content: center; gap: 20px; margin-bottom: 20px; }
        .tab-btn {
            background: #555; border: none; color: #ccc; font-size: 20px; border-radius: 30px;
            padding: 10px 30px; cursor: pointer; transition: 0.2s; font-weight: bold;
        }
        .tab-btn.active { background: var(--accent-color); color: #2c3e50; }
        
        .ranking-list-container { 
            display: flex; gap: 20px; flex: 1; width: 100%; max-width: 1000px;
            overflow: hidden; /* ã‚³ãƒ³ãƒ†ãƒŠè‡ªä½“ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªã„ */
        }
        .ranking-column { 
            flex: 1; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 15px; 
            display: flex; flex-direction: column; overflow: hidden;
        }
        .ranking-column h3 { text-align: center; margin: 0 0 15px 0; font-size: 22px; border-bottom: 1px solid #555; padding-bottom: 10px; }
        .ranking-scroll-area { overflow-y: auto; flex: 1; padding-right: 5px; }
        .ranking-scroll-area::-webkit-scrollbar { width: 8px; }
        .ranking-scroll-area::-webkit-scrollbar-thumb { background: #7f8c8d; border-radius: 4px; }
        
        .rank-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 16px; }
        .rank-item:last-child { border-bottom: none; }
        .rank-item span:first-child { max-width: 160px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .rank-item span:last-child { font-weight: bold; color: #f1c40f; }

        /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã€æ¼”å‡º */
        #item-confirm-popup {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; color: #2c3e50; padding: 25px; border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.4); z-index: 100; text-align: center;
            width: 320px; border: 5px solid #3498db;
        }
        #transition-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.6); z-index: 30; color: white;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #transition-overlay.active { opacity: 1; pointer-events: auto; cursor: pointer; }
        .transition-text { font-size: 64px; font-weight: 900; text-shadow: 0 0 20px var(--accent-color); margin-bottom: 20px; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-align: center; }
        .transition-sub { font-size: 24px; animation: blink 1.5s infinite; }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    </style>
</head>
<body>

<div id="game-scaler">

    <div id="left-panel" class="side-panel">
        <h2>ã‚ãã³ã‹ãŸ</h2>
        <ol>
            <li>ã—ã‚ã„ã‚«ãƒ¼ãƒ‰ã‚’ã°ã®ã‚«ãƒ¼ãƒ‰ã«ã‹ã•ã­ã‚‹ã¨ã‹ãšãŒã‹ã‘ã–ã‚“ã•ã‚Œã‚‹ã‚ˆ</li>
            <li>ã°ã®ã‚«ãƒ¼ãƒ‰ãŒ <b>101ã„ã˜ã‚‡ã†</b> ã«ãªã‚‹ã¨<br>ã¦ãã« ã“ã†ã’ã ã™ã‚‹ã‚ˆï¼</li>
            <li>ã“ã†ã’ãã™ã‚‹ã¨ <b>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</b> ãŒã¸ã‚‹ã‚ˆã€‚<br>0ã«ãªã‚‹ã¨ ã¾ã‘ã¡ã‚ƒã†ï¼</li>
            <li>ã¦ãã‚’ãŸãŠã™ã¨ ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¯ãƒªã‚¢ï¼<br>ãŒã‚ã‚“ã‚’ã‚¿ãƒƒãƒã—ã¦ ã¤ãã¸ã€‚</li>
            <li>ã‚¢ã‚¤ãƒ†ãƒ ã‚’ ã†ã¾ãã¤ã‹ã£ã¦<br>ã•ã„ã”ã®ãƒœã‚¹ã‚’ ãŸãŠãã†ï¼</li>
        </ol>
        <button id="btn-return-title" class="btn-back hidden" onclick="game.showTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã¸ ã‚‚ã©ã‚‹</button>
    </div>

    <div id="game-wrapper">
        <canvas id="gameCanvas"></canvas>

        <div id="title-screen" class="overlay">
            
            <h1 class="title-main">MATH BRAVES</h1>
            <div class="title-sub">- ã‹ã‘ã–ã‚“ï¼’ -</div>
            <div class="title-flavor">ã‘ã„ã•ã‚“ã® ã¡ã‹ã‚‰ã§<br>ã¾ã‚‚ã®ã‚’ ãŸãŠã›ï¼</div>

            <div class="player-select-btn" onclick="game.openPlayerModal()">
                <span class="player-icon">ğŸ‘¤</span>
                <span id="current-player-name">ãªãªã—ã•ã‚“</span>
                <span class="change-label">(ã¸ã‚“ã“ã†)</span>
            </div>
            
            <div class="difficulty-container">
                <div class="difficulty-item">
                    <div class="crown" id="crown-easy"></div>
                    <button class="btn btn-easy" onclick="game.initGame('easy')">ã—ã‚‡ãã‚…ã†</button>
                    <div class="clear-count" id="count-easy">0å›ã‚¯ãƒªã‚¢</div>
                </div>
                <div class="difficulty-item">
                    <div class="crown" id="crown-normal"></div>
                    <button class="btn btn-normal" onclick="game.initGame('normal')">ã¡ã‚…ã†ãã‚…ã†</button>
                    <div class="clear-count" id="count-normal">0å›ã‚¯ãƒªã‚¢</div>
                </div>
                <div class="difficulty-item">
                    <div class="crown" id="crown-hard"></div>
                    <button class="btn btn-hard" onclick="game.initGame('hard')">ã˜ã‚‡ã†ãã‚…ã†</button>
                    <div class="clear-count" id="count-hard">0å›ã‚¯ãƒªã‚¢</div>
                </div>
            </div>

            <div id="login-area">
                <div id="login-status-text">ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“</div>
                <button id="btn-login" class="btn btn-red" onclick="game.login()">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
                <button id="btn-logout" class="btn btn-red hidden" onclick="game.logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
            
            <div class="bottom-btns">
                <button class="btn btn-score" onclick="game.toggleRankingPopup(true)">ã‚¹ã‚³ã‚¢ã‚’ã¿ã‚‹</button>
                <button class="btn btn-gray" onclick="window.location.href='index.html'">INDEXã¸</button>
            </div>
        </div>

        <div id="player-modal-overlay" class="hidden">
            <div class="player-modal">
                <h2>ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã‚’ãˆã‚‰ã¶</h2>
                <div class="player-modal-sub">
                    ã²ã‚‰ãŒãª ã§ã«ã‚…ã†ã‚Šã‚‡ãã—ã¦ã­<br>
                    ã¿ã‚“ãªãŒè¦‹ã‚‹ãªã¾ãˆã§ã™<br>
                    ã¦ã„ã­ã„ãªã“ã¨ã°ã‚’ã¤ã‹ã£ã¦ã­
                </div>
                <div class="player-input-row">
                    <input type="text" id="new-player-input" class="player-input" placeholder="ãªã¾ãˆ (ã²ã‚‰ãŒãª 12ã‚‚ã˜)" maxlength="12">
                    <button class="btn-add" onclick="game.addPlayerName()">ã¤ã„ã‹</button>
                </div>
                <div id="validation-msg" class="validation-msg"></div>
                <ul id="player-list-ui" class="player-list">
                    </ul>
                <button class="btn btn-blue btn-close-modal" onclick="game.closePlayerModal()">ã¨ã˜ã‚‹</button>
            </div>
        </div>

        <div id="result-screen" class="overlay hidden">
            <div id="result-popup">
                <h2 id="result-popup-title">ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</h2>
                <div class="result-row">
                    <span>ãƒ¬ãƒ™ãƒ«</span>
                    <span id="res-level"></span>
                </div>
                <div class="result-row">
                    <span>ã”ã†ã‘ã„ã‚¹ã‚³ã‚¢</span>
                    <span id="res-base-score"></span>
                </div>
                <div class="result-row">
                    <span>ã®ã“ã‚Šã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœãƒ¼ãƒŠã‚¹</span>
                    <span id="res-bonus"></span>
                </div>
                <hr class="result-divider">
                <div class="result-row total-row">
                    <span>æœ€çµ‚ã‚¹ã‚³ã‚¢</span>
                    <span id="res-final-score"></span>
                </div>
                <button class="btn-ok" onclick="game.showTitle()">OK</button>
            </div>
        </div>

        <div id="transition-overlay">
            <div class="transition-text" id="transition-msg">ã‚¯ãƒªã‚¢ï¼</div>
            <div class="transition-sub">ã‚¿ãƒƒãƒã—ã¦ ã™ã™ã‚€</div>
        </div>

        <div id="ranking-popup" class="hidden">
            <div class="ranking-header">ãƒ™ã‚¹ãƒˆã‚¹ã‚³ã‚¢</div>
            <div class="ranking-tabs">
                <button class="tab-btn active" onclick="game.switchRankingTab('local')">ãƒ­ãƒ¼ã‚«ãƒ«</button>
                <button class="tab-btn" onclick="game.switchRankingTab('world')">ãƒ¯ãƒ¼ãƒ«ãƒ‰</button>
            </div>
            <div class="ranking-list-container">
                <div class="ranking-column">
                    <h3 style="color:#2ecc71;">ã—ã‚‡ãã‚…ã†</h3>
                    <div class="ranking-scroll-area" id="rank-list-easy"></div>
                </div>
                <div class="ranking-column">
                    <h3 style="color:#3498db;">ã¡ã‚…ã†ãã‚…ã†</h3>
                    <div class="ranking-scroll-area" id="rank-list-normal"></div>
                </div>
                <div class="ranking-column">
                    <h3 style="color:#e74c3c;">ã˜ã‚‡ã†ãã‚…ã†</h3>
                    <div class="ranking-scroll-area" id="rank-list-hard"></div>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-blue" style="width: 200px; height: 50px; font-size: 20px;" onclick="game.toggleRankingPopup(false)">ã¨ã˜ã‚‹</button>
            </div>
        </div>

        <div id="item-confirm-popup" class="hidden">
            <h3 id="popup-name" style="margin-top:0; color:#2980b9; font-size: 24px;">ã‚¢ã‚¤ãƒ†ãƒ å</h3>
            <p id="popup-desc" style="font-size:18px; margin:20px 0; line-height:1.5;">ã›ã¤ã‚ã„</p>
            <div style="display:flex; justify-content:space-around; gap: 10px;">
                <button class="btn btn-blue" style="min-width:100px; padding:10px;" onclick="game.confirmItemUse(true)">ã¤ã‹ã†</button>
                <button class="btn btn-gray" style="min-width:100px; padding:10px;" onclick="game.confirmItemUse(false)">ã‚„ã‚ã‚‹</button>
            </div>
        </div>
    </div>

    <div id="right-panel" class="side-panel">
        <div id="right-panel-content">
            <div class="info-block">
                <div class="info-label">ãƒ¬ãƒ™ãƒ«</div>
                <div class="info-value" id="level-display">ã¡ã‚…ã†ãã‚…ã†</div>
            </div>
            <div class="info-block">
                <div class="info-label">ROUND</div>
                <div class="info-value" id="round-display">1 / 6</div>
            </div>
            <div class="info-block">
                <div class="info-label">ã‚¹ã‚³ã‚¢</div>
                <div class="info-value" id="score-display">0</div>
            </div>
            <div class="info-block" style="flex: 1; display: flex; flex-direction: column; border-bottom: none; overflow: hidden;">
                <div class="info-label">ã‚¢ã‚¤ãƒ†ãƒ </div>
                <div id="item-list"></div>
            </div>
        </div>
    </div>

</div>

<script>
/**
 * Math Braves Multiplication 2
 */

// ==========================================
// Constants & Config
// ==========================================
const NG_WORDS_HIRAGANA = [
'ã—ã­', 'ã—ã¬', 'ã—ã«', 'ã“ã‚ã™', 'ã“ã‚ã›', 'ã•ã¤ãŒã„', 'ããŸã°ã‚Œ',
'ã˜ã•ã¤', 'ãã•ã¤', 'ã¤ã‚‹ã™', 'ã‚Œã‚“ãŸã‚“', 'ã—ã«ãŸã„',
'ã¦ã‚', 'ã¦ã‚ã‚Šã™ã¨', 'ã°ãã¯', 'ã°ãã ã‚“', 'ã»ã†ã‹',
'ã¯ã‚“ã–ã„', 'ã”ã†ã¨ã†', 'ã‚†ã†ã‹ã„', 'ã‹ã‚“ãã‚“', 'ãŠãã†',
'ã‚„ãã–', 'ã¼ã†ã‚Šã‚‡ã', 'ã¯ã‚“ãã‚Œ', 'ã¡ã‚“ã´ã‚‰', 'ã¾ãµãƒã‚',
'ãŸã„ã¾', 'ã¾ã‚„ã', 'ã‹ãã›ã„ã–ã„', 'ã—ã‚ƒã¶', 'ã©ã‚‰ã£ã', 'ã“ã‹ã„ã‚“',
'ã¸ã‚ã„ã‚“', 'ãˆãã™ãŸã—ãƒ¼', 'ã ã£ã½ã†', 'ãã‚ã›ã',
'ã„ã˜ã‚', 'ãã‚ƒããŸã„',
'ã°ã‹', 'ã‚ã»', 'ã¾ã¬ã‘', 'ãã¡ãŒã„', 'ãé•ã„',
'ã†ã–ã„', 'ã†ã–', 'ãã‚‚ã„', 'ãã‚‚', 'ãã—ã‚‡ã„', 'ããˆã‚',
'ããš', 'ã”ã¿', 'ã”ã¿ã‚€ã—', 'ã‹ã™', 'ã–ã“', 'ãœã¤',
'ã¶ã™', 'ã§ã¶', 'ã¯ã’', 'ã¡ã³', 'ã§ã£ã±', 'ã„ãªã‹ã‚‚ã®',
'ã†ã˜', 'ã¯ã„ã¼ã', 'ã¾ã‘ã„ã¬', 'ãŠã¤ã‚€', 'ã®ã†ãŸã‚Šã‚“',
'ã¦ã„ã®ã†', 'ã¡ã—ã‚‡ã†', 'ã—ã‚‡ã†ãŒã„', 'ãŒã„ã˜', 'ã‹ãŸã‚', 'ã³ã£ã“',
'ã‚ãã‚‰', 'ã¤ã‚“ã¼', 'ãŠã—', 'ã©ã˜ã‚“', 'ãˆãŸ', 'ã²ã«ã‚“',
'ãŸã²', 'ãŸã²ã­', 'ã†ã›ã‚', 'ã ã¾ã‚Œ',
'ã¡ã‚“ã¡ã‚“', 'ã¡ã‚“ã“', 'ã¡ã‚“ã½', 'ã¡ã‚“ã‹', 'ã¾ã‚‰', 'ã•ãŠ',
'ã¾ã‚“ã“', 'ã¾ã‚“ã—ã‚…ã†', 'ã¾ã‚“ã’', 'ã‚ã‚Œã‚', 'ãŠã¾ãŸ',
'ãã‚Š', 'ãã‚Šã¨ã‚Šã™', 'ã„ã‚“ã—ã‚“', 'ã„ã‚“ã‹ã', 'ã³ã‚‰ã³ã‚‰',
'ã“ã†ãŒã‚“', 'ãŸã¾ãã‚“', 'ãã‚“ãŸã¾', 'ãµãã‚Š',
'ãŠã£ã±ã„', 'ã¡ã¡', 'ã«ã‚…ã†ã‚Šã‚“', 'ã«ã‚…ã†ã¨ã†', 'ãã‚‡ã«ã‚…ã†', 'ã²ã‚“ã«ã‚…ã†',
'ã‘ã¤', 'ã‚ãªã‚‹', 'ã“ã†ã‚‚ã‚“', 'ã‘ã¤ã®ã‚ãª',
'ãˆã‚', 'ãˆã£ã¡', 'ã™ã‘ã¹', 'ã¸ã‚“ãŸã„', 'ã‚€ã£ã¤ã‚Š', 'ã—ã“',
'ã›ã£ãã™', 'ã›ã„ã“ã†', 'ã¾ãã‚ã„', 'ãã†ã«ã‚…ã†', 'ã¯ã‚ã‚‹',
'ãŠãªã«ãƒ¼', 'ã˜ã„', 'ã—ã“ã—ã“', 'ãµã‡ã‚‰', 'ã±ã„ãšã‚Š', 'ãã‚“ã«',
'ã„ã‚‰ã¾', 'ã—ã£ã—ã‚“', 'ãªã‹ã ã—', 'ã”ã£ãã‚“', 'ã¶ã£ã‹ã‘',
'ã—ãŠãµã', 'ãœã£ã¡ã‚‡ã†', 'ã„ã', 'ã„ã‹ã›ã‚', 'ã‚ãˆã',
'ã©ã†ã¦ã„', 'ã—ã‚‡ã˜ã‚‡', 'ã‚„ã‚Šã¾ã‚“', 'ã‚„ã‚Šã¡ã‚“', 'ã³ã£ã¡',
'ã›ãµã‚Œ', 'ã±ã“', 'ã±ã“ã±ã“', 'ã‚ã„ã›ã¤', 'ã‚ã‚Š', 'ã—ã‚‡ãŸ', 'ãºã©',
'ãã‚“ã—ã‚“', 'ã˜ã‚…ã†ã‹ã‚“', 'ã‚Šã‚‡ã†ã˜ã‚‡ã', 'ã‚‰ã‚“ã“ã†', 'ã™ã‹ã‚“ã¨',
'ã®ãƒ¼ã±ã‚“', 'ã±ã‚“ã¡ã‚‰',
'ã‚Œã„ã·', 'ã”ã†ã‹ã‚“', 'ã¡ã‹ã‚“', 'ã¨ã†ã•ã¤', 'ã®ãã', 'ã‚ã—ã‚…ã¤',
'ãµã†ãã', 'ããƒ¼ã·', 'ã¸ã‚‹ã™', 'ã§ã‚Šã¸ã‚‹', 'ã´ã‚“ã•ã‚', 'ã„ã‚ãã‚‰',
'ã‚ã ã‚‹ã¨', 'ãˆãƒ¼ã¶ã„', 'ãˆã¶ã„', 'ã½ã‚‹ã®', 'ã†ã‚‰ã³ã§ãŠ', 'ã‚€ã—ã‚…ã†ã›ã„',
'ãˆã‚“ã“ã†', 'ãˆã‚“ã˜ã‚‡', 'ã†ã‚Š', 'ã‹ã„ã—ã‚…ã‚“', 'ã°ã„ã—ã‚…ã‚“',
'ã±ã±ã‹ã¤', 'ã¾ã¾ã‹ã¤', 'ã†ã‚Šã›ã‚“',
'ã†ã‚“ã“', 'ã†ã‚“ã¡', 'ãã', 'ã’ã‚Š', 'ã¹ã‚“', 'ãµã‚“',
'ã—ã£ã“', 'ã—ã‚‡ã‚“ã¹ã‚“', 'ã«ã‚‡ã†', 'ã»ã†ã«ã‚‡ã†',
'ã¸', 'ãŠãªã‚‰', 'ã’ã‚', 'ãŸã‚“',
'ã†ã‚“ãˆã„', 'ã“ã†ã—ã', 'ã™ãŸã£ãµ', 'ã‹ã‚“ã‚Š', 'ã±ã¨ã‚ãƒ¼ã‚‹',
'ã˜ãˆã‚€', 'ã’ãƒ¼ã‚€ã¾ã™ãŸãƒ¼', 'ã¾ã™ãŸãƒ¼', 'ã‚ã©ã¿ã‚“', 'ã—ã™ã¦ã‚€',
'ã•ãƒ¼ã°ãƒ¼', 'ã‚ã‹ã°ã‚“', 'ã°ã‚“', 'ã¡ãƒ¼ã¨', 'ã¡ãƒ¼ãŸãƒ¼', 'ã°ã',
'ã‚‰ã„ã‚“', 'ã‹ã‹ãŠ', 'ã™ã‹ã„ã·', 'ã„ã‚“ã™ãŸ', 'ã¤ã„ã£ãŸãƒ¼', 'ã§ãƒã™ã“',
'ã§ã‚“ã‚', 'ã°ã‚“ã”ã†', 'ã‘ã„ãŸã„', 'ã‚ã©ã‚Œã™', 'ã‚ã‚ã©', 'ã˜ã‚…ã†ã—ã‚‡',
'ã‚ãŠ', 'ã‚ã„ãŸã„', 'ã¾ã¡ã‚ã‚ã›', 'ã»ã¦ã‚‹', 'ã‚‰ã¶ã»', 'ãŠãµã‹ã„',
'ã±ã™ã‚ãƒ¼ã©', 'ã±ã™', 'ã‚ã‹ã†ã‚“ã¨', 'ã“ã˜ã‚“ã˜ã‚‡ã†ã»ã†'
];

const firebaseConfig = {
    apiKey: "AIzaSyBCg5dCEM89UmYYhfGqVeRf_VrUlg8_o-4",
    authDomain: "math-braves.firebaseapp.com",
    projectId: "math-braves",
    storageBucket: "math-braves.firebasestorage.app",
    messagingSenderId: "217117619290",
    appId: "1:217117619290:web:d227feb603970d3948d463"
};

let db, auth;
try {
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    auth = firebase.auth();
} catch (e) { console.error("Firebase init failed:", e); }

// ==========================================
// ã‚²ãƒ¼ãƒ ã‚¯ãƒ©ã‚¹
// ==========================================
class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        
        // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å
        this.collectionName = "scores_multiplication2"; 
        
        // åŸºæœ¬è§£åƒåº¦ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ï¼‰
        this.baseWidth = 700;
        this.baseHeight = 720; // ã‚³ãƒ³ãƒ†ãƒŠé«˜ã•ã«åˆã‚ã›ã‚‹
        
        // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°è¨­å®š
        this.scaler = document.getElementById('game-scaler');
        this.designWidth = 1280;
        this.designHeight = 720;
        
        this.resize();
        window.addEventListener('resize', () => this.resize());

        this.attachInputHandlers();
        this.setupAuth();

        // çŠ¶æ…‹
        this.state = 'TITLE'; 
        this.difficulty = 'normal';
        this.round = 1;
        this.maxRound = 6;
        this.score = 0;
        this.actionCount = 0;
        this.rankingMode = 'local';
        this.user = null;

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç®¡ç†
        this.playerList = [];
        this.currentPlayerIndex = -1;
        this.loadPlayerSystem();

        // ã‚²ãƒ¼ãƒ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        this.handCards = [];
        this.fieldCard = null;
        this.enemy = null;
        this.draggedCard = null;
        this.dragOffset = {x:0, y:0};
        this.particles = [];
        this.floatTexts = [];
        
        // ã‚¢ã‚¤ãƒ†ãƒ 
        this.items = {
            'change': { name: 'ãƒã‚§ãƒ³ã‚¸', desc: 'ã¦ãµã  ã‚’ ã™ã¹ã¦ ã²ããªãŠã™', count: 0, color: '#f39c12' },
            'action_plus': { name: 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼‹ï¼‘', desc: 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒ ï¼‘ ã‹ã„ãµãã™ã‚‹', count: 0, color: '#2ecc71' },
            'x20': { name: 'Ã—ï¼’ï¼', desc: 'ã°ã®ã‚«ãƒ¼ãƒ‰ã‚’ ï¼’ï¼ã°ã„ ã™ã‚‹\n(101ã„ã˜ã‚‡ã†ã§ ã™ãã«ã“ã†ã’ã)', count: 0, color: '#9b59b6' },
            'damage_500': { name: 'ãƒ€ãƒ¡ãƒ¼ã‚¸500', desc: 'ã¦ãã« 500ãƒ€ãƒ¡ãƒ¼ã‚¸ã‚’ ã‚ãŸãˆã‚‹\n(ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯ ã¸ã‚‰ãªã„)', count: 0, color: '#e74c3c' },
            'all_plus_5': { name: 'ãœã‚“ã¶ï¼‹ï¼•', desc: 'ã¦ãµã ã® ã™ã†ã˜ãŒ ã™ã¹ã¦ ï¼‹ï¼• ã•ã‚Œã‚‹', count: 0, color: '#34495e' }
        };
        this.itemKeys = Object.keys(this.items);
        this.selectedItemKey = null;
        this.lastItemJSON = "";

        this.lastTime = 0;
        this.updateClearCounts();
    }

    // --- èªè¨¼é–¢é€£ ---
    setupAuth() {
        if (!auth) return;
        auth.onAuthStateChanged((user) => {
            this.user = user;
            const statusText = document.getElementById('login-status-text');
            const loginBtn = document.getElementById('btn-login');
            const logoutBtn = document.getElementById('btn-logout');

            if (user) {
                statusText.textContent = `ãƒ­ã‚°ã‚¤ãƒ³ä¸­: ${user.displayName || "åç„¡ã—"}`;
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
            } else {
                statusText.textContent = "ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã¾ã›ã‚“";
                loginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
            }
        });
    }

    login() {
        if (!auth) return;
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch((error) => {
            console.error("Login failed:", error);
            alert("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ");
        });
    }

    logout() {
        if (!auth) return;
        auth.signOut().catch((error) => console.error("Logout failed:", error));
    }

    // --- ãƒªã‚µã‚¤ã‚ºï¼ˆå…¨ä½“ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼‰ ---
    resize() {
        // ã‚­ãƒ£ãƒ³ãƒã‚¹è§£åƒåº¦è¨­å®š
        this.canvas.width = this.baseWidth;
        this.canvas.height = this.baseHeight;
        this.canvas.style.width = this.baseWidth + "px";
        this.canvas.style.height = this.baseHeight + "px";

        // å…¨ä½“ã‚¹ã‚±ãƒ¼ãƒ«è¨ˆç®—
        const scaleX = window.innerWidth / this.designWidth;
        const scaleY = window.innerHeight / this.designHeight;
        this.scaleRatio = Math.min(scaleX, scaleY); // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ç¶­æŒ

        this.scaler.style.transform = `scale(${this.scaleRatio})`;
    }

    // --- ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼åç®¡ç† (æ–°æ©Ÿèƒ½ç§»æ¤) ---
    loadPlayerSystem() {
        const savedList = localStorage.getItem('math_braves_player_list');
        const savedIndex = localStorage.getItem('math_braves_current_player_index');
        
        if (savedList) {
            this.playerList = JSON.parse(savedList);
            this.currentPlayerIndex = savedIndex ? parseInt(savedIndex) : -1;
        } else {
            this.playerList = [];
            this.currentPlayerIndex = -1;
        }
        this.updatePlayerButton();
    }

    savePlayerSystem() {
        localStorage.setItem('math_braves_player_list', JSON.stringify(this.playerList));
        localStorage.setItem('math_braves_current_player_index', this.currentPlayerIndex);
        this.updatePlayerButton();
    }

    updatePlayerButton() {
        const nameDisplay = document.getElementById('current-player-name');
        if (this.currentPlayerIndex >= 0 && this.currentPlayerIndex < this.playerList.length) {
            nameDisplay.textContent = this.playerList[this.currentPlayerIndex];
        } else {
            nameDisplay.textContent = "ãªãªã—ã•ã‚“";
        }
    }

    openPlayerModal() {
        document.getElementById('player-modal-overlay').classList.remove('hidden');
        document.getElementById('validation-msg').textContent = ""; // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
        document.getElementById('new-player-input').value = "";
        this.renderPlayerModalList();
    }

    closePlayerModal() {
        document.getElementById('player-modal-overlay').classList.add('hidden');
    }

    renderPlayerModalList() {
        const listEl = document.getElementById('player-list-ui');
        listEl.innerHTML = '';
        
        if (this.playerList.length === 0) {
            listEl.innerHTML = '<li style="text-align:center; color:#bdc3c7;">ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ãŒã„ã¾ã›ã‚“ã€‚<br>ã†ãˆã‹ã‚‰ ã¤ã„ã‹ ã—ã¦ã­ã€‚</li>';
        }

        this.playerList.forEach((name, index) => {
            const li = document.createElement('li');
            li.className = 'player-item';
            if (index === this.currentPlayerIndex) li.classList.add('selected');
            
            li.onclick = () => this.handleSelectPlayer(index);

            li.innerHTML = `
                <span class="player-item-name">${name}</span>
                <button class="btn-delete-name" onclick="event.stopPropagation(); game.handleDeletePlayer(${index})">Ã—</button>
            `;
            listEl.appendChild(li);
        });
    }

    addPlayerName() {
        const input = document.getElementById('new-player-input');
        const msgEl = document.getElementById('validation-msg');
        let name = input.value.trim();
        msgEl.textContent = "";

        if (!name) {
            msgEl.textContent = "ãŠãªã¾ãˆã‚’ ã‹ã„ã¦ã­";
            return;
        }
        // ã²ã‚‰ãŒãªãƒã‚§ãƒƒã‚¯
        if (!/^[ã-ã‚“ãƒ¼]+$/.test(name)) {
            msgEl.textContent = "ã²ã‚‰ãŒãª ã ã‘ã§ ã‹ã„ã¦ã­";
            return;
        }
        // NGãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
        for (const ng of NG_WORDS_HIRAGANA) {
            if (name.includes(ng)) {
                msgEl.textContent = "ã¤ã‹ãˆãªã„ ã“ã¨ã°ãŒ ã¯ã„ã£ã¦ã„ã¾ã™";
                return;
            }
        }
        // é‡è¤‡ãƒã‚§ãƒƒã‚¯
        if (this.playerList.includes(name)) {
            msgEl.textContent = "ãã®ãŠãªã¾ãˆã¯ ã™ã§ã«ã‚ã‚Šã¾ã™";
            return;
        }
        // äººæ•°åˆ¶é™
        if (this.playerList.length >= 5) {
            msgEl.textContent = 'ã¨ã†ã‚ã ã§ãã‚‹ã®ã¯ 5ã«ã‚“ ã¾ã§ã§ã™';
            return;
        }
        
        this.playerList.push(name);
        this.currentPlayerIndex = this.playerList.length - 1; // è¿½åŠ ã—ãŸäººã‚’è‡ªå‹•é¸æŠ
        input.value = '';
        this.savePlayerSystem();
        this.renderPlayerModalList();
    }

    handleSelectPlayer(index) {
        this.currentPlayerIndex = index;
        this.savePlayerSystem();
        this.renderPlayerModalList();
    }

    handleDeletePlayer(index) {
        if (!confirm('ã“ã®ãƒ—ãƒ¬ãƒ¼ãƒ¤ãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        
        this.playerList.splice(index, 1);
        
        // é¸æŠã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®èª¿æ•´
        if (this.currentPlayerIndex === index) {
            // å‰Šé™¤ã—ãŸã®ãŒé¸æŠä¸­ã®äººãªã‚‰ã€ãƒªã‚¹ãƒˆãŒç©ºãªã‚‰æœªé¸æŠã€ã‚ã‚Œã°å…ˆé ­ã¸
            this.currentPlayerIndex = this.playerList.length > 0 ? 0 : -1;
        } else if (this.currentPlayerIndex > index) {
            this.currentPlayerIndex--;
        }
        
        this.savePlayerSystem();
        this.renderPlayerModalList();
    }

    attachInputHandlers() {
        const getPos = (e) => {
            const rect = this.canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            return { 
                x: (clientX - rect.left) / this.scaleRatio, 
                y: (clientY - rect.top) / this.scaleRatio 
            };
        };

        const onStart = (e) => {
            if (this.state === 'ROUND_TRANSITION_WAIT') { this.nextRound(); return; }
            if (this.state === 'GAME_OVER_WAIT') { this.gameOver(); return; }
            if (this.state !== 'PLAYING') return;
            
            const pos = getPos(e);
            for (let i = this.handCards.length - 1; i >= 0; i--) {
                let card = this.handCards[i];
                if (pos.x >= card.x - card.width/2 && pos.x <= card.x + card.width/2 &&
                    pos.y >= card.y - card.height/2 && pos.y <= card.y + card.height/2) {
                    this.draggedCard = card;
                    card.isDragging = true;
                    this.dragOffset.x = pos.x - card.x;
                    this.dragOffset.y = pos.y - card.y;
                    this.handCards.splice(i, 1); this.handCards.push(card); 
                    break;
                }
            }
        };
        const onMove = (e) => {
            if (!this.draggedCard) return;
            const pos = getPos(e);
            this.draggedCard.x = pos.x - this.dragOffset.x;
            this.draggedCard.y = pos.y - this.dragOffset.y;
        };
        const onEnd = (e) => {
            if (!this.draggedCard) return;
            const card = this.draggedCard;
            const field = this.fieldCard;
            const dist = Math.sqrt(Math.pow(card.x - field.x, 2) + Math.pow(card.y - field.y, 2));
            if (dist < 80 && this.state === 'PLAYING') this.mergeCard(card);
            else card.isDragging = false;
            this.draggedCard = null;
        };

        this.canvas.addEventListener('mousedown', onStart);
        this.canvas.addEventListener('mousemove', onMove);
        this.canvas.addEventListener('mouseup', onEnd);
        this.canvas.addEventListener('touchstart', onStart, {passive: false});
        this.canvas.addEventListener('touchmove', onMove, {passive: false});
        this.canvas.addEventListener('touchend', onEnd, {passive: false});
        
        document.getElementById('transition-overlay').addEventListener('click', () => {
            if (this.state === 'ROUND_TRANSITION_WAIT') this.nextRound();
            else if (this.state === 'GAME_OVER_WAIT') this.gameOver();
        });
    }

    // --- ã‚²ãƒ¼ãƒ é€²è¡Œ ---
    initGame(diff) {
        this.difficulty = diff;
        this.score = 0;
        this.round = 1;
        this.itemKeys.forEach(k => this.items[k].count = 0);
        this.lastItemJSON = ""; 
        
        document.getElementById('title-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.add('hidden');
        document.getElementById('transition-overlay').classList.remove('active');
        document.getElementById('right-panel-content').style.display = 'flex';
        // ã€Œã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        document.getElementById('btn-return-title').classList.remove('hidden');
        
        this.startRound();
        this.state = 'PLAYING';
        this.loop();
    }

    startRound() {
        const n = this.round;
        let baseAction = n + 4;
        let hp = (n + 4) * (50 * n + (this.difficulty==='easy'?300 : this.difficulty==='normal'?350 : 400));
        
        this.actionCount = baseAction;
        this.enemy = { hp: hp, maxHp: hp, shake: 0 };
        this.handCards = [];
        for(let i=0; i<5; i++) this.addHandCard(i);
        this.setFieldCard();
        this.addFloatText(this.round === 6 ? 'FINAL ROUND' : `ROUND ${this.round}`, this.baseWidth/2, this.baseHeight/2, 60, '#2c3e50');
    }

    addHandCard(index) {
        const spacing = 110;
        const startX = (this.baseWidth - (5 * spacing)) / 2 + spacing/2;
        const cardY = 600; 
        this.handCards.push({
            value: [2,2,3,3,4,5,6,7,8,9][Math.floor(Math.random() * 10)], 
            x: startX + index * spacing, y: cardY,
            width: 90, height: 130,
            targetX: startX + index * spacing, targetY: cardY,
            isDragging: false, alpha: 1
        });
    }

    setFieldCard() {
        // Yåº§æ¨™ã‚’ä¿®æ­£ (æ‰‹æœ­ã¨æ•µã®é–“ã®é©åˆ‡ãªä½ç½®ã«)
        const fieldY = 420; 
        this.fieldCard = {
            value: Math.floor(Math.random() * 8) + 2,
            x: this.baseWidth / 2, y: fieldY,
            width: 120, height: 160, scale: 1.0, alpha: 1,
            targetY: fieldY, originalY: fieldY
        };
    }

    loop(timestamp) {
        const dt = timestamp - this.lastTime;
        this.lastTime = timestamp;
        this.update(dt);
        this.draw();
        this.updateUI(); 
        if (this.state !== 'TITLE') requestAnimationFrame(t => this.loop(t));
    }

    update(dt) {
        this.handCards.forEach(card => {
            if (!card.isDragging) {
                card.x += (card.targetX - card.x) * 0.2;
                card.y += (card.targetY - card.y) * 0.2;
            }
        });
        if (this.state === 'ATTACKING') {
            this.fieldCard.y -= 15;
            this.fieldCard.alpha -= 0.05;
            if (this.fieldCard.alpha <= 0) this.applyDamage(this.fieldCard.value);
        } else {
            if (this.fieldCard && this.fieldCard.scale > 1.0) this.fieldCard.scale -= 0.05;
        }
        this.particles.forEach(p => { p.x+=p.vx; p.y+=p.vy; p.life--; p.alpha-=0.02; });
        this.particles = this.particles.filter(p => p.life > 0);
        this.floatTexts.forEach(t => { t.y-=1; t.life--; });
        this.floatTexts = this.floatTexts.filter(t => t.life > 0);
        if (this.enemy && this.enemy.shake > 0) this.enemy.shake--;
    }

    updateUI() {
        const diffText = this.difficulty === 'easy' ? 'ã—ã‚‡ãã‚…ã†' : this.difficulty === 'normal' ? 'ã¡ã‚…ã†ãã‚…ã†' : 'ã˜ã‚‡ã†ãã‚…ã†';
        document.getElementById('level-display').textContent = diffText;
        document.getElementById('round-display').textContent = `${this.round} / ${this.maxRound}${this.round===6?' (FINAL)':''}`;
        document.getElementById('score-display').textContent = this.score;

        const currentJSON = JSON.stringify(this.items);
        if (this.lastItemJSON !== currentJSON) {
            this.lastItemJSON = currentJSON;
            const itemList = document.getElementById('item-list');
            itemList.innerHTML = '';
            this.itemKeys.forEach(key => {
                const item = this.items[key];
                if (item.count > 0) {
                    const btn = document.createElement('button');
                    btn.className = 'item-btn';
                    btn.style.backgroundColor = item.color;
                    btn.innerHTML = `${item.name}<span class="item-count">x${item.count}</span>`;
                    btn.onclick = () => this.openItemConfirm(key);
                    itemList.appendChild(btn);
                }
            });
        }
    }

    mergeCard(handCard) {
        this.fieldCard.value *= handCard.value;
        this.fieldCard.scale = 1.5;
        this.createParticles(this.fieldCard.x, this.fieldCard.y, 10, '#f1c40f');
        this.addFloatText(`Ã—${handCard.value}`, this.fieldCard.x, this.fieldCard.y - 80, 40, '#e74c3c');
        handCard.value = [2,2,3,3,4,5,6,7,8,9][Math.floor(Math.random() * 10)];
        handCard.isDragging = false;
        handCard.x = handCard.targetX; handCard.y = handCard.targetY;

        if (this.fieldCard.value > 100) this.triggerAttackAnim();
    }

    triggerAttackAnim() {
        this.state = 'ATTACKING'; 
        this.actionCount--;
    }

    applyDamage(damage) {
        if (!this.enemy) return;
        this.enemy.hp -= damage;
        this.enemy.shake = 20;
        this.score += damage;
        this.createParticles(this.baseWidth/2, 200, 30, '#e74c3c');
        this.addFloatText(`-${damage}`, this.baseWidth/2, 180, 70, '#ff0000');

        if (this.enemy.hp <= 0) {
            this.enemy.hp = 0;
            this.winRoundWait();
        } else if (this.actionCount <= 0) {
            this.waitGameOver();
        } else {
            this.setFieldCard();
            this.state = 'PLAYING';
        }
    }

    winRoundWait() {
        const msg = this.round === this.maxRound ? "ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢ï¼" : "ã‚¯ãƒªã‚¢ï¼";
        document.getElementById('transition-msg').textContent = msg;
        document.getElementById('transition-msg').style.color = 'white';
        document.getElementById('transition-overlay').classList.add('active');
        this.state = 'ROUND_TRANSITION_WAIT';
    }

    waitGameOver() {
        document.getElementById('transition-msg').textContent = "GAME OVER";
        document.getElementById('transition-msg').style.color = '#e74c3c';
        document.getElementById('transition-overlay').classList.add('active');
        this.state = 'GAME_OVER_WAIT';
    }

    nextRound() {
        document.getElementById('transition-overlay').classList.remove('active');
        if (this.round >= this.maxRound) {
            this.gameClear();
        } else {
            const itemKey = this.itemKeys[Math.floor(Math.random() * this.itemKeys.length)];
            this.items[itemKey].count++;
            this.addFloatText(`GET: ${this.items[itemKey].name}`, this.baseWidth/2, this.baseHeight/2, 40, '#f39c12');
            this.round++;
            this.startRound();
            this.state = 'PLAYING';
        }
    }

    gameOver() {
        document.getElementById('transition-overlay').classList.remove('active');
        this.state = 'RESULT';
        document.getElementById('result-popup-title').textContent = "ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼";
        document.getElementById('result-popup-title').style.color = "#e74c3c";
        this.saveScore(this.score);
        this.showResult();
    }

    gameClear() {
        this.state = 'RESULT';
        const bonus = this.actionCount * 1000;
        this.score += bonus;
        document.getElementById('result-popup-title').textContent = "å®Œå…¨ã‚¯ãƒªã‚¢ï¼";
        document.getElementById('result-popup-title').style.color = "#f1c40f";
        this.showResult(bonus);
        this.saveScore(this.score);
        this.updateLocalClearCount();
    }

    showResult(bonus = 0) {
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('right-panel-content').style.display = 'none';
        document.getElementById('btn-return-title').classList.add('hidden'); // çµæœç”»é¢ã§ã¯æˆ»ã‚‹ãƒœã‚¿ãƒ³ã¯å‡ºã•ãªã„

        // ã‚¹ã‚³ã‚¢è¨ˆç®—ãƒ»è¡¨ç¤ºæ›´æ–°
        const finalScore = this.score;
        const baseScore = finalScore - bonus;
        const diffText = this.difficulty === 'easy' ? 'ã—ã‚‡ãã‚…ã†' : this.difficulty === 'normal' ? 'ã¡ã‚…ã†ãã‚…ã†' : 'ã˜ã‚‡ã†ãã‚…ã†';

        document.getElementById('res-level').textContent = diffText;
        document.getElementById('res-base-score').textContent = `${baseScore}ç‚¹`;
        document.getElementById('res-bonus').textContent = `${bonus}ç‚¹`;
        document.getElementById('res-final-score').textContent = `${finalScore}ç‚¹`;
    }

    showTitle() {
        this.state = 'TITLE';
        document.getElementById('title-screen').classList.remove('hidden');
        document.getElementById('result-screen').classList.add('hidden');
        document.getElementById('right-panel-content').style.display = 'none';
        // ã€Œã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
        document.getElementById('btn-return-title').classList.add('hidden');
        this.updateClearCounts();
    }

    // --- ã‚¢ã‚¤ãƒ†ãƒ å‡¦ç† ---
    openItemConfirm(key) {
        if (this.state !== 'PLAYING') return;
        this.selectedItemKey = key;
        const item = this.items[key];
        document.getElementById('popup-name').textContent = item.name;
        document.getElementById('popup-desc').innerText = item.desc;
        document.getElementById('item-confirm-popup').classList.remove('hidden');
        this.state = 'ITEM_POPUP'; 
    }
    confirmItemUse(doUse) {
        document.getElementById('item-confirm-popup').classList.add('hidden');
        if (doUse && this.selectedItemKey) this.useItem(this.selectedItemKey);
        this.selectedItemKey = null;
        this.state = 'PLAYING'; 
    }
    useItem(key) {
        if (this.items[key].count <= 0) return;
        this.items[key].count--;
        this.lastItemJSON = ""; 
        const item = this.items[key];
        this.addFloatText(`USED: ${item.name}`, this.baseWidth/2, this.baseHeight/2 - 100, 40, item.color);
        switch(key) {
            case 'change': this.handCards.forEach(c => c.value = [2,2,3,3,4,5,6,7,8,9][Math.floor(Math.random() * 10)]); break;
            case 'action_plus': this.actionCount++; break;
            case 'x20':
                this.fieldCard.value *= 20;
                this.fieldCard.scale = 2.0;
                if (this.fieldCard.value > 100) setTimeout(() => this.triggerAttackAnim(), 600);
                break;
            case 'damage_500': if(this.enemy) this.applyDamage(500); break;
            case 'all_plus_5': this.handCards.forEach(c => c.value += 5); break;
        }
    }

    // --- æç”» ---
    draw() {
        this.ctx.clearRect(0, 0, this.baseWidth, this.baseHeight);
        
        // ã‚°ãƒªãƒƒãƒ‰
        this.ctx.strokeStyle = '#ecf0f1'; this.ctx.lineWidth = 2;
        for(let i=0; i<this.baseWidth; i+=60) { this.ctx.beginPath(); this.ctx.moveTo(i,0); this.ctx.lineTo(i,this.baseHeight); this.ctx.stroke(); }
        for(let i=0; i<this.baseHeight; i+=60) { this.ctx.beginPath(); this.ctx.moveTo(0,i); this.ctx.lineTo(this.baseWidth,i); this.ctx.stroke(); }

        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³æ•°
        this.ctx.fillStyle = '#2c3e50'; this.ctx.font = "bold 24px 'M PLUS Rounded 1c'"; this.ctx.textAlign = 'center';
        this.ctx.fillText("ã®ã“ã‚Šã‚¢ã‚¯ã‚·ãƒ§ãƒ³", this.baseWidth/2, 40);
        this.ctx.font = "900 64px 'M PLUS Rounded 1c'";
        this.ctx.lineWidth = 6; this.ctx.strokeStyle = '#c0392b'; 
        this.ctx.strokeText(this.actionCount, this.baseWidth/2, 100);
        this.ctx.fillStyle = '#e74c3c'; this.ctx.fillText(this.actionCount, this.baseWidth/2, 100);

        // æ•µ
        if (this.enemy && this.enemy.hp > 0) {
            const shakeX = (Math.random() - 0.5) * this.enemy.shake;
            this.drawEnemyIcon(this.baseWidth/2 + shakeX, 200, this.round);
            
            const barW = 300, barH = 24, barY = 280;
            const hpPct = Math.max(0, this.enemy.hp / this.enemy.maxHp);
            this.ctx.fillStyle = '#333';
            this.ctx.beginPath(); this.ctx.roundRect(this.baseWidth/2 - barW/2, barY, barW, barH, 12); this.ctx.fill();
            this.ctx.fillStyle = hpPct > 0.5 ? '#2ecc71' : hpPct > 0.2 ? '#f1c40f' : '#e74c3c';
            this.ctx.beginPath(); this.ctx.roundRect(this.baseWidth/2 - barW/2 + 2, barY + 2, (barW-4) * hpPct, barH - 4, 10); this.ctx.fill();
            this.ctx.fillStyle = '#2c3e50'; this.ctx.font = "bold 20px 'M PLUS Rounded 1c'";
            this.ctx.fillText(`${this.enemy.hp} / ${this.enemy.maxHp}`, this.baseWidth/2, barY + 50);
        }

        // ã‚«ãƒ¼ãƒ‰
        if (this.fieldCard && this.fieldCard.alpha > 0) this.drawCard(this.fieldCard, true);
        this.handCards.forEach(card => this.drawCard(card, false));

        // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« & ãƒ†ã‚­ã‚¹ãƒˆ
        this.particles.forEach(p => {
            this.ctx.globalAlpha = p.alpha; this.ctx.fillStyle = p.color;
            this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); this.ctx.fill();
        });
        this.ctx.globalAlpha = 1.0;
        this.floatTexts.forEach(t => {
            this.ctx.save();
            this.ctx.shadowColor = 'rgba(0,0,0,0.5)'; this.ctx.shadowBlur = 4;
            this.ctx.fillStyle = t.color; this.ctx.font = `bold ${t.size}px 'M PLUS Rounded 1c'`;
            this.ctx.textAlign = 'center'; this.ctx.lineWidth = 3;
            this.ctx.strokeText(t.text, t.x, t.y); this.ctx.fillText(t.text, t.x, t.y);
            this.ctx.restore();
        });
    }

    drawCard(card, isField) {
        this.ctx.save();
        this.ctx.translate(card.x, card.y);
        this.ctx.scale(card.scale, card.scale);
        this.ctx.globalAlpha = card.alpha;
        if (card.isDragging) { this.ctx.shadowColor='rgba(0,0,0,0.3)'; this.ctx.shadowBlur=20; this.ctx.scale(1.1,1.1); }

        this.ctx.fillStyle = isField ? '#ecf0f1' : '#ffffff';
        this.ctx.beginPath(); this.ctx.roundRect(-card.width/2, -card.height/2, card.width, card.height, 12); this.ctx.fill();
        this.ctx.lineWidth = isField ? 4 : 2; this.ctx.strokeStyle = isField ? '#e67e22' : '#bdc3c7'; this.ctx.stroke();

        this.ctx.fillStyle = '#2c3e50'; this.ctx.font = `bold ${isField?64:52}px 'M PLUS Rounded 1c'`;
        this.ctx.textAlign = 'center'; this.ctx.textBaseline = 'middle';
        this.ctx.fillText(card.value, 0, 0);
        
        if (isField && card.value >= 80 && card.value <= 100 && this.state === 'PLAYING') {
             this.ctx.fillStyle = '#e74c3c'; this.ctx.font = 'bold 16px sans-serif'; 
             this.ctx.fillText('ã‚ã¨ã™ã“ã—!', 0, card.height/2 + 20);
        }
        this.ctx.restore();
    }

    drawEnemyIcon(x, y, round) {
        this.ctx.save(); this.ctx.translate(x, y);
        const colors = ['#9b59b6', '#3498db', '#2ecc71', '#f1c40f', '#e67e22', '#34495e'];
        this.ctx.fillStyle = colors[(round-1)%6];
        this.ctx.beginPath();
        switch(round) {
            case 1: this.ctx.arc(0, -20, 60, Math.PI, 0); for(let i=0; i<=6; i++) this.ctx.lineTo(60 - i*20, (i%2===0)?40:60); break;
            case 2: this.ctx.roundRect(-50, -60, 100, 100, 10); break;
            case 3: this.ctx.moveTo(0, -70); this.ctx.bezierCurveTo(-60, -20, -70, 50, 0, 50); this.ctx.bezierCurveTo(70, 50, 60, -20, 0, -70); break;
            case 4: for(let i=0; i<8; i++) { const a = (Math.PI*2/8)*i; this.ctx.lineTo(Math.cos(a)*70, Math.sin(a)*70); this.ctx.lineTo(Math.cos(a+0.4)*40, Math.sin(a+0.4)*40); } break;
            case 5: this.ctx.arc(0, 0, 65, 0, Math.PI*2); break;
            case 6: this.ctx.moveTo(-40, -60); this.ctx.lineTo(-70, -110); this.ctx.lineTo(-20, -75); this.ctx.moveTo(40, -60); this.ctx.lineTo(70, -110); this.ctx.lineTo(20, -75); this.ctx.arc(0, 0, 75, 0, Math.PI*2); break;
        }
        this.ctx.closePath(); this.ctx.fill();
        this.ctx.fillStyle = 'white';
        if (round === 5) {
            this.ctx.beginPath(); this.ctx.arc(0, -10, 25, 0, Math.PI*2); this.ctx.fill();
            this.ctx.fillStyle = 'black'; this.ctx.beginPath(); this.ctx.arc(0, -10, 10, 0, Math.PI*2); this.ctx.fill();
        } else {
            this.ctx.beginPath(); this.ctx.arc(-20, -20, 15, 0, Math.PI*2); this.ctx.fill();
            this.ctx.beginPath(); this.ctx.arc(20, -20, 15, 0, Math.PI*2); this.ctx.fill();
            this.ctx.fillStyle = 'black'; this.ctx.beginPath(); this.ctx.arc(-20, -20, 6, 0, Math.PI*2); this.ctx.fill();
            this.ctx.beginPath(); this.ctx.arc(20, -20, 6, 0, Math.PI*2); this.ctx.fill();
        }
        this.ctx.restore();
    }

    // --- ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»ãƒ©ãƒ³ã‚­ãƒ³ã‚° ---
    updateLocalClearCount() {
        const key = `clearCount_${this.difficulty}_mul2`;
        localStorage.setItem(key, (parseInt(localStorage.getItem(key)||0)+1));
        this.updateClearCounts();
    }
    updateClearCounts() {
        ['easy', 'normal', 'hard'].forEach(d => {
            const c = localStorage.getItem(`clearCount_${d}_mul2`)||0;
            document.getElementById(`count-${d}`).textContent = `${c}å›ã‚¯ãƒªã‚¢`;
            document.getElementById(`crown-${d}`).textContent = c>=10?'ğŸ¥‡':c>=5?'ğŸ¥ˆ':c>=1?'ğŸ¥‰':'';
        });
    }
    async saveScore(score) {
        // åå‰ã‚’å–å¾—ï¼ˆãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠä¸­ãªã‚‰ãã‚Œã‚’ä½¿ã†ã€ãªã‘ã‚Œã°ã€Œãªãªã—ã•ã‚“ã€ï¼‰
        let nameToSave = "ãªãªã—ã•ã‚“";
        if (this.currentPlayerIndex >= 0 && this.currentPlayerIndex < this.playerList.length) {
            nameToSave = this.playerList[this.currentPlayerIndex];
        }

        // ãƒ­ãƒ¼ã‚«ãƒ«
        let ranks = JSON.parse(localStorage.getItem(`ranking_local_${this.collectionName}`) || "{}");
        if(!ranks[this.difficulty]) ranks[this.difficulty] = [];
        ranks[this.difficulty].push({name: nameToSave, score: score, date: new Date().toISOString()});
        ranks[this.difficulty].sort((a,b)=>b.score-a.score);
        ranks[this.difficulty] = ranks[this.difficulty].slice(0,10);
        localStorage.setItem(`ranking_local_${this.collectionName}`, JSON.stringify(ranks));
        
        // Firestore (ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ã¿)
        if(db && this.user) {
             try {
                 await db.collection(this.collectionName).add({
                     uid: this.user.uid,
                     displayName: this.user.displayName || nameToSave,
                     score: score, difficulty: this.difficulty,
                     timestamp: firebase.firestore.FieldValue.serverTimestamp()
                 });
             } catch(e) { console.error("Score save error:", e); }
        }
    }

    toggleRankingPopup(show) {
        document.getElementById('ranking-popup').classList.toggle('hidden', !show);
        if(show) this.loadRankingData();
    }
    switchRankingTab(mode) {
        this.rankingMode = mode;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.textContent.includes(mode==='local'?'ãƒ­ãƒ¼ã‚«ãƒ«':'ãƒ¯ãƒ¼ãƒ«ãƒ‰')));
        this.loadRankingData();
    }
    async loadRankingData() {
        ['easy', 'normal', 'hard'].forEach(diff => {
            const list = document.getElementById(`rank-list-${diff}`);
            list.innerHTML = '<div style="text-align:center; margin-top:10px;">ãƒ­ãƒ¼ãƒ‰ä¸­...</div>';
            this.getRanking(diff).then(data => {
                list.innerHTML = '';
                if(data.length===0) list.innerHTML = '<div style="text-align:center; padding:10px;">è¨˜éŒ²ãªã—</div>';
                data.forEach((r, i) => {
                    list.innerHTML += `<div class="rank-item"><span>${i+1}. ${r.name}</span><span>${r.score}</span></div>`;
                });
            });
        });
    }
    async getRanking(diff) {
        if(this.rankingMode === 'local') {
            const ranks = JSON.parse(localStorage.getItem(`ranking_local_${this.collectionName}`) || "{}");
            return ranks[diff] || [];
        } else {
            if(!db) return [{name:"ã‚ªãƒ•ãƒ©ã‚¤ãƒ³", score:0}];
            try {
                const q = await db.collection(this.collectionName)
                    .where('difficulty','==',diff)
                    .orderBy('score','desc')
                    .limit(10)
                    .get();
                return q.docs.map(d => ({name: d.data().displayName, score: d.data().score}));
            } catch(e) {
                console.error(e);
                return [{name:"å–å¾—ã‚¨ãƒ©ãƒ¼", score:0}];
            }
        }
    }

    createParticles(x, y, n, c) { for(let i=0;i<n;i++) this.particles.push({x,y,vx:(Math.random()-0.5)*10,vy:(Math.random()-0.5)*10,life:30,size:Math.random()*5+2,color:c,alpha:1}); }
    addFloatText(t, x, y, s, c) { this.floatTexts.push({text:t,x,y,size:s,color:c,life:60}); }
}

const game = new Game();
</script>
</body>
</html>
