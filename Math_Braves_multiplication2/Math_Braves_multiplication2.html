<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Braves - かけざん２</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* 明るいRPGカラー設定 */
            --main-bg-color: #87ceeb;
            --window-bg-top: #4facfe;
            --window-bg-bottom: #00f2fe;
            --text-color: #ffffff;
            --accent-color: #fff700;
            --danger-color: #ff5252;
            
            /* ボタンカラー */
            --btn-blue-top: #00c6ff; --btn-blue-bot: #0072ff;
            --btn-red-top: #ff512f; --btn-red-bot: #dd2476;
            --btn-green-top: #11998e; --btn-green-bot: #38ef7d;
            --btn-gold-top: #fce38a; --btn-gold-bot: #f38181;
        }

        body {
            margin: 0; padding: 0; overflow: hidden;
            background-color: #111;
            color: var(--text-color);
            font-family: 'M PLUS Rounded 1c', sans-serif;
            touch-action: none; user-select: none;
            width: 100vw; height: 100vh;
            display: flex; justify-content: center; align-items: center;
        }

        /* --- ゲーム画面コンテナ --- */
        #game-scaler {
            width: 1280px; height: 720px;
            position: relative;
            transform-origin: center center;
            background-color: var(--main-bg-color); 
            display: flex;
            overflow: hidden;
            flex-shrink: 0;
            border: 4px solid #fff;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
        }

        /* 共通ウィンドウデザイン */
        .rpg-window {
            background: linear-gradient(to bottom, var(--window-bg-top), var(--window-bg-bottom));
            border: 4px solid #fff;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3), inset 0 0 30px rgba(255,255,255,0.4);
            color: #fff;
        }

        /* レイアウト */
        .side-panel {
            width: 290px; 
            height: 720px;
            padding: 20px; 
            display: flex; flex-direction: column;
            box-sizing: border-box; 
            z-index: 10;
            flex: 0 0 290px;
            /* 落ち着いた紺色 */
            background: rgba(10, 20, 40, 0.9);
            border-right: 2px solid #555; 
            border-left: 2px solid #555;
        }
        
        /* 戦闘画面の中央エリア */
        #game-wrapper {
            width: 700px;
            height: 720px;
            position: relative;
            display: flex; justify-content: center; align-items: center;
            background-image: url('images/battle.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            overflow: hidden;
            flex: 0 0 700px;
            transition: background-image 0.5s;
        }

        canvas {
            border: 3px solid rgba(255,255,255,0.5);
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* 左パネル */
        #left-panel h2 { 
            margin-top: 0; border-bottom: 2px solid #aaa; 
            padding-bottom: 10px; font-size: 24px; color: #fff;
            text-shadow: none;
        }
        #left-panel ol { padding-left: 20px; line-height: 1.6; font-size: 15px; color: #ccc; text-shadow: none; font-weight: normal; }
        #left-panel li { margin-bottom: 10px; }
        
        .btn-back {
            margin-top: auto; 
            background: linear-gradient(to bottom, #7f8c8d, #2c3e50);
            color: #fff; border: 2px solid #aaa;
            padding: 15px; border-radius: 12px; font-size: 18px; font-weight: bold;
            cursor: pointer; transition: transform 0.1s;
            box-shadow: 0 4px 0 #111;
        }
        .btn-back:hover { filter: brightness(1.2); }
        .btn-back:active { transform: translateY(4px); box-shadow: none; }

        /* 右パネル */
        #right-panel-content { display: none; flex-direction: column; height: 100%; width: 100%; }
        
        .info-block { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #555; }
        .info-label { font-size: 14px; color: #aaa; margin-bottom: 5px; font-weight: normal; }
        .info-value { font-size: 26px; font-weight: bold; color: #fff; }
        #item-list { flex: 1; overflow-y: auto; padding-right: 5px; }
        
        #item-list::-webkit-scrollbar { width: 8px; }
        #item-list::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
        #item-list::-webkit-scrollbar-thumb { background: #777; border-radius: 4px; }

        .item-btn {
            display: block; width: 100%; padding: 10px; margin-bottom: 8px;
            border: 1px solid #777; border-radius: 8px; color: #fff; font-weight: bold; font-size: 14px;
            cursor: pointer; text-align: left; position: relative;
            background: rgba(255, 255, 255, 0.1);
            box-shadow: none; transition: transform 0.1s;
            text-shadow: 1px 1px 0 #000;
        }
        .item-btn:hover { background: rgba(255,255,255,0.2); transform: translateX(2px); }
        .item-count {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            background: #fff; color: #000; border: none; padding: 2px 8px; border-radius: 10px; font-size: 12px;
            box-shadow: none; font-weight: bold;
        }

        /* --- オーバーレイ（全画面） --- */
        #global-overlays {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 100;
        }
        .full-screen-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background-color: #000;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            pointer-events: auto; opacity: 0; transition: opacity 0.3s;
            z-index: 110;
        }
        .full-screen-overlay.active { opacity: 1; pointer-events: auto; }

        /* 背景画像クラス */
        .bg-title-img {
            background-image: url('images/title.png');
        }

        /* コンテンツを見やすくする白い半透明ボックス */
        .content-box-translucent {
            background: rgba(255, 255, 255, 0.85); 
            padding: 30px 50px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 4px solid #fff;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            max-width: 90%;
            max-height: 90%;
        }

        /* タイトル画面 */
        .title-main { 
            font-size: 80px; margin: 0; color: #fff; 
            text-shadow: 4px 4px 0 #0072ff, 0 0 20px #fff; 
            font-weight: 900; letter-spacing: 2px;
            background: linear-gradient(to bottom, #fff, #c2e9fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(4px 4px 0 rgba(0,0,0,0.2));
        }
        .title-sub { 
            font-size: 32px; color: #0072ff; margin: 10px 0 30px 0; font-weight: bold; 
            text-shadow: none; letter-spacing: 4px;
        }

        /* ポップなボタン共通 */
        .puz-btn {
            width: 360px; height: 65px; margin: 10px;
            font-size: 24px; font-weight: 900; font-family: 'M PLUS Rounded 1c', sans-serif;
            color: #fff; 
            border: 3px solid #fff; border-radius: 50px;
            cursor: pointer; position: relative;
            box-shadow: 0 5px 0 rgba(0,0,0,0.2);
            transition: all 0.1s;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
            display: flex; justify-content: center; align-items: center;
        }
        .puz-btn:active { transform: translateY(5px); box-shadow: none; }
        .puz-btn:hover { filter: brightness(1.1); transform: scale(1.02); }
        
        .btn-start { background: linear-gradient(to bottom, var(--btn-blue-top), var(--btn-blue-bot)); }
        .btn-score { background: linear-gradient(to bottom, var(--btn-green-top), var(--btn-green-bot)); }
        .btn-player { background: linear-gradient(to bottom, var(--btn-gold-top), var(--btn-gold-bot)); text-shadow: 1px 1px 0 rgba(0,0,0,0.2); }
        .btn-login { background: linear-gradient(to bottom, #a18cd1, #fbc2eb); }
        .btn-sub { background: linear-gradient(to bottom, #cfd9df, #e2ebf0); color: #555; text-shadow: none; }
        
        /* 難易度選択 */
        .btn-diff { width: 220px; height: 120px; margin: 10px; font-size: 28px; border-radius: 20px; } 
        .btn-easy { background: linear-gradient(to bottom, #42e695, #3bb2b8); }
        .btn-normal { background: linear-gradient(to bottom, #4facfe, #00f2fe); }
        .btn-hard { background: linear-gradient(to bottom, #ff9a9e, #fecfef); }

        .diff-container { 
            display: flex; flex-direction: row; 
            justify-content: center; align-items: flex-end; 
            gap: 30px; margin-top: 20px;
        }
        .diff-column {
            display: flex; flex-direction: column; align-items: center;
            width: 240px;
        }
        .crown-area {
            height: 60px;
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 5px;
        }
        .crown-icon { font-size: 50px; filter: drop-shadow(0 0 5px gold); }
        
        .clear-label { 
            color: #333; font-weight: 900; font-size: 20px; margin-top: 10px;
            background: #fff; border: 1px solid #ccc;
            padding: 5px 15px; border-radius: 20px;
        }

        /* プレーヤーモーダル (背景暗転なし) */
        #player-modal-overlay { background: rgba(0,0,0,0); z-index: 200; }
        .player-modal { width: 500px; padding: 10px; }
        .player-modal-inner { padding: 25px; text-align: center; }
        .player-modal h2 { margin-top: 0; color: #fff; text-shadow: 0 2px 4px rgba(0,0,0,0.3); border-bottom: 2px solid #fff; display: inline-block; padding-bottom: 5px; }
        .player-input {
            width: 70%; padding: 12px; border-radius: 30px; border: 2px solid #fff; 
            font-size: 18px; text-align: center; background: rgba(255,255,255,0.9); color: #333; font-weight: bold;
        }
        .btn-add {
            background: linear-gradient(to bottom, var(--btn-green-top), var(--btn-green-bot));
            color: #fff; border: 2px solid #fff; padding: 12px 25px;
            border-radius: 30px; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
        }
        .btn-add:active { transform: translateY(4px); box-shadow: none; }
        
        .player-list { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; text-align: left; margin-top: 20px; }
        .player-item {
            background: rgba(255,255,255,0.2); padding: 12px; margin-bottom: 8px;
            border-radius: 12px; display: flex; justify-content: space-between; cursor: pointer;
            border: 2px solid rgba(255,255,255,0.5); transition: background 0.2s;
        }
        .player-item:hover { background: rgba(255,255,255,0.4); }
        .player-item.selected { border: 2px solid var(--accent-color); background: rgba(255,247,0,0.3); }
        .btn-delete-name { background: #ff5252; color: white; border: 2px solid #fff; border-radius: 50%; width: 30px; height: 30px; cursor: pointer; line-height: 26px; font-weight: bold; }

        /* リザルト画面 (地味なダークブラウン・セピア調) */
        .result-box { 
            padding: 40px; width: 500px; text-align: center;
            background: linear-gradient(to bottom, #4e342e, #3e2723); 
            border: 4px solid #8d6e63;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .res-row { display: flex; justify-content: space-between; font-size: 20px; margin: 15px 0; border-bottom: 2px dashed #8d6e63; padding-bottom: 5px; color: #d7ccc8; }
        .res-val { color: #ffccbc; font-weight: 900; font-size: 24px; text-shadow: none; }
        .res-total { font-size: 50px; color: #ffab91; text-shadow: none; margin: 10px 0; font-weight: 900; }

        /* ランキング */
        #ranking-popup { background-color: #000; }
        .ranking-container { display: flex; gap: 20px; width: 100%; height: 400px; }
        .ranking-col { flex: 1; padding: 10px; display: flex; flex-direction: column; background: rgba(0,0,0,0.5); border-radius: 10px; border: 2px solid #fff; }
        .rank-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.3); color: #fff; font-weight: bold; }
        .rank-score { color: var(--accent-color); text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .tab-btn {
            background: #999; color: #fff; border: 2px solid #fff; padding: 10px 30px;
            border-radius: 15px 15px 0 0; cursor: pointer; font-size: 18px; margin: 0 5px;
            position: relative; top: 4px; font-weight: bold;
        }
        .tab-btn.active { 
            background: #00c6ff; color: #fff; border-bottom: none; 
            z-index: 10;
        }

        /* ゲーム内演出 */
        #transition-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.6); z-index: 50; color: white;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #transition-overlay.active { opacity: 1; pointer-events: auto; cursor: pointer; }
        .transition-text { 
            font-size: 80px; font-weight: 900; color: #fff;
            text-shadow: 4px 4px 0 #0072ff, 0 0 30px #fff; 
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }
        
        /* アイテム確認ポップアップ (地味なダークグレー系) */
        #item-confirm-popup {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 20px; width: 350px; text-align: center; z-index: 150;
            display: none;
            background: linear-gradient(to bottom, #34495e, #2c3e50);
            border: 4px solid #7f8c8d;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }

    </style>
</head>
<body>

<div id="game-scaler">

    <div id="left-panel" class="side-panel">
        <h2>あそびかた</h2>
        <ol>
            <li>しろいカードをばのカードにかさねるとかずがかけざんされるよ</li>
            <li>ばのカードが <b>101いじょう</b> になると<br>てきに こうげき するよ！</li>
            <li>こうげきすると <b>アクション</b> がへるよ。<br>0になると ゲームオーバー</li>
            <li>てきをたおすと ラウンドクリア！<br>アイテムが１つもらえるよ！</li>
            <li>アイテムを うまくつかって<br>さいごのボスを たおそう！</li>
        </ol>
        <button id="btn-return-title" class="btn-back hidden" onclick="game.showTitle()">タイトルへ もどる</button>
    </div>

    <div id="game-wrapper">
        <canvas id="gameCanvas"></canvas>
        
        <div id="transition-overlay">
            <div class="transition-text" id="transition-msg">クリア！</div>
            <div style="font-size: 24px; margin-top:20px; animation: blink 1s infinite; text-shadow:1px 1px 0 #000;">タッチして すすむ</div>
        </div>

        <div id="item-confirm-popup" class="hidden" style="display:none;">
            <h3 id="popup-name" style="margin:0 0 10px 0; color:#f1c40f; font-size:24px; text-shadow:1px 1px 0 #000;">アイテム名</h3>
            <p id="popup-desc" style="font-size:16px; color:#ecf0f1; min-height:60px; font-weight:bold;">せつめい</p>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="puz-btn btn-start" style="width:120px; height:50px; font-size:20px; margin:0;" onclick="game.confirmItemUse(true)">つかう</button>
                <button class="puz-btn btn-sub" style="width:120px; height:50px; font-size:20px; margin:0;" onclick="game.confirmItemUse(false)">やめる</button>
            </div>
        </div>
    </div>

    <div id="right-panel" class="side-panel">
        <div id="right-panel-content">
            <div class="info-block">
                <div class="info-label">レベル</div>
                <div class="info-value" id="level-display">ちゅうきゅう</div>
            </div>
            <div class="info-block">
                <div class="info-label">ROUND</div>
                <div class="info-value" id="round-display">1 / 6</div>
            </div>
            <div class="info-block">
                <div class="info-label">スコア</div>
                <div class="info-value" id="score-display">0</div>
            </div>
            <div class="info-block" style="flex: 1; display: flex; flex-direction: column; border-bottom: none; overflow: hidden;">
                <div class="info-label">アイテム</div>
                <div id="item-list"></div>
            </div>
        </div>
    </div>

    <div id="global-overlays">
        
        <div id="title-screen" class="full-screen-overlay bg-title-img active">
            <div class="content-box-translucent">
                <h1 class="title-main">MATH BRAVES</h1>
                <div class="title-sub">- かけざん２ -</div>

                <div style="display:flex; flex-direction:column; align-items:center;">
                    <button class="puz-btn btn-start" onclick="game.showDifficultySelect()">はじめる</button>
                    
                    <button class="puz-btn btn-player" onclick="game.openPlayerModal()">
                        <span style="font-size:16px; margin-right:10px;">プレーヤー:</span>
                        <span id="current-player-name-title">ななしさん</span>
                    </button>

                    <button id="btn-title-login" class="puz-btn btn-login" onclick="game.login()">Googleでログイン</button>
                    <button id="btn-title-logout" class="puz-btn btn-login hidden" onclick="game.logout()">ログアウト</button>

                    <button class="puz-btn btn-score" onclick="game.toggleRankingPopup(true)">ランキング</button>
                    
                    <button class="puz-btn btn-sub" onclick="window.location.href='../index.html'">INDEXへ</button>
                </div>
            </div>
        </div>

        <div id="difficulty-select-screen" class="full-screen-overlay bg-title-img hidden">
            <div class="content-box-translucent">
                <h2 class="title-main" style="font-size:50px; margin-bottom:40px; text-shadow: 2px 2px 0 #0072ff; color: #333;">なんいどを えらぶ</h2>
                
                <div class="diff-container">
                    <div class="diff-column">
                        <div class="crown-area"><div class="crown-icon" id="crown-easy"></div></div>
                        <button class="puz-btn btn-diff btn-easy" onclick="game.initGame('easy')">しょきゅう</button>
                        <div class="clear-label" id="count-easy">0回</div>
                    </div>
                    <div class="diff-column">
                        <div class="crown-area"><div class="crown-icon" id="crown-normal"></div></div>
                        <button class="puz-btn btn-diff btn-normal" onclick="game.initGame('normal')">ちゅうきゅう</button>
                        <div class="clear-label" id="count-normal">0回</div>
                    </div>
                    <div class="diff-column">
                        <div class="crown-area"><div class="crown-icon" id="crown-hard"></div></div>
                        <button class="puz-btn btn-diff btn-hard" onclick="game.initGame('hard')">じょうきゅう</button>
                        <div class="clear-label" id="count-hard">0回</div>
                    </div>
                </div>

                <button class="puz-btn btn-sub" style="margin-top:40px;" onclick="game.showTitle()">もどる</button>
            </div>
        </div>

        <div id="player-modal-overlay" class="full-screen-overlay hidden">
            <div class="player-modal rpg-window">
                <div class="player-modal-inner">
                    <h2>プレーヤー設定</h2>
                    <div style="display:flex; gap:10px; justify-content:center; margin-bottom:20px;">
                        <input type="text" id="new-player-input" class="player-input" placeholder="なまえ (ひらがな)" maxlength="8">
                        <button class="btn-add" onclick="game.addPlayerName()">ついか</button>
                    </div>
                    <div id="validation-msg" style="color:#ff5252; height:20px; font-weight:bold; text-shadow:0 1px 1px rgba(0,0,0,0.2);"></div>
                    <ul id="player-list-ui" class="player-list"></ul>
                    <button class="puz-btn btn-sub" style="margin:20px auto 0 auto; width:150px; height:50px;" onclick="game.closePlayerModal()">とじる</button>
                </div>
            </div>
        </div>

        <div id="ranking-popup" class="full-screen-overlay bg-title-img hidden">
            <div class="content-box-translucent" style="width: 1000px;">
                <h2 class="title-main" style="font-size:40px; margin-bottom:20px; text-shadow: 2px 2px 0 #0072ff; color:#333;">ランキング</h2>
                <div>
                    <button class="tab-btn active" onclick="game.switchRankingTab('local')">ローカル</button>
                    <button class="tab-btn" onclick="game.switchRankingTab('world')">ワールド</button>
                </div>
                <div class="ranking-container">
                    <div class="ranking-col">
                        <h3 style="text-align:center; color:#2ecc71; margin:0 0 10px 0; text-shadow:0 1px 2px rgba(0,0,0,0.5);">しょきゅう</h3>
                        <div style="overflow-y:auto; flex:1;" id="rank-list-easy"></div>
                    </div>
                    <div class="ranking-col">
                        <h3 style="text-align:center; color:#3498db; margin:0 0 10px 0; text-shadow:0 1px 2px rgba(0,0,0,0.5);">ちゅうきゅう</h3>
                        <div style="overflow-y:auto; flex:1;" id="rank-list-normal"></div>
                    </div>
                    <div class="ranking-col">
                        <h3 style="text-align:center; color:#e74c3c; margin:0 0 10px 0; text-shadow:0 1px 2px rgba(0,0,0,0.5);">じょうきゅう</h3>
                        <div style="overflow-y:auto; flex:1;" id="rank-list-hard"></div>
                    </div>
                </div>
                <button class="puz-btn btn-sub" style="margin-top:20px;" onclick="game.toggleRankingPopup(false)">とじる</button>
            </div>
        </div>

        <div id="result-screen" class="full-screen-overlay hidden">
            <div class="result-box">
                <h2 id="result-popup-title" class="title-main" style="font-size:48px; margin-bottom:20px;">GAME OVER</h2>
                <div class="res-row"><span>難易度</span><span class="res-val" id="res-level"></span></div>
                <div class="res-row"><span>基本スコア</span><span class="res-val" id="res-base-score"></span></div>
                <div class="res-row"><span>ボーナス</span><span class="res-val" id="res-bonus"></span></div>
                <div style="margin-top:20px; font-weight:bold; color:#fff;">TOTAL SCORE</div>
                <div class="res-total" id="res-final-score">0</div>
                <button class="puz-btn btn-start" style="margin:30px auto 0 auto;" onclick="game.showTitle()">タイトルへ</button>
            </div>
        </div>

    </div>

</div>

<script>
const NG_WORDS_HIRAGANA = [
    'しね', 'しぬ', 'しに', 'ころす', 'ころせ', 'さつがい', 'くたばれ',
    'じさつ', 'ぎさつ', 'つるす', 'れんたん', 'しにたい',
    'てろ', 'てろりすと', 'ばくは', 'ばくだん', 'ほうか',
    'はんざい', 'ごうとう', 'ゆうかい', 'かんきん', 'おそう',
    'やくざ', 'ぼうりょく', 'はんぐれ', 'ちんぴら', 'まふぃあ',
    'たいま', 'まやく', 'かくせいざい', 'しゃぶ', 'どらっぐ', 'こかいん',
    'へろいん', 'えくすたしー', 'だっぽう', 'きめせく',
    'いじめ', 'ぎゃくたい',
    'ばか', 'あほ', 'まぬけ', 'きちがい', 'き違い',
    'うざい', 'うざ', 'きもい', 'きも', 'きしょい', 'きえろ',
    'くず', 'ごみ', 'ごみむし', 'かす', 'ざこ', 'ぜつ',
    'ぶす', 'でぶ', 'はげ', 'ちび', 'でっぱ', 'いなかもの',
    'うじ', 'はいぼく', 'まけいぬ', 'おつむ', 'のうたりん',
    'ていのう', 'ちしょう', 'しょうがい', 'がいじ', 'かたわ', 'びっこ',
    'めくら', 'つんぼ', 'おし', 'どじん', 'えた', 'ひにん',
    'たひ', 'たひね',
    'うせろ', 'だまれ',
    'ちんちん', 'ちんこ', 'ちんぽ', 'ちんか', 'まら', 'さお',
    'まんこ', 'まんしゅう', 'まんげ', 'われめ', 'おまた',
    'くり', 'くりとりす', 'いんしん', 'いんかく', 'びらびら',
    'こうがん', 'たまきん', 'きんたま', 'ふぐり',
    'おっぱい', 'ちち', 'にゅうりん', 'にゅうとう', 'きょにゅう', 'ひんにゅう',
    'けつ', 'あなる', 'こうもん', 'けつのあな',
    'えろ', 'えっち', 'すけべ', 'へんたい', 'むっつり', 'しこ',
    'せっくす', 'せいこう', 'まぐわい', 'そうにゅう', 'はめる',
    'おなにー', 'じい', 'しこしこ', 'ふぇら', 'ぱいずり', 'くんに',
    'いらま', 'しっしん', 'なかだし', 'ごっくん', 'ぶっかけ',
    'しおふき', 'ぜっちょう', 'いく', 'いかせろ', 'あえぎ',
    'どうてい', 'しょじょ', 'やりまん', 'やりちん', 'びっち',
    'せふれ', 'ぱこ', 'ぱこぱこ', 'わいせつ', 'ろり', 'しょた', 'ぺど',
    'きんしん', 'じゅうかん', 'りょうじょく', 'らんこう', 'すかんと',
    'のーぱん', 'ぱんちら',
    'れいぷ', 'ごうかん', 'ちかん', 'とうさつ', 'のぞき', 'ろしゅつ',
    'ふうぞく', 'そーぷ', 'へるす', 'でりへる', 'ぴんさろ', 'いめくら',
    'あだると', 'えーぶい', 'えぶい', 'ぽるの', 'うらびでお', 'むしゅうせい',
    'えんこう', 'えんじょ', 'うり', 'かいしゅん', 'ばいしゅん',
    'ぱぱかつ', 'ままかつ', 'うりせん',
    'うんこ', 'うんち', 'くそ', 'げり', 'べん', 'ふん',
    'しっこ', 'しょんべん', 'にょう', 'ほうにょう',
    'へ', 'おなら', 'げろ', 'たん',
    'うんえい', 'こうしき', 'すたっふ', 'かんり', 'ぱとろーる',
    'じえむ', 'げーむますたー', 'ますたー', 'あどみん', 'しすてむ',
    'さーばー', 'あかばん', 'ばん', 'ちーと', 'ちーたー', 'ばぐ',
    'らいん', 'かかお', 'すかいぷ', 'いんすた', 'ついったー', 'でぃすこ',
    'でんわ', 'ばんごう', 'けいたい', 'あどれす', 'めあど', 'じゅうしょ',
    'あお', 'あいたい', 'まちあわせ', 'ほてる', 'らぶほ', 'おふかい',
    'ぱすわーど', 'ぱす', 'あかうんと', 'こじんじょうほう'
];

const firebaseConfig = {
    apiKey: "AIzaSyBCg5dCEM89UmYYhfGqVeRf_VrUlg8_o-4",
    authDomain: "math-braves.firebaseapp.com",
    projectId: "math-braves",
    storageBucket: "math-braves.firebasestorage.app",
    messagingSenderId: "217117619290",
    appId: "1:217117619290:web:d227feb603970d3948d463"
};

let db, auth;
try {
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    auth = firebase.auth();
} catch (e) {
    console.error("Firebase init failed:", e);
}

class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.collectionName = "scores_multiplication2";

        this.baseWidth = 700;
        this.baseHeight = 720; 

        this.scaler = document.getElementById('game-scaler');
        this.designWidth = 1280;
        this.designHeight = 720;
        this.resize();
        window.addEventListener('resize', () => this.resize());

        this.attachInputHandlers();
        this.setupAuth();

        this.state = 'TITLE';
        this.difficulty = 'normal';
        this.round = 1;
        this.maxRound = 6;
        this.score = 0;
        this.actionCount = 0;
        this.rankingMode = 'local';
        this.user = null;

        this.playerList = [];
        this.currentPlayerIndex = -1;
        this.loadPlayerSystem();

        this.handCards = [];
        this.fieldCard = null;
        this.enemy = null;
        this.draggedCard = null;
        this.dragOffset = {x:0, y:0};
        this.particles = [];
        this.floatTexts = [];

        this.items = {
            'change': { name: 'チェンジ', desc: 'てふだ を すべて ひきなおす', count: 0, color: '#f1c40f' },
            'action_plus': { name: 'アクション＋１', desc: 'アクションが １ かいふくする', count: 0, color: '#2ecc71' },
            'x20': { name: '×２０', desc: 'ばのカードを ２０ばい する\n(101いじょうで すぐにこうげき)', count: 0, color: '#9b59b6' },
            'damage_500': { name: 'ダメージ500', desc: 'てきに 500ダメージを あたえる\n(アクションは へらない)', count: 0, color: '#e74c3c' },
            'all_plus_5': { name: 'ぜんぶ＋５', desc: 'てふだの すうじが すべて ＋５ される', count: 0, color: '#3498db' }
        };
        this.itemKeys = Object.keys(this.items);
        this.selectedItemKey = null;
        this.lastItemJSON = "";

        this.lastTime = 0;
        this.updateClearCounts();
    }

    setupAuth() {
        if (!auth) return;
        auth.onAuthStateChanged((user) => {
            this.user = user;
            const btnLogin = document.getElementById('btn-title-login');
            const btnLogout = document.getElementById('btn-title-logout');

            if (user) {
                btnLogin.classList.add('hidden');
                btnLogout.classList.remove('hidden');
                btnLogout.innerHTML = `ログアウト<br><span style="font-size:14px;">(${user.displayName || "名無し"})</span>`;
            } else {
                btnLogin.classList.remove('hidden');
                btnLogout.classList.add('hidden');
            }
        });
    }

    login() {
        if (!auth) return;
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch((error) => {
            console.error("Login failed:", error);
            alert("ログインに失敗しました");
        });
    }

    logout() {
        if (!auth) return;
        auth.signOut().catch((error) => console.error("Logout failed:", error));
    }

    resize() {
        this.canvas.width = this.baseWidth;
        this.canvas.height = this.baseHeight;
        this.canvas.style.width = this.baseWidth + "px";
        this.canvas.style.height = this.baseHeight + "px";

        const scaleX = window.innerWidth / this.designWidth;
        const scaleY = window.innerHeight / this.designHeight;
        this.scaleRatio = Math.min(scaleX, scaleY);

        this.scaler.style.transform = `scale(${this.scaleRatio})`;
    }

    loadPlayerSystem() {
        const savedList = localStorage.getItem('math_braves_player_list');
        const savedIndex = localStorage.getItem('math_braves_current_player_index');
        
        if (savedList) {
            this.playerList = JSON.parse(savedList);
            this.currentPlayerIndex = savedIndex ? parseInt(savedIndex) : -1;
        } else {
            this.playerList = [];
            this.currentPlayerIndex = -1;
        }
        this.updatePlayerButton();
    }

    savePlayerSystem() {
        localStorage.setItem('math_braves_player_list', JSON.stringify(this.playerList));
        localStorage.setItem('math_braves_current_player_index', this.currentPlayerIndex);
        this.updatePlayerButton();
    }

    updatePlayerButton() {
        const nameTitle = document.getElementById('current-player-name-title');
        let name = "ななしさん";
        if (this.currentPlayerIndex >= 0 && this.currentPlayerIndex < this.playerList.length) {
            name = this.playerList[this.currentPlayerIndex];
        }
        nameTitle.textContent = name;
    }

    openPlayerModal() {
        document.getElementById('player-modal-overlay').classList.remove('hidden');
        document.getElementById('player-modal-overlay').classList.add('active');
        document.getElementById('validation-msg').textContent = ""; 
        document.getElementById('new-player-input').value = "";
        this.renderPlayerModalList();
    }

    closePlayerModal() {
        document.getElementById('player-modal-overlay').classList.remove('active');
        setTimeout(() => document.getElementById('player-modal-overlay').classList.add('hidden'), 300);
    }

    renderPlayerModalList() {
        const listEl = document.getElementById('player-list-ui');
        listEl.innerHTML = '';
        
        if (this.playerList.length === 0) {
            listEl.innerHTML = '<li style="text-align:center; color:#ccc;">プレーヤーがいません。<br>うえから ついか してね。</li>';
        }

        this.playerList.forEach((name, index) => {
            const li = document.createElement('li');
            li.className = 'player-item';
            if (index === this.currentPlayerIndex) li.classList.add('selected');
            
            li.onclick = () => this.handleSelectPlayer(index);

            li.innerHTML = `
                <span style="font-size:20px; font-weight:bold; color:#fff;">${name}</span>
                <button class="btn-delete-name" onclick="event.stopPropagation(); game.handleDeletePlayer(${index})">×</button>
            `;
            listEl.appendChild(li);
        });
    }

    addPlayerName() {
        const input = document.getElementById('new-player-input');
        const msgEl = document.getElementById('validation-msg');
        let name = input.value.trim();
        msgEl.textContent = "";

        if (!name) {
            msgEl.textContent = "おなまえを かいてね";
            return;
        }
        if (!/^[ぁ-んー]+$/.test(name)) {
            msgEl.textContent = "ひらがな だけで かいてね";
            return;
        }
        for (const ng of NG_WORDS_HIRAGANA) {
            if (name.includes(ng)) {
                msgEl.textContent = "つかえない ことばが はいっています";
                return;
            }
        }
        if (this.playerList.includes(name)) {
            msgEl.textContent = "そのおなまえは すでにあります";
            return;
        }
        if (this.playerList.length >= 5) {
            msgEl.textContent = 'とうろく できるのは 5にん までです';
            return;
        }
        
        this.playerList.push(name);
        this.currentPlayerIndex = this.playerList.length - 1; 
        input.value = '';
        this.savePlayerSystem();
        this.renderPlayerModalList();
    }

    handleSelectPlayer(index) {
        this.currentPlayerIndex = index;
        this.savePlayerSystem();
        this.renderPlayerModalList();
    }

    handleDeletePlayer(index) {
        if (!confirm('このプレーヤーを削除しますか？')) return;
        
        this.playerList.splice(index, 1);
        
        if (this.currentPlayerIndex === index) {
            this.currentPlayerIndex = this.playerList.length > 0 ? 0 : -1;
        } else if (this.currentPlayerIndex > index) {
            this.currentPlayerIndex--;
        }
        
        this.savePlayerSystem();
        this.renderPlayerModalList();
    }

    attachInputHandlers() {
        const getPos = (e) => {
            const rect = this.canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            
            return { 
                x: (clientX - rect.left) / this.scaleRatio, 
                y: (clientY - rect.top) / this.scaleRatio 
            };
        };

        const onStart = (e) => {
            if (this.state === 'ROUND_TRANSITION_WAIT') { this.nextRound(); return; }
            if (this.state === 'GAME_OVER_WAIT') { this.gameOver(); return; }
            if (this.state !== 'PLAYING') return;
            
            const pos = getPos(e);
            for (let i = this.handCards.length - 1; i >= 0; i--) {
                let card = this.handCards[i];
                if (pos.x >= card.x - card.width/2 && pos.x <= card.x + card.width/2 &&
                    pos.y >= card.y - card.height/2 && pos.y <= card.y + card.height/2) {
                    this.draggedCard = card;
                    card.isDragging = true;
                    this.dragOffset.x = pos.x - card.x;
                    this.dragOffset.y = pos.y - card.y;
                    this.handCards.splice(i, 1); this.handCards.push(card); 
                    break;
                }
            }
        };
        const onMove = (e) => {
            if (!this.draggedCard) return;
            const pos = getPos(e);
            this.draggedCard.x = pos.x - this.dragOffset.x;
            this.draggedCard.y = pos.y - this.dragOffset.y;
        };
        const onEnd = (e) => {
            if (!this.draggedCard) return;
            const card = this.draggedCard;
            const field = this.fieldCard;
            const dist = Math.sqrt(Math.pow(card.x - field.x, 2) + Math.pow(card.y - field.y, 2));
            if (dist < 80 && this.state === 'PLAYING') this.mergeCard(card);
            else card.isDragging = false;
            this.draggedCard = null;
        };

        this.canvas.addEventListener('mousedown', onStart);
        this.canvas.addEventListener('mousemove', onMove);
        this.canvas.addEventListener('mouseup', onEnd);
        this.canvas.addEventListener('touchstart', onStart, {passive: false});
        this.canvas.addEventListener('touchmove', onMove, {passive: false});
        this.canvas.addEventListener('touchend', onEnd, {passive: false});
        
        document.getElementById('transition-overlay').addEventListener('click', () => {
            if (this.state === 'ROUND_TRANSITION_WAIT') this.nextRound();
            else if (this.state === 'GAME_OVER_WAIT') this.gameOver();
        });
    }

    showDifficultySelect() {
        document.getElementById('title-screen').classList.remove('active');
        setTimeout(() => document.getElementById('title-screen').classList.add('hidden'), 300);
        
        document.getElementById('difficulty-select-screen').classList.remove('hidden');
        document.getElementById('difficulty-select-screen').classList.add('active');
    }

    initGame(diff) {
        this.difficulty = diff;
        this.score = 0;
        this.round = 1;
        this.itemKeys.forEach(k => this.items[k].count = 0);
        this.lastItemJSON = ""; 
        
        document.getElementById('title-screen').classList.add('hidden');
        document.getElementById('difficulty-select-screen').classList.add('hidden');
        document.getElementById('difficulty-select-screen').classList.remove('active');
        document.getElementById('result-screen').classList.add('hidden');
        document.getElementById('result-screen').classList.remove('active');
        document.getElementById('transition-overlay').classList.remove('active');
        
        // アイテムポップアップを強制的に隠す
        document.getElementById('item-confirm-popup').classList.add('hidden');
        document.getElementById('item-confirm-popup').style.display = 'none';

        // パネル表示
        document.getElementById('right-panel-content').style.display = 'flex';
        document.getElementById('btn-return-title').classList.remove('hidden');
        
        this.startRound();
        this.state = 'PLAYING';
        this.loop();
    }

    startRound() {
        const n = this.round;
        let baseAction = n + 4;
        let hp = (n + 4) * (50 * n + (this.difficulty==='easy'?300 : this.difficulty==='normal'?350 : 400));
        
        // 背景切り替え（ボス戦だけ特別）
        const wrapper = document.getElementById('game-wrapper');
        if (this.round === 6) {
            wrapper.style.backgroundImage = "url('images/boss.png')";
        } else {
            wrapper.style.backgroundImage = "url('images/battle.png')";
        }

        this.actionCount = baseAction;
        this.enemy = { hp: hp, maxHp: hp, shake: 0 };
        this.handCards = [];
        for(let i=0; i<5; i++) this.addHandCard(i);
        this.setFieldCard();
        this.addFloatText(this.round === 6 ? 'FINAL ROUND' : `ROUND ${this.round}`, this.baseWidth/2, this.baseHeight/2, 60, '#fff');
    }

    addHandCard(index) {
        const spacing = 110;
        const startX = (this.baseWidth - (5 * spacing)) / 2 + spacing/2;
        const cardY = 600; 
        this.handCards.push({
            value: [2,2,3,3,4,5,6,7,8,9][Math.floor(Math.random() * 10)], 
            x: startX + index * spacing, y: cardY,
            width: 90, height: 130,
            targetX: startX + index * spacing, targetY: cardY,
            isDragging: false, alpha: 1
        });
    }

    setFieldCard() {
        const fieldY = 420; 
        this.fieldCard = {
            value: Math.floor(Math.random() * 8) + 2,
            x: this.baseWidth / 2, y: fieldY,
            width: 120, height: 160, scale: 1.0, alpha: 1,
            targetY: fieldY, originalY: fieldY
        };
    }

    loop(timestamp) {
        const dt = timestamp - this.lastTime;
        this.lastTime = timestamp;
        this.update(dt);
        this.draw();
        this.updateUI(); 
        if (this.state !== 'TITLE') requestAnimationFrame(t => this.loop(t));
    }

    update(dt) {
        this.handCards.forEach(card => {
            if (!card.isDragging) {
                card.x += (card.targetX - card.x) * 0.2;
                card.y += (card.targetY - card.y) * 0.2;
            }
        });
        if (this.state === 'ATTACKING') {
            this.fieldCard.y -= 15;
            this.fieldCard.alpha -= 0.05;
            if (this.fieldCard.alpha <= 0) this.applyDamage(this.fieldCard.value);
        } else {
            if (this.fieldCard && this.fieldCard.scale > 1.0) this.fieldCard.scale -= 0.05;
        }
        this.particles.forEach(p => { p.x+=p.vx; p.y+=p.vy; p.life--; p.alpha-=0.02; });
        this.particles = this.particles.filter(p => p.life > 0);
        this.floatTexts.forEach(t => { t.y-=1; t.life--; });
        this.floatTexts = this.floatTexts.filter(t => t.life > 0);
        if (this.enemy && this.enemy.shake > 0) this.enemy.shake--;
    }

    updateUI() {
        const diffText = this.difficulty === 'easy' ? 'しょきゅう' : this.difficulty === 'normal' ? 'ちゅうきゅう' : 'じょうきゅう';
        document.getElementById('level-display').textContent = diffText;
        document.getElementById('round-display').textContent = `${this.round} / ${this.maxRound}${this.round===6?' (FINAL)':''}`;
        document.getElementById('score-display').textContent = this.score;

        const currentJSON = JSON.stringify(this.items);
        if (this.lastItemJSON !== currentJSON) {
            this.lastItemJSON = currentJSON;
            const itemList = document.getElementById('item-list');
            itemList.innerHTML = '';
            this.itemKeys.forEach(key => {
                const item = this.items[key];
                if (item.count > 0) {
                    const btn = document.createElement('button');
                    btn.className = 'item-btn';
                    btn.style.color = item.color; // アイテム色は文字色に反映
                    btn.innerHTML = `<span style="text-shadow:1px 1px 0 #000;">${item.name}</span><span class="item-count">x${item.count}</span>`;
                    btn.onclick = () => this.openItemConfirm(key);
                    itemList.appendChild(btn);
                }
            });
        }
    }

    mergeCard(handCard) {
        this.fieldCard.value *= handCard.value;
        this.fieldCard.scale = 1.5;
        this.createParticles(this.fieldCard.x, this.fieldCard.y, 10, '#f1c40f');
        this.addFloatText(`×${handCard.value}`, this.fieldCard.x, this.fieldCard.y - 80, 40, '#e74c3c');
        handCard.value = [2,2,3,3,4,5,6,7,8,9][Math.floor(Math.random() * 10)];
        handCard.isDragging = false;
        handCard.x = handCard.targetX; handCard.y = handCard.targetY;

        if (this.fieldCard.value > 100) this.triggerAttackAnim();
    }

    triggerAttackAnim() {
        this.state = 'ATTACKING'; 
        this.actionCount--;
    }

    applyDamage(damage, resetField = true) {
        if (!this.enemy) return;
        this.enemy.hp -= damage;
        this.enemy.shake = 20;
        this.score += damage;
        this.createParticles(this.baseWidth/2, 200, 30, '#e74c3c');
        this.addFloatText(`-${damage}`, this.baseWidth/2, 180, 70, '#ff0000');

        if (this.enemy.hp <= 0) {
            this.enemy.hp = 0;
            this.winRoundWait();
        } else if (this.actionCount <= 0) {
            this.waitGameOver();
        } else {
            if (resetField) this.setFieldCard();
            this.state = 'PLAYING';
        }
    }

    winRoundWait() {
        const msg = this.round === this.maxRound ? "ゲームクリア！" : "クリア！";
        document.getElementById('transition-msg').textContent = msg;
        document.getElementById('transition-msg').style.color = 'white';
        document.getElementById('transition-overlay').classList.add('active');
        this.state = 'ROUND_TRANSITION_WAIT';
    }

    waitGameOver() {
        document.getElementById('transition-msg').textContent = "GAME OVER";
        document.getElementById('transition-msg').style.color = '#e74c3c';
        document.getElementById('transition-overlay').classList.add('active');
        this.state = 'GAME_OVER_WAIT';
    }

    nextRound() {
        document.getElementById('transition-overlay').classList.remove('active');
        if (this.round >= this.maxRound) {
            this.gameClear();
        } else {
            const itemKey = this.itemKeys[Math.floor(Math.random() * this.itemKeys.length)];
            this.items[itemKey].count++;
            this.addFloatText(`GET: ${this.items[itemKey].name}`, this.baseWidth/2, this.baseHeight/2, 40, '#f39c12');
            this.round++;
            this.startRound();
            this.state = 'PLAYING';
        }
    }

    gameOver() {
        document.getElementById('transition-overlay').classList.remove('active');
        this.state = 'RESULT';
        document.getElementById('result-popup-title').textContent = "GAME OVER";
        document.getElementById('result-popup-title').style.color = "#e74c3c";
        this.saveScore(this.score);
        this.showResult();
    }

    gameClear() {
        this.state = 'RESULT';
        const bonus = this.actionCount * 1000;
        this.score += bonus;
        document.getElementById('result-popup-title').textContent = "完全クリア！";
        document.getElementById('result-popup-title').style.color = "#f1c40f";
        this.showResult(bonus);
        this.saveScore(this.score);
        this.updateLocalClearCount();
    }

    showResult(bonus = 0) {
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('result-screen').classList.add('active');
        document.getElementById('right-panel-content').style.display = 'none';
        document.getElementById('btn-return-title').classList.add('hidden'); 

        const finalScore = this.score;
        const baseScore = finalScore - bonus;
        const diffText = this.difficulty === 'easy' ? 'しょきゅう' : this.difficulty === 'normal' ? 'ちゅうきゅう' : 'じょうきゅう';

        document.getElementById('res-level').textContent = diffText;
        document.getElementById('res-base-score').textContent = `${baseScore}点`;
        document.getElementById('res-bonus').textContent = `${bonus}点`;
        document.getElementById('res-final-score').textContent = `${finalScore}点`;
    }

    showTitle() {
        this.state = 'TITLE';
        
        document.getElementById('title-screen').classList.remove('hidden');
        document.getElementById('title-screen').classList.add('active');
        
        document.getElementById('difficulty-select-screen').classList.remove('active');
        document.getElementById('difficulty-select-screen').classList.add('hidden');
        
        document.getElementById('result-screen').classList.remove('active');
        document.getElementById('result-screen').classList.add('hidden');
        
        document.getElementById('right-panel-content').style.display = 'none';
        document.getElementById('btn-return-title').classList.add('hidden');
        
        this.updateClearCounts();
    }

    openItemConfirm(key) {
        if (this.state !== 'PLAYING') return;
        this.selectedItemKey = key;
        const item = this.items[key];
        document.getElementById('popup-name').textContent = item.name;
        document.getElementById('popup-desc').innerText = item.desc;
        const popup = document.getElementById('item-confirm-popup');
        popup.classList.remove('hidden');
        popup.style.display = 'block';
        this.state = 'ITEM_POPUP'; 
    }
    confirmItemUse(doUse) {
        const popup = document.getElementById('item-confirm-popup');
        popup.classList.add('hidden');
        popup.style.display = 'none';
        
        if (doUse && this.selectedItemKey) this.useItem(this.selectedItemKey);
        this.selectedItemKey = null;
        this.state = 'PLAYING'; 
    }
    useItem(key) {
        if (this.items[key].count <= 0) return;
        this.items[key].count--;
        this.lastItemJSON = ""; 
        const item = this.items[key];
        this.addFloatText(`USED: ${item.name}`, this.baseWidth/2, this.baseHeight/2 - 100, 40, item.color);
        switch(key) {
            case 'change': this.handCards.forEach(c => c.value = [2,2,3,3,4,5,6,7,8,9][Math.floor(Math.random() * 10)]); break;
            case 'action_plus': this.actionCount++; break;
            case 'x20':
                this.fieldCard.value *= 20;
                this.fieldCard.scale = 2.0;
                if (this.fieldCard.value > 100) setTimeout(() => this.triggerAttackAnim(), 600);
                break;
            case 'damage_500': if(this.enemy) this.applyDamage(500, false); break;
            case 'all_plus_5': this.handCards.forEach(c => c.value += 5); break;
        }
    }

    draw() {
        this.ctx.clearRect(0, 0, this.baseWidth, this.baseHeight);
        
        this.ctx.strokeStyle = 'rgba(255,255,255,0.1)'; this.ctx.lineWidth = 2;
        // グリッド線
        // for(let i=0; i<this.baseWidth; i+=60) { this.ctx.beginPath(); this.ctx.moveTo(i,0); this.ctx.lineTo(i,this.baseHeight); this.ctx.stroke(); }
        // for(let i=0; i<this.baseHeight; i+=60) { this.ctx.beginPath(); this.ctx.moveTo(0,i); this.ctx.lineTo(this.baseWidth,i); this.ctx.stroke(); }

        this.ctx.fillStyle = '#fff'; this.ctx.font = "bold 24px 'M PLUS Rounded 1c'"; this.ctx.textAlign = 'center';
        this.ctx.shadowColor="black"; this.ctx.shadowBlur=4;
        this.ctx.fillText("のこりアクション", this.baseWidth/2, 40);
        this.ctx.font = "900 64px 'M PLUS Rounded 1c'";
        
        this.ctx.lineWidth = 6; this.ctx.strokeStyle = '#c0392b'; 
        this.ctx.strokeText(this.actionCount, this.baseWidth/2, 100);
        this.ctx.fillStyle = '#ff5252'; this.ctx.fillText(this.actionCount, this.baseWidth/2, 100);
        this.ctx.shadowBlur=0;

        if (this.enemy && this.enemy.hp > 0) {
            const shakeX = (Math.random() - 0.5) * this.enemy.shake;
            this.drawEnemyIcon(this.baseWidth/2 + shakeX, 200, this.round);
            
            const barW = 300, barH = 24, barY = 280;
            const hpPct = Math.max(0, this.enemy.hp / this.enemy.maxHp);
            
            this.ctx.shadowBlur = 0;
            this.ctx.fillStyle = '#000';
            this.ctx.beginPath(); this.ctx.roundRect(this.baseWidth/2 - barW/2, barY, barW, barH, 12); this.ctx.fill();
            
            this.ctx.fillStyle = hpPct > 0.5 ? '#2ecc71' : hpPct > 0.2 ? '#f1c40f' : '#e74c3c';
            this.ctx.beginPath(); this.ctx.roundRect(this.baseWidth/2 - barW/2 + 2, barY + 2, (barW-4) * hpPct, barH - 4, 10); this.ctx.fill();
            
            this.ctx.fillStyle = '#fff'; this.ctx.font = "bold 20px 'M PLUS Rounded 1c'";
            this.ctx.shadowColor="black"; this.ctx.shadowBlur=4;
            this.ctx.fillText(`${this.enemy.hp} / ${this.enemy.maxHp}`, this.baseWidth/2, barY + 50);
            this.ctx.shadowBlur=0;
        }

        if (this.fieldCard && this.fieldCard.alpha > 0) this.drawCard(this.fieldCard, true);
        this.handCards.forEach(card => this.drawCard(card, false));

        this.particles.forEach(p => {
            this.ctx.globalAlpha = p.alpha; this.ctx.fillStyle = p.color;
            this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); this.ctx.fill();
        });
        this.ctx.globalAlpha = 1.0;
        this.floatTexts.forEach(t => {
            this.ctx.save();
            this.ctx.shadowColor = 'rgba(0,0,0,0.8)'; this.ctx.shadowBlur = 4;
            this.ctx.fillStyle = t.color; this.ctx.font = `bold ${t.size}px 'M PLUS Rounded 1c'`;
            this.ctx.textAlign = 'center'; this.ctx.lineWidth = 3;
            this.ctx.strokeText(t.text, t.x, t.y); this.ctx.fillText(t.text, t.x, t.y);
            this.ctx.restore();
        });
    }

    drawCard(card, isField) {
        this.ctx.save();
        this.ctx.translate(card.x, card.y);
        this.ctx.scale(card.scale, card.scale);
        this.ctx.globalAlpha = card.alpha;
        if (card.isDragging) { this.ctx.shadowColor='rgba(0,0,0,0.5)'; this.ctx.shadowBlur=20; this.ctx.scale(1.1,1.1); }

        this.ctx.fillStyle = isField ? '#2a1a3a' : '#ffffff';
        this.ctx.beginPath(); this.ctx.roundRect(-card.width/2, -card.height/2, card.width, card.height, 12); this.ctx.fill();
        
        this.ctx.lineWidth = isField ? 4 : 2; 
        this.ctx.strokeStyle = isField ? '#ffd700' : '#888'; 
        this.ctx.stroke();

        this.ctx.fillStyle = isField ? '#ffd700' : '#2c3e50'; 
        this.ctx.font = `bold ${isField?64:52}px 'M PLUS Rounded 1c'`;
        this.ctx.textAlign = 'center'; this.ctx.textBaseline = 'middle';
        
        // 修正: 手札の影を完全に消去
        if (isField) {
            this.ctx.shadowColor = 'rgba(255,215,0,0.5)'; 
            this.ctx.shadowBlur = 10;
        } else {
            this.ctx.shadowColor = 'transparent'; // 透明にする
            this.ctx.shadowBlur = 0;
        }
        
        this.ctx.fillText(card.value, 0, 0);
        
        if (isField && card.value >= 80 && card.value <= 100 && this.state === 'PLAYING') {
             this.ctx.fillStyle = '#ff5252'; this.ctx.font = 'bold 16px sans-serif'; 
             this.ctx.fillText('あとすこし!', 0, card.height/2 + 20);
        }
        this.ctx.restore();
    }

    drawEnemyIcon(x, y, round) {
        this.ctx.save(); this.ctx.translate(x, y);
        const colors = ['#9b59b6', '#3498db', '#2ecc71', '#f1c40f', '#e67e22', '#34495e'];
        this.ctx.fillStyle = colors[(round-1)%6];
        
        this.ctx.shadowColor = colors[(round-1)%6]; this.ctx.shadowBlur = 20;

        this.ctx.beginPath();
        switch(round) {
            case 1: this.ctx.arc(0, -20, 60, Math.PI, 0); for(let i=0; i<=6; i++) this.ctx.lineTo(60 - i*20, (i%2===0)?40:60); break;
            case 2: this.ctx.roundRect(-50, -60, 100, 100, 10); break;
            case 3: this.ctx.moveTo(0, -70); this.ctx.bezierCurveTo(-60, -20, -70, 50, 0, 50); this.ctx.bezierCurveTo(70, 50, 60, -20, 0, -70); break;
            case 4: for(let i=0; i<8; i++) { const a = (Math.PI*2/8)*i; this.ctx.lineTo(Math.cos(a)*70, Math.sin(a)*70); this.ctx.lineTo(Math.cos(a+0.4)*40, Math.sin(a+0.4)*40); } break;
            case 5: this.ctx.arc(0, 0, 65, 0, Math.PI*2); break;
            case 6: this.ctx.moveTo(-40, -60); this.ctx.lineTo(-70, -110); this.ctx.lineTo(-20, -75); this.ctx.moveTo(40, -60); this.ctx.lineTo(70, -110); this.ctx.lineTo(20, -75); this.ctx.arc(0, 0, 75, 0, Math.PI*2); break;
        }
        this.ctx.closePath(); this.ctx.fill();
        this.ctx.fillStyle = 'white';
        if (round === 5) {
            this.ctx.beginPath(); this.ctx.arc(0, -10, 25, 0, Math.PI*2); this.ctx.fill();
            this.ctx.fillStyle = 'black'; this.ctx.beginPath(); this.ctx.arc(0, -10, 10, 0, Math.PI*2); this.ctx.fill();
        } else {
            this.ctx.beginPath(); this.ctx.arc(-20, -20, 15, 0, Math.PI*2); this.ctx.fill();
            this.ctx.beginPath(); this.ctx.arc(20, -20, 15, 0, Math.PI*2); this.ctx.fill();
            this.ctx.fillStyle = 'black'; this.ctx.beginPath(); this.ctx.arc(-20, -20, 6, 0, Math.PI*2); this.ctx.fill();
            this.ctx.beginPath(); this.ctx.arc(20, -20, 6, 0, Math.PI*2); this.ctx.fill();
        }
        this.ctx.restore();
    }

    updateLocalClearCount() {
        const key = `clearCount_${this.difficulty}_mul2`;
        localStorage.setItem(key, (parseInt(localStorage.getItem(key)||0)+1));
        this.updateClearCounts();
    }
    updateClearCounts() {
        ['easy', 'normal', 'hard'].forEach(d => {
            const c = localStorage.getItem(`clearCount_${d}_mul2`)||0;
            document.getElementById(`count-${d}`).textContent = `${c}回クリア`;
            document.getElementById(`crown-${d}`).textContent = c>=10?'👑':c>=5?'🥈':c>=1?'🥉':'';
        });
    }
    async saveScore(score) {
        let nameToSave = "ななしさん";
        if (this.currentPlayerIndex >= 0 && this.currentPlayerIndex < this.playerList.length) {
            nameToSave = this.playerList[this.currentPlayerIndex];
        }

        let ranks = JSON.parse(localStorage.getItem(`ranking_local_${this.collectionName}`) || "{}");
        if(!ranks[this.difficulty]) ranks[this.difficulty] = [];
        ranks[this.difficulty].push({name: nameToSave, score: score, date: new Date().toISOString()});
        ranks[this.difficulty].sort((a,b)=>b.score-a.score);
        ranks[this.difficulty] = ranks[this.difficulty].slice(0,10);
        localStorage.setItem(`ranking_local_${this.collectionName}`, JSON.stringify(ranks));
        
        if(db && this.user) {
             try {
                 await db.collection(this.collectionName).add({
                     uid: this.user.uid,
                     displayName: nameToSave, 
                     score: score, difficulty: this.difficulty,
                     timestamp: firebase.firestore.FieldValue.serverTimestamp()
                 });
             } catch(e) { console.error("Score save error:", e); }
        }
    }

    toggleRankingPopup(show) {
        document.getElementById('ranking-popup').classList.toggle('hidden', !show);
        document.getElementById('ranking-popup').classList.toggle('active', show);
        if(show) this.loadRankingData();
    }
    switchRankingTab(mode) {
        this.rankingMode = mode;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.textContent.includes(mode==='local'?'ローカル':'ワールド')));
        this.loadRankingData();
    }
    async loadRankingData() {
        ['easy', 'normal', 'hard'].forEach(diff => {
            const list = document.getElementById(`rank-list-${diff}`);
            list.innerHTML = '<div style="text-align:center; margin-top:10px;">ロード中...</div>';
            this.getRanking(diff).then(data => {
                list.innerHTML = '';
                if(data.length===0) list.innerHTML = '<div style="text-align:center; padding:10px; color:#ddd;">記録なし</div>';
                data.forEach((r, i) => {
                    list.innerHTML += `<div class="rank-item"><span>${i+1}. ${r.name}</span><span class="rank-score">${r.score}</span></div>`;
                });
            });
        });
    }
    async getRanking(diff) {
        if(this.rankingMode === 'local') {
            const ranks = JSON.parse(localStorage.getItem(`ranking_local_${this.collectionName}`) || "{}");
            return ranks[diff] || [];
        } else {
            if(!db) return [{name:"オフライン", score:0}];
            try {
                const q = await db.collection(this.collectionName)
                    .where('difficulty','==',diff)
                    .orderBy('score','desc')
                    .limit(10)
                    .get();
                return q.docs.map(d => ({name: d.data().displayName, score: d.data().score}));
            } catch(e) {
                console.error(e);
                return [{name:"取得エラー", score:0}];
            }
        }
    }

    createParticles(x, y, n, c) { for(let i=0;i<n;i++) this.particles.push({x,y,vx:(Math.random()-0.5)*10,vy:(Math.random()-0.5)*10,life:30,size:Math.random()*5+2,color:c,alpha:1}); }
    addFloatText(t, x, y, s, c) { this.floatTexts.push({text:t,x,y,size:s,color:c,life:60}); }
}

const game = new Game();
</script>
</body>
</html>
