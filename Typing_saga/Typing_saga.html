// ログイン監視とコレクション同期
auth.onAuthStateChanged(user => {
    currentUser = user;
    
    // HTML側のログインUI制御 (もしあれば)
    const loginBtn = document.getElementById('google-login-btn');
    const welcome = document.getElementById('welcome-msg');
    
    if (user) {
        if(loginBtn) loginBtn.style.display = 'none';
        if(welcome) {
            welcome.style.display = 'block';
            welcome.textContent = `Welcome, ${user.displayName}!`;
        }

        // ★重要: クラウドからコレクションを取得してローカルと統合
        db.collection("users").doc(user.uid).get().then((doc) => {
            if (doc.exists) {
                const cloudData = doc.data();
                if (cloudData.collection) {
                    // 1. 現在のローカルデータを取得
                    let currentLocal = { weapons: [], armors: [] };
                    
                    // gameStateがあればそこから、なければlocalStorageから
                    if (typeof gameState !== 'undefined' && gameState.collection) {
                        currentLocal = gameState.collection;
                    } else {
                        const saved = localStorage.getItem('myGame_collection');
                        if (saved) currentLocal = JSON.parse(saved);
                    }

                    // 2. マージ (重複排除)
                    const mergedWeapons = Array.from(new Set([...currentLocal.weapons, ...cloudData.collection.weapons]));
                    const mergedArmors = Array.from(new Set([...currentLocal.armors, ...cloudData.collection.armors]));
                    
                    const newCollection = { weapons: mergedWeapons, armors: mergedArmors };

                    // 3. gameState と localStorage の両方を更新
                    if (typeof gameState !== 'undefined') {
                        gameState.collection = newCollection;
                    }
                    localStorage.setItem('myGame_collection', JSON.stringify(newCollection));
                    
                    console.log("Collection synced and saved to local.");
                }
            }
        });

    } else {
        if(loginBtn) loginBtn.style.display = 'block';
        if(welcome) welcome.style.display = 'none';
    }
});
