<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Typing Saga</title>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=MedievalSharp&family=Pinyon+Script&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #1a1a1a;
            background-image: 
                linear-gradient(45deg, #2b2b2b 25%, transparent 25%), 
                linear-gradient(-45deg, #2b2b2b 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #2b2b2b 75%), 
                linear-gradient(-45deg, transparent 75%, #2b2b2b 75%);
            background-size: 20px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'DotGothic16', sans-serif;
            overflow: hidden;
            user-select: none;
            color: white;
        }

        #game-container {
            position: relative;
            width: 960px;
            height: 640px;
            box-shadow: 0 0 0 4px #555, 0 10px 20px rgba(0,0,0,0.5);
            background-color: #111;
            image-rendering: pixelated;
            transform-origin: center center;
        }

        canvas {
            display: block;
            background-color: #111;
        }

        #login-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .mc-btn {
            background-color: #777;
            border: 2px solid;
            border-color: #aaa #444 #444 #aaa;
            color: #fff;
            padding: 15px 30px;
            font-size: 20px;
            cursor: pointer;
            font-family: 'DotGothic16', sans-serif;
            margin: 10px;
            text-shadow: 2px 2px #000;
        }
        .mc-btn:active {
            border-color: #444 #aaa #aaa #444;
            transform: translateY(2px);
        }
        .mc-btn:hover {
            background-color: #888;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="data.js"></script>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas" width="960" height="640"></canvas>
    
    <div id="login-overlay">
        <h2 style="text-shadow: 2px 2px #000; color: #eee;">ログインが必要です</h2>
        <button class="mc-btn" id="google-login-btn">Googleでログイン</button>
        <button class="mc-btn" style="font-size:16px; width:200px;" onclick="document.getElementById('login-overlay').style.display='none'">ログインせず遊ぶ</button>
    </div>
</div>

<script>
/**
 * Math Craft: Typing Saga
 */

// Firebase設定
const firebaseConfig = {
  apiKey: "AIzaSyBCg5dCEM89UmYYhfGqVeRf_VrUlg8_o-4",
  authDomain: "math-braves.firebaseapp.com",
  projectId: "math-braves",
  storageBucket: "math-braves.firebasestorage.app",
  messagingSenderId: "217117619290",
  appId: "1:217117619290:web:d227feb603970d3948d463"
};

let db, auth;
let currentUser = null;

if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    auth = firebase.auth();
} else {
    firebase.app();
    db = firebase.firestore();
    auth = firebase.auth();
}

// ログイン状態の監視とコレクションの読み込み
// ログイン監視とコレクション同期
auth.onAuthStateChanged(user => {
    currentUser = user;
    
    // HTML側のログインUI制御 (もしあれば)
    const loginBtn = document.getElementById('google-login-btn');
    const welcome = document.getElementById('welcome-msg');
    
    if (user) {
        if(loginBtn) loginBtn.style.display = 'none';
        if(welcome) {
            welcome.style.display = 'block';
            welcome.textContent = `Welcome, ${user.displayName}!`;
        }

        // ★重要: クラウドからコレクションを取得してローカルと統合
        db.collection("users").doc(user.uid).get().then((doc) => {
            if (doc.exists) {
                const cloudData = doc.data();
                if (cloudData.collection) {
                    // 1. 現在のローカルデータを取得
                    let currentLocal = { weapons: [], armors: [] };
                    
                    // gameStateがあればそこから、なければlocalStorageから
                    if (typeof gameState !== 'undefined' && gameState.collection) {
                        currentLocal = gameState.collection;
                    } else {
                        const saved = localStorage.getItem('myGame_collection');
                        if (saved) currentLocal = JSON.parse(saved);
                    }

                    // 2. マージ (重複排除)
                    const mergedWeapons = Array.from(new Set([...currentLocal.weapons, ...cloudData.collection.weapons]));
                    const mergedArmors = Array.from(new Set([...currentLocal.armors, ...cloudData.collection.armors]));
                    
                    const newCollection = { weapons: mergedWeapons, armors: mergedArmors };

                    // 3. gameState と localStorage の両方を更新
                    if (typeof gameState !== 'undefined') {
                        gameState.collection = newCollection;
                    }
                    localStorage.setItem('myGame_collection', JSON.stringify(newCollection));
                    
                    console.log("Collection synced and saved to local.");
                }
            }
        });

    } else {
        if(loginBtn) loginBtn.style.display = 'block';
        if(welcome) welcome.style.display = 'none';
    }
});

// --- Game State ---

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
ctx.imageSmoothingEnabled = false;

// 画像読み込みヘルパー
function createImage(src) {
    const img = new Image();
    img.onerror = () => { img.error = true; };
    img.src = src;
    return img;
}

// 背景画像
const bgImages = {
    1: createImage("images/haikei_1.png"),
    2: createImage("images/haikei_2.png"),
    3: createImage("images/haikei_3.png"),
    4: createImage("images/haikei_4.png"),
    5: createImage("images/haikei_5.png"), 
    'Izumi': createImage("images/Izumi.png")
};

// UI画像
const titleBgImage = createImage("images/title.png");
const typingBgImage = createImage("images/tiping.png");
const shopBgImage = createImage("images/shop.png");
const rankingBgImage = createImage("images/ranking.png"); 

// キャラクター画像
// ★修正: Jibun.png(削除済) を Jibun_1.png に変更
const playerImage = createImage("images/Jibun_1.png"); 

// 冒険者選択用画像
const charImages = {};
for (let i = 1; i <= 6; i++) {
    // ★修正: GitHub Pages用に大文字Jを使用 (jibun -> Jibun)
    charImages[i] = createImage(`images/Jibun_${i}.png`);
}

const monsterImages = {
    'Slime': createImage("images/Slime.png"),
    'Ogre': createImage("images/Ogre.png"),
    'Demon': createImage("images/Demon.png"),
    'Undead': createImage("images/Undead.png"),
    'Dragon': createImage("images/Dragon.png"),
    'Kajiya': createImage("images/Kajiya.png"), 
    'Yousei': createImage("images/Yousei.png"), 
    'Takara': createImage("images/Takara.png") 
};

// モンスターの基本データ (更新済み)
const MONSTER_DATA = [
    { name: "スライム", src: "Slime"   , hp: 550, atk: 60, def: 100 },
    { name: "オーガ", src: "Ogre"      , hp: 750, atk: 80, def: 120 },
    { name: "悪魔", src: "Demon"       , hp: 450, atk: 120, def: 80 },
    { name: "アンデッド", src: "Undead", hp: 300, atk: 140, def: 40 },
    { name: "ドラゴン", src: "Dragon"  , hp: 600, atk: 100, def: 150 }
];

const SCENES = { TITLE: 0, TYPING: 2, SHOP: 3, BATTLE: 4, RESULT: 5, FOUNTAIN: 6, EVENT: 7, RANKING: 8, COLLECTION: 9 };

// 冒険者データ管理
let adventurerList = JSON.parse(localStorage.getItem('ts_adventurers') || '[]');
// 5枠確保
while(adventurerList.length < 5) {
    adventurerList.push(null);
}
let currentAdventurer = null; // { name: "...", imgId: 1 }

// コレクションのロード
const savedCollection = JSON.parse(localStorage.getItem('ts_collection') || '{"weapons":[], "armors":[]}');

let gameState = {
    scene: SCENES.TITLE,
    // titleState: 0=TOP, 1=DIFFICULTY, 2=ADV_SELECT, 3=ADV_REGISTER
    titleState: 0, 
    warningMsg: "",
    warningTimer: 0,
    regTemp: { name: "", imgId: 1 }, // 登録中の一時データ
    difficulty: null, 
    maxFloors: 10,
    currentFloor: 1,
    typingScore: 0, 
    player: {
        hp: 500, maxHp: 500, 
        atk: 10,  
        def: 10,  
        gold: 0,
        imgId: 0, // 0ならdefault, 1~6ならjibun_X
        weapon: { name: "きのえだ", atk: 3, crit: 0, hit: 100, plus: 0 }, 
        armor: { name: "ふだんぎ", def: 1, guardHalf: 0, guardFull: 0, plus: 0 },
        hpUpCount: 0 
    },
    enemy: null,
    typing: {
        isWaitingForStart: true,
        timeLeft: 30,
        currentWord: "",
        inputBuffer: "",
        score: 0,
        typedLog: "",
        showTable: false,
        tablePage: 0,
        wordDeck: []
    },
    shop: {
        weapons: [], 
        armors: [],  
        fruits: [],  
    },
    battle: {
        timer: 0,
        phase: 'start', 
        floatingTexts: [],
        shake: 0, 
        flash: 0,
        isFastForward: false
    },
    event: {
        type: null, 
        msg: "",
        choices: [],
        finished: false
    },
    resultPhase: 0,
    // コレクション管理
    collection: {
        weapons: savedCollection.weapons || [], 
        armors: savedCollection.armors || [],
        scrollY: 0
    }
};

// ★修正: 消えていた startGame 関数をここに復活させました
function startGame(diff) {
    gameState.difficulty = diff;
    gameState.maxFloors = (diff + 1) * 10;
    gameState.currentFloor = 1;
    gameState.player.hp = 500; gameState.player.maxHp = 500; 
    gameState.player.atk = 10; gameState.player.def = 10;
    gameState.typingScore = 0; 
    gameState.player.hpUpCount = 0; 
    
    // 一時停止フラグの初期化
    gameState.typing.isPaused = false;
    
    if (currentAdventurer) {
        gameState.player.imgId = currentAdventurer.imgId;
        // 冒険者の名前をプレイヤー名に反映
        gameState.player.name = currentAdventurer.name;
    } else {
        gameState.player.imgId = 0; 
        gameState.player.name = "勇者";
    }

    if (diff === 0) gameState.player.gold = 1000;
    else if (diff === 1) gameState.player.gold = 500;
    else gameState.player.gold = 0;

    gameState.player.weapon = { name: "きのえだ", atk: 3, crit: 0, hit: 100, plus: 0 };
    gameState.player.armor = { name: "ふだんぎ", def: 1, guardHalf: 0, guardFull: 0, plus: 0 };
    
    gameState.scene = SCENES.TYPING;
    typingEngine.refillDeck(); 
    typingEngine.reset();
}

let rankingState = {
    difficulty: 0,
    mode: 'local',
    data: []
};
