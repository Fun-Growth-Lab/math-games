<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Math Sugoroku - Fun & Growth Lab</title>
    
    <style>
        /* --- Âü∫Êú¨Ë®≠ÂÆö --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden;
            font-family: 'M PLUS Rounded 1c', 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
            background-color: #333; /* ËÉåÊôØËâ≤ */
            user-select: none; touch-action: none;
            position: relative;
        }

        /* „Ç≤„Éº„É†ÂÖ®‰Ωì„ÅÆ„Ç≥„É≥„ÉÜ„ÉäÔºà1280x720 Âõ∫ÂÆöËß£ÂÉèÂ∫¶„ÉªÁµ∂ÂØæÈÖçÁΩÆÔºâ */
        #game-root {
            width: 1280px; 
            height: 720px;
            position: absolute;
            top: 50%;
            left: 50%;
            /* transform„ÅØJS„ÅßÂà∂Âæ° */
            
            background-color: #FFF9C4; /* Êòé„Çã„ÅÑ„Ç´„Çπ„Çø„Éº„Éâ„ÇØ„É™„Éº„É†Ëâ≤ */
            background-image: radial-gradient(#FFCC80 20%, transparent 20%);
            background-size: 20px 20px; /* „Éâ„ÉÉ„ÉàÊüÑ */
            color: #5D4037; 
            box-shadow: 0 0 50px rgba(0,0,0,0.5); /* ÊµÆ„ÅçÂá∫„ÅóÂäπÊûú */
            overflow: hidden;
        }

        /* „É°„Ç§„É≥„É¨„Ç§„Ç¢„Ç¶„ÉàÔºà„É´„Éº„ÉàÂÜÖ„Åß100%Ôºâ */
        #main-wrapper { 
            display: flex; 
            width: 100%; height: 100%; 
            padding: 6px; box-sizing: border-box; gap: 6px; 
        }

        /* --- Â∑¶„Éë„Éç„É´Ôºö„ÅÇ„Åù„Å≥„Åã„Åü --- */
        #side-panel-left {
            flex: 19; /* ÂÖ®‰Ωì„ÅÆÁ¥Ñ19% */
            background-color: #ffffff; 
            border: 3px solid #FFAB91;
            border-radius: 12px; 
            color: #5D4037;
            padding: 8px;
            box-sizing: border-box; display: flex; flex-direction: column;
            z-index: 10;
            font-size: 11px;
            overflow: hidden;
            box-shadow: 2px 2px 0px rgba(255, 171, 145, 0.4);
        }
        #side-panel-left h2 { 
            margin-top: 2px; font-size: 16px;
            color: #FF7043;
            text-align: center;
            border-bottom: 2px dashed #FFCC80;
            padding-bottom: 4px; margin-bottom: 6px;
            text-shadow: 1px 1px 0 #fff;
        }
        #side-panel-left ul { padding-left: 14px; line-height: 1.4; margin: 6px 0; }
        #side-panel-left li { margin-bottom: 3px; list-style-type: 'üç©'; padding-left: 2px; }
        #side-panel-left li::marker { color: #FFA726; font-size: 10px;}

        .instruction-box { 
            background: #FFF3E0; 
            padding: 8px; 
            border-radius: 8px; 
            margin-bottom: 6px; 
            text-align: center;
            border: 2px solid #FFE0B2;
        }
        hr { border: 0; border-top: 2px dashed #FFCC80; width: 100%; margin: 6px 0; }
        #side-panel-left p { margin: 4px 0; font-weight: bold; color: #E64A19; text-align: center; }

        /* --- ‰∏≠Â§Æ„Éë„Éç„É´Ôºö„Ç≤„Éº„É†ÁîªÈù¢ --- */
        #game-container {
            flex: 60; /* ÂÖ®‰Ωì„ÅÆÁ¥Ñ60% */
            display: flex; flex-direction: column;
            background-color: #E1F5FE;
            border: 3px solid #4FC3F7;
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            box-shadow: 3px 3px 0px rgba(79, 195, 247, 0.4);
        }

        /* „Ç≠„É£„É≥„Éê„Çπ */
        #game-canvas {
            background-color: transparent; 
            width: 100%; flex-grow: 1;
        }

        /* ÊÆã„ÇäÊôÇÈñìË°®Á§∫ */
        #top-timer-container {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            background: #FFEB3B;
            padding: 4px 30px;
            border-radius: 30px; 
            box-shadow: 0 3px 0 #FBC02D, 0 4px 8px rgba(0,0,0,0.1); 
            text-align: center; z-index: 50; 
            border: 3px solid #fff;
            min-width: 120px;
        }
        #top-timer-label { font-size: 12px; color: #F57F17; font-weight: bold; letter-spacing: 1px;}
        #top-timer-value { font-size: 38px; font-weight: 900; color: #E65100; line-height: 1; font-family: 'M PLUS Rounded 1c', sans-serif; text-shadow: 2px 2px 0 #fff;}

        /* „É°„ÉÉ„Çª„Éº„Ç∏„Ç®„É™„Ç¢ */
        #central-message-area {
            position: absolute; 
            bottom: 220px; 
            top: auto;
            left: 50%; transform: translateX(-50%); width: 90%;
            pointer-events: none; text-align: center; z-index: 60;
            height: 60px; display: flex; justify-content: center; align-items: center;
        }
        #central-message-text {
            font-size: 24px; font-weight: 900; color: #fff;
            background: #FF4081;
            padding: 15px 40px;
            border-radius: 50px; 
            box-shadow: 0 4px 0 #C2185B, 0 8px 15px rgba(0,0,0,0.2);
            white-space: nowrap; opacity: 0; transition: transform 0.2s, opacity 0.2s;
            border: 4px solid #fff;
            transform: scale(0.5);
        }
        #central-message-text.visible { opacity: 1; transform: scale(1); }

        /* --- Âè≥„Éë„Éç„É´ÔºöÊÉÖÂ†±„Å®„Çπ„Ç≠„É´ --- */
        #side-panel-right {
            flex: 21; /* ÂÖ®‰Ωì„ÅÆÁ¥Ñ21% */
            background-color: #ffffff; 
            border: 3px solid #4DD0E1; 
            border-radius: 12px;
            color: #5D4037;
            padding: 10px;
            box-sizing: border-box; display: flex; flex-direction: column;
            z-index: 20; overflow: hidden;
            box-shadow: 2px 2px 0px rgba(77, 208, 225, 0.4);
        }

        .panel-section { margin-bottom: 12px; border-bottom: 2px dashed #B2EBF2; padding-bottom: 8px; }
        .panel-title { font-size: 12px; font-weight: bold; color: #0097A7; margin-bottom: 8px; display: flex; align-items: center; gap: 4px; letter-spacing: 0.5px;}
        
        .status-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 6px; font-size: 12px; }
        .status-val { font-size: 18px; font-weight: 900; color: #5D4037; font-family: 'M PLUS Rounded 1c', monospace; }
        #point-val { color: #FF9800; text-shadow: 1px 1px 0 #FFE0B2; }
        #gem-val { color: #00BCD4; text-shadow: 1px 1px 0 #E0F7FA; }

        .skill-btn {
            display: block; width: 100%; padding: 8px 10px; margin-bottom: 8px;
            background: #fff; 
            border: 2px solid #26C6DA; border-bottom-width: 4px;
            color: #00838F;
            border-radius: 10px; 
            font-size: 11px; font-weight: bold; cursor: pointer;
            text-align: left; 
            transition: all 0.1s;
            position: relative;
        }
        .skill-btn:hover { background-color: #E0F7FA; transform: translateY(-1px); }
        .skill-btn:active { transform: translateY(3px); border-bottom-width: 1px; }
        .skill-btn:disabled {
            background: #ECEFF1; border-color: #CFD8DC; color: #B0BEC5; cursor: not-allowed; transform: none; border-bottom-width: 3px;
        }
        .skill-cost { float: right; font-size: 10px; background: #26C6DA; color: white; padding: 1px 6px; border-radius: 8px; font-weight: bold;}
        .skill-btn:disabled .skill-cost { background: #B0BEC5; }

        #collection-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px;
            padding: 0 2px;
        }
        .collection-item {
            width: 100%; aspect-ratio: 1; 
            background: #FAFAFA;
            border: 1px solid #EEEEEE;
            border-radius: 6px;
            display: flex; justify-content: center; align-items: center; 
            font-size: 16px;
            opacity: 0.5; filter: grayscale(80%); transition: all 0.3s;
        }
        .collection-item.collected {
            opacity: 1; filter: grayscale(0%); 
            background: #FFF8E1; 
            border: 1px solid #FFC107;
            box-shadow: 0 2px 0 #FFC107;
            transform: translateY(-1px);
        }

        /* ÊâãÊú≠„Ç®„É™„Ç¢ (È´ò„ÅïË™øÊï¥) */
        #hand-area {
            height: 200px;
            width: 100%; background-color: rgba(255,255,255,0.8);
            border-top: 3px solid #4FC3F7;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 20;
            position: relative;
            backdrop-filter: blur(5px);
        }

        #hand-message { 
            font-size: 30px;
            color: #5D4037; margin-bottom: 15px; font-weight: 900; 
            background: #fff; 
            padding: 8px 40px; border-radius: 50px;
            font-family: 'M PLUS Rounded 1c', monospace; 
            border: 4px solid #FFAB91;
            min-width: 150px; text-align: center;
            box-shadow: 0 4px 0 #FFAB91;
        }
        #hand-cards-container { display: flex; gap: 15px; padding: 5px; align-items: center; }

        .card {
            width: 70px; height: 90px;
            background-color: white; 
            background-image: repeating-linear-gradient(45deg, #fff, #fff 10px, #FAFAFA 10px, #FAFAFA 20px);
            border: 3px solid #8D6E63; 
            border-radius: 12px; display: flex; justify-content: center; align-items: center;
            font-size: 36px; font-weight: 900; color: #5D4037; cursor: pointer;
            box-shadow: 0 6px 0 #6D4C41; 
            transition: transform 0.1s;
            user-select: none;
            position: relative;
        }
        .card::after { content:''; position:absolute; top:3px; left:3px; right:3px; bottom:3px; border: 2px dashed #D7CCC8; border-radius: 8px; pointer-events: none;}
        .card:active { transform: translateY(6px); box-shadow: none; border-color: #8D6E63;}
        .card:hover { border-color: #FF7043; color: #FF7043; box-shadow: 0 6px 0 #E64A19; top: -3px; }

        /* --- „Ç™„Éº„Éê„Éº„É¨„Ç§ÂÖ±ÈÄö --- */
        .overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255, 249, 196, 0.9); display:flex; justify-content:center; align-items:center; z-index:100; backdrop-filter: blur(5px);}
        
        #result-screen .overlay-content {
            text-align: center; 
            background:#fff; padding: 30px 50px; 
            border-radius: 30px; 
            box-shadow: 0 10px 0 #E0E0E0, 0 20px 40px rgba(0,0,0,0.1); 
            max-width: 600px; width: 90%;
            border: 5px solid #FFCC80; 
            max-height: 90vh; overflow-y: auto;
        }

        /* „É©„É≥„Ç≠„É≥„Ç∞ÁîªÈù¢Áî®„Çπ„Çø„Ç§„É´ */
        #ranking-screen {
            position: absolute; top:0; left:0; width:100%; height:100%; 
            background:#FFF3E0; 
            display:flex; justify-content:center; align-items:center; z-index:110;
        }
        #ranking-content {
            width: 80%; max-width: 1000px; height: 85%;
            display: flex; flex-direction: column;
            color: #5D4037;
        }
        .ranking-header { text-align: center; margin-bottom: 20px; font-size: 32px; color: #FF9800; font-weight: 900; letter-spacing: 2px; text-shadow: 2px 2px 0 #fff; -webkit-text-stroke: 1px #E65100;}
        
        /* „É©„É≥„Ç≠„É≥„Ç∞„Çø„Éñ */
        .ranking-tabs { display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; }
        .rank-tab {
            padding: 10px 30px; border-radius: 30px; border: 3px solid #B0BEC5;
            background: #fff; color: #90A4AE; cursor: pointer; font-weight: bold; font-size: 14px;
            transition: all 0.2s; box-shadow: 0 4px 0 #CFD8DC;
        }
        .rank-tab:active { transform: translateY(4px); box-shadow: none; }
        .rank-tab.active {
            background: #FFCA28; color: #fff; border-color: #FFCA28;
            box-shadow: 0 4px 0 #FFB300;
        }

        .ranking-columns { display: flex; justify-content: space-between; gap: 15px; height: 100%; overflow: hidden; }
        
        .ranking-col {
            flex: 1; 
            background: #fff;
            border: 4px solid #eee;
            border-radius: 20px;
            display: flex; flex-direction: column;
            padding: 15px;
            box-shadow: 0 5px 0 #ddd;
        }
        /* Á¥ö„Åî„Å®„ÅÆËâ≤ÂàÜ„Åë */
        #rank-col-easy { border-color: #A5D6A7; }
        #rank-col-easy .rank-col-header { color: #4CAF50; border-bottom: 2px dashed #A5D6A7; }
        #rank-col-normal { border-color: #90CAF9; }
        #rank-col-normal .rank-col-header { color: #2196F3; border-bottom: 2px dashed #90CAF9; }
        #rank-col-hard { border-color: #EF9A9A; }
        #rank-col-hard .rank-col-header { color: #F44336; border-bottom: 2px dashed #EF9A9A; }

        .rank-col-header {
            text-align: center; font-size: 20px; font-weight: 900; padding-bottom: 10px; margin-bottom: 10px;
        }

        .rank-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        .rank-item {
            display: flex; justify-content: space-between; padding: 10px 5px;
            border-bottom: 2px dotted #eee; font-size: 14px;
        }
        .rank-item:last-child { border-bottom: none; }
        .rank-num { width: 25px; color: #90A4AE; font-weight: bold; }
        .rank-score { font-weight: 900; color: #5D4037; text-align: right; flex-grow: 1; }
        .rank-name { font-size: 12px; color: #795548; width: 70px; text-align: right; margin-left: 5px; display: flex; align-items: center; justify-content: flex-end; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;}
        .rank-date { font-size: 10px; color: #B0BEC5; width: 70px; text-align: right; margin-left: 5px; display: flex; align-items: center; justify-content: flex-end;}

        #title-screen { background: rgba(255,255,255,0.5); }
        #title-screen .overlay-content {
            text-align: center; max-width: 900px; width: 100%; padding: 20px; box-shadow: none; border: none; background: transparent;
        }

        #char-screen .overlay-content {
            text-align: center; background:#fff; padding: 25px;
            border-radius: 25px; box-shadow: 0 10px 0 #eee;
            max-width: 500px; width: 90%;
            border: 4px solid #FFAB91;
        }

        .hidden { display: none !important; }
        
        /* „Éù„ÉÉ„Éó„Å™„Éú„Çø„É≥ÂÖ±ÈÄö */
        .btn { 
            padding: 12px 0; font-size: 18px; border: 3px solid #fff; border-radius: 30px; 
            cursor: pointer; color: white; margin: 5px; font-weight: 900; width: 100%; 
            transition: transform 0.1s; 
            box-shadow: 0 5px 0 rgba(0,0,0,0.1); 
            text-shadow: 1px 1px 0 rgba(0,0,0,0.2);
            position: relative;
        }
        .btn:active { transform: translateY(5px); box-shadow: none; border-bottom-width: 3px;}
        
        .btn-easy { background: #66BB6A; box-shadow: 0 5px 0 #2E7D32; border-color:#81C784; }
        .btn-normal { background: #42A5F5; box-shadow: 0 5px 0 #1565C0; border-color:#64B5F6; }
        .btn-hard { background: #EF5350; box-shadow: 0 5px 0 #C62828; border-color:#E57373; }
        .btn-gray { background: #B0BEC5; color: white; box-shadow: 0 5px 0 #78909C; border-color:#CFD8DC; }
        .btn-yellow { background-color: #FFCA28; color: #5D4037; box-shadow: 0 5px 0 #FF6F00; border-color:#FFD54F; text-shadow:none;}
        .btn-google { background-color: #DB4437; box-shadow: 0 5px 0 #8F251D; border-color:#E57373; }

        .title-header { margin-bottom: 40px; transform: rotate(-2deg); }
        .title-main { 
            font-family: 'M PLUS Rounded 1c', sans-serif;
            font-weight: 900;
            font-size: 80px; color: #FFEB3B; margin: 0; text-transform: uppercase; letter-spacing: 2px;
            -webkit-text-stroke: 4px #FF7043;
            text-shadow: 5px 5px 0 rgba(0,0,0,0.1); 
        }
        .title-sub { font-size: 20px; color: #5D4037; margin-top: 15px; font-weight: 900; background: #fff; display: inline-block; padding: 6px 25px; border-radius: 20px; border: 3px solid #FF7043;}
        
        .level-select-container { display: flex; justify-content: center; gap: 20px; margin: 30px 0; }
        .level-box { display: flex; flex-direction: column; align-items: center; width: 140px; }
        .clear-count-label { margin-top: 8px; font-size: 13px; color: #795548; font-weight: bold; background: #FFF3E0; padding: 4px 12px; border-radius: 10px;}

        .bottom-actions { display: flex; flex-direction: column; align-items: center; gap: 10px; max-width: 320px; margin: 0 auto; }
        .action-row { display: flex; gap: 10px; width: 100%; justify-content: center; margin-top: 5px; }

        #login-status-text { font-size:13px; color:#795548; margin-top:5px; font-weight: bold; }

        #char-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px auto; 
            max-width: 320px; justify-content: center;
        }
        .char-btn {
            width: 70px; height: 70px; font-size: 40px; padding: 0;
            border: 3px solid #eee; border-radius: 15px; background: #fff; cursor: pointer;
            transition: transform 0.1s, background 0.2s; box-shadow: 0 4px 0 #ddd;
            display: flex; justify-content: center; align-items: center;
        }
        .char-btn:hover { background: #FFF3E0; border-color: #FFB74D; box-shadow: 0 4px 0 #FFB74D; }
        .char-btn:active { transform: translateY(4px); box-shadow: none; }

        /* ÂêçÂâçÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ */
        #name-input-container { margin-bottom: 15px; }
        #nickname-input {
            font-size: 20px; padding: 10px; text-align: center;
            border: 3px solid #FFAB91; border-radius: 15px;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            color: #5D4037; width: 80%; outline: none;
        }
        #nickname-input::placeholder { color: #D7CCC8; }
        
        .result-row { display: flex; justify-content: space-between; font-size: 20px; margin-bottom: 12px; border-bottom: 2px dashed #FFE0B2; padding-bottom: 8px;}
        .result-label { color: #8D6E63; font-weight: bold;}
        .result-val { font-weight: 900; color: #5D4037; }
        .result-total { display: flex; justify-content: space-between; font-size: 40px; color: #E91E63; margin-top: 25px; border-top: 5px solid #FFD54F; padding-top: 15px; text-shadow: 2px 2px 0 rgba(0,0,0,0.1);}

    </style>
</head>
<body>

    <div id="game-root">
        <div id="main-wrapper">
            <div id="side-panel-left">
                <h2>„ÅÇ„Åù„Å≥„Åã„Åü</h2>
                <div class="instruction-box">
                    <strong style="color:#E64A19; font-size:14px;">100„Åæ„Åß„ÅÑ„Å£„Åü„Çâ„Ç¥„Éº„É´ÔºÅ</strong>
                </div>
                <ul>
                    <li><strong>„Åò„Åã„Çì„Åé„Çå„Å´„Å™„Çã„Å®<br>„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº</strong></li>
                </ul>
                <p><strong>„ÅÑ„Çç„ÅÑ„Çç„Å™„Éû„Çπ</strong></p>
                <ul>
                    <li>‚è∞: „Åò„Åã„Çì„Åã„ÅÑ„Åµ„Åè</li>
                    <li>üéÅ: „Éù„Ç§„É≥„Éà</li>
                    <li>üëª: „Åä„Å∞„Åë(„Éû„Ç§„Éä„Çπ)</li>
                    <li>üíé: „Åª„ÅÜ„Åõ„Åç</li>
                </ul>
                <hr>
                <p><strong>„Éú„Éº„Éä„ÇπÔºÅ</strong></p>
                <ul>
                    <li>10,20‚Ä¶„Çí„Åì„Åà„Çã„Å®<br><strong style="color:#FF9800;">+100„Éù„Ç§„É≥„Éà</strong></li>
                    <li>„Å¥„Å£„Åü„Çä„Å®„Åæ„Çã„Å®<br><strong style="color:#E91E63;">+200„Éù„Ç§„É≥„Éà</strong></li>
                    <li>„Ç¥„Éº„É´„Å¥„Å£„Åü„Çä„ÅØ<br><strong style="color:#E91E63;">+1000„Éù„Ç§„É≥„Éà!</strong></li>
                </ul>
                <hr>
                <ul>
                    <li><strong>16„Åó„ÇÖ„Çã„ÅÑ„ÅÆ„Ç¢„Ç§„ÉÜ„É†<br>„ÅÑ„Åè„Å§„Å≤„Çç„Åà„Çã„Åã„Å™Ôºü</strong></li>
                    <li><strong>üíé„Åå„ÅÇ„Çå„Å∞<br>„Å®„Åè„Åó„ÇÖ„ÅÆ„ÅÜ„Çä„Çá„Åè„Åå<br>„Å§„Åã„Åà„Çã„ÅûÔºÅ</strong></li>
                </ul>
                <button class="btn btn-gray" onclick="location.reload()" style="margin-top:auto; width:95%; font-size:12px; padding:8px;">„Çø„Ç§„Éà„É´„Å∏</button>
            </div>

            <div id="game-container">
                <div id="top-timer-container">
                    <div id="top-timer-label">„ÅÆ„Åì„Çä„Åò„Åã„Çì</div>
                    <div id="top-timer-value">10</div>
                </div>

                <canvas id="game-canvas"></canvas>
                
                <div id="central-message-area">
                    <div id="central-message-text"></div>
                </div>

                <div id="hand-area">
                    <div id="hand-message" style="font-size:24px; min-width:280px;">„Åì„Åì„Å´„Åë„ÅÑ„Åï„Çì„Åå„Å≤„Çá„ÅÜ„Åò„Åï„Çå„Çã„Çà</div>
                    <div id="hand-cards-container"></div>
                </div>

                <div id="title-screen" class="overlay">
                    <div class="overlay-content">
                        <div class="title-header">
                            <h1 class="title-main">Math Sugoroku</h1>
                            <div class="title-sub">„Åü„Åó„Åñ„Çì„Åó„Å™„Åå„ÇâÔºëÔºêÔºê„Çí„ÇÅ„Åñ„ÅõÔºÅ<br>„ÅÑ„Çç„Çì„Å™„Éû„Çπ„ÇÑ„Ç¢„Ç§„ÉÜ„É†„Åå„Åß„Å¶„Åè„Çã„ÇàÔºÅ</div>
                        </div>

                        <div class="level-select-container">
                            <div class="level-box">
                                <button class="btn btn-easy" onclick="selectLevel('easy')">„Åó„Çá„Åç„ÇÖ„ÅÜ</button>
                                <div class="clear-count-label"><span id="clear-easy">0</span>Âõû„ÇØ„É™„Ç¢</div>
                            </div>
                            <div class="level-box">
                                <button class="btn btn-normal" onclick="selectLevel('normal')">„Å°„ÇÖ„ÅÜ„Åç„ÇÖ„ÅÜ</button>
                                <div class="clear-count-label"><span id="clear-normal">0</span>Âõû„ÇØ„É™„Ç¢</div>
                            </div>
                            <div class="level-box">
                                <button class="btn btn-hard" onclick="selectLevel('hard')">„Åò„Çá„ÅÜ„Åç„ÇÖ„ÅÜ</button>
                                <div class="clear-count-label"><span id="clear-hard">0</span>Âõû„ÇØ„É™„Ç¢</div>
                            </div>
                        </div>

                        <div class="bottom-actions">
                            <div id="login-status-text">„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì</div>
                            <button id="btn-login-google" class="btn btn-google" onclick="handleGoogleLogin()">Google„Åß„É≠„Ç∞„Ç§„É≥</button>
                            
                            <div class="action-row">
                                <button class="btn btn-yellow" onclick="showFullRanking()" style="flex:1;">„Çπ„Ç≥„Ç¢„Çí„Åø„Çã</button>
                                <button class="btn btn-gray" onclick="window.location.href='../index.html'" style="flex:1;">INDEX„Å∏</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="char-screen" class="overlay hidden">
                    <div class="overlay-content">
                        <h2 style="color:#5D4037; margin-top:0;">„Åä„Å™„Åæ„Åà„Å®„Ç≠„É£„É©„ÇØ„Çø„Éº„Çí„Åà„Çâ„Çì„Åß„Å≠</h2>
                        
                        <div id="name-input-container">
                            <input type="text" id="nickname-input" placeholder="„Åä„Å™„Åæ„Åà (8„ÇÇ„Åò„Åæ„Åß)" maxlength="8">
                        </div>
                        <p style="font-size:12px; color:#E64A19;">‚Äª„Å≤„Çâ„Åå„Å™ „Å® „Äå„Éº„Äç „Å†„Åë „Å§„Åã„Åà„Åæ„Åô</p>

                        <div id="char-grid"></div>
                        <div style="display:flex; flex-direction:column; align-items:center; gap:10px; margin-top:20px;">
                            <button class="btn btn-normal" onclick="pickRandomChar()" style="width:200px;">üé≤ „Åä„Åæ„Åã„Åõ</button>
                            <button class="btn btn-gray" onclick="backToTitle()" style="width:200px;">Êàª„Çã</button>
                        </div>
                    </div>
                </div>

                <div id="result-screen" class="overlay hidden">
                    <div class="overlay-content">
                        <h1 id="result-title" style="font-size:50px; margin:0 0 20px 0; color:#E91E63; -webkit-text-stroke: 2px #fff; text-shadow: 3px 3px 0 rgba(0,0,0,0.1);">„Ç≤„Éº„É†„Çª„ÉÉ„Éà</h1>
                        
                        <div style="text-align:left; width:100%; margin-bottom:20px;">
                            <div class="result-row">
                                <span class="result-label">„Åã„Åè„Å®„Åè„Éù„Ç§„É≥„Éà</span>
                                <span class="result-val" id="res-base">0</span>
                            </div>
                            <div class="result-row">
                                <span class="result-label">„Ç¢„Ç§„ÉÜ„É†„Éú„Éº„Éä„Çπ <span id="res-item-cnt" style="font-size:0.8em;">(0ÂÄã)</span></span>
                                <span class="result-val" style="color:#FF9800;" id="res-item">0</span>
                            </div>
                            <div class="result-row">
                                <span class="result-label">„Çø„Ç§„É†„Éú„Éº„Éä„Çπ <span id="res-time-cnt" style="font-size:0.8em;">(0s)</span></span>
                                <span class="result-val" style="color:#4CAF50;" id="res-time">0</span>
                            </div>
                            <div class="result-row">
                                <span class="result-label">„Åª„ÅÜ„Åõ„Åç„Éú„Éº„Éä„Çπ <span id="res-gem-cnt" style="font-size:0.8em;">(0ÂÄã)</span></span>
                                <span class="result-val" style="color:#00BCD4;" id="res-gem">0</span>
                            </div>
                            
                            <div class="result-total">
                                <span>„Åî„ÅÜ„Åë„ÅÑ</span>
                                <span id="res-final" style="font-weight:900;">0</span>
                            </div>
                        </div>

                        <div style="margin-bottom:20px;">
                             <button class="btn btn-yellow" onclick="showFullRanking()">„É©„É≥„Ç≠„É≥„Ç∞„Çí„Åø„Çã</button>
                        </div>

                        <button class="btn btn-normal" onclick="location.reload()" style="width:220px; font-size:20px; padding:12px;">„Çø„Ç§„Éà„É´„Å∏„ÇÇ„Å©„Çã</button>
                    </div>
                </div>

                <div id="ranking-screen" class="hidden">
                    <div id="ranking-content">
                        <div class="ranking-header">‚òÖ „É©„É≥„Ç≠„É≥„Ç∞ ‚òÖ</div>
                        
                        <div class="ranking-tabs">
                            <button id="tab-local" class="rank-tab active" onclick="switchRankingMode('local')">„É≠„Éº„Ç´„É´</button>
                            <button id="tab-online" class="rank-tab" onclick="switchRankingMode('online')">„Ç™„É≥„É©„Ç§„É≥</button>
                        </div>

                        <div class="ranking-columns">
                            <div class="ranking-col" id="rank-col-easy">
                                <div class="rank-col-header">„Åó„Çá„Åç„ÇÖ„ÅÜ</div>
                                <ul class="rank-list" id="rank-list-easy"></ul>
                            </div>
                            <div class="ranking-col" id="rank-col-normal">
                                <div class="rank-col-header">„Å°„ÇÖ„ÅÜ„Åç„ÇÖ„ÅÜ</div>
                                <ul class="rank-list" id="rank-list-normal"></ul>
                            </div>
                            <div class="ranking-col" id="rank-col-hard">
                                <div class="rank-col-header">„Åò„Çá„ÅÜ„Åç„ÇÖ„ÅÜ</div>
                                <ul class="rank-list" id="rank-list-hard"></ul>
                            </div>
                        </div>
                        <div style="text-align:center; margin-top:20px;">
                            <button class="btn btn-normal" onclick="closeRanking()" style="width:200px;">„Å®„Åò„Çã</button>
                        </div>
                    </div>
                </div>
            
            </div>

            <div id="side-panel-right">
                <div class="panel-section">
                    <div class="panel-title">„Çπ„ÉÜ„Éº„Çø„Çπ</div>
                    <div class="status-row">
                        <span>„É¨„Éô„É´</span> <span id="level-val" style="font-weight:bold;">-</span>
                    </div>
                    <div class="status-row">
                        <span>„Éù„Ç§„É≥„Éà</span> <span id="point-val">0</span>
                    </div>
                    <div class="status-row">
                        <span>üíé „Åª„ÅÜ„Åõ„Åç</span> <span id="gem-val">0</span>
                    </div>
                </div>

                <div class="panel-section">
                    <div class="panel-title">„Å®„Åè„Åó„ÇÖ„ÅÆ„ÅÜ„Çä„Çá„Åè (üíéÊ∂àË≤ª)</div>
                    <button class="skill-btn" onclick="useAbility('change')" id="btn-change" disabled>
                        üÉè ÊâãÊú≠„ÉÅ„Çß„É≥„Ç∏ <span class="skill-cost">üíé1</span>
                    </button>
                    <button class="skill-btn" onclick="useAbility('move1')" id="btn-move1" disabled>
                        üü¢ 1„Éû„Çπ„Åô„Åô„ÇÄ <span class="skill-cost">üíé1</span>
                    </button>
                    <button class="skill-btn" onclick="useAbility('time5')" id="btn-time5" disabled>
                        ‚è∞ „Åò„Åã„Çì +5 <span class="skill-cost">üíé1</span>
                    </button>
                </div>

                <div class="panel-section" style="border-bottom:none;">
                    <div class="panel-title">„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ (<span id="collected-count">0</span>/16)</div>
                    <div id="collection-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, setDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // NG„ÉØ„Éº„Éâ„É™„Çπ„ÉàÔºà„Å≤„Çâ„Åå„Å™Ôºâ
        const NG_WORDS_HIRAGANA = [
            // --- „ÄêÈáçË¶Å„ÄëÊÆ∫ÂÆ≥„ÉªËá™ÊÆ∫„Éª„ÉÜ„É≠„ÉªÁäØÁΩ™ ---
            '„Åó„Å≠', '„Åó„Å¨', '„Åó„Å´', '„Åì„Çç„Åô', '„Åì„Çç„Åõ', '„Åï„Å§„Åå„ÅÑ', '„Åè„Åü„Å∞„Çå',
            '„Åò„Åï„Å§', '„Åé„Åï„Å§', '„Å§„Çã„Åô', '„Çå„Çì„Åü„Çì', '„Åó„Å´„Åü„ÅÑ',
            '„Å¶„Çç', '„Å¶„Çç„Çä„Åô„Å®', '„Å∞„Åè„ÅØ', '„Å∞„Åè„Å†„Çì', '„Åª„ÅÜ„Åã',
            '„ÅØ„Çì„Åñ„ÅÑ', '„Åî„ÅÜ„Å®„ÅÜ', '„ÇÜ„ÅÜ„Åã„ÅÑ', '„Åã„Çì„Åç„Çì', '„Åä„Åù„ÅÜ',
            '„ÇÑ„Åè„Åñ', '„Åº„ÅÜ„Çä„Çá„Åè', '„ÅØ„Çì„Åê„Çå', '„Å°„Çì„Å¥„Çâ', '„Åæ„Åµ„ÅÉ„ÅÇ',
            '„Åü„ÅÑ„Åæ', '„Åæ„ÇÑ„Åè', '„Åã„Åè„Åõ„ÅÑ„Åñ„ÅÑ', '„Åó„ÇÉ„Å∂', '„Å©„Çâ„Å£„Åê', '„Åì„Åã„ÅÑ„Çì',
            '„Å∏„Çç„ÅÑ„Çì', '„Åà„Åè„Åô„Åü„Åó„Éº', '„Å†„Å£„ÅΩ„ÅÜ', '„Åç„ÇÅ„Åõ„Åè',
            '„ÅÑ„Åò„ÇÅ', '„Åé„ÇÉ„Åè„Åü„ÅÑ',

            // --- ÊîªÊíÉ„ÉªÊö¥Ë®Ä„ÉªË™πË¨ó‰∏≠ÂÇ∑ ---
            '„Å∞„Åã', '„ÅÇ„Åª', '„Åæ„Å¨„Åë', '„Åç„Å°„Åå„ÅÑ', '„ÅçÈÅï„ÅÑ',
            '„ÅÜ„Åñ„ÅÑ', '„ÅÜ„Åñ', '„Åç„ÇÇ„ÅÑ', '„Åç„ÇÇ', '„Åç„Åó„Çá„ÅÑ', '„Åç„Åà„Çç',
            '„Åè„Åö', '„Åî„Åø', '„Åî„Åø„ÇÄ„Åó', '„Åã„Åô', '„Åñ„Åì', '„Åú„Å§',
            '„Å∂„Åô', '„Åß„Å∂', '„ÅØ„Åí', '„Å°„Å≥', '„Åß„Å£„Å±', '„ÅÑ„Å™„Åã„ÇÇ„ÅÆ',
            '„ÅÜ„Åò', '„ÅØ„ÅÑ„Åº„Åè', '„Åæ„Åë„ÅÑ„Å¨', '„Åä„Å§„ÇÄ', '„ÅÆ„ÅÜ„Åü„Çä„Çì',
            '„Å¶„ÅÑ„ÅÆ„ÅÜ', '„Å°„Åó„Çá„ÅÜ', '„Åó„Çá„ÅÜ„Åå„ÅÑ', '„Åå„ÅÑ„Åò', '„Åã„Åü„Çè', '„Å≥„Å£„Åì',
            '„ÇÅ„Åè„Çâ', '„Å§„Çì„Åº', '„Åä„Åó', '„Å©„Åò„Çì', '„Åà„Åü', '„Å≤„Å´„Çì',
            '„Åü„Å≤', '„Åü„Å≤„Å≠', // „ÄåÊ≠ª„Å≠„Äç„ÅÆÈö†Ë™û
            '„ÅÜ„Åõ„Çç', '„Å†„Åæ„Çå',

            // --- ÊÄßÁöÑÔºàË∫´‰ΩìÈÉ®‰ΩçÔºâ ---
            '„Å°„Çì„Å°„Çì', '„Å°„Çì„Åì', '„Å°„Çì„ÅΩ', '„Å°„Çì„Åã', '„Åæ„Çâ', '„Åï„Åä',
            '„Åæ„Çì„Åì', '„Åæ„Çì„Åó„ÇÖ„ÅÜ', '„Åæ„Çì„Åí', '„Çè„Çå„ÇÅ', '„Åä„Åæ„Åü',
            '„Åè„Çä', '„Åè„Çä„Å®„Çä„Åô', '„ÅÑ„Çì„Åó„Çì', '„ÅÑ„Çì„Åã„Åè', '„Å≥„Çâ„Å≥„Çâ',
            '„Åì„ÅÜ„Åå„Çì', '„Åü„Åæ„Åç„Çì', '„Åç„Çì„Åü„Åæ', '„Åµ„Åê„Çä',
            '„Åä„Å£„Å±„ÅÑ', '„Å°„Å°', '„Å´„ÇÖ„ÅÜ„Çä„Çì', '„Å´„ÇÖ„ÅÜ„Å®„ÅÜ', '„Åç„Çá„Å´„ÇÖ„ÅÜ', '„Å≤„Çì„Å´„ÇÖ„ÅÜ',
            '„Åë„Å§', '„ÅÇ„Å™„Çã', '„Åì„ÅÜ„ÇÇ„Çì', '„Åë„Å§„ÅÆ„ÅÇ„Å™',

            // --- ÊÄßÁöÑÔºàË°åÁÇ∫„ÉªÁä∂ÊÖãÔºâ ---
            '„Åà„Çç', '„Åà„Å£„Å°', '„Åô„Åë„Åπ', '„Å∏„Çì„Åü„ÅÑ', '„ÇÄ„Å£„Å§„Çä', '„Åó„Åì',
            '„Åõ„Å£„Åè„Åô', '„Åõ„ÅÑ„Åì„ÅÜ', '„Åæ„Åê„Çè„ÅÑ', '„Åù„ÅÜ„Å´„ÇÖ„ÅÜ', '„ÅØ„ÇÅ„Çã',
            '„Åä„Å™„Å´„Éº', '„Åò„ÅÑ', '„Åó„Åì„Åó„Åì', '„Åµ„Åá„Çâ', '„Å±„ÅÑ„Åö„Çä', '„Åè„Çì„Å´',
            '„ÅÑ„Çâ„Åæ', '„Åó„Å£„Åó„Çì', '„Å™„Åã„Å†„Åó', '„Åî„Å£„Åè„Çì', '„Å∂„Å£„Åã„Åë',
            '„Åó„Åä„Åµ„Åç', '„Åú„Å£„Å°„Çá„ÅÜ', '„ÅÑ„Åè', '„ÅÑ„Åã„Åõ„Çç', '„ÅÇ„Åà„Åé',
            '„Å©„ÅÜ„Å¶„ÅÑ', '„Åó„Çá„Åò„Çá', '„ÇÑ„Çä„Åæ„Çì', '„ÇÑ„Çä„Å°„Çì', '„Å≥„Å£„Å°',
            '„Åõ„Åµ„Çå', '„Å±„Åì', '„Å±„Åì„Å±„Åì', '„Çè„ÅÑ„Åõ„Å§', '„Çç„Çä', '„Åó„Çá„Åü', '„Å∫„Å©',
            '„Åç„Çì„Åó„Çì', '„Åò„ÇÖ„ÅÜ„Åã„Çì', '„Çä„Çá„ÅÜ„Åò„Çá„Åè', '„Çâ„Çì„Åì„ÅÜ', '„Åô„Åã„Çì„Å®',
            '„ÅÆ„Éº„Å±„Çì', '„Å±„Çì„Å°„Çâ',

            // --- ÊÄßÁöÑÔºàÁî£Ê•≠„ÉªÁäØÁΩ™„ÉªÈö†Ë™ûÔºâ ---
            '„Çå„ÅÑ„Å∑', '„Åî„ÅÜ„Åã„Çì', '„Å°„Åã„Çì', '„Å®„ÅÜ„Åï„Å§', '„ÅÆ„Åû„Åç', '„Çç„Åó„ÇÖ„Å§',
            '„Åµ„ÅÜ„Åû„Åè', '„Åù„Éº„Å∑', '„Å∏„Çã„Åô', '„Åß„Çä„Å∏„Çã', '„Å¥„Çì„Åï„Çç', '„ÅÑ„ÇÅ„Åè„Çâ',
            '„ÅÇ„Å†„Çã„Å®', '„Åà„Éº„Å∂„ÅÑ', '„Åà„Å∂„ÅÑ', '„ÅΩ„Çã„ÅÆ', '„ÅÜ„Çâ„Å≥„Åß„Åä', '„ÇÄ„Åó„ÇÖ„ÅÜ„Åõ„ÅÑ',
            '„Åà„Çì„Åì„ÅÜ', '„Åà„Çì„Åò„Çá', '„ÅÜ„Çä', '„Åã„ÅÑ„Åó„ÇÖ„Çì', '„Å∞„ÅÑ„Åó„ÇÖ„Çì',
            '„Å±„Å±„Åã„Å§', '„Åæ„Åæ„Åã„Å§', '„ÅÜ„Çä„Åõ„Çì',

            // --- ÊéíÊ≥Ñ„ÉªÊ±öÁâ© ---
            '„ÅÜ„Çì„Åì', '„ÅÜ„Çì„Å°', '„Åè„Åù', '„Åí„Çä', '„Åπ„Çì', '„Åµ„Çì',
            '„Åó„Å£„Åì', '„Åó„Çá„Çì„Åπ„Çì', '„Å´„Çá„ÅÜ', '„Åª„ÅÜ„Å´„Çá„ÅÜ',
            '„Å∏', '„Åä„Å™„Çâ', '„Åí„Çç', '„Åü„Çì',

            // --- ÈÅãÂñ∂„Å™„Çä„Åô„Åæ„Åó„Éª„Ç∑„Çπ„ÉÜ„É† ---
            '„ÅÜ„Çì„Åà„ÅÑ', '„Åì„ÅÜ„Åó„Åç', '„Åô„Åü„Å£„Åµ', '„Åã„Çì„Çä', '„Å±„Å®„Çç„Éº„Çã',
            '„Åò„Åà„ÇÄ', '„Åí„Éº„ÇÄ„Åæ„Åô„Åü„Éº', '„Åæ„Åô„Åü„Éº', '„ÅÇ„Å©„Åø„Çì', '„Åó„Åô„Å¶„ÇÄ',
            '„Åï„Éº„Å∞„Éº', '„ÅÇ„Åã„Å∞„Çì', '„Å∞„Çì', '„Å°„Éº„Å®', '„Å°„Éº„Åü„Éº', '„Å∞„Åê',

            // --- ÂÄã‰∫∫ÊÉÖÂ†±„ÉªÂá∫‰ºö„ÅÑ„ÉªÂ§ñÈÉ®Ë™òÂ∞é ---
            '„Çâ„ÅÑ„Çì', '„Åã„Åã„Åä', '„Åô„Åã„ÅÑ„Å∑', '„ÅÑ„Çì„Åô„Åü', '„Å§„ÅÑ„Å£„Åü„Éº', '„Åß„ÅÉ„Åô„Åì',
            '„Åß„Çì„Çè', '„Å∞„Çì„Åî„ÅÜ', '„Åë„ÅÑ„Åü„ÅÑ', '„ÅÇ„Å©„Çå„Åô', '„ÇÅ„ÅÇ„Å©', '„Åò„ÇÖ„ÅÜ„Åó„Çá',
            '„ÅÇ„Åä', '„ÅÇ„ÅÑ„Åü„ÅÑ', '„Åæ„Å°„ÅÇ„Çè„Åõ', '„Åª„Å¶„Çã', '„Çâ„Å∂„Åª', '„Åä„Åµ„Åã„ÅÑ',
            '„Å±„Åô„Çè„Éº„Å©', '„Å±„Åô', '„ÅÇ„Åã„ÅÜ„Çì„Å®', '„Åì„Åò„Çì„Åò„Çá„ÅÜ„Åª„ÅÜ'
        ];

        // --- FirebaseË®≠ÂÆö ---
        const firebaseConfig = {
            apiKey: "AIzaSyBCg5dCEM89UmYYhfGqVeRf_VrUlg8_o-4",
            authDomain: "math-braves.firebaseapp.com",
            projectId: "math-braves",
            storageBucket: "math-braves.firebasestorage.app",
            messagingSenderId: "217117619290",
            appId: "1:217117619290:web:d227feb603970d3948d463"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        // --- FirebaseÈñ¢ÈÄ£Èñ¢Êï∞ ---
        function handleGoogleLogin() {
            if (currentUser) {
                signOut(auth).then(() => {
                    alert("„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü");
                }).catch((error) => {
                    console.error(error);
                });
            } else {
                const provider = new GoogleAuthProvider();
                signInWithPopup(auth, provider)
                    .then((result) => {
                        console.log("Logged in:", result.user);
                    }).catch((error) => {
                        console.error("Login failed:", error);
                        alert("„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + error.message);
                    });
            }
        }

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            const statusText = document.getElementById("login-status-text");
            const loginBtn = document.getElementById("btn-login-google");

            if (user) {
                statusText.innerText = `„É≠„Ç∞„Ç§„É≥‰∏≠: ${user.displayName}`;
                statusText.style.color = "#43A047";
                statusText.style.fontWeight = "bold";
                loginBtn.innerText = "„É≠„Ç∞„Ç¢„Ç¶„Éà";
                loginBtn.classList.remove("btn-google");
                loginBtn.classList.add("btn-gray");
            } else {
                statusText.innerText = "„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì";
                statusText.style.color = "#8D6E63";
                statusText.style.fontWeight = "normal";
                loginBtn.innerText = "Google„Åß„É≠„Ç∞„Ç§„É≥";
                loginBtn.classList.remove("btn-gray");
                loginBtn.classList.add("btn-google");
            }
        });

        // --- ÂÆöÊï∞„ÉªÂ§âÊï∞ ---
        const ITEMS = ["üõº","üèçÔ∏è","üö≤","üöÄ","üöÅ","üö©","üóº","üåà","ü§ñ","üëì","üíç","üß∏","üéª","üçú","üçπ","‚òÉÔ∏è"];
        const CHARACTERS = ["üê±","üòÑ","üòé","üê∂","üê∞","üêº","üêª‚Äç‚ùÑÔ∏è","üê£","ü¶Å","üêØ","üêÆ","üê∏","üî¥","üü¢","üîµ","üü†"];

        const GOAL_POS = 100;
        const TILES_PER_ROW = 10;
        const TILES_PER_PAGE = 20; 
        
        // „Éô„Éº„ÇπËß£ÂÉèÂ∫¶Ôºà16:9Âõ∫ÂÆöÔºâ
        const BASE_WIDTH = 1280;
        const BASE_HEIGHT = 720;

        let gameState = "title"; 
        let currentPos = 0;
        let points = 0;
        let gems = 0;
        let timeLeft = 10;
        let difficulty = "normal";
        let hand = [];
        let mapData = []; 
        let cameraOffset = 0;
        let collectedItems = [];
        let playerChar = "üê±";
        let selectedLevel = "normal";
        let currentPlayerName = "ÂêçÁÑ°„Åó„Åï„Çì";

        let scrollAnim = { active: false, progress: 0, startOff: 0, targetOff: 0 };
        let messageQueue = [];
        let isDisplayingMessage = false;

        let currentRankingMode = 'local';

        const canvas = document.getElementById("game-canvas");
        const ctx = canvas.getContext("2d");
        const handContainer = document.getElementById("hand-cards-container");
        const msgText = document.getElementById("central-message-text");
        
        const ui = {
            time: document.getElementById("top-timer-value"),
            point: document.getElementById("point-val"),
            gem: document.getElementById("gem-val"),
            level: document.getElementById("level-val"),
            count: document.getElementById("collected-count"),
            grid: document.getElementById("collection-grid"),
            btns: {
                change: document.getElementById("btn-change"),
                move1: document.getElementById("btn-move1"),
                time5: document.getElementById("btn-time5")
            }
        };

        // --- ÁîªÈù¢Ë™øÊï¥„É≠„Ç∏„ÉÉ„ÇØ (ÂÆåÂÖ®Âõ∫ÂÆöÊØîÁéá„ÉªÁµ∂ÂØæÈÖçÁΩÆ) ---
        function adjustLayout() {
            const root = document.getElementById('game-root');
            // „Ç¶„Ç£„É≥„Éâ„Ç¶„Çµ„Ç§„Ç∫„Å®„Éô„Éº„Çπ„Çµ„Ç§„Ç∫„ÅÆÊØîÁéá
            const winW = window.innerWidth;
            const winH = window.innerHeight;
            
            // Á∏¶Ê®™„Å©„Å°„Çâ„Åã„Åå„ÅØ„ÅøÂá∫„Å™„ÅÑ„Çà„ÅÜ„Å´ÊúÄÂ∞è„ÅÆ„Çπ„Ç±„Éº„É´„ÇíÊé°Áî®
            const scale = Math.min(winW / BASE_WIDTH, winH / BASE_HEIGHT);
            
            // translate(-50%, -50%) „ÅßÁîªÈù¢‰∏≠Â§Æ„Å´ÈÖçÁΩÆ„Åó„ÄÅ„Åù„Åì„Åã„Çâ„Çπ„Ç±„Éº„É´„Åï„Åõ„Çã
            root.style.transform = `translate(-50%, -50%) scale(${scale})`;
        }

        function resizeCanvas() {
            // Âõ∫ÂÆöËß£ÂÉèÂ∫¶ÂÜÖ„ÅÆ„Ç≠„É£„É≥„Éê„Çπ„Çµ„Ç§„Ç∫„Å´Âêà„Çè„Åõ„Çã
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            if(gameState !== 'title' && gameState !== 'char_select' && gameState !== 'ranking') drawGame();
        }

        window.addEventListener("resize", () => {
            adjustLayout();
            // resizeCanvas„ÅØÂëº„Å∞„Å™„ÅÑÔºàÂõ∫ÂÆöËß£ÂÉèÂ∫¶ÂÜÖ„Åß„ÅÆ„Çµ„Ç§„Ç∫„ÅØ‰∏çÂ§â„ÅÆ„Åü„ÇÅÔºâ
        });

        window.onload = () => { 
            adjustLayout();
            resizeCanvas(); 
            initCollectionGrid(); 
            initCharGrid(); 
            loadClearCounts(); 
        };

        function initCollectionGrid() {
            ui.grid.innerHTML = "";
            ITEMS.forEach((icon, idx) => {
                const div = document.createElement("div");
                div.className = "collection-item";
                div.id = `col-item-${idx}`;
                div.textContent = icon;
                ui.grid.appendChild(div);
            });
        }

        function initCharGrid() {
            const grid = document.getElementById("char-grid");
            CHARACTERS.forEach(char => {
                const btn = document.createElement("div");
                btn.className = "char-btn";
                btn.textContent = char;
                btn.onclick = () => startGameWithChar(char);
                grid.appendChild(btn);
            });
        }

        function loadClearCounts() {
            const data = JSON.parse(localStorage.getItem('mathSugorokuClears')) || { easy: 0, normal: 0, hard: 0 };
            document.getElementById('clear-easy').innerText = data.easy;
            document.getElementById('clear-normal').innerText = data.normal;
            document.getElementById('clear-hard').innerText = data.hard;
        }

        function saveClearCount(level) {
            const data = JSON.parse(localStorage.getItem('mathSugorokuClears')) || { easy: 0, normal: 0, hard: 0 };
            if(data[level] !== undefined) {
                data[level]++;
                localStorage.setItem('mathSugorokuClears', JSON.stringify(data));
            }
        }

        // --- „Ç≤„Éº„É†„Éï„É≠„Éº ---
        function selectLevel(level) {
            selectedLevel = level;
            document.getElementById("title-screen").classList.add("hidden");
            document.getElementById("char-screen").classList.remove("hidden");
            gameState = "char_select";
        }

        function backToTitle() {
            document.getElementById("char-screen").classList.add("hidden");
            document.getElementById("title-screen").classList.remove("hidden");
            gameState = "title";
        }

        function pickRandomChar() {
            const r = Math.floor(Math.random() * CHARACTERS.length);
            startGameWithChar(CHARACTERS[r]);
        }

        function startGameWithChar(char) {
            // ÂêçÂâç„ÅÆÂèñÂæó„Å®„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
            const inputName = document.getElementById("nickname-input").value.trim();
            
            if (inputName) {
                // „Å≤„Çâ„Åå„Å™„ÉªÈï∑Èü≥Á¨¶„ÉÅ„Çß„ÉÉ„ÇØ
                if (!/^[„ÅÅ-„Çì„Éº]+$/.test(inputName)) {
                    alert("„Åä„Å™„Åæ„Åà„ÅØ „Å≤„Çâ„Åå„Å™ „Å® „Äå„Éº„Äç „Å†„Åë„Åß „Åã„ÅÑ„Å¶„Å≠ÔºÅ");
                    return;
                }
                
                // NG„ÉØ„Éº„Éâ„ÉÅ„Çß„ÉÉ„ÇØ
                for (const ng of NG_WORDS_HIRAGANA) {
                    if (inputName.includes(ng)) {
                        alert("„Åù„ÅÆ„Åä„Å™„Åæ„Åà„ÅØ „Å§„Åã„Åà„Åæ„Åõ„Çì„ÄÇ„Åπ„Å§„ÅÆ „Åä„Å™„Åæ„Åà„Å´ „Åó„Å¶„Å≠„ÄÇ");
                        return;
                    }
                }
                currentPlayerName = inputName;
            } else {
                currentPlayerName = "ÂêçÁÑ°„Åó„Åï„Çì";
            }
            
            playerChar = char;
            document.getElementById("char-screen").classList.add("hidden");
            startGame(selectedLevel);
        }

        function startGame(level) {
            difficulty = level;
            timeLeft = (level === 'easy' ? 15 : level === 'normal' ? 10 : 5);
            ui.level.innerText = (level === 'easy' ? "„Åó„Çá„Åç„ÇÖ„ÅÜ" : level === 'normal' ? "„Å°„ÇÖ„ÅÜ„Åç„ÇÖ„ÅÜ" : "„Åò„Çá„ÅÜ„Åç„ÇÖ„ÅÜ");

            currentPos = 0;
            points = 0;
            gems = 0;
            cameraOffset = 0;
            hand = [];
            collectedItems = [];
            messageQueue = [];
            isDisplayingMessage = false;
            scrollAnim.active = false;
            
            ITEMS.forEach((_, i) => document.getElementById(`col-item-${i}`).className = "collection-item");
            msgText.classList.remove("visible");

            generateMap();
            fillHandInitial();
            
            gameState = "playing";
            updateUI();
            drawGame();
        }

        // --- „Ç≤„Éº„É†„É≠„Ç∏„ÉÉ„ÇØ ---
        function generateMap() {
            mapData = new Array(GOAL_POS + 1).fill(0);
            let available = [];
            for(let i=11; i<GOAL_POS; i++) available.push(i);
            
            for (let i = available.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [available[i], available[j]] = [available[j], available[i]];
            }

            for(let k=0; k<16; k++) {
                if(k < available.length) mapData[available[k]] = 100 + k;
            }

            let probs = (difficulty === 'easy') ? [0.3, 0.55, 0.75, 0.85, 0.90, 1.0] 
                      : (difficulty === 'hard') ? [0.25, 0.35, 0.45, 0.60, 0.85, 1.0] 
                      : [0.30, 0.45, 0.60, 0.75, 0.85, 1.0];

            for(let i=1; i<GOAL_POS; i++) {
                if(mapData[i] >= 100) continue; 
                let r = Math.random();
                if(r < probs[0]) mapData[i] = 0; 
                else if(r < probs[1]) mapData[i] = 1; 
                else if(r < probs[2]) mapData[i] = 2; 
                else if(r < probs[3]) mapData[i] = 3; 
                else if(r < probs[4]) mapData[i] = 4; 
                else mapData[i] = 5; 
            }
        }

        function getRandomCard() { return Math.floor(Math.random() * 9) + 1; }

        function fillHandInitial() {
            hand = [];
            for(let i=0; i<5; i++) hand.push(getRandomCard());
            renderHand();
        }

        function updateUI() {
            ui.time.innerText = timeLeft;
            ui.point.innerText = points;
            ui.gem.innerText = gems;
            ui.count.innerText = collectedItems.length;

            const active = (gameState === "playing" && timeLeft > 0 && gems > 0 && !isDisplayingMessage && !scrollAnim.active);
            ui.btns.change.disabled = !active;
            ui.btns.move1.disabled = !active;
            ui.btns.time5.disabled = !active;
        }

        // --- ÊèèÁîª (Â§âÊõ¥„Å™„Åó) ---
        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();
            const marginX = 20;
            const tileW = (canvas.width - marginX * 2) / TILES_PER_ROW;
            const tileH = tileW * 1.3; 
            const marginY = 15; 
            const totalBoardH = tileH * 2 + marginY;
            let startY = (canvas.height - totalBoardH) / 2 + 10; // Â∞ë„Åó‰∏ä„Å´
            const minStartY = tileH + marginY + 10;
            if(startY < minStartY) startY = minStartY;

            // „Éû„ÇπÁõÆ„ÅÆËâ≤„Çí„Éù„ÉÉ„ÉóÁ≥ª„Å´Â§âÊõ¥
            const zoneColors = ["#C5E1A5", "#FFF59D", "#FFCC80", "#80DEEA", "#F48FB1"];

            let yShift = 0;
            let drawOffset = cameraOffset;
            let drawCount = TILES_PER_PAGE;
            if (scrollAnim.active) {
                yShift = -scrollAnim.progress * (tileH + marginY);
                drawOffset = scrollAnim.startOff;
                drawCount = 30; 
            }
            ctx.translate(0, yShift);

            if (drawOffset === 0) {
                let zRow = -1; let zCol = 0;
                let zx = marginX + zCol * tileW;
                let zy = startY + zRow * (tileH + marginY);
                ctx.fillStyle = "#FFB74D"; 
                drawRoundedRect(ctx, zx + 5, zy + 5, tileW - 10, tileH - 10, 15);
                ctx.fill();
                ctx.strokeStyle = "#fff"; ctx.lineWidth=3; ctx.stroke();
                ctx.fillStyle = "#E65100";
                ctx.font = "900 12px 'M PLUS Rounded 1c', sans-serif"; ctx.textAlign = "center"; ctx.textBaseline="bottom";
                ctx.fillText("START", zx + tileW/2, zy + tileH - 8);
                if (currentPos === 0) drawPlayer(zx + tileW/2, zy + tileH/2, tileW);
            }

            for (let i = 0; i < drawCount; i++) {
                let tileNum = drawOffset + i + 1;
                if (tileNum > GOAL_POS + 1) continue;
                let row = Math.floor(i / 10);
                let col = i % 10;
                let x = marginX + col * tileW;
                let y = startY + row * (tileH + marginY);
                let type = mapData[tileNum];
                let zoneIndex = Math.floor((tileNum - 1) / 10) % zoneColors.length;
                ctx.fillStyle = (tileNum === GOAL_POS) ? "#FDD835" : zoneColors[zoneIndex];
                drawRoundedRect(ctx, x + 2, y + 2, tileW - 4, tileH - 4, 10); 
                ctx.fill();
                
                // Êû†Á∑ö„ÇíÂ§™„ÅèÁôΩ„Åè„Åó„Å¶„Çπ„ÉÜ„ÉÉ„Ç´„ÉºÈ¢®„Å´
                ctx.strokeStyle = "#fff"; ctx.lineWidth = 3; ctx.stroke();
                
                let isPassed = (tileNum <= currentPos);
                if (isPassed && tileNum <= GOAL_POS) {
                    ctx.fillStyle = "#E0E0E0";
                    drawRoundedRect(ctx, x + 2, y + 2, tileW - 4, tileH - 4, 10);
                    ctx.fill();
                }
                if (!isPassed && tileNum <= GOAL_POS) {
                    if (type >= 100) {
                        const borderX = x + 4; const borderY = y + 4;
                        const borderW = tileW - 8; const borderH = tileH - 8;
                        ctx.fillStyle = "#fff"; ctx.fillRect(borderX, borderY, borderW, borderH);
                        ctx.strokeStyle = "#FF9800"; ctx.lineWidth = 2; ctx.strokeRect(borderX, borderY, borderW, borderH); 
                        ctx.lineWidth = 1;
                        let icon = ITEMS[type - 100];
                        ctx.fillStyle = "#333";
                        ctx.font = `${tileW * 0.5}px Arial`;
                        ctx.textAlign = "center"; ctx.textBaseline = "middle";
                        ctx.fillText(icon, x + tileW/2, y + tileH * 0.4);
                    } else {
                        let icon = "";
                        switch(type) {
                            case 1: icon = "‚è∞"; break;
                            case 2: icon = "üéÅ"; break;
                            case 3: icon = "‚ùì"; break;
                            case 4: icon = "üëª"; break;
                            case 5: icon = "üíé"; break;
                        }
                        if (icon) {
                            ctx.fillStyle = "#333";
                            ctx.font = `${tileW * 0.5}px Arial`;
                            ctx.textAlign = "center"; ctx.textBaseline = "middle";
                            ctx.fillText(icon, x + tileW/2, y + tileH * 0.35);
                        }
                    }
                }
                if (tileNum <= GOAL_POS) {
                    ctx.fillStyle = "#5D4037"; // ÊñáÂ≠óËâ≤„ÅØ„ÉÅ„Éß„Ç≥Ëâ≤
                    let isKiri = (tileNum % 10 === 0);
                    let fontSize = isKiri ? tileW * 0.55 : tileW * 0.5; 
                    let fontWeigth = isKiri ? "900" : "bold"; 
                    ctx.font = `${fontWeigth} ${fontSize}px 'M PLUS Rounded 1c', sans-serif`;
                    ctx.textAlign = "center"; ctx.textBaseline = "middle";
                    if(isKiri) ctx.fillStyle = "#E91E63"; // „Ç≠„É™Áï™„ÅØ„Éî„É≥„ÇØ
                    ctx.fillText(tileNum, x + tileW/2, y + tileH * 0.75);
                }
                if (tileNum === currentPos) {
                    drawPlayer(x + tileW/2, y + tileH * 0.35, tileW);
                }
            }
            ctx.restore();
        }

        function drawPlayer(x, y, tileSize) {
            const offsetY = y - (tileSize * 0.2); // Â∞ë„ÅóÈ´ò„ÇÅ„Å´ÊµÆ„Åã„Åô
            ctx.font = `${tileSize * 0.75}px Arial`;
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillStyle = "rgba(0,0,0,0.2)"; // ÂΩ±
            ctx.fillText(playerChar, x + 2, offsetY + 4); 
            ctx.fillStyle = "#fff"; 
            ctx.fillText(playerChar, x, offsetY);
        }

        function drawRoundedRect(ctx, x, y, w, h, r) {
            ctx.beginPath();
            ctx.moveTo(x+r, y); ctx.lineTo(x+w-r, y);
            ctx.quadraticCurveTo(x+w, y, x+w, y+r); ctx.lineTo(x+w, y+h-r);
            ctx.quadraticCurveTo(x+w, y+h, x+w-r, y+h); ctx.lineTo(x+r, y+h);
            ctx.quadraticCurveTo(x, y+h, x, y+h-r); ctx.lineTo(x, y+r);
            ctx.quadraticCurveTo(x, y, x+r, y); ctx.closePath();
        }

        // --- „É°„ÉÉ„Çª„Éº„Ç∏„Ç∑„Çπ„ÉÜ„É† ---
        function enqueueMessage(text) {
            messageQueue.push(text);
            processMessageQueue();
        }

        function processMessageQueue() {
            if (isDisplayingMessage || messageQueue.length === 0) {
                if (messageQueue.length === 0 && !isDisplayingMessage && gameState !== "title" && gameState !== "char_select" && gameState !== "ranking" && !scrollAnim.active) {
                    onTurnMessagesFinished();
                }
                return;
            }
            isDisplayingMessage = true;
            updateUI(); 
            const text = messageQueue.shift();
            msgText.innerText = text;
            msgText.classList.add("visible");
            setTimeout(() => {
                if (gameState !== 'goal_waiting') {
                    msgText.classList.remove("visible");
                    setTimeout(() => {
                        isDisplayingMessage = false;
                        processMessageQueue();
                    }, 200); 
                }
            }, 1000); 
        }

        function onTurnMessagesFinished() {
            if(gameState === "playing") {
                checkSlide();
                if(!scrollAnim.active && timeLeft <= 0) gameOver();
                updateUI(); 
            }
        }

        // --- „Ç¢„ÇØ„Ç∑„Éß„É≥ ---
        function playCard(index) {
            if (gameState !== "playing" || timeLeft <= 0 || isDisplayingMessage || scrollAnim.active) return;
            let moveVal = hand[index];
            timeLeft--;
            const equation = `<span style="color:#795548">${currentPos}</span> + <span style="color:#E91E63">${moveVal}</span> = ${(currentPos + moveVal)}`;
            const hm = document.getElementById('hand-message');
            hm.style.fontSize = "38px"; hm.style.minWidth = "150px"; hm.innerHTML = equation;
            hand[index] = getRandomCard();
            renderHand();
            if (timeLeft < 0) { timeLeft = 0; gameOver(); return; }
            animateMove(currentPos, currentPos + moveVal, moveVal);
        }

        function useAbility(type) {
            if (gameState !== "playing" || gems <= 0 || isDisplayingMessage || scrollAnim.active) return;
            if (type === 'change') {
                gems--; hand = []; for(let i=0; i<5; i++) hand.push(getRandomCard());
                renderHand(); enqueueMessage("üíé „Å¶„Åµ„Å†„ÉÅ„Çß„É≥„Ç∏ÔºÅ"); updateUI();
            } else if (type === 'time5') {
                gems--; timeLeft += 5; enqueueMessage("üíé „Åò„Åã„Çì Ôºã5ÔºÅ"); updateUI();
            } else if (type === 'move1') {
                gems--; updateUI(); animateMove(currentPos, currentPos + 1, 1);
            }
        }

        function animateMove(start, end, steps) {
            gameState = "animation";
            let current = start;
            let count = 0;
            const timer = setInterval(() => {
                current++; count++; currentPos = current;
                if (current % 10 === 0 && current < end && current <= 90) {
                    points += 100; enqueueMessage(`${current}ÈÄöÈÅé! +100pt`);
                }
                drawGame();
                if (current >= GOAL_POS) {
                    clearInterval(timer);
                    currentPos = GOAL_POS;
                    if (end > GOAL_POS) { points += 500; enqueueMessage("„Ç¥„Éº„É´ÈÄöÈÅé! +500pt"); } 
                    else { points += 1000; }
                    msgText.innerText = "„Ç¥„Éº„É´ÔºÅ";
                    msgText.classList.add("visible");
                    gameState = "goal_waiting";
                    const clickHandler = () => {
                        document.removeEventListener('click', clickHandler);
                        document.removeEventListener('touchstart', clickHandler);
                        finishGame(true, (end === GOAL_POS));
                    };
                    setTimeout(() => {
                        document.addEventListener('click', clickHandler);
                        document.addEventListener('touchstart', clickHandler);
                    }, 500);
                    return;
                }
                if (count >= steps) {
                    clearInterval(timer);
                    if (current % 10 === 0 && current <= 90) {
                        points += 200; enqueueMessage(`„Å¥„Å£„Åü„Çä! +200pt`);
                    }
                    gameState = "playing";
                    handleEvent(current);
                }
            }, 200);
        }

        function handleEvent(pos) {
            let type = mapData[pos];
            if (type >= 100) {
                let itemIdx = type - 100;
                if (!collectedItems.includes(itemIdx)) {
                    collectedItems.push(itemIdx);
                    document.getElementById(`col-item-${itemIdx}`).classList.add("collected");
                    enqueueMessage(`${ITEMS[itemIdx]} „Ç≤„ÉÉ„ÉàÔºÅ`);
                } else { enqueueMessage("„Åô„Åß„Å´„ÇÇ„Å£„Å¶„ÅÑ„ÇãÔºÅ"); }
            } else {
                switch(type) {
                    case 1: 
                        let t = Math.floor(Math.random()*2)+1; timeLeft += t; enqueueMessage(`„Åò„Åã„Çì Ôºã${t}`); break;
                    case 2:
                        let p = (Math.floor(Math.random()*3)+1)*50; points += p; enqueueMessage(`„Éù„Ç§„É≥„Éà Ôºã${p}`); break;
                    case 3: 
                        if(Math.random()<0.5) { points+=200; enqueueMessage("„É©„ÉÉ„Ç≠„Éº! +200pt"); } 
                        else { points = Math.max(0, points-100); enqueueMessage("„Ç¢„É≥„É©„ÉÉ„Ç≠„Éº... -100pt"); }
                        break;
                    case 4: 
                        if(Math.random()<0.5) { timeLeft=Math.max(0, timeLeft-2); enqueueMessage("üëª „Åò„Åã„Çì -2"); } 
                        else { points=Math.max(0, points-50); enqueueMessage("üëª „Éù„Ç§„É≥„Éà -50"); }
                        break;
                    case 5:
                        gems++; enqueueMessage("üíé „Åª„ÅÜ„Åõ„Åç„Ç≤„ÉÉ„ÉàÔºÅ"); break;
                    default:
                        processMessageQueue(); break;
                }
            }
        }

        function checkSlide() {
            if (currentPos > 0 && currentPos <= 90) {
                let row = Math.floor((currentPos - 1) / 10);
                let target = row * 10;
                if (target > cameraOffset) {
                    gameState = "sliding";
                    scrollAnim.active = true;
                    scrollAnim.startOff = cameraOffset;
                    scrollAnim.targetOff = target;
                    scrollAnim.progress = 0;
                    const slideTimer = setInterval(() => {
                        scrollAnim.progress += 0.05;
                        if (scrollAnim.progress >= 1.0) {
                            scrollAnim.progress = 0; scrollAnim.active = false;
                            cameraOffset = scrollAnim.targetOff;
                            clearInterval(slideTimer);
                            gameState = "playing";
                            if(timeLeft <= 0) gameOver();
                            updateUI(); 
                        }
                        drawGame();
                    }, 20);
                }
            }
        }

        function renderHand() {
            handContainer.innerHTML = "";
            hand.forEach((num, idx) => {
                let div = document.createElement("div");
                div.className = "card";
                div.innerText = num;
                div.onclick = () => playCard(idx);
                handContainer.appendChild(div);
            });
        }
        
        function recordScore(score, level) {
            saveLocalScore(score, level);
            if (currentUser) {
                const diffUpper = level.toUpperCase();
                // „Éó„É¨„Ç§„É§„ÉºÂêç„Å®„Åó„Å¶„ÄÅÂÖ•Âäõ„Åï„Çå„Åü„ÇÇ„ÅÆ„Çí‰ΩøÁî®
                saveOnlineScore(currentUser.uid, currentPlayerName, diffUpper, score);
            }
        }

        async function saveOnlineScore(userId, userName, difficulty, score) {
            console.log(`[Debug] saveOnlineScore: ${difficulty}, ${score}pt, Name:${userName}`);
            try {
                const docId = `${userId}_${difficulty}_${Date.now()}`;
                
                await setDoc(doc(db, "scores_sugoroku", docId), {
                    uid: userId,
                    name: userName, // ÂÖ•ÂäõÂêç„Çí‰ΩøÁî®
                    difficulty: difficulty, 
                    score: score,
                    createdAt: serverTimestamp() 
                });
                console.log("[Debug] Saved to scores_sugoroku!");
            } catch (error) {
                console.error("[Error] Save failed:", error);
            }
        }

        function gameOver() {
            gameState = "result";
            document.getElementById("result-screen").classList.remove("hidden");
            document.getElementById("result-title").innerText = "„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº...";
            document.getElementById("result-title").style.color = "#7f8c8d";
            document.getElementById("res-base").innerText = points;
            document.getElementById("res-item").innerText = 0; document.getElementById("res-item-cnt").innerText = "";
            document.getElementById("res-time").innerText = 0; document.getElementById("res-time-cnt").innerText = "";
            document.getElementById("res-gem").innerText = 0; document.getElementById("res-gem-cnt").innerText = "";
            document.getElementById("res-final").innerText = points;
            
            recordScore(points, difficulty);
        }

        function finishGame(cleared, isPerfectGoal) {
            gameState = "result";
            msgText.classList.remove("visible"); 
            let count = collectedItems.length;
            let bonusItem = count * 300; 
            let bonusTime = timeLeft * 50;
            let bonusGem = gems * 300;
            let final = points + bonusItem + bonusTime + bonusGem;

            if (cleared) {
                saveClearCount(difficulty);
                recordScore(final, difficulty);
            }

            document.getElementById("result-screen").classList.remove("hidden");
            if (isPerfectGoal) {
                 document.getElementById("result-title").innerText = "„Å¥„Å£„Åü„Çä„Ç¥„Éº„É´ÔºÅ";
                 document.getElementById("result-title").style.color = "#E91E63";
            } else {
                 document.getElementById("result-title").innerText = "„Ç¥„Éº„É´ÔºÅ";
                 document.getElementById("result-title").style.color = "#FF9800";
            }
            document.getElementById("res-base").innerText = points;
            document.getElementById("res-item").innerText = `+${bonusItem}`; document.getElementById("res-item-cnt").innerText = `(${count}ÂÄã)`;
            document.getElementById("res-time").innerText = `+${bonusTime}`; document.getElementById("res-time-cnt").innerText = `(${timeLeft}Áßí)`;
            document.getElementById("res-gem").innerText = `+${bonusGem}`; document.getElementById("res-gem-cnt").innerText = `(${gems}ÂÄã)`;
            document.getElementById("res-final").innerText = final;
        }

        // --- „É≠„Éº„Ç´„É´„É©„É≥„Ç≠„É≥„Ç∞ ---
        const LOCAL_RANKING_KEY = 'mathSugorokuRankingByLevel';

        function saveLocalScore(score, level) {
            let rankingData = JSON.parse(localStorage.getItem(LOCAL_RANKING_KEY)) || { easy: [], normal: [], hard: [] };
            if(Array.isArray(rankingData)) rankingData = { easy: [], normal: [], hard: [] }; 
            if (!rankingData[level]) rankingData[level] = [];

            // ÂÖ•Âäõ„Åï„Çå„ÅüÂêçÂâç„Åß‰øùÂ≠ò
            rankingData[level].push({ score: score, name: currentPlayerName, date: new Date().toLocaleDateString() });
            rankingData[level].sort((a, b) => b.score - a.score);
            rankingData[level] = rankingData[level].slice(0, 10); 
            
            localStorage.setItem(LOCAL_RANKING_KEY, JSON.stringify(rankingData));
        }

        function loadLocalRankingColumn(level, elementId) {
            const list = document.getElementById(elementId);
            list.innerHTML = "";
            let rankingData = JSON.parse(localStorage.getItem(LOCAL_RANKING_KEY)) || { easy: [], normal: [], hard: [] };
            if(Array.isArray(rankingData)) rankingData = { easy: [], normal: [], hard: [] };
            
            const data = rankingData[level] || [];
            renderRankingList(data, list);
        }

        // --- „Ç™„É≥„É©„Ç§„É≥„É©„É≥„Ç≠„É≥„Ç∞ (Firestore) ---
        async function fetchOnlineRanking(difficulty) {
             console.log(`[Debug] fetchOnlineRanking: ${difficulty}`);
             try {
                const q = query(
                    collection(db, "scores_sugoroku"), 
                    where("difficulty", "==", difficulty)
                );
                
                const querySnapshot = await getDocs(q);
                let ranking = [];
                
                querySnapshot.forEach((doc) => {
                    const d = doc.data();
                    if (d.score !== undefined) {
                        ranking.push(d);
                    }
                });

                ranking.sort((a, b) => b.score - a.score);
                return ranking.slice(0, 10);

            } catch (error) {
                console.error("[Error] Fetch ranking failed:", error);
                return [];
            }
        }

        function renderRankingList(data, listElement) {
            listElement.innerHTML = "";
            if (data.length === 0) {
                listElement.innerHTML = "<li style='text-align:center; color:#B0BEC5; margin-top:10px;'>Ë®òÈå≤„Å™„Åó</li>";
                return;
            }
            data.forEach((entry, idx) => {
                const li = document.createElement("li");
                li.className = "rank-item";
                
                let rankColor = "#5D4037";
                if(idx === 0) rankColor = "#FFD700"; 
                else if(idx === 1) rankColor = "#C0C0C0";
                else if(idx === 2) rankColor = "#CD7F32";
                
                let dispName = entry.name || "Unknown";
                
                const isMe = (currentUser && entry.uid === currentUser.uid);
                const nameStyle = isMe ? 'color: #E91E63; font-weight: bold;' : 'color: #8D6E63;';
                const displayNameHtml = `<span class="rank-name" style="${nameStyle}">${dispName}</span>`;

                let dateStr = "";
                if (entry.date) {
                    dateStr = entry.date;
                } else if (entry.createdAt && entry.createdAt.toDate) {
                    dateStr = entry.createdAt.toDate().toLocaleDateString();
                }

                li.innerHTML = `
                    <span class="rank-num">${idx + 1}.</span>
                    <span class="rank-score" style="color:${rankColor}">${entry.score}</span>
                    ${displayNameHtml}
                    <span class="rank-date">${dateStr}</span>
                `;
                listElement.appendChild(li);
            });
        }
        
        // --- „É©„É≥„Ç≠„É≥„Ç∞Âàá„ÇäÊõø„Åà ---
        async function switchRankingMode(mode) {
            currentRankingMode = mode;
            document.getElementById("tab-local").classList.toggle("active", mode === 'local');
            document.getElementById("tab-online").classList.toggle("active", mode === 'online');

            ['rank-list-easy', 'rank-list-normal', 'rank-list-hard'].forEach(id => {
               document.getElementById(id).innerHTML = "<li style='text-align:center; padding:10px;'>Ë™≠„ÅøËæº„Åø‰∏≠...</li>";
            });

            if (mode === 'local') {
                loadLocalRankingColumn('easy', 'rank-list-easy');
                loadLocalRankingColumn('normal', 'rank-list-normal');
                loadLocalRankingColumn('hard', 'rank-list-hard');
            } else {
                if(!currentUser) {
                    ['rank-list-easy', 'rank-list-normal', 'rank-list-hard'].forEach(id => {
                       document.getElementById(id).innerHTML = "<li style='text-align:center; color:#aaa; padding:10px;'>„É≠„Ç∞„Ç§„É≥„ÅåÂøÖË¶Å„Åß„Åô</li>";
                    });
                    return;
                }
                
                const [easyData, normalData, hardData] = await Promise.all([
                    fetchOnlineRanking('EASY'),
                    fetchOnlineRanking('NORMAL'),
                    fetchOnlineRanking('HARD')
                ]);

                renderRankingList(easyData, document.getElementById('rank-list-easy'));
                renderRankingList(normalData, document.getElementById('rank-list-normal'));
                renderRankingList(hardData, document.getElementById('rank-list-hard'));
            }
        }

        function showFullRanking() {
            document.getElementById("title-screen").classList.add("hidden");
            document.getElementById("result-screen").classList.add("hidden");
            document.getElementById("ranking-screen").classList.remove("hidden");
            gameState = "ranking";
            switchRankingMode('local');
        }

        function closeRanking() {
            document.getElementById("ranking-screen").classList.add("hidden");
            if (timeLeft <= 0 || currentPos >= GOAL_POS) {
                document.getElementById("result-screen").classList.remove("hidden");
                gameState = "result";
            } else {
                document.getElementById("title-screen").classList.remove("hidden");
                gameState = "title";
            }
        }

        // --- Window„Å∏„ÅÆÂÖ¨Èñã ---
        window.selectLevel = selectLevel;
        window.backToTitle = backToTitle;
        window.pickRandomChar = pickRandomChar;
        window.startGameWithChar = startGameWithChar;
        window.startGame = startGame;
        window.playCard = playCard;
        window.useAbility = useAbility;
        window.showFullRanking = showFullRanking;
        window.closeRanking = closeRanking;
        window.handleGoogleLogin = handleGoogleLogin;
        window.switchRankingMode = switchRankingMode;
        window.fetchOnlineRanking = fetchOnlineRanking;

    </script>
</body>
</html>
