<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Éà„É¨„Ç∏„É£„ÉºÔºÜ„ÇØ„É©„Éï„Éà ÔΩû7„Å§„ÅÆÁßòÂ¢É„Å®Âπª„ÅÆÁ´úÔΩû</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="data.js"></script>

    <style>
        body {
            margin: 0; padding: 0; background-color: #2c3e50;
            overflow: hidden; display: flex; justify-content: center;
            align-items: center; height: 100vh;
            font-family: 'M PLUS Rounded 1c', sans-serif; touch-action: none;
        }
        #gameContainer {
            position: relative; width: 1280px; height: 720px;
            transform-origin: center center; box-shadow: 0 0 20px rgba(0,0,0,0.5);
            background-color: #ecf0f1; flex-shrink: 0;
        }
        canvas { display: block; width: 100%; height: 100%; outline: none; }
        
        #nameInput {
            display: none; position: absolute; left: 490px; top: 335px; width: 300px; height: 40px;
            font-size: 20px; text-align: center; font-family: 'M PLUS Rounded 1c', sans-serif;
            border: 2px solid #34495e; border-radius: 5px; outline: none; z-index: 10;
            background: #fff; color: #2c3e50;
        }
    </style>
</head>
<body>

<div id="gameContainer">
    <canvas id="gameCanvas" width="1280" height="720"></canvas>
    <input type="text" id="nameInput" maxlength="8">
</div>

<script>
// „É¨„Ç∑„Éî‰æ°Ê†º„ÅÆ‰∏ÄÊã¨Â§âÊõ¥Âá¶ÁêÜ
setTimeout(() => {
    if (typeof ITEMS !== 'undefined') {
        ITEMS.forEach(item => {
            if (item.type === 10) {
                if (item.lv === 2) item.price = 100;
                if (item.lv === 3) item.price = 500;
                if (item.lv === 4) item.price = 2500;
                if (item.lv === 5) item.price = 10000;
                if (item.lv === 6) item.price = 50000;
                if (item.lv === 7) item.price = 250000;
            }
        });
    }
}, 100);

// ==========================================
// 1. ÂÆöÊï∞„ÉªÂàùÊúüË®≠ÂÆö
// ==========================================
const firebaseConfig = {
    apiKey: "AIzaSyBCg5dCEM89UmYYhfGqVeRf_VrUlg8_o-4",
    authDomain: "math-braves.firebaseapp.com",
    projectId: "math-braves",
    storageBucket: "math-braves.firebasestorage.app",
    messagingSenderId: "217117619290",
    appId: "1:217117619290:web:d227feb603970d3948d463"
};
if (!firebase.apps.length) {
    firebase.initializeApp(firebaseConfig);
}
const db = firebase.firestore();
const FIRESTORE_COLLECTION = "scores_treasure_craft";

const cvs = document.getElementById("gameCanvas");
const ctx = cvs.getContext("2d");

// ==========================================
// 2. „É¨„Çπ„Éù„É≥„Ç∑„Éñ
// ==========================================
function resize() {
    const ww = window.innerWidth;
    const wh = window.innerHeight;
    const aspect = 1280 / 720;
    let scale = ww / wh < aspect ? ww / 1280 : wh / 720;
    document.getElementById("gameContainer").style.transform = `scale(${scale})`;
}
window.addEventListener("resize", resize);
resize();

// ==========================================
// 3. ÁîªÂÉèÁÆ°ÁêÜ („Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂØæÂøú)
// ==========================================
const imgs = {};
function loadImg(key, src, fallbackColor, fallbackText) {
    imgs[key] = { img: new Image(), loaded: false, error: false, color: fallbackColor, text: fallbackText };
    imgs[key].img.onload = () => imgs[key].loaded = true;
    imgs[key].img.onerror = () => imgs[key].error = true;
    imgs[key].img.src = src;
}
loadImg('title', 'images/title.png', '#34495e', '„Çø„Ç§„Éà„É´ÁîªÂÉè');
loadImg('map1', 'images/map1.png', '#27ae60', '„ÅØ„Åò„Åæ„Çä„ÅÆÊ£Æ');
loadImg('map2', 'images/map2.png', '#d35400', 'ÈäÖ„ÅÆÈâ±Â±±');
loadImg('map3', 'images/map3.png', '#7f8c8d', 'ÈâÑ„ÅÆÂ≤©Â£Å');
loadImg('map4', 'images/map4.png', '#bdc3c7', 'ÈäÄ„ÅÆÂªÉÈÉΩ');
loadImg('map5', 'images/map5.png', '#f1c40f', 'ÈªÑÈáë„ÅÆÁ•ûÊÆø');
loadImg('map6', 'images/map6.png', '#2980b9', 'Â§©Á©∫„ÅÆÁ†¶');
loadImg('map7', 'images/map7.png', '#c0392b', 'Á´ú„ÅÆÁÅ´Âè£');
loadImg('rest', 'images/rest.png', '#16a085', '‰ºë„ÇÄ');

loadImg('buki', 'images/buki.png', '#2980b9', 'Ê≠¶');
loadImg('tate', 'images/tate.png', '#2980b9', 'Áõæ');
loadImg('yoroi', 'images/yoroi.png', '#2980b9', 'Èéß');
loadImg('yubiwa', 'images/yubiwa.png', '#2980b9', 'È£æ');
loadImg('kusuri', 'images/kusuri.png', '#2980b9', 'Ëñ¨');
loadImg('clear', 'images/clear.png', '#f1c40f', '„ÇØ„É™„Ç¢');

function drawImageRect(key, x, y, w, h) {
    if (imgs[key] && imgs[key].loaded && !imgs[key].error) {
        ctx.drawImage(imgs[key].img, x, y, w, h);
    } else {
        ctx.fillStyle = imgs[key] ? imgs[key].color : '#7f8c8d';
        ctx.fillRect(x, y, w, h);
        ctx.fillStyle = '#fff';
        ctx.font = 'bold 30px "M PLUS Rounded 1c"';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(imgs[key] ? imgs[key].text : key, x + w / 2, y + h / 2);
    }
}

// ==========================================
// 4. „Ç∑„Çπ„ÉÜ„É†Áä∂ÊÖã„ÉªÂ§âÊï∞
// ==========================================
const NG_WORDS_HIRAGANA = [
    '„Åó„Å≠', '„Åó„Å¨', '„Åó„Å´', '„Åì„Çç„Åô', '„Åì„Çç„Åõ', '„Åï„Å§„Åå„ÅÑ', '„Åè„Åü„Å∞„Çå', '„Åò„Åï„Å§', '„Åé„Åï„Å§', '„Å§„Çã„Åô', '„Çå„Çì„Åü„Çì', '„Åó„Å´„Åü„ÅÑ',
    '„Å¶„Çç', '„Å¶„Çç„Çä„Åô„Å®', '„Å∞„Åè„ÅØ', '„Å∞„Åè„Å†„Çì', '„Åª„ÅÜ„Åã', '„ÅØ„Çì„Åñ„ÅÑ', '„Åî„ÅÜ„Å®„ÅÜ', '„ÇÜ„ÅÜ„Åã„ÅÑ', '„Åã„Çì„Åç„Çì', '„Åä„Åù„ÅÜ', '„ÇÑ„Åè„Åñ', '„Åº„ÅÜ„Çä„Çá„Åè',
    '„ÅØ„Çì„Åê„Çå', '„Å°„Çì„Å¥„Çâ', '„Åæ„Åµ„ÅÉ„ÅÇ', '„Åü„ÅÑ„Åæ', '„Åæ„ÇÑ„Åè', '„Åã„Åè„Åõ„ÅÑ„Åñ„ÅÑ', '„Åó„ÇÉ„Å∂', '„Å©„Çâ„Å£„Åê', '„Åì„Åã„ÅÑ„Çì', '„Å∏„Çç„ÅÑ„Çì', '„Åà„Åè„Åô„Åü„Åó„Éº',
    '„Å†„Å£„ÅΩ„ÅÜ', '„Åç„ÇÅ„Åõ„Åè', '„ÅÑ„Åò„ÇÅ', '„Åé„ÇÉ„Åè„Åü„ÅÑ', '„Å∞„Åã', '„ÅÇ„Åª', '„Åæ„Å¨„Åë', '„Åç„Å°„Åå„ÅÑ', '„ÅçÈÅï„ÅÑ', '„ÅÜ„Åñ„ÅÑ', '„ÅÜ„Åñ', '„Åç„ÇÇ„ÅÑ', '„Åç„ÇÇ',
    '„Åç„Åó„Çá„ÅÑ', '„Åç„Åà„Çç', '„Åè„Åö', '„Åî„Åø', '„Åî„Åø„ÇÄ„Åó', '„Åã„Åô', '„Åñ„Åì', '„Åú„Å§', '„Å∂„Åô', '„Åß„Å∂', '„ÅØ„Åí', '„Å°„Å≥', '„Åß„Å£„Å±', '„ÅÑ„Å™„Åã„ÇÇ„ÅÆ',
    '„ÅÜ„Åò', '„ÅØ„ÅÑ„Åº„Åè', '„Åæ„Åë„ÅÑ„Å¨', '„Åä„Å§„ÇÄ', '„ÅÆ„ÅÜ„Åü„Çä„Çì', '„Å¶„ÅÑ„ÅÆ„ÅÜ', '„Å°„Åó„Çá„ÅÜ', '„Åó„Çá„ÅÜ„Åå„ÅÑ', '„Åå„ÅÑ„Åò', '„Åã„Åü„Çè', '„Å≥„Å£„Åì', '„ÇÅ„Åè„Çâ',
    '„Å§„Çì„Åº', '„Åä„Åó', '„Å©„Åò„Çì', '„Åà„Åü', '„Å≤„Å´„Çì', '„Åü„Å≤', '„Åü„Å≤„Å≠', '„ÅÜ„Åõ„Çç', '„Å†„Åæ„Çå', '„Å°„Çì„Å°„Çì', '„Å°„Çì„Åì', '„Å°„Çì„ÅΩ', '„Å°„Çì„Åã',
    '„Åæ„Çâ', '„Åï„Åä', '„Åæ„Çì„Åì', '„Åæ„Çì„Åó„ÇÖ„ÅÜ', '„Åæ„Çì„Åí', '„Çè„Çå„ÇÅ', '„Åä„Åæ„Åü', '„Åè„Çä', '„Åè„Çä„Å®„Çä„Åô', '„ÅÑ„Çì„Åó„Çì', '„ÅÑ„Çì„Åã„Åè', '„Å≥„Çâ„Å≥„Çâ',
    '„Åì„ÅÜ„Åå„Çì', '„Åü„Åæ„Åç„Çì', '„Åç„Çì„Åü„Åæ', '„Åµ„Åê„Çä', '„Åä„Å£„Å±„ÅÑ', '„Å°„Å°', '„Å´„ÇÖ„ÅÜ„Çä„Çì', '„Å´„ÇÖ„ÅÜ„Å®„ÅÜ', '„Åç„Çá„Å´„ÇÖ„ÅÜ', '„Å≤„Çì„Å´„ÇÖ„ÅÜ',
    '„Åë„Å§', '„ÅÇ„Å™„Çã', '„Åì„ÅÜ„ÇÇ„Çì', '„Åë„Å§„ÅÆ„ÅÇ„Å™', '„Åà„Çç', '„Åà„Å£„Å°', '„Åô„Åë„Åπ', '„Å∏„Çì„Åü„ÅÑ', '„ÇÄ„Å£„Å§„Çä', '„Åó„Åì', '„Åõ„Å£„Åè„Åô', '„Åõ„ÅÑ„Åì„ÅÜ',
    '„Åæ„Åê„Çè„ÅÑ', '„Åù„ÅÜ„Å´„ÇÖ„ÅÜ', '„ÅØ„ÇÅ„Çã', '„Åä„Å™„Å´„Éº', '„Åò„ÅÑ', '„Åó„Åì„Åó„Åì', '„Åµ„Åá„Çâ', '„Å±„ÅÑ„Åö„Çä', '„Åè„Çì„Å´', '„ÅÑ„Çâ„Åæ', '„Åó„Å£„Åó„Çì', '„Å™„Åã„Å†„Åó',
    '„Åî„Å£„Åè„Çì', '„Å∂„Å£„Åã„Åë', '„Åó„Åä„Åµ„Åç', '„Åú„Å£„Å°„Çá„ÅÜ', '„ÅÑ„Åè', '„ÅÑ„Åã„Åõ„Çç', '„ÅÇ„Åà„Åé', '„Å©„ÅÜ„Å¶„ÅÑ', '„Åó„Çá„Åò„Çá', '„ÇÑ„Çä„Åæ„Çì', '„ÇÑ„Çä„Å°„Çì',
    '„Å≥„Å£„Å°', '„Åõ„Åµ„Çå', '„Å±„Åì', '„Å±„Åì„Å±„Åì', '„Çè„ÅÑ„Åõ„Å§', '„Çç„Çä', '„Åó„Çá„Åü', '„Å∫„Å©', '„Åç„Çì„Åó„Çì', '„Åò„ÇÖ„ÅÜ„Åã„Çì', '„Çä„Çá„ÅÜ„Åò„Çá„Åè', '„Çâ„Çì„Åì„ÅÜ',
    '„Åô„Åã„Çì„Å®', '„ÅÆ„Éº„Å±„Çì', '„Å±„Çì„Å°„Çâ', '„Çå„ÅÑ„Å∑', '„Åî„ÅÜ„Åã„Çì', '„Å°„Åã„Çì', '„Å®„ÅÜ„Åï„Å§', '„ÅÆ„Åû„Åç', '„Çç„Åó„ÇÖ„Å§', '„Åµ„ÅÜ„Åû„Åè', '„Åù„Éº„Å∑',
    '„Å∏„Çã„Åô', '„Åß„Çä„Å∏„Çã', '„Å¥„Çì„Åï„Çç', '„ÅÑ„ÇÅ„Åè„Çâ', '„ÅÇ„Å†„Çã„Å®', '„Åà„Éº„Å∂„ÅÑ', '„Åà„Å∂„ÅÑ', '„ÅΩ„Çã„ÅÆ', '„ÅÜ„Çâ„Å≥„Åß„Åä', '„ÇÄ„Åó„ÇÖ„ÅÜ„Åõ„ÅÑ', '„Åà„Çì„Åì„ÅÜ',
    '„Åà„Çì„Åò„Çá', '„ÅÜ„Çä', '„Åã„ÅÑ„Åó„ÇÖ„Çì', '„Å∞„ÅÑ„Åó„ÇÖ„Çì', '„Å±„Å±„Åã„Å§', '„Åæ„Åæ„Åã„Å§', '„ÅÜ„Çä„Åõ„Çì', '„ÅÜ„Çì„Åì', '„ÅÜ„Çì„Å°', '„Åè„Åù', '„Åí„Çä', '„Åπ„Çì',
    '„Åµ„Çì', '„Åó„Å£„Åì', '„Åó„Çá„Çì„Åπ„Çì', '„Å´„Çá„ÅÜ', '„Åª„ÅÜ„Å´„Çá„ÅÜ', '„Å∏', '„Åä„Å™„Çâ', '„Åí„Çç', '„Åü„Çì', '„ÅÜ„Çì„Åà„ÅÑ', '„Åì„ÅÜ„Åó„Åç', '„Åô„Åü„Å£„Åµ',
    '„Åã„Çì„Çä', '„Å±„Å®„Çç„Éº„Çã', '„Åò„Åà„ÇÄ', '„Åí„Éº„ÇÄ„Åæ„Åô„Åü„Éº', '„Åæ„Åô„Åü„Éº', '„ÅÇ„Å©„Åø„Çì', '„Åó„Åô„Å¶„ÇÄ', '„Åï„Éº„Å∞„Éº', '„ÅÇ„Åã„Å∞„Çì', '„Å∞„Çì', '„Å°„Éº„Å®',
    '„Å°„Éº„Åü„Éº', '„Å∞„Åê', '„Çâ„ÅÑ„Çì', '„Åã„Åã„Åä', '„Åô„Åã„ÅÑ„Å∑', '„ÅÑ„Çì„Åô„Åü', '„Å§„ÅÑ„Å£„Åü„Éº', '„Åß„ÅÉ„Åô„Åì', '„Åß„Çì„Çè', '„Å∞„Çì„Åî„ÅÜ', '„Åë„ÅÑ„Åü„ÅÑ',
    '„ÅÇ„Å©„Çå„Åô', '„ÇÅ„ÅÇ„Å©', '„Åò„ÇÖ„ÅÜ„Åó„Çá', '„ÅÇ„Åä', '„ÅÇ„ÅÑ„Åü„ÅÑ', '„Åæ„Å°„ÅÇ„Çè„Åõ', '„Åª„Å¶„Çã', '„Çâ„Å∂„Åª', '„Åä„Åµ„Åã„ÅÑ', '„Å±„Åô„Çè„Éº„Å©', '„Å±„Åô',
    '„ÅÇ„Åã„ÅÜ„Çì„Å®', '„Åì„Åò„Çì„Åò„Çá„ÅÜ„Åª„ÅÜ'
];
let GAME_STATE = "TITLE"; 
let clickZones = [];
let localPlayers = JSON.parse(localStorage.getItem('fgl_players')) || [];
let currentPlayerName = "„Ç≤„Çπ„Éà";
let googleUser = null;

let gameData = {
    day: 1, ap: 10, maxAp: 10, level: 1, exp: 0, gold: 0, maxStageLv: 1,
    inventory: [], equipment: { weapon: null, shield: null, armor: null, accessory: null, potion: null },
    unlockedRecipes: [], messages: ["Êñ∞„Åó„ÅÑÂÜíÈô∫„ÅåÂßã„Åæ„Çä„Åæ„Åô„ÄÇ"], uidCounter: 1,
    baseStatus: { atk: 0, def: 0, mag: 0 }
};

let currentInvTab = "ALL"; 
let invPage = 0;
let craftTabLevel = 1; 

let shopTab = "COMMON";
let shopPage = 0;

let exploreData = { stage: null, currentFloor: 0, maxFloor: 0, maxPossibleFloor: 0, gainedExpTotal: 0 };
let showHelp = false;
let activePopup = null; 
let restEffect = { active: false, alpha: 0, phase: 'in' }; 

let rankingTab = "LOCAL"; 
let rankingDataWorld = null;

// ==========================================
// 5. „É≠„Ç∏„ÉÉ„ÇØ„Éò„É´„Éë„Éº
// ==========================================
function getObjById(arr, id) { return arr.find(o => o.id === id); }

function getItemColor(master) {
    let t = master.type;
    if (t >= 1 && t <= 5) return '#2980b9'; // Weapon, Shield, Armor, Acc, Potion
    if (t === 6 || t === 7) return '#27ae60'; // Processed, Raw
    if (t === 8) return '#7f8c8d'; // Trash
    if (t === 9) return '#8e44ad'; // Part
    if (t === 10) return '#d35400'; // Recipe
    return '#2c3e50';
}

function addMessage(msg) {
    let maxLen = 26;
    for (let i = 0; i < msg.length; i += maxLen) {
        gameData.messages.push(msg.substring(i, i + maxLen));
    }
    if (gameData.messages.length > 10) {
        gameData.messages.splice(0, gameData.messages.length - 10);
    }
}

function getActualStat(invItem) {
    let upg = invItem.upgrade || 0;
    return Math.floor(invItem.stat * (1 + 0.1 * upg));
}

function calcCombatPower() {
    let atk = 0, defCloth = 0, defShield = 0, mag = 0, potionLv = 0;
    const eq = gameData.equipment;
    if (eq.weapon) atk = getActualStat(getInvItem(eq.weapon));
    if (eq.shield) defShield = getActualStat(getInvItem(eq.shield));
    if (eq.armor) defCloth = getActualStat(getInvItem(eq.armor));
    if (eq.accessory) mag = getActualStat(getInvItem(eq.accessory));
    if (eq.potion) potionLv = getObjById(ITEMS, getInvItem(eq.potion).itemId).lv;
    
    let baseAtk = gameData.baseStatus.atk;
    let baseDef = gameData.baseStatus.def;
    let baseMag = gameData.baseStatus.mag;
    
    let totalAtkVal = atk + baseAtk;
    let totalDefVal = defShield + defCloth + baseDef;
    let accMultiplier = 0.5 + Math.random() * 1.5;
    let totalMagVal = (mag + baseMag) * accMultiplier;

    let basePower = totalAtkVal + totalDefVal + totalMagVal;
    return Math.floor(basePower * (1 + potionLv * 0.1));
}

function getInvItem(uid) { return gameData.inventory.find(i => i.uid === uid); }
function countItem(itemId) {
    const t = getObjById(ITEMS, itemId).type;
    if(t >= 1 && t <= 4) return gameData.inventory.filter(i => i.itemId === itemId).length;
    const i = gameData.inventory.find(i => i.itemId === itemId);
    return i ? i.count : 0;
}

function addItem(itemId, stat = 0, count = 1) {
    const itemMaster = getObjById(ITEMS, itemId);
    if(itemMaster.type >= 1 && itemMaster.type <= 4) {
        for(let i=0; i<count; i++) gameData.inventory.push({ uid: gameData.uidCounter++, itemId: itemId, stat: stat, upgrade: 0, count: 1 });
    } else {
        let exist = gameData.inventory.find(i => i.itemId === itemId);
        if (exist) exist.count += count;
        else gameData.inventory.push({ uid: gameData.uidCounter++, itemId: itemId, stat: 0, count: count });
    }
}

function removeItem(itemId, count = 1) {
    const itemMaster = getObjById(ITEMS, itemId);
    if(itemMaster.type < 1 || itemMaster.type > 4) {
        let exist = gameData.inventory.find(i => i.itemId === itemId);
        if (exist) {
            exist.count -= count;
            if (exist.count <= 0) gameData.inventory = gameData.inventory.filter(i => i.itemId !== itemId);
        }
    }
}

function getGaussianStat(baseStat) {
    if (baseStat === 0) return 0;
    let u = 0, v = 0;
    while(u === 0) u = Math.random();
    while(v === 0) v = Math.random();
    let num = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
    let multiplier = 1 + (num * 0.15);
    return Math.max(1, Math.floor(baseStat * multiplier));
}

function getEquipRarityStar(stat, baseStat) {
    if(baseStat === 0) return "";
    let Z = (stat / baseStat - 1) / 0.15;
    if(Z <= -1.28) return "‚≠ê";
    if(Z <= -0.385) return "‚≠ê‚≠ê";
    if(Z <= 0.385) return "‚≠ê‚≠ê‚≠ê";
    if(Z <= 1.28) return "‚≠ê‚≠ê‚≠ê‚≠ê";
    return "‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê";
}

function getLootRarityCoin(prob) {
    if(prob <= 2) return "ü™ôü™ôü™ôü™ôü™ô";
    if(prob <= 4) return "ü™ôü™ôü™ôü™ô";
    if(prob <= 6) return "ü™ôü™ôü™ô";
    if(prob <= 8) return "ü™ôü™ô";
    return "ü™ô";
}

function getStageFloorDifficulty(n, m) {
    const TARGET_CP = [
        0,
        (5*7)*1.1*1.1,
        (15*7)*1.2*1.2,
        (40*7)*1.3*1.3,
        (100*7)*1.4*1.4,
        (250*7)*1.5*1.5,
        (600*7)*1.6*1.6,
        (1500*7)*1.7*1.7
    ];
    let maxM = n * 5 + 5;
    let targetCP = TARGET_CP[n];
    
    if (n === 1) {
        if (m <= 3) return 0;
        return targetCP * ((m - 3) / (maxM - 3));
    } else {
        let prevTargetCP = TARGET_CP[n - 1];
        if (m <= 3) {
            let startCP = TARGET_CP[n - 1] * 0.8;
            return startCP + (prevTargetCP - startCP) * ((m - 1) / 2);
        } else {
            return prevTargetCP + (targetCP - prevTargetCP) * ((m - 3) / (maxM - 3));
        }
    }
}

function calculateTotalAssets() {
    let assets = gameData.gold;
    gameData.inventory.forEach(inv => { assets += (getObjById(ITEMS, inv.itemId).price * inv.count); });
    return assets;
}

function getNextExp(level) {
    return 10 * Math.pow(level, 2);
}

function checkLevelUp() {
    let reqExp = getNextExp(gameData.level);
    while(gameData.exp >= reqExp) {
        gameData.exp -= reqExp;
        gameData.level++;
        gameData.maxAp += 1;
        
        let upAtk = Math.floor(Math.random() * 3) + 1;
        let upDef = Math.floor(Math.random() * 3) + 1;
        let upMag = Math.floor(Math.random() * 3) + 1;
        gameData.baseStatus.atk += upAtk;
        gameData.baseStatus.def += upDef;
        gameData.baseStatus.mag += upMag;

        addMessage(`„É¨„Éô„É´„Ç¢„ÉÉ„ÉóÔºÅLv${gameData.level}„Å´ÔºÅÊúÄÂ§ßAP+1 (Êîª+${upAtk}/Èò≤+${upDef}/È≠î+${upMag})`);
        reqExp = getNextExp(gameData.level);
    }
}

function initializeGame() {
    gameData = {
        day: 1, ap: 10, maxAp: 10, level: 1, exp: 0, gold: 100, maxStageLv: 1,
        inventory: [], equipment: { weapon: null, shield: null, armor: null, accessory: null, potion: null },
        unlockedRecipes: [], messages: ["ÂÜíÈô∫„ÅåÂßã„Åæ„Çä„Åæ„Åô„ÄÇ"], uidCounter: 1,
        baseStatus: { atk: 0, def: 0, mag: 0 }
    };
    let wood = ITEMS.find(i => i.name === 'Êú®');
    if(wood) addItem(wood.id, 0, 1);
    GAME_STATE = "MAIN";
}

function getRecipeRequirements(targetMaster, rule) {
    let baseName = "", matCount = 1;
    if(targetMaster.type === 1) { baseName = "Ê£í"; matCount = 2; }
    else if(targetMaster.type === 2) { baseName = "„Å≤„ÇÇ"; matCount = 1; }
    else if(targetMaster.type === 3) { baseName = "Â∏É"; matCount = 3; }
    else if(targetMaster.type === 4) { baseName = "ÊåáËº™"; matCount = 1; }
    else if(targetMaster.type === 5) { baseName = "Ê∞¥"; matCount = 1; }
    else return null; 
    
    let baseItem = ITEMS.find(i => i.name === baseName);
    let matItem = getObjById(ITEMS, rule.mat1Id);
    return { baseItem, matItem, matCount };
}

// ==========================================
// 6. „É°„Ç§„É≥„É´„Éº„Éó„Å®ÊèèÁîª
// ==========================================
function addZone(x, y, w, h, onClick) { clickZones.push({ x, y, w, h, onClick }); }

function drawText(text, x, y, size, color, align="left", weight="bold") {
    ctx.fillStyle = color;
    ctx.font = `${weight} ${size}px "M PLUS Rounded 1c"`;
    ctx.textAlign = align;
    ctx.textBaseline = "middle";
    ctx.fillText(text, x, y);
}

function drawBtn(text, x, y, w, h, color, onClick, disabled=false) {
    ctx.fillStyle = disabled ? '#95a5a6' : color;
    if (disabled && text === "Ë£ÖÂÇô‰∏≠" || text === "Â£≤Âàá") {
        ctx.fillStyle = text === "Ë£ÖÂÇô‰∏≠" ? '#e74c3c' : '#7f8c8d';
    }
    ctx.beginPath(); ctx.roundRect(x, y, w, h, 10); ctx.fill();
    ctx.strokeStyle = '#2c3e50'; ctx.lineWidth = 3; ctx.stroke();
    let fSize = Math.min(22, Math.floor(h * 0.5));
    drawText(text, x + w/2, y + h/2, fSize, '#fff', 'center');
    if (!disabled) addZone(x, y, w, h, onClick);
}

function drawPanel(x, y, w, h, title) {
    ctx.save();
    ctx.beginPath();
    ctx.roundRect(x, y, w, h, 15);
    ctx.clip(); 

    ctx.fillStyle = 'rgba(255,255,255,0.9)';
    ctx.fill();

    if(title) {
        ctx.fillStyle = '#34495e';
        ctx.fillRect(x, y, w, 40); 
        drawText(title, x + w/2, y + 20, 22, '#fff', 'center');
    }

    ctx.restore();

    ctx.strokeStyle = '#34495e'; 
    ctx.lineWidth = 4;
    ctx.beginPath(); 
    ctx.roundRect(x, y, w, h, 15); 
    ctx.stroke();
}

// --- „Çø„Ç§„Éà„É´ÁîªÈù¢ ---
function renderTitle() {
    drawImageRect('title', 0, 0, 1280, 720);
    ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(0,0,1280,720);
    
    drawText("„Éà„É¨„Ç∏„É£„ÉºÔºÜ„ÇØ„É©„Éï„Éà", 640, 120, 80, '#f1c40f', 'center', '900');
    drawText("ÔΩû7„Å§„ÅÆÁßòÂ¢É„Å®Âπª„ÅÆÁ´úÔΩû", 640, 210, 40, '#ecf0f1', 'center');

    let startY = 320;
    let bW = 260; 
    let bH = 60;
    let gapX = 40;
    let gapY = 40;
    
    let leftX = 640 - bW - (gapX / 2);
    let rightX = 640 + (gapX / 2);

    let row1Y = startY;
    let row2Y = startY + bH + gapY;

    drawBtn("„ÅØ„Åò„ÇÅ„Çã", leftX, row1Y, bW, bH, '#ffb3ba', () => { GAME_STATE = "PLAYER_SELECT"; });
    
    let loginTxt = googleUser ? "„É≠„Ç∞„Ç¢„Ç¶„Éà" : "Google„Åß„É≠„Ç∞„Ç§„É≥";
    let loginCol = googleUser ? '#d3d3d3' : '#bae1ff';
    drawBtn(loginTxt, rightX, row1Y, bW, bH, loginCol, () => { 
        if(googleUser) logout(); else loginWithGoogle(); 
    });

    drawBtn("„É©„É≥„Ç≠„É≥„Ç∞", leftX, row2Y, bW, bH, '#ffd8b1', () => { 
        rankingTab = "LOCAL"; rankingDataWorld = null; GAME_STATE = "RANKING"; 
    });

    drawBtn("INDEX„Å∏", rightX, row2Y, bW, bH, '#e2f0cb', () => { window.location.href = "../index.html"; });

    if(googleUser) {
        let dispName = googleUser.displayName || googleUser.email || "„É¶„Éº„Ç∂„Éº";
        drawText(`(${dispName}„Åß„É≠„Ç∞„Ç§„É≥‰∏≠)`, 1260, 690, 20, '#ecf0f1', 'right');
    }
}

function loginWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    firebase.auth().signInWithPopup(provider).then((result) => {
        googleUser = result.user;
        activePopup = { text: `${googleUser.displayName}„Åï„Çì„ÄÅ„Çà„ÅÜ„Åì„ÅùÔºÅ`, isAlert: true };
    }).catch((error) => {
        activePopup = { text: "„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ", isAlert: true };
    });
}

function logout() {
    firebase.auth().signOut().then(() => {
        googleUser = null;
        activePopup = { text: "„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü„ÄÇ", isAlert: true };
    });
}

function showPrompt(title, defaultVal, callback) {
    const inp = document.getElementById("nameInput");
    inp.value = defaultVal || "";
    inp.style.display = "block";
    inp.focus();
    
    activePopup = {
        isPrompt: true,
        text: title,
        onYes: () => {
            let val = inp.value;
            inp.style.display = "none";
            callback(val);
        },
        onNo: () => {
            inp.style.display = "none";
            activePopup = null;
        }
    };
}

function handleNameRegistration(val, index = -1) {
    if (!val) { activePopup = null; return; }
    if (!/^[„ÅÅ-„Çì„Éº]{1,8}$/.test(val)) {
        activePopup = { text: "„Å≤„Çâ„Åå„Å™„ÉªÈï∑Èü≥„ÅÆ„Åø„ÄÅ1„Äú8ÊñáÂ≠ó„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", isAlert: true };
        return;
    }
    for(let w of NG_WORDS_HIRAGANA) {
        if(val.includes(w)) {
            activePopup = { text: "‰ΩøÁî®„Åß„Åç„Å™„ÅÑË®ÄËëâ„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ", isAlert: true };
            return;
        }
    }
    
    if (index >= 0) {
        localPlayers[index] = val;
        localStorage.setItem('fgl_players', JSON.stringify(localPlayers));
        activePopup = null;
    } else {
        localPlayers.push(val);
        localStorage.setItem('fgl_players', JSON.stringify(localPlayers));
        currentPlayerName = val; 
        activePopup = null;
        initializeGame();
    }
}

function renderPlayerSelect() {
    drawImageRect('title', 0, 0, 1280, 720);
    ctx.fillStyle = 'rgba(236, 240, 241, 0.85)'; 
    ctx.fillRect(0,0,1280,720);
    drawText("„Éó„É¨„Ç§„É§„ÉºÈÅ∏Êäû", 640, 80, 40, '#2c3e50', 'center');

    for (let i = 0; i < 5; i++) {
        let py = 150 + i * 70;
        if (i < localPlayers.length) {
            drawBtn(`${localPlayers[i]} „ÅßÈñãÂßã`, 470, py, 340, 50, '#3498db', () => {
                currentPlayerName = localPlayers[i]; initializeGame();
            });
            drawBtn("Â§âÊõ¥", 830, py, 100, 50, '#f39c12', () => {
                showPrompt("Êñ∞„Åó„ÅÑ„Éó„É¨„Ç§„É§„ÉºÂêç", localPlayers[i], (val) => {
                    handleNameRegistration(val, i);
                });
            });
            drawBtn("Ê∂àÂéª", 950, py, 100, 50, '#e74c3c', () => {
                activePopup = {
                    text: `${localPlayers[i]} „ÇíÊ∂àÂéª„Åó„Å¶„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü`,
                    subtext: "‚Äª„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì",
                    onYes: () => {
                        localPlayers.splice(i, 1);
                        localStorage.setItem('fgl_players', JSON.stringify(localPlayers));
                    }
                };
            });
        } else if (i === localPlayers.length) {
            drawBtn("Êñ∞„Åó„ÅèÁôªÈå≤", 470, py, 340, 50, '#2ecc71', () => {
                showPrompt("Êñ∞„Åó„ÅÑ„Éó„É¨„Ç§„É§„ÉºÂêç", "", (val) => {
                    handleNameRegistration(val, -1);
                });
            });
        } else {
            drawBtn("Ôºà„ÅÇ„ÅçÔºâ", 470, py, 340, 50, '#bdc3c7', () => {});
        }
    }
    
    drawText("‚Äª„Å≤„Çâ„Åå„Å™„ÉªÈï∑Èü≥(„Éº)„ÅÆ„ÅøÂÖ•ÂäõÂèØËÉΩ„ÄÅÊúÄÂ§ß8ÊñáÂ≠óÔºàNG„ÉØ„Éº„Éâ„ÉÅ„Çß„ÉÉ„ÇØ„ÅÇ„ÇäÔºâ", 640, 550, 20, '#e74c3c', 'center');
    drawBtn("„Çø„Ç§„Éà„É´„Å∏Êàª„Çã", 540, 620, 200, 50, '#7f8c8d', () => { GAME_STATE = "TITLE"; });
}

// --- „É°„Ç§„É≥UI ---
function drawStatusPanel(x, y) {
    drawPanel(x, y, 330, 680, "„Çπ„ÉÜ„Éº„Çø„Çπ");
    let cy = y + 70;
    drawText(`ÂêçÂâç: ${currentPlayerName}`, x+20, cy, 24, '#2c3e50'); cy += 40;
    
    let reqExp = getNextExp(gameData.level);
    let expLeft = reqExp - gameData.exp;
    drawText(`Lv: ${gameData.level}`, x+20, cy, 22, '#2c3e50'); cy += 30;
    
    let expStr = `Ê¨°„ÅÆ„É¨„Éô„É´„Åæ„Åß„ÅÇ„Å®: ${expLeft} exp`;
    let expFontSize = 18;
    if (expLeft >= 1000000) expFontSize = 14;
    else if (expLeft >= 100000) expFontSize = 16;
    drawText(expStr, x+20, cy, expFontSize, '#2c3e50'); cy += 40;
    
    drawText(`AP: ${gameData.ap} / ${gameData.maxAp}`, x+20, cy, 24, '#d35400'); cy += 40;
    drawText(`Êó•Êï∞: ${gameData.day}Êó•ÁõÆ`, x+20, cy, 24, '#2c3e50'); cy += 50;

    let eq = gameData.equipment;
    let wStat = eq.weapon ? getActualStat(getInvItem(eq.weapon)) : 0;
    let atkTotal = wStat + gameData.baseStatus.atk;
    
    let sStat = eq.shield ? getActualStat(getInvItem(eq.shield)) : 0;
    let aStat = eq.armor ? getActualStat(getInvItem(eq.armor)) : 0;
    let defEqTotal = sStat + aStat;
    let defTotal = defEqTotal + gameData.baseStatus.def;
    
    let mStat = eq.accessory ? getActualStat(getInvItem(eq.accessory)) : 0;
    let magTotal = mStat + gameData.baseStatus.mag;

    let atkFSize = atkTotal >= 1000 ? 14 : 18;
    let defFSize = defTotal >= 1000 ? 14 : 18;
    let magFSize = magTotal >= 1000 ? 14 : 18;

    drawText(`ÊîªÊíÉÂäõ: ${atkTotal} (Âü∫Êú¨${gameData.baseStatus.atk} + Ë£ÖÂÇô${wStat})`, x+20, cy, atkFSize, '#2980b9'); cy += 30;
    drawText(`Èò≤Âæ°Âäõ: ${defTotal} (Âü∫Êú¨${gameData.baseStatus.def} + Ë£ÖÂÇô${defEqTotal})`, x+20, cy, defFSize, '#27ae60'); cy += 30;
    drawText(`È≠îÊ≥ïÂäõ: ${magTotal} (Âü∫Êú¨${gameData.baseStatus.mag} + Ë£ÖÂÇô${mStat})`, x+20, cy, magFSize, '#8e44ad'); cy += 40;

    const slots = [
        {key:'weapon', icon:'buki'}, {key:'shield', icon:'tate'},
        {key:'armor', icon:'yoroi'}, {key:'accessory', icon:'yubiwa'}, {key:'potion', icon:'kusuri'}
    ];
    slots.forEach(s => {
        let itemStr = "„Å™„Åó";
        let starStr = "";
        let color = '#7f8c8d';
        if(eq[s.key]) {
            let invItem = getInvItem(eq[s.key]);
            let m = getObjById(ITEMS, invItem.itemId);
            let actualStat = getActualStat(invItem);
            let upgStr = (invItem.upgrade || 0) > 0 ? `+${invItem.upgrade}` : "";
            
            if (m.type >= 1 && m.type <= 4) starStr = getEquipRarityStar(invItem.stat, m.stat);
            
            if(m.type === 1) itemStr = `${m.name}${upgStr} (Êîª${actualStat})`;
            else if(m.type === 2 || m.type === 3) itemStr = `${m.name}${upgStr} (Èò≤${actualStat})`;
            else if(m.type === 4) itemStr = `${m.name}${upgStr} (È≠î${actualStat})`;
            else if(m.type === 5) itemStr = m.name;
            color = getItemColor(m);
        }
        
        let iconSize = 24;
        drawImageRect(s.icon, x+15, cy-12, iconSize, iconSize);
        let fSize = 18;
        if (itemStr.length > 12) fSize = 13;
        drawText(itemStr, x+45, cy-8, fSize, color);
        if (starStr) {
            drawText(starStr, x+45, cy+10, 12, color);
        }
        
        if(eq[s.key]) {
            drawBtn("Â§ñ„Åô", x+270, cy-14, 45, 28, '#e74c3c', () => { eq[s.key] = null; });
        }
        cy += 45;
    });

    drawBtn("„Éò„É´„Éó", x+20, y+620, 290, 40, '#f39c12', () => { showHelp = true; });
}

function drawCenterPanel(x, y) {
    drawPanel(x, y, 410, 680, "");
    
    let imgKey = GAME_STATE === "SHOP" ? 'shop' : 'rest';
    if (imgKey === 'shop') {
        ctx.fillStyle = '#8e44ad'; ctx.fillRect(x+10, y+10, 390, 219);
        ctx.fillStyle = '#fff'; ctx.font = 'bold 30px "M PLUS Rounded 1c"';
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        ctx.fillText('„ÅäÂ∫ó', x+205, y+119);
    } else {
        drawImageRect(imgKey, x+10, y+10, 390, 219);
    }

    ctx.fillStyle = '#ecf0f1'; ctx.fillRect(x+10, y+240, 390, 250);
    ctx.strokeStyle = '#bdc3c7'; ctx.strokeRect(x+10, y+240, 390, 250);
    for(let i=0; i<gameData.messages.length; i++) drawText(gameData.messages[i], x+20, y+265 + i*22, 16, '#2c3e50');

    drawBtn("Êé¢Á¥¢", x+20, y+510, 175, 60, '#2ecc71', () => { GAME_STATE = "EXPLORE_SELECT"; });
    drawBtn("„ÅäÂ∫ó", x+215, y+510, 175, 60, '#9b59b6', () => { GAME_STATE = "SHOP"; });
    drawBtn("‰ºë„ÇÄ", x+20, y+590, 175, 60, '#f1c40f', () => {
        activePopup = {
            text: "‰ºë„Åø„Åæ„Åô„ÅãÔºü",
            subtext: "AP„ÅåÂõûÂæ©„Åó„Å¶Ê¨°„ÅÆÊó•„Å´„Å™„Çä„Åæ„Åô„ÄÇ",
            onYes: () => {
                restEffect.active = true; restEffect.alpha = 0; restEffect.phase = 'in';
            }
        };
    });
    drawBtn("ÁµÇ‰∫Ü", x+215, y+590, 175, 60, '#e74c3c', () => {
        activePopup = {
            text: "„Åì„Åì„ÅßÂÜíÈô∫„ÇíÁµÇ‰∫Ü„Åó„Å¶Êú¨ÂΩì„Å´„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü",
            subtext: "‚Äª„Çª„Éº„Éñ„ÅØ„Åï„Çå„Åæ„Åõ„Çì„ÄÇ",
            onYes: () => finishGame(false)
        };
    });
}

function drawRightPanel(x, y) {
    drawPanel(x, y, 460, 680, "ÊåÅ„Å°Áâ©„Éª„ÇØ„É©„Éï„Éà");
    let cy = y + 60;
    
    drawText(`ÊâÄÊåÅÈáë: ${gameData.gold} G`, x+20, cy, 22, '#f39c12');
    
    drawBtn("Êï¥ÁêÜ", x+360, cy-20, 80, 40, '#1abc9c', () => {
        const typeOrder = {1:1, 2:2, 3:3, 4:4, 5:5, 9:6, 6:7, 7:8, 8:9};
        gameData.inventory.sort((a, b) => {
            let m1 = getObjById(ITEMS, a.itemId);
            let m2 = getObjById(ITEMS, b.itemId);
            if (typeOrder[m1.type] !== typeOrder[m2.type]) return typeOrder[m1.type] - typeOrder[m2.type];
            return a.itemId - b.itemId;
        });
        addMessage("ÈÅìÂÖ∑„ÇíÊï¥ÁêÜ„Åó„Åü„ÄÇ");
    });
    
    cy += 40;

    drawBtn("ÂÖ®„Å¶", x+20, cy, 70, 35, currentInvTab==="ALL" ? '#3498db' : '#bdc3c7', () => {currentInvTab="ALL"; invPage=0;});
    drawBtn("ÂêàÊàê", x+95, cy, 70, 35, currentInvTab==="CRAFT" ? '#3498db' : '#bdc3c7', () => {currentInvTab="CRAFT"; invPage=0;});
    drawBtn("Âº∑Âåñ", x+170, cy, 70, 35, currentInvTab==="ENHANCE" ? '#3498db' : '#bdc3c7', () => {currentInvTab="ENHANCE"; invPage=0;});
    
    if(currentInvTab === "ALL") {
        drawBtn("ÊèõÈáëÁâ©„ÅÆ‰∏ÄÊã¨Â£≤Âç¥", x+245, cy, 195, 35, '#e67e22', () => {
            let lootItems = [];
            let totalVal = 0;
            gameData.inventory.forEach(inv => {
                let m = getObjById(ITEMS, inv.itemId);
                let isMat = false;
                if(typeof CRAFT_RULES !== 'undefined') {
                    for(let k in CRAFT_RULES) {
                        if(CRAFT_RULES[k].mat1Id === m.id || CRAFT_RULES[k].mat2Id === m.id) { isMat = true; break; }
                    }
                }
                let isEquip = m.type >= 1 && m.type <= 4;
                let isPotion = m.type === 5;
                let isShopItem = m.type === 9 || m.type === 10;
                let isLoot = !isEquip && !isPotion && !isShopItem && !isMat;
                
                if(isLoot) {
                    lootItems.push(inv);
                    totalVal += m.price * inv.count;
                }
            });
            
            if(lootItems.length === 0) {
                addMessage("‰∏ÄÊã¨Â£≤Âç¥„Åß„Åç„ÇãÊèõÈáëÁâ©„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ");
                return;
            }
            activePopup = {
                text: `ÊèõÈáëÁâ©„ÇíÂÖ®„Å¶Â£≤Âç¥„Åó„Å¶ ${totalVal} G „Å´Êèõ„Åà„Åæ„Åô„ÄÇ`,
                subtext: "„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü",
                onYes: () => {
                    lootItems.forEach(inv => {
                        gameData.gold += getObjById(ITEMS, inv.itemId).price * inv.count;
                        gameData.inventory = gameData.inventory.filter(i => i.uid !== inv.uid);
                    });
                    addMessage(`ÊèõÈáëÁâ©„Çí‰∏ÄÊã¨Â£≤Âç¥„Åó„ÄÅ${totalVal} G Âæó„Åü„ÄÇ`);
                }
            };
        });
    }
    
    cy += 70; 

    if(currentInvTab === "CRAFT") renderCraftList(x, y, cy);
    else if(currentInvTab === "ENHANCE") renderEnhanceList(x, y, cy);
    else renderInventoryList(x, y, cy);
}

function confirmSellAll(inv, master) {
    activePopup = {
        text: `„Åì„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÇíÂÖ®„Å¶Â£≤„Çä„Åæ„Åô„ÅãÔºü`,
        subtext: `${master.name} x${inv.count} (+${master.price * inv.count}G)`,
        onYes: () => {
            sellItem(inv, master, true);
            addMessage(`${master.name}„ÇíÂÖ®„Å¶Â£≤Âç¥„Åó„Åü„ÄÇ`);
        }
    };
}

function renderInventoryList(x, y, cy) {
    let list = gameData.inventory;
    const itemsPerPage = 10; 
    let maxPage = Math.max(0, Math.ceil(list.length / itemsPerPage) - 1);
    let pageItems = list.slice(invPage * itemsPerPage, (invPage + 1) * itemsPerPage);

    pageItems.forEach(inv => {
        let master = getObjById(ITEMS, inv.itemId);
        
        let isEquip = master.type >= 1 && master.type <= 4;
        let isPotion = master.type === 5;
        
        let star = "";
        if (isEquip) star = getEquipRarityStar(inv.stat, master.stat);
        else if (master.type === 8 && master.prob) star = getLootRarityCoin(master.prob);

        let upgStr = (inv.upgrade || 0) > 0 ? `+${inv.upgrade}` : "";
        let nameTxt = master.name + upgStr;
        let actualStat = getActualStat(inv);

        if(master.type === 1) nameTxt += ` (Êîª${actualStat})`;
        else if(master.type === 2 || master.type === 3) nameTxt += ` (Èò≤${actualStat})`;
        else if(master.type === 4) nameTxt += ` (È≠î${actualStat})`;

        let textColor = getItemColor(master);

        let currentX = x + 15;
        
        drawText(nameTxt, currentX, cy-8, 18, textColor);
        if (star) {
            drawText(star, currentX, cy+10, 12, textColor);
        }

        if(!isEquip) {
            drawText(`x${inv.count}`, x + 240, cy, 18, '#2c3e50', 'right');
        }

        drawText(`${master.price}G`, x + 310, cy, 18, '#f39c12', 'right');

        let isEquipped = Object.values(gameData.equipment).includes(inv.uid);

        if(isEquip) {
            if(isEquipped) {
                drawBtn("Ë£ÖÂÇô‰∏≠", x+320, cy-15, 60, 30, '#e74c3c', () => {}, true);
            } else {
                drawBtn("Ë£ÖÂÇô", x+320, cy-15, 60, 30, '#2ecc71', () => equipItem(inv));
            }
            drawBtn("Â£≤Âç¥", x+390, cy-15, 50, 30, '#e67e22', () => sellItem(inv, master));
        } else if (isPotion) {
            if(isEquipped) {
                drawBtn("Ë£ÖÂÇô‰∏≠", x+310, cy-15, 50, 30, '#e74c3c', () => {}, true);
            } else {
                drawBtn("Ë£ÖÂÇô", x+310, cy-15, 50, 30, '#2ecc71', () => equipItem(inv));
            }
            drawBtn("Â£≤", x+365, cy-15, 35, 30, '#e67e22', () => sellItem(inv, master));
            if (inv.count > 1) {
                drawBtn("all", x+405, cy-15, 35, 30, '#d35400', () => confirmSellAll(inv, master));
            }
        } else {
            drawBtn("Â£≤Âç¥", x+350, cy-15, 45, 30, '#e67e22', () => sellItem(inv, master));
            if (inv.count > 1) {
                drawBtn("all", x+400, cy-15, 40, 30, '#d35400', () => confirmSellAll(inv, master));
            }
        }
        cy += 45; 
    });

    drawText(`${invPage+1} / ${maxPage+1}`, x+230, y+650, 18, '#2c3e50', 'center');
    if(invPage > 0) drawBtn("Ôºú", x+110, y+635, 50, 35, '#34495e', () => invPage--);
    if(invPage < maxPage) drawBtn("Ôºû", x+300, y+635, 50, 35, '#34495e', () => invPage++);
}

function equipItem(inv) {
    let m = getObjById(ITEMS, inv.itemId), key = "";
    if(m.type === 1) key = 'weapon'; if(m.type === 2) key = 'shield';
    if(m.type === 3) key = 'armor'; if(m.type === 4) key = 'accessory'; if(m.type === 5) key = 'potion';
    if(key) { gameData.equipment[key] = inv.uid; addMessage(`${m.name}„ÇíË£ÖÂÇô„Åó„Åü„ÄÇ`); }
}

function sellItem(inv, master, sellAll = false) {
    for(let k in gameData.equipment) { if(gameData.equipment[k] === inv.uid) return addMessage("Ë£ÖÂÇô‰∏≠„ÅØÂ£≤Âç¥„Åß„Åç„Åæ„Åõ„Çì„ÄÇ"); }
    let amount = sellAll ? inv.count : 1;
    gameData.gold += master.price * amount; 
    removeItem(inv.itemId, amount);
    if(master.type >= 1 && master.type <= 4) gameData.inventory = gameData.inventory.filter(i => i.uid !== inv.uid);
}

function renderCraftList(x, y, cy) {
    let tabCy = cy - 10;
    for(let i=1; i<=7; i++) {
        let btnX = x + 20 + (i-1)*55;
        drawBtn(`Lv${i}`, btnX, tabCy, 50, 30, craftTabLevel===i ? '#e67e22' : '#bdc3c7', () => {
            craftTabLevel = i;
            invPage = 0;
        });
    }
    cy += 65;

    let craftableIds = Object.keys(CRAFT_RULES).map(Number).filter(id => {
        let isUnlocked = gameData.unlockedRecipes.includes(CRAFT_RULES[id].recipeId);
        let m = getObjById(ITEMS, id);
        return isUnlocked && m.lv === craftTabLevel;
    });

    const itemsPerPage = 7; 
    let maxPage = Math.max(0, Math.ceil(craftableIds.length / itemsPerPage) - 1);
    let pageItems = craftableIds.slice(invPage * itemsPerPage, (invPage + 1) * itemsPerPage);

    pageItems.forEach(targetId => {
        let rule = CRAFT_RULES[targetId];
        let targetMaster = getObjById(ITEMS, targetId);
        let tColor = getItemColor(targetMaster);
        
        let reqs = getRecipeRequirements(targetMaster, rule);
        if (reqs && reqs.baseItem && reqs.matItem) {
            let cBase = countItem(reqs.baseItem.id);
            let cMat = countItem(reqs.matItem.id);
            let canCraft = (cBase >= 1) && (cMat >= reqs.matCount);
            
            drawText(targetMaster.name, x+15, cy-15, 20, canCraft ? tColor : '#95a5a6');
            drawText(`${reqs.baseItem.name}(${cBase}/1) + ${reqs.matItem.name}(${cMat}/${reqs.matCount})`, x+15, cy+15, 16, '#7f8c8d');
            
            drawBtn("‰ΩúÊàê", x+350, cy-20, 80, 40, canCraft ? '#3498db' : '#bdc3c7', () => {
                if(gameData.ap < 1) return addMessage("AP„ÅåË∂≥„Çä„Åæ„Åõ„Çì„ÄÇ");
                removeItem(reqs.baseItem.id, 1);
                removeItem(reqs.matItem.id, reqs.matCount);
                gameData.ap -= 1;
                addItem(targetId, targetMaster.type <= 4 ? getGaussianStat(targetMaster.stat) : 0, 1);
                addMessage(`${targetMaster.name}„Çí‰ΩúÊàê„Åó„ÅüÔºÅ`);
            }, !canCraft);
        } else {
            let m1 = getObjById(ITEMS, rule.mat1Id), m2 = rule.mat2Id ? getObjById(ITEMS, rule.mat2Id) : null;
            let c1 = countItem(rule.mat1Id), c2 = m2 ? countItem(rule.mat2Id) : 0;
            let canCraft = (c1 > 0) && (!m2 || c2 > 0);

            drawText(targetMaster.name, x+15, cy-15, 20, canCraft ? tColor : '#95a5a6');
            drawText(`${m1.name}(${c1}/1)` + (m2 ? ` + ${m2.name}(${c2}/1)` : ""), x+15, cy+15, 16, '#7f8c8d');
            
            drawBtn("‰ΩúÊàê", x+350, cy-20, 80, 40, canCraft ? '#3498db' : '#bdc3c7', () => {
                if(gameData.ap < 1) return addMessage("AP„ÅåË∂≥„Çä„Åæ„Åõ„Çì„ÄÇ");
                removeItem(rule.mat1Id, 1); if(rule.mat2Id) removeItem(rule.mat2Id, 1);
                gameData.ap -= 1;
                addItem(targetId, targetMaster.type <= 4 ? getGaussianStat(targetMaster.stat) : 0, 1);
                addMessage(`${targetMaster.name}„Çí‰ΩúÊàê„Åó„ÅüÔºÅ`);
            }, !canCraft);
        }
        cy += 65; 
    });

    drawText(`${invPage+1} / ${maxPage+1}`, x+230, y+650, 18, '#2c3e50', 'center');
    if(invPage > 0) drawBtn("Ôºú", x+110, y+635, 50, 35, '#34495e', () => invPage--);
    if(invPage < maxPage) drawBtn("Ôºû", x+300, y+635, 50, 35, '#34495e', () => invPage++);
}

function renderEnhanceList(x, y, cy) {
    let list = gameData.inventory.filter(inv => {
        let m = getObjById(ITEMS, inv.itemId);
        return m.type >= 1 && m.type <= 4;
    });
    const itemsPerPage = 10; 
    let maxPage = Math.max(0, Math.ceil(list.length / itemsPerPage) - 1);
    let pageItems = list.slice(invPage * itemsPerPage, (invPage + 1) * itemsPerPage);

    pageItems.forEach(inv => {
        let master = getObjById(ITEMS, inv.itemId);
        let star = getEquipRarityStar(inv.stat, master.stat);
        let upg = inv.upgrade || 0;
        let upgStr = upg > 0 ? `+${upg}` : "";
        
        let nameTxt = master.name + upgStr;
        let actualStat = getActualStat(inv);

        if(master.type === 1) nameTxt += ` (Êîª${actualStat})`;
        else if(master.type === 2 || master.type === 3) nameTxt += ` (Èò≤${actualStat})`;
        else if(master.type === 4) nameTxt += ` (È≠î${actualStat})`;

        drawText(nameTxt, x + 15, cy-8, 18, getItemColor(master));
        if (star) {
            drawText(star, x + 15, cy+10, 12, getItemColor(master));
        }

        let cost = master.price * 2;
        let canEnhance = gameData.gold >= cost && upg < 10;
        let costTxt = upg >= 10 ? "MAX" : `${cost}G`;

        drawText(costTxt, x + 300, cy, 18, '#f39c12', 'right');

        drawBtn("Âº∑Âåñ", x+320, cy-15, 120, 30, canEnhance ? '#9b59b6' : '#bdc3c7', () => {
            if (upg >= 10) return addMessage("„Åì„Çå‰ª•‰∏äÂº∑Âåñ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ");
            if (gameData.gold < cost) return addMessage("„ÅäÈáë„ÅåË∂≥„Çä„Åæ„Åõ„Çì„ÄÇ");
            gameData.gold -= cost;
            inv.upgrade = upg + 1;
            addMessage(`${master.name}„ÇíÂº∑Âåñ„Åó„ÅüÔºÅ`);
        }, !canEnhance);
        
        cy += 45; 
    });

    drawText(`${invPage+1} / ${maxPage+1}`, x+230, y+650, 18, '#2c3e50', 'center');
    if(invPage > 0) drawBtn("Ôºú", x+110, y+635, 50, 35, '#34495e', () => invPage--);
    if(invPage < maxPage) drawBtn("Ôºû", x+300, y+635, 50, 35, '#34495e', () => invPage++);
}

// --- Êé¢Á¥¢„Éª„ÅäÂ∫ó ---
function finishExploration(isClear) {
    if (exploreData && exploreData.gainedExpTotal > 0) {
        addMessage(`Êé¢Á¥¢ÁµÇ‰∫Ü„ÄÇÁµåÈ®ìÂÄ§ ${exploreData.gainedExpTotal} „ÇíÁç≤Âæó„Åó„ÅüÔºÅ`);
    }

    if (gameData.equipment.potion) {
        let pUid = gameData.equipment.potion;
        let pInv = getInvItem(pUid);
        gameData.equipment.potion = null;
        if (pInv) {
            pInv.count--;
            if (pInv.count <= 0) {
                gameData.inventory = gameData.inventory.filter(i => i.uid !== pUid);
            }
        }
        addMessage("Ë£ÖÂÇô„Åó„Å¶„ÅÑ„ÅüËñ¨„ÇíÊ∂àË≤ª„Åó„Åü„ÄÇ");
    }
    
    if (isClear && exploreData.stage.lv === 7) {
        let assets = calculateTotalAssets();
        let scoreData = { name: currentPlayerName, days: gameData.day, assets: assets, isClear: true };
        
        let localRank = JSON.parse(localStorage.getItem('fgl_local_ranking')) || [];
        localRank.push(scoreData);
        localRank.sort((a, b) => a.days - b.days || b.assets - a.assets);
        localStorage.setItem('fgl_local_ranking', JSON.stringify(localRank));
        
        activePopup = {
            isClearPopup: true,
            assets: assets,
            level: gameData.level,
            days: gameData.day,
            saving: true
        };
        
        if(firebase.apps.length > 0 && firebaseConfig.apiKey !== "YOUR_API_KEY") {
            db.collection(FIRESTORE_COLLECTION).add({
                ...scoreData, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => { if(activePopup && activePopup.isClearPopup) activePopup.saving = false; })
              .catch(() => { if(activePopup && activePopup.isClearPopup) activePopup.saving = false; });
        } else {
            setTimeout(() => { if(activePopup && activePopup.isClearPopup) activePopup.saving = false; }, 1000);
        }
        GAME_STATE = "MAIN";
    } else {
        GAME_STATE = "MAIN";
    }
}

function renderExploreSelect(x, y) {
    drawPanel(x, y, 410, 680, "Êé¢Á¥¢„Ç®„É™„Ç¢ÈÅ∏Êäû");
    let cy = y + 80;
    STAGES.forEach(stg => {
        let isUnlock = stg.lv <= gameData.maxStageLv;
        let maxFloor = stg.lv * 5 + 5; 

        drawText(`Lv.${stg.lv} ${stg.name} (ÊúÄÂ§ß${maxFloor}Èöé)`, x+20, cy, 18, isUnlock ? '#2c3e50' : '#95a5a6');
        drawBtn("Êé¢Á¥¢", x+300, cy-15, 90, 40, isUnlock ? '#e74c3c' : '#bdc3c7', () => {
            if(gameData.ap < 1) return addMessage("AP„ÅåË∂≥„Çä„Åæ„Åõ„ÇìÔºÅ");
            
            let cp = calcCombatPower();
            let n = stg.lv;
            let maxF = 0;
            
            for(let f = 1; f <= maxFloor; f++) {
                if(cp >= getStageFloorDifficulty(n, f)) maxF = f;
                else break;
            }
            
            let r = Math.random();
            let drop = r < 0.5 ? 0 : r < 0.75 ? 1 : r < 0.9 ? 2 : 3;
            let reachedF = maxF - drop;
            if(maxF >= 1 && reachedF < 1) reachedF = 1; 

            exploreData = {
                stage: stg,
                currentFloor: 0,
                maxFloor: maxFloor,
                maxPossibleFloor: reachedF,
                gainedExpTotal: 0
            };

            if (gameData.equipment.potion) {
                addMessage("Ëñ¨„ÅÆÂäõ„ÅßÊé¢Á¥¢„ÅåÊúâÂà©„Å´„Å™„ÇãÔºÅ");
            }
            addMessage(`${stg.name}„ÅÆÊé¢Á¥¢„ÇíÈñãÂßã„Åó„Åü„ÄÇ`);

            GAME_STATE = "EXPLORING";
        }, !isUnlock);
        cy += 75;
    });
    drawBtn("Êàª„Çã", x+145, y+620, 120, 50, '#7f8c8d', () => { GAME_STATE = "MAIN"; });
}

function renderExploring(x, y) {
    drawPanel(x, y, 410, 680, "");
    let imgKey = 'map' + exploreData.stage.lv;
    drawImageRect(imgKey, x+10, y+10, 390, 219);

    ctx.fillStyle = '#ecf0f1'; ctx.fillRect(x+10, y+240, 390, 250);
    ctx.strokeStyle = '#bdc3c7'; ctx.strokeRect(x+10, y+240, 390, 250);
    for(let i=0; i<gameData.messages.length; i++) drawText(gameData.messages[i], x+20, y+265 + i*22, 16, '#2c3e50');

    drawText(`${exploreData.stage.name} - ÁèæÂú® ${exploreData.currentFloor} / ${exploreData.maxFloor}Èöé`, x+205, y+520, 20, '#2c3e50', 'center');

    drawBtn("ÈÄ≤„ÇÄ", x+20, y+560, 115, 60, '#3498db', () => advanceFloor(false));
    drawBtn("SKIP", x+145, y+560, 115, 60, '#e67e22', () => advanceFloor(true));
    drawBtn("Â∏∞„Çã", x+270, y+560, 115, 60, '#95a5a6', () => { 
        addMessage("Êé¢Á¥¢„ÇíÂàá„Çä‰∏ä„Åí„Å¶Â∏∞ÈÇÑ„Åó„Åü„ÄÇ"); 
        finishExploration(false); 
    });
}

function advanceFloor(isSkip) {
    do {
        if(gameData.ap < 1) {
            addMessage("AP„ÅåË∂≥„Çä„Å™„ÅÑÔºÅÂ∏∞ÈÇÑ„Åó„Åü„ÄÇ");
            finishExploration(false);
            break;
        }

        if(exploreData.currentFloor >= exploreData.maxPossibleFloor) {
            addMessage("Êïµ„ÅåÂº∑„Åô„Åé„Å¶ÈÄ≤„ÇÅ„Å™„ÅÑÔºÅÈÄÉ„ÅíÂ∏∞„Å£„Åü...");
            gameData.ap -= 1; 
            finishExploration(false);
            break;
        }

        exploreData.currentFloor++;
        gameData.ap -= 1;
        
        let stg = exploreData.stage;
        let gainedExp = getStageFloorDifficulty(stg.lv, exploreData.currentFloor);
        let actualGainedExp = Math.floor(gainedExp);
        gameData.exp += actualGainedExp;
        exploreData.gainedExpTotal += actualGainedExp;

        let pool = ITEMS.filter(i => i.lv === stg.lv && i.prob > 0);
        if (pool.length > 0) {
            let dropCount = Math.floor(Math.random() * 4) + 1;
            let drops = {};
            for(let k = 0; k < dropCount; k++) {
                let tProb = pool.reduce((s, i) => s + i.prob, 0);
                let rnd = Math.random() * tProb, cur = 0, droppedItem = null;
                for(let item of pool) {
                    cur += item.prob;
                    if(rnd <= cur) { droppedItem = item; break; }
                }
                if(droppedItem) {
                    drops[droppedItem.id] = (drops[droppedItem.id] || 0) + 1;
                }
            }
            
            let dropMsgs = [];
            for(let id in drops) {
                let count = drops[id];
                let itemMaster = getObjById(ITEMS, parseInt(id));
                addItem(itemMaster.id, 0, count);
                dropMsgs.push(`${itemMaster.name}√ó${count}`);
            }
            if(dropMsgs.length > 0) {
                addMessage(`${exploreData.currentFloor}Èöé: ${dropMsgs.join('„ÄÅ')} „ÇíGETÔºÅ`);
            } else {
                addMessage(`${exploreData.currentFloor}Èöé: ‰Ωï„ÇÇË¶ã„Å§„Åã„Çâ„Å™„Åã„Å£„Åü„ÄÇ`);
            }
        } else {
            addMessage(`${exploreData.currentFloor}Èöé: ‰Ωï„ÇÇË¶ã„Å§„Åã„Çâ„Å™„Åã„Å£„Åü„ÄÇ`);
        }

        checkLevelUp();

        if(exploreData.currentFloor >= exploreData.maxFloor) {
            addMessage(`${stg.name}„ÅÆÊúÄÊ∑±ÈÉ®„ÇíÂà∂Ë¶á„Åó„ÅüÔºÅ`);
            if(gameData.maxStageLv === stg.lv) { gameData.maxStageLv++; addMessage(`Êñ∞„Ç®„É™„Ç¢Ëß£ÊîæÔºÅ`); }
            finishExploration(true);
            break;
        }

    } while(isSkip);
}

function renderShop(x, y) {
    drawPanel(x, y, 410, 680, "„ÅäÂ∫ó (ÂÖ±ÈÄö„Éë„Éº„ÉÑ„Éª„É¨„Ç∑„Éî)");
    drawText(`ÊâÄÊåÅÈáë: ${gameData.gold} G`, x+20, y+70, 24, '#f39c12');
    
    drawBtn("ÂÖ±ÈÄö", x+20, y+100, 50, 30, shopTab==="COMMON" ? '#e67e22' : '#bdc3c7', () => {shopTab="COMMON"; shopPage=0;});
    for(let i=1; i<=7; i++) {
        drawBtn(`Lv${i}`, x+75 + (i-1)*45, y+100, 40, 30, shopTab===`LV${i}` ? '#e67e22' : '#bdc3c7', () => {shopTab=`LV${i}`; shopPage=0;});
    }

    let shopItems = ITEMS.filter(i => {
        if (shopTab === "COMMON") return i.type === 9;
        if (shopTab.startsWith("LV")) {
            let lv = parseInt(shopTab.replace("LV", ""));
            return i.type === 10 && i.lv === lv;
        }
        return false;
    }); 
    
    let pageItems = shopItems.slice(shopPage * 7, (shopPage + 1) * 7);
    let cy = y+165;
    pageItems.forEach(item => {
        let isRecipe = item.type === 10;
        let isSoldOut = isRecipe && gameData.unlockedRecipes.includes(item.id);
        let canBuy = !isSoldOut && gameData.gold >= item.price;

        let fSize = 18;
        if (item.name.length >= 15) fSize = 13;
        else if (item.name.length >= 11) fSize = 15;

        drawText(`${item.price}G ${item.name}`, x+15, cy, fSize, isSoldOut ? '#95a5a6' : canBuy ? getItemColor(item) : '#e74c3c');
        
        let btnX = x+330;
        let btnY = cy-15;
        let btnW = 60;
        let btnH = 35;

        if (item.type === 9) {
            drawText(`ÊâÄÊåÅ:${countItem(item.id)}`, btnX - 10, cy, 14, '#2c3e50', 'right');
        }

        if (isSoldOut) {
            drawBtn("Â£≤Âàá", btnX, btnY, btnW, btnH, '#bdc3c7', () => {}, true);
        } else {
            drawBtn("Ë≥ºÂÖ•", btnX, btnY, btnW, btnH, canBuy ? '#3498db' : '#bdc3c7', () => {
                gameData.gold -= item.price;
                if(item.type === 10) { gameData.unlockedRecipes.push(item.id); addMessage(`„É¨„Ç∑„ÉîÁøíÂæóÔºÅ`); }
                else { addItem(item.id, 0, 1); addMessage(`${item.name}„ÇíË≥ºÂÖ•„ÄÇ`); }
            }, !canBuy);
        }
        cy += 65;
    });

    drawText(`${shopPage+1} / ${Math.max(0, Math.ceil(shopItems.length/7)-1)+1}`, x+205, y+650, 20, '#2c3e50', 'center');
    if(shopPage > 0) drawBtn("Ôºú", x+110, y+630, 50, 40, '#34495e', () => shopPage--);
    if(shopPage < Math.ceil(shopItems.length/7)-1) drawBtn("Ôºû", x+250, y+630, 50, 40, '#34495e', () => shopPage++);
    drawBtn("Êàª„Çã", x+20, y+630, 80, 40, '#7f8c8d', () => { GAME_STATE = "MAIN"; });
}

// --- „É™„Ç∂„É´„Éà„Éª„É©„É≥„Ç≠„É≥„Ç∞„Éª„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó ---
function finishGame(isClear) {
    GAME_STATE = "RESULT";
    let assets = calculateTotalAssets();
    let scoreData = { name: currentPlayerName, days: gameData.day, assets: assets, isClear: isClear };

    let localRank = JSON.parse(localStorage.getItem('fgl_local_ranking')) || [];
    localRank.push(scoreData);
    localRank.sort((a, b) => a.days - b.days || b.assets - a.assets);
    localStorage.setItem('fgl_local_ranking', JSON.stringify(localRank));

    if(firebase.apps.length > 0 && firebaseConfig.apiKey !== "YOUR_API_KEY") {
        db.collection(FIRESTORE_COLLECTION).add({
            ...scoreData, timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => setTimeout(() => { rankingTab="LOCAL"; GAME_STATE="RANKING"; }, 2000))
          .catch(() => setTimeout(() => { rankingTab="LOCAL"; GAME_STATE="RANKING"; }, 2000));
    } else {
        setTimeout(() => { rankingTab="LOCAL"; GAME_STATE="RANKING"; }, 2000);
    }
}

function renderResult() {
    ctx.fillStyle = '#ecf0f1'; ctx.fillRect(0,0,1280,720);
    drawText("„Ç≤„Éº„É†ÁµÇ‰∫Ü", 640, 200, 60, '#2c3e50', 'center');
    drawText(`Á∑èË≥áÁî£: ${calculateTotalAssets()} G`, 640, 360, 30, '#f39c12', 'center');
    drawText("„Éá„Éº„ÇøÂá¶ÁêÜ‰∏≠...", 640, 500, 20, '#7f8c8d', 'center');
}

function renderRanking() {
    drawImageRect('title', 0, 0, 1280, 720);
    ctx.fillStyle = 'rgba(236, 240, 241, 0.85)'; 
    ctx.fillRect(0,0,1280,720);
    drawText("üèÜ „É©„É≥„Ç≠„É≥„Ç∞ üèÜ", 640, 60, 50, '#f39c12', 'center');

    drawBtn("„É≠„Éº„Ç´„É´", 440, 120, 150, 40, rankingTab==="LOCAL" ? '#e74c3c' : '#bdc3c7', () => rankingTab="LOCAL");
    drawBtn("„ÉØ„Éº„É´„Éâ", 690, 120, 150, 40, rankingTab==="WORLD" ? '#3498db' : '#bdc3c7', () => {
        rankingTab="WORLD";
        if(!rankingDataWorld && firebaseConfig.apiKey !== "YOUR_API_KEY") {
            db.collection(FIRESTORE_COLLECTION).orderBy("days", "asc").orderBy("assets", "desc").limit(10).get()
              .then(snap => { rankingDataWorld = []; snap.forEach(doc => rankingDataWorld.push(doc.data())); })
              .catch(error => { 
                  console.error("„É©„É≥„Ç≠„É≥„Ç∞ÂèñÂæó„Ç®„É©„Éº:", error);
                  if(error.message && error.message.includes("index")) {
                      console.error("‰ª•‰∏ã„ÅÆ„É™„É≥„ÇØ„Åã„ÇâË§áÂêà„Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ:\n" + error.message);
                  }
                  rankingDataWorld = []; 
              });
        }
    });

    let displayData = [];
    if(rankingTab === "LOCAL") {
        displayData = JSON.parse(localStorage.getItem('fgl_local_ranking')) || [];
    } else {
        displayData = rankingDataWorld;
    }

    let startY = 200;
    let tableX = 240, tableW = 800;

    if(displayData && displayData.length > 0) {
        ctx.fillStyle = '#34495e'; ctx.fillRect(tableX, startY, tableW, 40);
        drawText("È†Ü‰Ωç", tableX+50, startY+20, 20, '#fff', 'center');
        drawText("ÂêçÂâç", tableX+120, startY+20, 20, '#fff', 'left');
        drawText("Êó•Êï∞", tableX+440, startY+20, 20, '#fff', 'center');
        drawText("Á∑èË≥áÁî£", tableX+580, startY+20, 20, '#fff', 'right');
        drawText("ÁµêÊûú", tableX+700, startY+20, 20, '#fff', 'center');

        let cy = startY + 60;
        displayData.slice(0, 10).forEach((d, idx) => {
            if(idx % 2 === 1) {
                ctx.fillStyle = 'rgba(189, 195, 199, 0.3)';
                ctx.fillRect(tableX, cy - 20, tableW, 40);
            }
            let clr = d.isClear ? "‚òÖ„ÇØ„É™„Ç¢" : "„É™„Çø„Ç§„Ç¢";
            let tColor = '#2c3e50';
            drawText(`${idx+1}‰Ωç`, tableX+50, cy, 20, tColor, 'center');
            drawText(d.name, tableX+120, cy, 20, tColor, 'left');
            drawText(`${d.days}Êó•`, tableX+440, cy, 20, tColor, 'center');
            drawText(`${d.assets} G`, tableX+580, cy, 20, '#f39c12', 'right');
            drawText(clr, tableX+700, cy, 20, d.isClear ? '#e74c3c' : '#7f8c8d', 'center');
            
            ctx.strokeStyle = '#bdc3c7'; ctx.lineWidth = 1;
            ctx.beginPath(); ctx.moveTo(tableX, cy+20); ctx.lineTo(tableX+tableW, cy+20); ctx.stroke();
            cy += 40;
        });
        
        ctx.strokeStyle = '#34495e'; ctx.lineWidth = 2;
        ctx.strokeRect(tableX, startY, tableW, cy - startY);
    } else {
        drawText(rankingTab==="WORLD" && !rankingDataWorld ? "Ë™≠„ÅøËæº„Åø‰∏≠..." : "„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì", 640, 300, 24, '#2c3e50', 'center');
    }

    drawBtn("„Çø„Ç§„Éà„É´„Å∏Êàª„Çã", 540, 640, 200, 50, '#2c3e50', () => { GAME_STATE = "TITLE"; });
}

function renderHelpPopup() {
    clickZones = []; 
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(0,0,1280,720);
    
    let px = 240, py = 40, pw = 800, ph = 640;
    ctx.save();
    ctx.beginPath(); ctx.roundRect(px, py, pw, ph, 15); ctx.clip();
    ctx.fillStyle = '#ecf0f1'; ctx.fill();
    ctx.fillStyle = '#34495e'; ctx.fillRect(px, py, pw, 50);
    drawText("Â∫èÁõ§„ÅÆÈÄ≤„ÇÅÊñπ", px + pw/2, py + 25, 24, '#fff', 'center');
    ctx.restore();
    ctx.strokeStyle = '#34495e'; ctx.lineWidth = 4;
    ctx.beginPath(); ctx.roundRect(px, py, pw, ph, 15); ctx.stroke();
    
    let lines = [
        "ÊúÄÂàù„Å´„ÄÅÊ¨°„ÅÆ„Åì„Å®„Çí„ÇÑ„Å£„Å¶„Åø„Çà„ÅÜ",
        "‚ë†„ÅäÂ∫ó„Å´Ë°å„Å£„Å¶„Åø„Çà„ÅÜ„ÄÇ",
        "‚ë°„Äå„Å≤„ÇÇ„Äç„Å®„ÄåÊú®„ÅÆÁõæ„ÅÆ„É¨„Ç∑„Éî„Äç„ÇíË≥ºÂÖ•„Åó„Çà„ÅÜ„ÄÇ",
        "‚ë¢Êú®„ÅÆÁõæ„ÇíÂêàÊàê„Åó„Å¶Ë£ÖÂÇô„Åó„Çà„ÅÜ„ÄÇ",
        "‚ë£Êé¢Á¥¢„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶„ÄÅÂßã„Åæ„Çä„ÅÆÊ£Æ„ÇíÊé¢Á¥¢„Åó„Çà„ÅÜ„ÄÇ",
        "‚ë§GET„Åó„Åü„Ç¢„Ç§„ÉÜ„É†„ÇíÂ£≤„Å£„Å¶„ÄÅ„É¨„Ç∑„Éî„ÇíË≥ºÂÖ•„Åó„Å¶Êñ∞„Åó„ÅÑË£ÖÂÇô„Çí‰Ωú„Å£„Å¶„Åø„Çà„ÅÜ„ÄÇ",
        "‚ë•AP„Åå„Å™„Åè„Å™„Å£„Åü„Çâ‰ºë„ÇÄ„Å®ÂõûÂæ©„Åô„Çã„Çà„ÄÇ",
        "„ÄåÁ´ú„ÅÆÁÅ´Âè£„Äç„ÅÆÊúÄÊ∑±ÈÉ®„ÇíÁõÆÊåá„Åù„ÅÜÔºÅ",
        "",
        "„Åù„ÅÆ‰ªñ„ÅÆ„ÉØ„É≥„Éù„Ç§„É≥„Éà„Ç¢„Éâ„Éê„Ç§„Çπ",
        "„ÉªÊèõÈáëÁâ©„ÅØ„Å®„Åè„Å´‰Ωø„ÅÑÈÅì„ÅØ„Å™„ÅÑ„ÅÆ„ÅßÂ£≤„Å£„Å¶„Åó„Åæ„Åä„ÅÜ„ÄÇü™ô„ÅÆÊï∞„ÅåÂ§ö„ÅÑ„Åª„Å©‰æ°ÂÄ§„ÅåÈ´ò„ÅÑ„Çà„ÄÇ",
        "„Éª„É¨„Ç∑„Éî„ÅØ‰∏ÄÂ∫¶Ë≤∑„Åà„Å∞‰Ωú„ÇäÊñπ„ÅØË¶ö„Åà„Çã„Çà„ÄÇ",
        "„ÉªË£ÖÂÇô„ÅØÂº∑„ÅÑ„ÇÇ„ÅÆ„Å®Âº±„ÅÑ„ÇÇ„ÅÆ„Åå„É©„É≥„ÉÄ„É†„Åß‰ΩúÊàê„Åï„Çå„Çã„Çà„ÄÇ‚≠ê„ÅÆÊï∞„Åß„Å†„ÅÑ„Åü„ÅÑ„ÅÆÂº∑„Åï„Åå„Çè„Åã„Çã„Çà„ÄÇ",
        "„ÉªËñ¨„ÅØ‰∏ÄÂõû„ÅÆÊé¢Á¥¢„Åß„Å™„Åè„Å™„Å£„Å¶„Åó„Åæ„ÅÜ„Åë„Å©„ÄÅÊé¢Á¥¢„ÅÆÊàêÂäüÁéá„ÅåÈ´ò„Åè„Å™„Çã„Çà„ÄÇ",
        "„Éª„Çª„Éº„Éñ„ÅØÂá∫Êù•„Å™„ÅÑ„Çà„ÄÇ",
        "„Éª„ÇØ„É™„Ç¢ÊôÇ„ÅÆÊó•Êï∞„Å®Á∑èË≥áÁî£„ÅåË®òÈå≤„Åï„Çå„Çã„Çà„ÄÇËâØ„ÅÑÊàêÁ∏æ„Å™„Çâ„É©„É≥„Ç≠„É≥„Ç∞„Å´Ëºâ„Çã„Çà„ÄÇ"
    ];
    
    let cy = py + 80;
    for (let line of lines) {
        drawText(line, px + 30, cy, 18, '#2c3e50', 'left', 'normal');
        cy += 28;
    }
    
    drawBtn("Èñâ„Åò„Çã", px + pw/2 - 75, py + 570, 150, 50, '#e74c3c', () => { showHelp = false; });
}

function renderPopup() {
    clickZones = []; 
    ctx.fillStyle = 'rgba(0,0,0,0.6)';
    ctx.fillRect(0,0,1280,720);
    
    let px = 340, py = 260, pw = 600, ph = 200;
    
    if (activePopup.isClearPopup) {
        py = 100; ph = 520;
    }

    ctx.save();
    ctx.beginPath(); ctx.roundRect(px, py, pw, ph, 15); ctx.clip();
    ctx.fillStyle = '#ecf0f1'; ctx.fill();
    ctx.restore();
    
    ctx.strokeStyle = '#34495e'; ctx.lineWidth = 4;
    ctx.beginPath(); ctx.roundRect(px, py, pw, ph, 15); ctx.stroke();
    
    if (activePopup.isClearPopup) {
        drawText("„Ç≤„Éº„É†„ÇØ„É™„Ç¢ÔºÅ", px + pw/2, py + 40, 30, '#f1c40f', 'center', '900');
        drawImageRect('clear', px + 40, py + 70, 520, 292);
        
        let cy = py + 390;
        drawText(`Á∑èË≥áÁî£: ${activePopup.assets} G`, px + pw/2, cy, 22, '#f39c12', 'center'); cy += 30;
        drawText(`ÊúÄÁµÇ„É¨„Éô„É´: Lv.${activePopup.level}`, px + pw/2, cy, 20, '#2c3e50', 'center'); cy += 30;
        drawText(`„ÇØ„É™„Ç¢Êó•Êï∞: ${activePopup.days}Êó•`, px + pw/2, cy, 20, '#2c3e50', 'center'); cy += 40;
        
        if (activePopup.saving) {
            drawText("„É©„É≥„Ç≠„É≥„Ç∞„Éá„Éº„ÇøÈÄÅ‰ø°‰∏≠...", px + pw/2, cy, 16, '#7f8c8d', 'center');
        } else {
            drawBtn("„Çø„Ç§„Éà„É´„Å∏Êàª„Çã", px + pw/2 - 100, cy - 20, 200, 50, '#3498db', () => {
                activePopup = null;
                GAME_STATE = "TITLE";
            });
        }
    } else if(activePopup.isPrompt) {
        drawText(activePopup.text, px + pw/2, py + 40, 22, '#2c3e50', 'center');
        if (activePopup.subtext) {
            drawText(activePopup.subtext, px + pw/2, py + 120, 16, '#e74c3c', 'center');
        }
        drawBtn("Ê±∫ÂÆö", px + 100, py + 140, 150, 45, '#3498db', () => {
            if(activePopup.onYes) activePopup.onYes();
        });
        drawBtn("„Ç≠„É£„É≥„Çª„É´", px + 350, py + 140, 150, 45, '#7f8c8d', () => {
            if(activePopup.onNo) activePopup.onNo();
        });
    } else {
        drawText(activePopup.text, px + pw/2, py + 60, 22, '#2c3e50', 'center');
        if (activePopup.subtext) {
            drawText(activePopup.subtext, px + pw/2, py + 95, 18, '#e74c3c', 'center');
        }
        
        if(activePopup.isAlert) {
            drawBtn("Á¢∫Ë™ç", px + pw/2 - 75, py + 130, 150, 45, '#3498db', () => { activePopup = null; });
        } else {
            drawBtn("„ÅØ„ÅÑ", px + 100, py + 130, 150, 45, '#e74c3c', () => {
                let onYes = activePopup.onYes;
                activePopup = null;
                if(onYes) onYes();
            });
            drawBtn("„ÅÑ„ÅÑ„Åà", px + 350, py + 130, 150, 45, '#7f8c8d', () => {
                activePopup = null;
            });
        }
    }
}

function loop() {
    ctx.clearRect(0, 0, cvs.width, cvs.height);
    clickZones = [];
    switch(GAME_STATE) {
        case "TITLE": renderTitle(); break;
        case "PLAYER_SELECT": renderPlayerSelect(); break;
        case "MAIN": drawStatusPanel(20, 20); drawCenterPanel(370, 20); drawRightPanel(800, 20); break;
        case "EXPLORE_SELECT": drawStatusPanel(20, 20); renderExploreSelect(370, 20); drawRightPanel(800, 20); break;
        case "EXPLORING": drawStatusPanel(20, 20); renderExploring(370, 20); drawRightPanel(800, 20); break;
        case "SHOP": drawStatusPanel(20, 20); renderShop(370, 20); drawRightPanel(800, 20); break;
        case "RESULT": renderResult(); break;
        case "RANKING": renderRanking(); break;
    }

    if (showHelp) {
        renderHelpPopup();
    } else if (activePopup) {
        renderPopup();
    }

    if (restEffect.active) {
        ctx.fillStyle = `rgba(0, 0, 0, ${restEffect.alpha})`;
        ctx.fillRect(0, 0, 1280, 720);
        
        if (restEffect.phase === 'in') {
            restEffect.alpha += 0.05;
            if (restEffect.alpha >= 1) {
                restEffect.alpha = 1;
                restEffect.phase = 'out';
                gameData.day++;
                gameData.ap = gameData.maxAp;
                addMessage(`${gameData.day}Êó•ÁõÆ„Å´„Å™„Å£„Åü„ÄÇAPÂÖ®ÂõûÂæ©ÔºÅ`);
            }
        } else {
            restEffect.alpha -= 0.05;
            if (restEffect.alpha <= 0) {
                restEffect.alpha = 0;
                restEffect.active = false;
            }
        }
    }

    requestAnimationFrame(loop);
}

cvs.addEventListener("click", (e) => {
    const rect = cvs.getBoundingClientRect();
    const scaleX = 1280 / rect.width;
    const scaleY = 720 / rect.height;
    const x = (e.clientX - rect.left) * scaleX;
    const y = (e.clientY - rect.top) * scaleY;
    for (let i = clickZones.length - 1; i >= 0; i--) {
        let z = clickZones[i];
        if (x >= z.x && x <= z.x + z.w && y >= z.y && y <= z.y + z.h) { z.onClick(); break; }
    }
});

requestAnimationFrame(loop); 

if (firebase.apps.length > 0 && firebaseConfig.apiKey !== "YOUR_API_KEY") {
    firebase.auth().onAuthStateChanged((user) => {
        if (user && !user.isAnonymous) {
            googleUser = user;
        } else {
            googleUser = null;
        }
    });
    firebase.auth().signInAnonymously().catch(e => console.warn("Auth Info: ", e.message));
}

</script>
</body>
</html>
