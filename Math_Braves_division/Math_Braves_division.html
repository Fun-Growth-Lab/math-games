<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>„Çè„Çä„Åñ„Çì„Éê„Éà„É´ - Math Braves Division</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #222;
            font-family: "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
        }
        #container {
            width: 1280px;
            height: 720px;
            flex-shrink: 0;
            display: flex;
            background-color: #f0f4f8;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            transform-origin: center center;
        }
        
        #left-panel, #right-panel {
            flex: 0 0 280px;
            width: 280px;
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            z-index: 10;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        
        #left-panel {
            justify-content: space-between;
        }
        
        #right-panel {
            justify-content: center;
        }

        #game-area {
            flex: 1;
            position: relative;
            background-color: #ecf0f1;
            overflow: hidden;
        }

        /* APË°®Á§∫Áî® (‰∏≠Â§Æ‰∏äÈÉ®) */
        #ap-display-container {
            position: absolute;
            top: 15px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 5;
            background: rgba(255, 255, 255, 0.95);
            padding: 5px 25px;
            border-radius: 10px;
            border: 2px solid #2ecc71;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        #ap-label {
            font-size: 0.9rem;
            color: #27ae60;
            font-weight: bold;
        }
        #ap-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2ecc71;
            line-height: 1;
            text-shadow: 1px 1px 0 #fff;
        }
        #quota-remaining {
            font-size: 1.0rem;
            color: #e74c3c;
            font-weight: bold;
            margin-top: 5px;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        h2 { margin-top: 0; border-bottom: 2px solid #3498db; padding-bottom: 10px; font-size: 1.2rem; }
        .info-item { margin-bottom: 20px; font-size: 1.0rem; }
        .info-value { font-size: 2.0rem; font-weight: bold; color: #f1c40f; }
        .info-label { font-size: 0.9rem; color: #bdc3c7; margin-bottom: 5px; }
        
        .info-value-quota { font-size: 2.5rem; font-weight: bold; color: #e74c3c; }

        .invisible { visibility: hidden; }

        .btn {
            background-color: #3498db; color: white; border: none; padding: 10px 20px;
            border-radius: 5px; cursor: pointer; font-size: 1rem; margin: 5px;
            transition: background 0.2s;
            box-shadow: 0 4px 0 #2980b9;
            -webkit-tap-highlight-color: transparent;
        }
        .btn:hover { background-color: #2980b9; transform: translateY(2px); box-shadow: 0 2px 0 #2980b9; }
        .btn:active { transform: translateY(4px); box-shadow: none; }
        
        .btn-danger { background-color: #e74c3c; box-shadow: 0 4px 0 #c0392b; }
        .btn-danger:hover { background-color: #c0392b; box-shadow: 0 2px 0 #c0392b;}
        
        .btn-success { background-color: #2ecc71; box-shadow: 0 4px 0 #27ae60; }
        .btn-success:hover { background-color: #27ae60; box-shadow: 0 2px 0 #27ae60; }

        .btn-warning { background-color: #f1c40f; box-shadow: 0 4px 0 #d35400; color: #333; }
        .btn-warning:hover { background-color: #f39c12; box-shadow: 0 2px 0 #d35400; }
        
        .btn-auth {
            background-color: #ea4335; box-shadow: 0 4px 0 #d93025;
            color: white; padding: 12px 20px; font-weight: bold; margin-top: 15px;
        }
        .btn-auth:hover { background-color: #d93025; }
        
        .btn-toggle {
            background-color: #95a5a6; color: white; padding: 5px 15px; 
            font-size: 0.9rem; margin: 0 5px; box-shadow: none;
        }
        .btn-toggle.active {
            background-color: #f1c40f; color: #333; pointer-events: none;
        }

        #overlay, #ranking-overlay, #player-manager-overlay, #round-clear-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex; justify-content: center; align-items: center;
            z-index: 100;
            flex-direction: column;
            color: white;
        }
        .overlay-content {
            background: #34495e; padding: 30px; border-radius: 10px;
            text-align: center; max-width: 90%; width: 90%;
            max-height: 90vh; overflow-y: auto;
        }
        
        .hidden { display: none !important; }
        
        .difficulty-container {
            display: flex; justify-content: center; gap: 15px; margin-bottom: 20px; align-items: flex-end;
        }
        .diff-wrapper {
            display: flex; flex-direction: column; align-items: center; position: relative;
        }
        .crown-icon {
            font-size: 2rem; margin-bottom: -5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3); filter: drop-shadow(0 0 5px rgba(255,255,0,0.5));
            visibility: hidden;
        }
        .clear-count-text {
            font-size: 1.1rem; color: #2c3e50; font-weight: bold; margin-top: 5px;
        }
        .difficulty-container button {
            width: 120px; padding: 15px 0; font-size: 1rem; font-weight: bold; margin: 0;
        }
        
        #game-result {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 20; width: 80%; max-width: 500px;
        }

        /* Ranking & Player Manager Styles */
        .ranking-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: nowrap; padding-bottom: 0; }
        .ranking-box { background: #2c3e50; padding: 10px; border-radius: 8px; flex: 1; min-width: 0; border: 2px solid #7f8c8d; }
        .ranking-title { font-weight: bold; color: #f1c40f; margin-bottom: 8px; border-bottom: 1px solid #555; padding-bottom: 5px; font-size: 1rem; }
        .ranking-list { list-style: none; padding: 0; margin: 0; text-align: left; font-size: 0.85rem; height: 300px; overflow-y: auto; }
        .ranking-list li { padding: 5px 0; border-bottom: 1px dashed #444; display: flex; justify-content: space-between; }
        .ranking-rank { display: inline-block; width: 20px; color: #bdc3c7; }
        .ranking-name { display: inline-block; width: 80px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; vertical-align: bottom; }
        .ranking-score { font-weight: bold; color: white; float: right; }

        #player-select-btn {
            background-color: #8e44ad; color: white; padding: 10px 30px;
            border-radius: 30px; cursor: pointer; font-size: 1.2rem;
            box-shadow: 0 4px 0 #6c3483; border: none; display: flex; align-items: center; gap: 10px;
            margin-bottom: 20px; transition: transform 0.1s;
        }
        #player-select-btn:hover { transform: scale(1.05); }
        #player-select-btn:active { transform: scale(0.95); box-shadow: 0 2px 0 #6c3483; }

        .player-list { list-style: none; padding: 0; margin: 20px 0; display: flex; flex-direction: column; gap: 10px; }
        .player-item {
            background: #2c3e50; padding: 10px 20px; border-radius: 8px;
            display: flex; justify-content: space-between; align-items: center;
            border: 2px solid transparent; cursor: pointer; transition: all 0.2s;
        }
        .player-item:hover { background: #34495e; }
        .player-item.selected { border-color: #f1c40f; background: #34495e; }
        .player-item-name { font-size: 1.2rem; font-weight: bold; flex: 1; text-align: left; }
        .delete-btn { background: #e74c3c; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; margin-left: 10px; }
        .add-player-form { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        .input-name { padding: 10px; font-size: 1rem; border-radius: 5px; border: none; width: 200px; }

    </style>
</head>
<body>

<div id="container">
    <div id="left-panel">
        <div>
            <h2>„ÅÇ„Åù„Å≥„Åã„Åü</h2>
            <div style="font-size: 0.85rem; line-height: 1.4;">
                <p>1. <strong>„Å¶„Åµ„Å†(2„Äú10)</strong> „Çí<br>
                <strong>„Å∞ „ÅÆ „Ç´„Éº„Éâ</strong> „Å´„Åã„Åï„Å≠„Å¶<br>
                „Çè„Çä„Åñ„Çì „Çí„Åó„Çà„ÅÜÔºÅ</p>
                
                <p>2. <strong>„Åó„Çá„ÅÜ(„Åì„Åü„Åà)</strong> „Å®<br>
                <strong>„ÅÇ„Åæ„Çä</strong> „ÅÆ „Éë„Éç„É´„Çí„ÅÜ„ÇÅ„Çà„ÅÜÔºÅ<br>
                („Ç∞„É¨„Éº„Å´„Å™„Å£„Åü„Çâ HITÔºÅ)</p>
                
                <p>3. <strong>„Åç„ÇÅ„Çâ„Çå„Åü „Åã„Åö</strong> „ÅÆ„Éë„Éç„É´„Çí<br>
                HIT„Åï„Åõ„Åü„Çâ „É©„Ç¶„É≥„Éâ„ÇØ„É™„Ç¢ÔºÅ</p>

                <p>4. <strong>„Çπ„Ç≥„Ç¢</strong><br>
                „Éª„Åü„Çì„Å©„ÅèHITÔºö100pt<br>
                „Éª„Å©„ÅÜ„ÅòHITÔºö300pt<br>
                <span style="color:#f1c40f;">‚òÖ„Çø„Éº„Ç≤„ÉÉ„Éà„Çí„Åµ„Åè„ÇÄ„Å®ÂÄçÁéáUP!</span><br>
                (1„Å§„Åß2ÂÄç„ÄÅ2„Å§„Åß4ÂÄç)</p>

                <p>5. <strong>AP(„Ç¢„ÇØ„Ç∑„Éß„É≥)</strong> „Å´„Å°„ÇÖ„ÅÜ„ÅÑ„ÄÇ<br>
                AP„Åå 0 „Å´„Å™„Çã„Å® „Åæ„Åë„Å†„Çà„ÄÇ<br>
                9„É©„Ç¶„É≥„Éâ „ÇØ„É™„Ç¢„Çí „ÇÅ„Åñ„Åù„ÅÜÔºÅ</p>
            </div>
        </div>
        <div>
            <button id="btn-back-to-title-ingame" class="btn hidden" style="background-color: #7f8c8d; box-shadow: 0 4px 0 #586364; width: 100%; box-sizing: border-box; margin: 0;">„Çø„Ç§„Éà„É´„Å∏</button>
        </div>
    </div>

    <div id="game-area">
        <canvas id="gameCanvas"></canvas>
        
        <div id="ap-display-container">
            <div id="ap-label">„ÅÆ„Åì„ÇäAP</div>
            <div id="ap-value">10</div>
            <div id="quota-remaining">„ÅÇ„Å® 10 „Åì</div>
        </div>
        
        <div id="title-screen" style="position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; z-index:10; background:linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(240,244,248,0.95) 100%); color:#333;">
            <div style="text-align: center; margin-bottom: 30px; transform: scale(1.1);">
                <h1 style="font-size:4rem; margin:0; color:#2980b9; text-shadow: 3px 3px 0 #2c3e50, 6px 6px 0 rgba(0,0,0,0.1); letter-spacing: 2px;">MATH BRAVES</h1>
                <p style="font-size:1.8rem; margin-top:5px; margin-bottom:10px; font-weight:bold; color:#2c3e50; letter-spacing: 5px;">- „Çè„Çä„Åñ„Çì „Éë„Éç„É´ -</p>
            </div>
            
            <button id="player-select-btn" title="„Éó„É¨„Éº„É§„Éº„Çí„Å∏„Çì„Åì„ÅÜ„Åô„Çã">
                <span style="font-size: 1.5rem;">üë§</span>
                <span id="current-player-name-display">ÂêçÁÑ°„Åó„Åï„Çì</span>
                <span style="font-size: 0.8rem; margin-left: 5px; opacity: 0.8;">(„Å∏„Çì„Åì„ÅÜ)</span>
            </button>

            <div class="difficulty-container" style="margin-bottom: 30px;">
                <div class="diff-wrapper">
                    <div id="crown-easy" class="crown-icon">üëë</div>
                    <button id="btn-easy" class="btn btn-success">„Åó„Çá„Åç„ÇÖ„ÅÜ</button>
                    <div id="clear-easy" class="clear-count-text">0Âõû„ÇØ„É™„Ç¢</div>
                </div>
                <div class="diff-wrapper">
                    <div id="crown-normal" class="crown-icon">üëë</div>
                    <button id="btn-normal" class="btn">„Å°„ÇÖ„ÅÜ„Åç„ÇÖ„ÅÜ</button>
                    <div id="clear-normal" class="clear-count-text">0Âõû„ÇØ„É™„Ç¢</div>
                </div>
                <div class="diff-wrapper">
                    <div id="crown-hard" class="crown-icon">üëë</div>
                    <button id="btn-hard" class="btn btn-danger">„Åò„Çá„ÅÜ„Åç„ÇÖ„ÅÜ</button>
                    <div id="clear-hard" class="clear-count-text">0Âõû„ÇØ„É™„Ç¢</div>
                </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 15px; align-items: center; width: 100%;">
                <div style="display: flex; flex-direction: column; align-items: center; background: rgba(0,0,0,0.05); padding: 10px 20px; border-radius: 8px;">
                    <p id="auth-status" style="margin: 0 0 10px 0; font-size: 0.85rem; color: #555; font-weight: bold;">„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
                    <div style="display: flex; gap: 10px;">
                        <button id="btn-login" class="btn btn-auth" style="margin:0; font-size: 0.9rem; padding: 8px 16px;">Google„Åß„É≠„Ç∞„Ç§„É≥</button>
                        <button id="btn-logout" class="btn btn-danger hidden" style="margin:0; font-size: 0.9rem; padding: 8px 16px;">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                    </div>
                </div>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <button id="btn-view-ranking" class="btn btn-warning" style="width: 180px; box-shadow: 0 4px 0 #d35400;">üèÜ „Çπ„Ç≥„Ç¢„Çí„Åø„Çã</button>
                    <button id="btn-index" class="btn" style="background-color: #7f8c8d; width: 180px; box-shadow: 0 4px 0 #586364;">üè† INDEX„Å∏</button>
                </div>
            </div>
        </div>

        <div id="game-result" style="display: none;"></div>
        
        <div id="round-clear-overlay" class="hidden">
            <div class="overlay-content">
                <h2 style="color: #f1c40f;">ROUND CLEAR!</h2>
                <p id="round-clear-msg" style="font-size: 1.8rem; font-weight: bold;">Ê¨°„ÅÆ„É©„Ç¶„É≥„Éâ„Å∏ÈÄ≤„Åø„Åæ„Åô„ÅãÔºü</p>
                <button id="btn-next-round" class="btn btn-success">„Å§„Åé„Å∏</button>
            </div>
        </div>

        <div id="ranking-screen" class="hidden">
            <div id="ranking-overlay">
                <div class="overlay-content" style="width: 95%; max-width: 900px;">
                    <h2 id="ranking-header-title" style="color: #f1c40f; margin-top: 0;">„Éô„Çπ„Éà„Çπ„Ç≥„Ç¢ 10</h2>
                    <div style="margin-bottom: 10px;">
                        <button id="btn-rank-local" class="btn btn-toggle active">„É≠„Éº„Ç´„É´</button>
                        <button id="btn-rank-world" class="btn btn-toggle">„ÉØ„Éº„É´„Éâ</button>
                    </div>
                    <div class="ranking-container">
                        <div class="ranking-box">
                            <div class="ranking-title" style="color: #2ecc71;">„Åó„Çá„Åç„ÇÖ„ÅÜ</div>
                            <ul id="rank-list-easy" class="ranking-list"></ul>
                        </div>
                        <div class="ranking-box">
                            <div class="ranking-title" style="color: #3498db;">„Å°„ÇÖ„ÅÜ„Åç„ÇÖ„ÅÜ</div>
                            <ul id="rank-list-normal" class="ranking-list"></ul>
                        </div>
                        <div class="ranking-box">
                            <div class="ranking-title" style="color: #e74c3c;">„Åò„Çá„ÅÜ„Åç„ÇÖ„ÅÜ</div>
                            <ul id="rank-list-hard" class="ranking-list"></ul>
                        </div>
                    </div>
                    <button id="btn-close-ranking" class="btn">„Å®„Åò„Çã</button>
                </div>
            </div>
        </div>

        <div id="player-manager-overlay" class="hidden">
            <div class="overlay-content" style="width: 400px;">
                <h2 style="color: #f1c40f; margin-top: 0;">„Éó„É¨„Éº„É§„Éº„Çí„Åà„Çâ„Å∂</h2>
                <div class="add-player-form">
                    <input type="text" id="input-new-player" class="input-name" placeholder="„Å™„Åæ„Åà („Å≤„Çâ„Åå„Å™ 12„ÇÇ„Åò)" maxlength="12">
                    <button id="btn-add-player" class="btn btn-success">„Å§„ÅÑ„Åã</button>
                </div>
                <ul id="player-list-ul" class="player-list"></ul>
                <button id="btn-close-player-manager" class="btn">„Å®„Åò„Çã</button>
            </div>
        </div>
    </div>

    <div id="right-panel">
        <div id="right-panel-content">
            <div class="info-item">
                <div class="info-label">Èõ£ÊòìÂ∫¶</div>
                <div id="disp-difficulty-label" class="info-value" style="font-size: 1.4rem; color: #fff;"></div>
            </div>
            <div class="info-item">
                <div class="info-label">„É©„Ç¶„É≥„Éâ</div>
                <div id="disp-round" class="info-value">1</div>
            </div>
            <div class="info-item">
                <div class="info-label">„ÇØ„É™„Ç¢„ÇÇ„Åè„Å≤„Çá„ÅÜ (HIT)</div>
                <div id="disp-quota" class="info-value-quota">10</div>
            </div>
            <div class="info-item">
                <div class="info-label">„Åí„Çì„Åñ„ÅÑ„ÅÆ HIT</div>
                <div id="disp-current-hits" class="info-value" style="color:#3498db;">0</div>
            </div>
            <div class="info-item" style="border-top: 1px dashed #7f8c8d; padding-top: 15px;">
                <div class="info-label">„Åî„ÅÜ„Åë„ÅÑ „Çπ„Ç≥„Ç¢</div>
                <div id="disp-total-score" class="info-value">0</div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, serverTimestamp, query, where, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBCg5dCEM89UmYYhfGqVeRf_VrUlg8_o-4",
      authDomain: "math-braves.firebaseapp.com",
      projectId: "math-braves",
      storageBucket: "math-braves.firebasestorage.app",
      messagingSenderId: "217117619290",
      appId: "1:217117619290:web:d227feb603970d3948d463"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    window.currentUser = null; 

    const btnLogin = document.getElementById('btn-login');
    const btnLogout = document.getElementById('btn-logout');
    const authStatus = document.getElementById('auth-status');

    window.handleLogin = function() {
        signInWithPopup(auth, provider)
            .then((result) => { console.log("„É≠„Ç∞„Ç§„É≥ÊàêÂäü:", result.user.displayName); })
            .catch((error) => { console.error("„É≠„Ç∞„Ç§„É≥„Ç®„É©„Éº:", error); alert("„É≠„Ç∞„Ç§„É≥„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ"); });
    };

    window.handleLogout = function() {
        signOut(auth).then(() => { console.log("„É≠„Ç∞„Ç¢„Ç¶„ÉàÊàêÂäü"); }).catch((error) => { console.error("„É≠„Ç∞„Ç¢„Ç¶„Éà„Ç®„É©„Éº:", error); });
    };

    onAuthStateChanged(auth, (user) => {
        if (user) {
            window.currentUser = { uid: user.uid, displayName: user.displayName || 'ÂêçÁÑ°„Åó„Åï„Çì' };
            if(authStatus) authStatus.textContent = `„É≠„Ç∞„Ç§„É≥‰∏≠: ${window.currentUser.displayName}`;
            if(btnLogin) btnLogin.classList.add('hidden');
            if(btnLogout) btnLogout.classList.remove('hidden');
        } else {
            window.currentUser = null;
            if(authStatus) authStatus.textContent = '„É≠„Ç∞„Ç§„É≥„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì';
            if(btnLogin) btnLogin.classList.remove('hidden');
            if(btnLogout) btnLogout.classList.add('hidden');
        }
    });

    window.saveOnlineScore = async (userId, customName, difficulty, score) => {
        try {
            const docId = `${userId}_${difficulty}_${Date.now()}`;
            await setDoc(doc(db, "scores_math_braves_division", docId), {
                uid: userId, name: customName, difficulty: difficulty, score: score, createdAt: serverTimestamp()
            });
        } catch (error) { console.error("Firestore„Å∏„ÅÆ‰øùÂ≠ò„Ç®„É©„Éº:", error); }
    };

    window.fetchOnlineRanking = async (difficulty) => {
        if (!window.currentUser) { return []; }
        try {
            const scoresRef = collection(db, "scores_math_braves_division");
            const q = query(scoresRef, where("difficulty", "==", difficulty));
            const querySnapshot = await getDocs(q);
            let ranking = [];
            querySnapshot.forEach((doc) => { ranking.push(doc.data()); });
            ranking.sort((a, b) => b.score - a.score);
            return ranking.slice(0, 10);
        } catch (error) { console.error("„É©„É≥„Ç≠„É≥„Ç∞ÂèñÂæó„Ç®„É©„Éº:", error); return []; }
    };
</script>
<script>
// Game Config
const SETTINGS = {
    EASY: { label: "„Åó„Çá„Åç„ÇÖ„ÅÜ", quota: 12, maxRound: 5 },
    NORMAL: { label: "„Å°„ÇÖ„ÅÜ„Åç„ÇÖ„ÅÜ", quota: 13, maxRound: 7 },
    HARD: { label: "„Åò„Çá„ÅÜ„Åç„ÇÖ„ÅÜ", quota: 14, maxRound: 9 }
};

let state = {
    screen: 'TITLE', 
    difficulty: 'NORMAL',
    round: 1,
    ap: 10,
    score: 0,
    roundHits: 0,
    quota: 10,
    equationText: "„Åì„Åì„Å´ „Åë„ÅÑ„Åï„Çì„Åó„Åç „Åå „Å≤„Çá„ÅÜ„Åò „Åï„Çå„Çã„Çà",
    // previewEquation: null, // ÂâäÈô§
    
    // Arrays
    cards: [null, null, null, null, null], // ÊâãÊú≠ (2-10)
    fieldCards: [null, null, null], // Â†¥Êú≠ 3Êûö
    
    // Panel States (true = hit/grayed out)
    quotientPanels: Array(10).fill(false), // Index 0->Val 1, Index 9->Val 10
    remainderPanels: Array(10).fill(false), // Index 0->Val 0, Index 9->Val 9

    targetQuotient: null, // „É©„Ç¶„É≥„Éâ„Åî„Å®„ÅÆ„Çø„Éº„Ç≤„ÉÉ„Éà
    targetRemainder: null,
    
    width: 0, height: 0, dragInfo: null,
    isProcessing: false, inputLocked: false,
    rankingMode: 'LOCAL',
    playerName: "ÂêçÁÑ°„Åó„Åï„Çì",
    particles: [],
    flash: 0
};

const NG_WORDS_HIRAGANA = ['„Åó„Å≠','„Åó„Å¨','„Åì„Çç„Åô','„Åï„Å§„Åå„ÅÑ','„Åò„Åï„Å§','„Å¶„Çç','„Å∞„Åè„Å†„Çì','„ÅØ„Çì„Åñ„ÅÑ','„Å∞„Åã','„ÅÇ„Åª','„Åæ„Å¨„Åë','„Åç„Å°„Åå„ÅÑ','„ÅÜ„Åñ„ÅÑ','„Åç„ÇÇ„ÅÑ','„Åè„Åö','„Åî„Åø','„Å°„Çì„Å°„Çì','„ÅÜ„Çì„Åì','„Åó„Å£„Åì','„Åà„Çç','„Å∏„Çì„Åü„ÅÑ'];

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const ui = {
    rightPanelContent: document.getElementById('right-panel-content'),
    difficultyLabel: document.getElementById('disp-difficulty-label'),
    apValue: document.getElementById('ap-value'), 
    apContainer: document.getElementById('ap-display-container'), 
    quotaRemaining: document.getElementById('quota-remaining'), 
    round: document.getElementById('disp-round'),
    quota: document.getElementById('disp-quota'),
    currentHits: document.getElementById('disp-current-hits'),
    totalScore: document.getElementById('disp-total-score'),
    title: document.getElementById('title-screen'),
    result: document.getElementById('game-result'),
    roundClearOverlay: document.getElementById('round-clear-overlay'),
    roundClearMsg: document.getElementById('round-clear-msg'),
    btnNextRound: document.getElementById('btn-next-round'),
    
    rankingScreen: document.getElementById('ranking-screen'),
    rankingHeaderTitle: document.getElementById('ranking-header-title'),
    btnEasy: document.getElementById('btn-easy'),
    btnNormal: document.getElementById('btn-normal'),
    btnHard: document.getElementById('btn-hard'),
    btnViewRanking: document.getElementById('btn-view-ranking'),
    btnCloseRanking: document.getElementById('btn-close-ranking'),
    btnLogin: document.getElementById('btn-login'),
    btnLogout: document.getElementById('btn-logout'),
    btnIndex: document.getElementById('btn-index'),
    btnRankLocal: document.getElementById('btn-rank-local'),
    btnRankWorld: document.getElementById('btn-rank-world'),
    playerSelectBtn: document.getElementById('player-select-btn'),
    currentPlayerDisplay: document.getElementById('current-player-name-display'),
    playerManagerOverlay: document.getElementById('player-manager-overlay'),
    inputNewPlayer: document.getElementById('input-new-player'),
    btnAddPlayer: document.getElementById('btn-add-player'),
    playerListUl: document.getElementById('player-list-ul'),
    btnClosePlayerManager: document.getElementById('btn-close-player-manager'),
    crowns: { EASY: document.getElementById('crown-easy'), NORMAL: document.getElementById('crown-normal'), HARD: document.getElementById('crown-hard') },
    clears: { EASY: document.getElementById('clear-easy'), NORMAL: document.getElementById('clear-normal'), HARD: document.getElementById('clear-hard') },
    btnBackToTitleIngame: document.getElementById('btn-back-to-title-ingame')
};

function resize() {
    const container = document.getElementById('container');
    const scale = Math.min(window.innerWidth / 1280, window.innerHeight / 720);
    container.style.transform = `scale(${scale})`;
    if (state.width === 0) {
        state.width = canvas.parentElement.clientWidth;
        state.height = canvas.parentElement.clientHeight;
        canvas.width = state.width;
        canvas.height = state.height;
    }
}
window.addEventListener('resize', resize);
resize();

// --- Storage & Ranking ---
function getLocalScores(diff) {
    const key = `math_braves_division_ranking_${diff}`;
    try { return JSON.parse(localStorage.getItem(key)) || []; } catch(e) { return []; }
}
function saveLocalScore(diff, name, score) {
    const key = `math_braves_division_ranking_${diff}`;
    let list = getLocalScores(diff);
    list.push({ name: name, score: score, date: Date.now() });
    list.sort((a,b) => b.score - a.score);
    list = list.slice(0, 10);
    localStorage.setItem(key, JSON.stringify(list));
}
function getClearCounts() {
    try { return JSON.parse(localStorage.getItem("math_braves_division_clears")) || { EASY:0, NORMAL:0, HARD:0 }; } catch(e) { return { EASY:0, NORMAL:0, HARD:0 }; }
}
function incrementClearCount(diff) {
    let counts = getClearCounts();
    counts[diff] = (counts[diff] || 0) + 1;
    localStorage.setItem("math_braves_division_clears", JSON.stringify(counts));
}

// --- Player Manager ---
function getPlayers() {
    try { return JSON.parse(localStorage.getItem("math_braves_players")) || []; } catch { return []; }
}
function savePlayers(list) { localStorage.setItem("math_braves_players", JSON.stringify(list)); }
function containsNgWord(text) { return NG_WORDS_HIRAGANA.some(word => text.includes(word)); }

// --- Game Logic Classes ---
class Card {
    constructor(val, x, y) {
        this.value = val; 
        this.x = x; this.y = y; this.w = 80; this.h = 120;
        this.targetX = x; this.targetY = y; this.isDragging = false;
        this.baseY = y;
    }
    update() {
        if (!this.isDragging) {
            this.x += (this.targetX - this.x) * 0.2;
            this.y += (this.targetY - this.y) * 0.2;
        }
    }
    draw(ctx) {
        ctx.fillStyle = '#fff';
        ctx.shadowBlur = 10; ctx.shadowColor = 'rgba(0,0,0,0.2)';
        ctx.beginPath(); ctx.roundRect(this.x, this.y, this.w, this.h, 10); ctx.fill();
        ctx.shadowBlur = 0; ctx.strokeStyle = '#333'; ctx.lineWidth = 2; ctx.stroke();
        ctx.fillStyle = '#333'; ctx.font = 'bold 36px Arial'; 
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        // ‰∏≠ÂøÉË™øÊï¥ (+3)
        ctx.fillText(this.value, this.x + this.w/2, this.y + this.h/2 + 3);
    }
}

class FieldCard {
    constructor(val, x, y) {
        this.value = val;
        this.w = 120; this.h = 120;
        this.x = x; this.y = y;
        this.scale = 0; this.targetScale = 1;
    }
    update() {
        if (this.scale < this.targetScale) this.scale += 0.05;
    }
    draw(ctx) {
        ctx.save();
        ctx.translate(this.x + this.w/2, this.y + this.h/2);
        ctx.scale(this.scale, this.scale);
        
        ctx.fillStyle = '#ecf0f1';
        ctx.shadowBlur = 15; ctx.shadowColor = 'rgba(0,0,0,0.3)';
        ctx.beginPath(); ctx.roundRect(-this.w/2, -this.h/2, this.w, this.h, 12); ctx.fill();
        ctx.shadowBlur = 0; ctx.strokeStyle = '#2980b9'; ctx.lineWidth = 4; ctx.stroke();
        
        ctx.fillStyle = '#2c3e50';
        ctx.font = 'bold 50px Arial';
        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
        // ‰∏≠ÂøÉË™øÊï¥
        ctx.fillText(this.value, 0, 3);
        
        ctx.restore();
    }
}

class Particle {
    constructor(x, y, color) {
        this.x = x; this.y = y; this.vx = (Math.random() - 0.5) * 15; this.vy = (Math.random() - 0.5) * 15;
        this.life = 1.0; this.color = color;
    }
    update() { this.x += this.vx; this.y += this.vy; this.life -= 0.03; }
    draw(ctx) {
        ctx.globalAlpha = Math.max(0, this.life); ctx.fillStyle = this.color;
        ctx.beginPath(); ctx.arc(this.x, this.y, Math.random()*8+2, 0, Math.PI*2); ctx.fill();
        ctx.globalAlpha = 1.0;
    }
}

function spawnParticle(x, y, color) {
    for (let i = 0; i < 20; i++) state.particles.push(new Particle(x, y, color));
}

// „Éë„Éç„É´ÊèèÁîª
function drawPanels(ctx) {
    // ‰∏äÈÉ®„ÅÆAPË°®Á§∫„ÇíÈÅø„Åë„Çã„Åü„ÇÅ„Å´YÂ∫ßÊ®ô„Çí‰∏ã„Åí„Çã
    const startY = 140; 
    const panelSize = 50;
    const gap = 10;
    
    const groupWidth = 5 * panelSize + 4 * gap;

    // Â∑¶ÔºöÂïÜ„Éë„Éç„É´ (1-10)
    const startX_Q = 30;
    const centerX_Q = startX_Q + groupWidth / 2;
    
    ctx.fillStyle = '#f1c40f';
    ctx.font = 'bold 20px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'alphabetic';
    ctx.fillText("ÂïÜ („Åó„Çá„ÅÜ)", centerX_Q, startY - 20);

    for(let i=0; i<10; i++) {
        const val = i + 1;
        const col = i % 5;
        const row = Math.floor(i / 5);
        const px = startX_Q + col * (panelSize + gap);
        const py = startY + row * (panelSize + gap);
        
        const isHit = state.quotientPanels[i];
        const isTarget = (val === state.targetQuotient);
        
        ctx.beginPath();
        ctx.roundRect(px, py, panelSize, panelSize, 5);
        if (isHit) {
            ctx.fillStyle = '#7f8c8d'; 
            ctx.fill();
            ctx.strokeStyle = '#7f8c8d';
            ctx.lineWidth = 1;
            ctx.stroke();
        } else {
            if (isTarget) {
                // „Çø„Éº„Ç≤„ÉÉ„ÉàÔºöËñÑ„ÅÑ„Ç™„É¨„É≥„Ç∏„ÅßÂ°ó„Çã
                ctx.fillStyle = 'rgba(241, 196, 15, 0.2)';
                ctx.fill();
                // Êû†ÔºöÈÄöÂ∏∏Ëâ≤„ÅßÂ§™„Åè
                ctx.strokeStyle = '#f39c12';
                ctx.lineWidth = 4;
            } else {
                ctx.fillStyle = '#fff';
                ctx.fill();
                ctx.strokeStyle = '#f39c12';
                ctx.lineWidth = 2;
            }
            ctx.stroke();
        }
        
        // „ÉÜ„Ç≠„Çπ„ÉàÊèèÁîª („Çø„Éº„Ç≤„ÉÉ„Éà„ÇÇÈªí„ÉªÂ§™Â≠ó)
        ctx.fillStyle = isHit ? '#bdc3c7' : '#333'; 
        ctx.font = isTarget ? 'bold 28px Arial' : 'bold 24px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        // ‰∏≠ÂøÉË™øÊï¥
        ctx.fillText(val, px + panelSize/2, py + panelSize/2 + 2);
    }

    // Âè≥Ôºö‰Ωô„Çä„Éë„Éç„É´ (0-9)
    const startX_R = state.width - groupWidth - 30;
    const centerX_R = startX_R + groupWidth / 2;
    
    ctx.fillStyle = '#3498db';
    ctx.font = 'bold 20px Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'alphabetic';
    ctx.fillText("‰Ωô„Çä („ÅÇ„Åæ„Çä)", centerX_R, startY - 20);

    for(let i=0; i<10; i++) {
        const val = i;
        const col = i % 5;
        const row = Math.floor(i / 5);
        const px = startX_R + col * (panelSize + gap);
        const py = startY + row * (panelSize + gap);
        
        const isHit = state.remainderPanels[i];
        const isTarget = (val === state.targetRemainder);
        
        ctx.beginPath();
        ctx.roundRect(px, py, panelSize, panelSize, 5);
        if (isHit) {
            ctx.fillStyle = '#7f8c8d'; 
            ctx.fill();
            ctx.strokeStyle = '#7f8c8d';
            ctx.lineWidth = 1;
            ctx.stroke();
        } else {
            if (isTarget) {
                // „Çø„Éº„Ç≤„ÉÉ„ÉàÔºöËñÑ„ÅÑÈùí„ÅßÂ°ó„Çã
                ctx.fillStyle = 'rgba(52, 152, 219, 0.2)';
                ctx.fill();
                // Êû†ÔºöÈÄöÂ∏∏Ëâ≤„ÅßÂ§™„Åè
                ctx.strokeStyle = '#2980b9';
                ctx.lineWidth = 4;
            } else {
                ctx.fillStyle = '#fff';
                ctx.fill();
                ctx.strokeStyle = '#2980b9';
                ctx.lineWidth = 2;
            }
            ctx.stroke();
        }
        
        ctx.fillStyle = isHit ? '#bdc3c7' : '#333';
        ctx.font = isTarget ? 'bold 28px Arial' : 'bold 24px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        // ‰∏≠ÂøÉË™øÊï¥
        ctx.fillText(val, px + panelSize/2, py + panelSize/2 + 2);
    }
}

// Ë®àÁÆóÂºèÊèèÁîª
function drawEquation(ctx) {
    const y = 320; // „Éë„Éç„É´(‰∏ãÁ´Ø260)„Å®Â†¥Êú≠(‰∏äÁ´Ø380)„ÅÆ‰∏≠Èñì
    
    const text = state.equationText;
    
    // „Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫„ÅÆÂàá„ÇäÊõø„Åà
    if (text === "„Åì„Åì„Å´ „Åë„ÅÑ„Åï„Çì„Åó„Åç „Åå „Å≤„Çá„ÅÜ„Åò „Åï„Çå„Çã„Çà") {
        ctx.font = 'bold 24px Arial'; // „Éó„É¨„Éì„É•„ÉºÁî®„ÅØÂ∞è„Åï„Åè
    } else {
        ctx.font = 'bold 40px Arial'; // ÂÆüÈöõ„ÅÆÂºè„ÅØÂ§ß„Åç„Åè
    }
    
    // ËÉåÊôØ„ÅÆÂ∏Ø„ÇíÊèèÁîª„Åó„Å¶ÂàÜ„Åã„Çä„ÇÑ„Åô„Åè„Åô„Çã
    const textMetrics = ctx.measureText(text);
    const bgWidth = Math.max(600, textMetrics.width + 60);
    const bgHeight = 60;
    
    ctx.fillStyle = 'rgba(236, 240, 241, 0.9)'; // ËñÑ„ÅÑËÉåÊôØËâ≤
    ctx.shadowBlur = 5; ctx.shadowColor = 'rgba(0,0,0,0.1)';
    ctx.beginPath();
    ctx.roundRect((state.width - bgWidth)/2, y - bgHeight/2, bgWidth, bgHeight, 30);
    ctx.fill();
    ctx.shadowBlur = 0;

    // „ÉÜ„Ç≠„Çπ„ÉàÊèèÁîª
    ctx.fillStyle = '#2c3e50';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(text, state.width / 2, y + 2);
}

// „Çø„Éº„Ç≤„ÉÉ„Éà„ÅÆ„Ç®„Éï„Çß„ÇØ„ÉàÂ∫ßÊ®ôÂèñÂæó„Éò„É´„Éë„ÉºÔºà„Ç®„Éï„Çß„ÇØ„Éà„ÅØÂâäÈô§„Åó„Åü„ÅåË®àÁÆóÁî®„Å´ÊÆã„ÅôÂèØËÉΩÊÄß„ÇíËÄÉÊÖÆÔºâ
function getPanelCenter(val, type) {
    const startY = 140; // Â§âÊõ¥Âæå„ÅÆYÂ∫ßÊ®ô
    const panelSize = 50;
    const gap = 10;
    const groupWidth = 5 * panelSize + 4 * gap;
    
    let index, startX;
    if (type === 'Q') { // Quotient 1-10
        index = val - 1;
        startX = 30;
    } else { // Remainder 0-9
        index = val;
        startX = state.width - groupWidth - 30;
    }
    
    if (index < 0 || index > 9) return null;
    
    const col = index % 5;
    const row = Math.floor(index / 5);
    const px = startX + col * (panelSize + gap);
    const py = startY + row * (panelSize + gap);
    
    return { x: px + panelSize/2, y: py + panelSize/2 };
}


// --- Main Game Logic ---

function startGame(difficulty) {
    state.difficulty = difficulty;
    state.screen = 'GAME';
    state.round = 1;
    state.score = 0;
    
    ui.title.style.display = 'none';
    ui.result.style.display = 'none';
    ui.btnBackToTitleIngame.classList.remove('hidden');
    ui.apContainer.classList.remove('hidden'); // APË°®Á§∫

    startRound(state.round);
}

function startRound(roundNum) {
    state.round = roundNum;
    const settings = SETTINGS[state.difficulty];
    state.quota = settings.quota;
    state.ap = 10;
    state.roundHits = 0;
    state.equationText = "„Åì„Åì„Å´ „Åë„ÅÑ„Åï„Çì„Åó„Åç „Åå „Å≤„Çá„ÅÜ„Åò „Åï„Çå„Çã„Çà";
    // state.previewEquation = null; // ÂâäÈô§
    
    // Reset Panels
    state.quotientPanels.fill(false);
    state.remainderPanels.fill(false);
    
    // „Çø„Éº„Ç≤„ÉÉ„Éà„ÅÆË®≠ÂÆö (ÂïÜ:1-10, ‰Ωô:0-9)
    state.targetQuotient = getRandomInt(1, 10);
    state.targetRemainder = getRandomInt(0, 9);
    
    state.particles = [];
    state.isProcessing = false;
    state.inputLocked = false;
    
    // Generate Hand (Unique 2-10)
    state.cards = [null, null, null, null, null];
    for (let i = 0; i < 5; i++) {
        refillHand(i);
    }
    
    // Generate Field Cards (3Êûö) - ÈáçË§á„Å™„Åó
    // Modified Logic: Min 10, Max (N+1)*10
    const minVal = 10;
    const maxVal = (state.round + 1) * 10; 
    
    // ÈáçË§á„Åó„Å™„ÅÑ„Çà„ÅÜ„Å´ÁîüÊàê
    let generatedFieldValues = [];
    for(let i=0; i<3; i++) {
        let val;
        do {
            val = getRandomInt(minVal, maxVal);
        } while (generatedFieldValues.includes(val));
        generatedFieldValues.push(val);
        
        const totalW = 3 * 120 + 2 * 30; 
        const startX = (state.width - totalW) / 2;
        // YÂ∫ßÊ®ô„Çí‰∏ã„Åí„Å¶„Éê„É©„É≥„ÇπË™øÊï¥ (380)
        state.fieldCards[i] = new FieldCard(val, startX + i * 150, 380);
    }
    
    updateUI();
    gameLoop();
}

function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function createCard(index, val) {
    const padding = 20;
    const cardW = 80;
    const totalW = 5 * cardW + 4 * padding;
    const startX = (state.width - totalW) / 2;
    // ÊâãÊú≠„ÅÆ‰ΩçÁΩÆ„ÇÇÂ∞ë„ÅóË™øÊï¥ (560)
    state.cards[index] = new Card(val, startX + index * (cardW + padding), 560); 
}

function refillHand(index) {
    const currentValues = state.cards.map(c => c ? c.value : -1);
    let newVal;
    do {
        newVal = getRandomInt(2, 10); 
    } while (currentValues.includes(newVal));
    
    createCard(index, newVal);
}

function gameLoop() {
    if (state.screen !== 'GAME') return;
    
    ctx.clearRect(0, 0, state.width, state.height);
    
    // Panels
    drawPanels(ctx);
    
    // Equation
    drawEquation(ctx);

    // Field Cards
    state.fieldCards.forEach(fc => {
        if(fc) { fc.update(); fc.draw(ctx); }
    });
    
    // Hand Cards
    state.cards.forEach(c => { if(c) { c.update(); c.draw(ctx); } });
    
    // Particles
    state.particles.forEach((p, i) => {
        p.update(); p.draw(ctx);
        if(p.life <= 0) state.particles.splice(i, 1);
    });
    
    // Flash
    if (state.flash > 0) {
        ctx.fillStyle = `rgba(255, 255, 255, ${state.flash})`;
        ctx.fillRect(0, 0, state.width, state.height);
        state.flash -= 0.1;
    }

    requestAnimationFrame(gameLoop);
}

// --- Input Handling ---
canvas.addEventListener('mousedown', handleInputStart);
canvas.addEventListener('mousemove', handleInputMove);
canvas.addEventListener('mouseup', handleInputEnd);
canvas.addEventListener('touchstart', (e) => { e.preventDefault(); handleInputStart(e.changedTouches[0]); }, {passive: false});
canvas.addEventListener('touchmove', (e) => { e.preventDefault(); handleInputMove(e.changedTouches[0]); }, {passive: false});
canvas.addEventListener('touchend', (e) => { e.preventDefault(); handleInputEnd(e.changedTouches[0]); }, {passive: false});

function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY };
}

function handleInputStart(e) {
    if (state.inputLocked) return;
    const pos = getPos(e);
    for (let i = 0; i < state.cards.length; i++) {
        const c = state.cards[i];
        if (c && pos.x >= c.x && pos.x <= c.x + c.w && pos.y >= c.y && pos.y <= c.y + c.h) {
            state.dragInfo = { index: i, offsetX: pos.x - c.x, offsetY: pos.y - c.y };
            c.isDragging = true;
            break;
        }
    }
}

function handleInputMove(e) {
    if (!state.dragInfo) return;
    const pos = getPos(e);
    const c = state.cards[state.dragInfo.index];
    c.x = pos.x - state.dragInfo.offsetX;
    c.y = pos.y - state.dragInfo.offsetY;

    // „Éâ„É≠„ÉÉ„Éó„Åô„Çã„Åæ„ÅßÂºè„ÅØË°®Á§∫„Åó„Å™„ÅÑ„Åü„ÇÅ„ÄÅ„Åì„Åì„Åß„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
}

function handleInputEnd(e) {
    if (!state.dragInfo) return;
    const idx = state.dragInfo.index;
    const card = state.cards[idx];
    const pos = getPos(e); 
    card.isDragging = false;
    state.dragInfo = null;
    // state.previewEquation = null; // ÂâäÈô§

    // Check collision with any Field Card
    for (let i = 0; i < state.fieldCards.length; i++) {
        const fc = state.fieldCards[i];
        if (fc && pos.x >= fc.x && pos.x <= fc.x + fc.w && pos.y >= fc.y && pos.y <= fc.y + fc.h) {
            processAttack(idx, i);
            return;
        }
    }
    
    // Êç®„Å¶Â†¥„Å™„Åó
}

function processAttack(cardIndex, fieldIndex) {
    if (state.ap <= 0) return;

    const card = state.cards[cardIndex];
    const fieldCard = state.fieldCards[fieldIndex];
    
    const divisor = card.value; 
    const dividend = fieldCard.value; 
    
    const quotient = Math.floor(dividend / divisor);
    const remainder = dividend % divisor;
    
    // Update Equation Text („Åì„Åì„ÅßÂàù„ÇÅ„Å¶Ë°®Á§∫)
    state.equationText = `${dividend} √∑ ${divisor} Ôºù ${quotient} „ÅÇ„Åæ„Çä ${remainder}`;
    
    state.ap--;
    
    let isQHit = false;
    let isRHit = false;
    
    // Check Quotient Panel (1-10) -> index = val - 1
    if (quotient >= 1 && quotient <= 10) {
        if (!state.quotientPanels[quotient - 1]) {
            state.quotientPanels[quotient - 1] = true;
            state.roundHits++;
            isQHit = true;
            const pos = getPanelCenter(quotient, 'Q');
            if (pos) spawnParticle(pos.x, pos.y, '#f1c40f');
        }
    }
    
    // Check Remainder Panel (0-9) -> index = val
    if (remainder >= 0 && remainder <= 9) {
        if (!state.remainderPanels[remainder]) {
            state.remainderPanels[remainder] = true;
            state.roundHits++;
            isRHit = true;
            const pos = getPanelCenter(remainder, 'R');
            if (pos) spawnParticle(pos.x, pos.y, '#3498db');
        }
    }
    
    // „Çπ„Ç≥„Ç¢Ë®àÁÆó
    let moveBaseScore = 0;
    if (isQHit && isRHit) {
        moveBaseScore = 300;
        state.flash = 0.2;
    } else if (isQHit || isRHit) {
        moveBaseScore = 100;
        state.flash = 0.1;
    }

    // „Çø„Éº„Ç≤„ÉÉ„ÉàÂÄçÁéáË®àÁÆó
    let targetMultiplier = 1;
    let targetHitCount = 0;

    if (isQHit && quotient === state.targetQuotient) targetHitCount++;
    if (isRHit && remainder === state.targetRemainder) targetHitCount++;

    if (targetHitCount === 1) targetMultiplier = 2;
    if (targetHitCount === 2) targetMultiplier = 4;

    const moveTotalScore = moveBaseScore * targetMultiplier;
    state.score += moveTotalScore;

    refillHand(cardIndex);
    
    // Â†¥Êú≠Êõ¥Êñ∞
    // Modified Logic: Min 10, Max (N+1)*10
    const minVal = 10;
    const maxVal = (state.round + 1) * 10;
    let newVal;
    const currentFieldValues = state.fieldCards.map((c, i) => i === fieldIndex ? -1 : c.value); 
    
    do {
        newVal = getRandomInt(minVal, maxVal);
    } while (currentFieldValues.includes(newVal));

    const totalW = 3 * 120 + 2 * 30; 
    const startX = (state.width - totalW) / 2;
    // YÂ∫ßÊ®ôË™øÊï¥Ê∏à„Åø (380)
    state.fieldCards[fieldIndex] = new FieldCard(newVal, startX + fieldIndex * 150, 380);
    
    updateUI();
    checkRoundStatus();
}

function checkRoundStatus() {
    const allQ = state.quotientPanels.every(b => b);
    const allR = state.remainderPanels.every(b => b);
    const isFullClear = allQ && allR;
    
    const isQuotaMet = state.roundHits >= state.quota;
    
    if (isFullClear || isQuotaMet) {
        setTimeout(handleRoundClear, 500);
    } else if (state.ap <= 0) {
        setTimeout(handleGameOver, 500);
    }
}

function handleRoundClear() {
    state.inputLocked = true;
    
    // AP„Éú„Éº„Éä„ÇπË®àÁÆó„Å®Âä†ÁÆó
    const apBonus = state.ap * 500;
    state.score += apBonus;
    updateUI();
    
    // Determine Max Round based on difficulty
    const currentMaxRound = SETTINGS[state.difficulty].maxRound;

    if (state.round >= currentMaxRound) {
        handleGameClear();
    } else {
        ui.roundClearOverlay.classList.remove('hidden');
        // „Éú„Éº„Éä„ÇπË°®Á§∫ËøΩÂä†
        ui.roundClearMsg.innerHTML = `„É©„Ç¶„É≥„Éâ ${state.round} „ÇØ„É™„Ç¢ÔºÅ<br>„Çπ„Ç≥„Ç¢: ${state.score} <span style="font-size:0.6em; color:#f1c40f; display:block; margin-top:5px;">(AP„Éú„Éº„Éä„Çπ +${apBonus})</span>`;
        
        ui.btnNextRound.onclick = () => {
            ui.roundClearOverlay.classList.add('hidden');
            startRound(state.round + 1);
        };
    }
}

function handleGameClear() {
    state.isProcessing = true;
    state.inputLocked = true;
    ui.btnBackToTitleIngame.classList.add('hidden');
    ui.apContainer.classList.add('hidden');
    
    incrementClearCount(state.difficulty);
    saveScoreData();

    ui.result.style.display = 'block';
    
    let titleText = (state.round >= SETTINGS[state.difficulty].maxRound && state.ap > 0) ? "GAME CLEAR!" : "FINISH!";
    let color = "#27ae60";

    ui.result.innerHTML = `
        <div style="background: ${color}; padding: 20px; border-radius: 10px; color: white; text-align: center; border: 4px solid #fff; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
            <h2 style="margin:0; font-size: 2.5rem; color: #f1c40f;">${titleText}</h2>
            <p>Âà∞ÈÅî„É©„Ç¶„É≥„Éâ: ${state.round}</p>
            <p style="font-size: 2rem; font-weight: bold; margin: 10px 0;">Á∑èÂêà„Çπ„Ç≥„Ç¢: ${state.score}</p>
            <button onclick="location.reload()" class="btn" style="background: #fff; color: ${color}; font-weight: bold; margin-top: 15px;">„Çø„Ç§„Éà„É´„Å∏</button>
        </div>
    `;
}

function handleGameOver() {
    if (state.isProcessing) return;
    state.isProcessing = true;
    state.inputLocked = true;
    ui.btnBackToTitleIngame.classList.add('hidden');
    ui.apContainer.classList.add('hidden');
    
    ui.result.style.display = 'block';
    ui.result.innerHTML = `
        <div style="background: #c0392b; padding: 20px; border-radius: 10px; color: white; text-align: center; border: 4px solid #fff; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
            <h2 style="margin:0; font-size: 2.5rem; color: #fff;">APÂàá„ÇåÔºÅ</h2>
            <p style="font-size: 1.2rem;">ÁõÆÊ®ô„ÇíÈÅîÊàê„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü...</p>
            <p style="font-size: 1.5rem; font-weight: bold;">Á∑èÂêà„Çπ„Ç≥„Ç¢: ${state.score}</p>
            <button onclick="location.reload()" class="btn" style="background: #fff; color: #c0392b; font-weight: bold; margin-top: 15px;">„Çø„Ç§„Éà„É´„Å∏</button>
        </div>
    `;
    saveScoreData();
}

function backToTitle() {
    state.screen = 'TITLE';
    ui.title.style.display = 'flex';
    ui.result.style.display = 'none';
    ui.roundClearOverlay.classList.add('hidden');
    ui.btnBackToTitleIngame.classList.add('hidden');
    ui.apContainer.classList.add('hidden');
    ui.rankingScreen.classList.add('hidden');
    ui.playerManagerOverlay.classList.add('hidden');
}

ui.btnBackToTitleIngame.addEventListener('click', () => {
    if(confirm('„Çø„Ç§„Éà„É´„Å∏„ÇÇ„Å©„Çä„Åæ„Åô„ÅãÔºüÔºà„Çπ„Ç≥„Ç¢„ÅØ„Åç„Çç„Åè„Åï„Çå„Åæ„Åõ„ÇìÔºâ')) {
        backToTitle();
    }
});

function updateUI() {
    ui.apValue.textContent = state.ap; // Êñ∞„Åó„ÅÑAPË°®Á§∫Êõ¥Êñ∞
    
    // ÊÆã„Çä„Éé„É´„ÉûË°®Á§∫„ÅÆÊõ¥Êñ∞
    const remaining = Math.max(0, state.quota - state.roundHits);
    ui.quotaRemaining.textContent = `„ÅÇ„Å® ${remaining} „Åì`;

    ui.round.textContent = state.round;
    ui.quota.textContent = state.quota;
    ui.currentHits.textContent = state.roundHits;
    ui.totalScore.textContent = state.score;
    ui.difficultyLabel.textContent = SETTINGS[state.difficulty].label;
}

function saveScoreData() {
    saveLocalScore(state.difficulty, state.playerName, state.score);
    if (window.currentUser) {
        window.saveOnlineScore(window.currentUser.uid, state.playerName, state.difficulty, state.score);
    }
}

const savedPlayers = getPlayers();
if (savedPlayers.length > 0) state.playerName = savedPlayers[0];

ui.btnEasy.addEventListener('click', () => startGame('EASY'));
ui.btnNormal.addEventListener('click', () => startGame('NORMAL'));
ui.btnHard.addEventListener('click', () => startGame('HARD'));
ui.btnIndex.addEventListener('click', () => window.location.href = '../index.html');

function renderPlayerList() {
    ui.playerListUl.innerHTML = '';
    const players = getPlayers();
    players.forEach((name, index) => {
        const li = document.createElement('li');
        li.className = `player-item ${name === state.playerName ? 'selected' : ''}`;
        li.innerHTML = `<span class="player-item-name">${name}</span>`;
        li.addEventListener('click', () => {
            state.playerName = name;
            ui.currentPlayerDisplay.textContent = name;
            renderPlayerList();
        });
        if (index >= 0) { // ÂÖ®„Å¶„ÅÆÁôªÈå≤„Éó„É¨„Éº„É§„Éº„Å´ÂâäÈô§„Éú„Çø„É≥„ÇíË°®Á§∫
            const delBtn = document.createElement('button');
            delBtn.className = 'delete-btn';
            delBtn.textContent = '√ó';
            delBtn.onclick = (e) => {
                e.stopPropagation();
                if(confirm(`${name} „Çí„Åï„Åè„Åò„Çá„Åó„Åæ„Åô„ÅãÔºü`)) {
                    players.splice(index, 1);
                    savePlayers(players);
                    if (state.playerName === name) {
                        if (players.length > 0) {
                            state.playerName = players[0];
                        } else {
                            state.playerName = "ÂêçÁÑ°„Åó„Åï„Çì";
                        }
                        ui.currentPlayerDisplay.textContent = state.playerName;
                    }
                    renderPlayerList();
                }
            };
            li.appendChild(delBtn);
        }
        ui.playerListUl.appendChild(li);
    });
}
ui.playerSelectBtn.addEventListener('click', () => {
    ui.playerManagerOverlay.classList.remove('hidden');
    renderPlayerList();
});
ui.btnClosePlayerManager.addEventListener('click', () => ui.playerManagerOverlay.classList.add('hidden'));
ui.btnAddPlayer.addEventListener('click', () => {
    const name = ui.inputNewPlayer.value.trim();
    if (!name) return;
    
    // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥: „Å≤„Çâ„Åå„Å™„Å®„Éº„ÅÆ„Åø
    if (!/^[„ÅÅ-„Çì„Éº]+$/.test(name)) {
        alert("„Å≤„Çâ„Åå„Å™ „Å® „Éº („ÅÆ„Å∞„Åô„Åº„ÅÜ) „Å†„Åë„Åß ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
        return;
    }

    if (name.length > 12) { alert("„Å™„Åæ„Åà„ÅØ12„ÇÇ„Åò„Åæ„Åß„Åß„Åô"); return; }
    if (containsNgWord(name)) { alert("„Åù„ÅÆ„Å™„Åæ„Åà„ÅØ„Å§„Åã„Åà„Åæ„Åõ„Çì"); return; }
    
    const players = getPlayers();
    
    // Êï∞Âà∂ÈôêËøΩÂä†
    if (players.length >= 5) {
        alert("ÁôªÈå≤„Åß„Åç„Çã„ÅÆ„ÅØ 5‰∫∫ „Åæ„Åß„Åß„Åô");
        return;
    }
    
    if (players.includes(name)) { alert("„Åô„Åß„Å´„ÅÇ„Çã„Å™„Åæ„Åà„Åß„Åô"); return; }
    players.push(name);
    savePlayers(players);
    state.playerName = name;
    ui.currentPlayerDisplay.textContent = name;
    ui.inputNewPlayer.value = '';
    renderPlayerList();
});

ui.btnViewRanking.addEventListener('click', async () => {
    ui.rankingScreen.classList.remove('hidden');
    state.rankingMode = 'LOCAL';
    ui.btnRankLocal.classList.add('active');
    ui.btnRankWorld.classList.remove('active');
    updateRankingDisplay();
});
ui.btnCloseRanking.addEventListener('click', () => ui.rankingScreen.classList.add('hidden'));

ui.btnRankLocal.addEventListener('click', () => {
    state.rankingMode = 'LOCAL';
    ui.btnRankLocal.classList.add('active');
    ui.btnRankWorld.classList.remove('active');
    updateRankingDisplay();
});
ui.btnRankWorld.addEventListener('click', () => {
    state.rankingMode = 'WORLD';
    ui.btnRankWorld.classList.add('active');
    ui.btnRankLocal.classList.remove('active');
    updateRankingDisplay();
});

async function updateRankingDisplay() {
    const lists = { EASY: document.getElementById('rank-list-easy'), NORMAL: document.getElementById('rank-list-normal'), HARD: document.getElementById('rank-list-hard') };
    for (const diff of ['EASY', 'NORMAL', 'HARD']) {
        let data = [];
        if (state.rankingMode === 'LOCAL') {
            data = getLocalScores(diff);
        } else {
            lists[diff].innerHTML = '<li>„Çà„Åø„Åì„Åø‰∏≠...</li>';
            data = await window.fetchOnlineRanking(diff);
        }
        lists[diff].innerHTML = '';
        if (data.length === 0) {
            lists[diff].innerHTML = '<li style="color:#7f8c8d; text-align:center;">„Éá„Éº„Çø„Å™„Åó</li>';
        } else {
            data.forEach((d, i) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span class="ranking-rank">${i+1}</span>
                    <span class="ranking-name">${d.name}</span>
                    <span class="ranking-score">${d.score}</span>
                `;
                lists[diff].appendChild(li);
            });
        }
    }
}

ui.currentPlayerDisplay.textContent = state.playerName;
const counts = getClearCounts();
if(counts.EASY > 0) { ui.crowns.EASY.style.visibility = 'visible'; ui.clears.EASY.textContent = `${counts.EASY}Âõû„ÇØ„É™„Ç¢`; }
if(counts.NORMAL > 0) { ui.crowns.NORMAL.style.visibility = 'visible'; ui.clears.NORMAL.textContent = `${counts.NORMAL}Âõû„ÇØ„É™„Ç¢`; }
if(counts.HARD > 0) { ui.crowns.HARD.style.visibility = 'visible'; ui.clears.HARD.textContent = `${counts.HARD}Âõû„ÇØ„É™„Ç¢`; }
</script>
</body>
</html>
